<!-- Onglet actif -->
<input type="hidden" name="attr_sheetTab" class="sheet-tabstoggle" value="profils" />

<div class="charsheet">
  
  <!-- CHECKBOX CACHÉE POUR GÉRER L'AFFICHAGE -->
  <input type="checkbox" name="attr_hide_color_zones" value="1" class="sheet-hidden" />
  
  <!-- BARRE D'ONGLETS AVEC ENGRENAGE -->
  <div class="sheet-tabsbar">
    <div class="sheet-tab-buttons">
      <!-- ENGRENAGE / OPTIONS -->
      <div class="sheet-gear-wrapper">
        <!-- Le toggle -->
        <input type="checkbox" id="ui_settings_open" name="attr_ui_settings_open" class="sheet-gear-toggle" />
        <!-- Le bouton -->
        <label for="ui_settings_open" class="sheet-gear-btn" title="Options (ouvrir/fermer)">&#9881;</label>
        <!-- Le panneau -->
        <div class="sheet-settings-panel" role="region" aria-label="Options de la fiche">
          <div class="sheet-settings-title">Options de la fiche</div>
          
          <!-- Option : Mode Goule -->
          <div class="sheet-settings-row">
            <label>
              <input type="checkbox" name="attr_mode_goule" value="1" />
              Mode Goule
            </label>
          </div>
          
          <!-- Option : Révélation d'aide -->
          <div class="sheet-settings-row">
            <label>
              <input type="checkbox" name="attr_aide_revelation" value="1" />
              Révélation d'aide
            </label>
          </div>
          
          <!-- ✅ NOUVELLE OPTION : Cacher Zone Couleur Template -->
          <div class="sheet-settings-row sheet-sort-only-option">
            <label>
              <input type="checkbox" name="attr_hide_color_zones" value="1" />
              Cacher "Zone couleur de Template"
            </label>
          </div>
          
        </div>
      </div>
      <!-- Tes onglets -->
      <button type="action" name="act_profils" class="sheet-tab-button">Profils</button>
      <button type="action" name="act_combat" class="sheet-tab-button">Combat</button>
      <button type="action" name="act_talent" class="sheet-tab-button">Talent</button>
      <button type="action" name="act_sort" class="sheet-tab-button">Sort/Capacité</button>
      <button type="action" name="act_inventaire" class="sheet-tab-button">Inventaire</button>
      <button type="action" name="act_entrainement" class="sheet-tab-button">Entraînement</button>
      <button type="action" name="act_connaissance" class="sheet-tab-button">Connaissance</button>
      <button type="action" name="act_infos" class="sheet-tab-button">Informations Perso</button>
      <button type="action" name="act_tableau" class="sheet-tab-button">Tableau de bord</button>
      <button type="action" name="act_metier" class="sheet-tab-button">Métier</button>
      <button type="action" name="act_corruption" class="sheet-tab-button">Corruption</button>
      <button type="action" name="act_voie_sanguinaire" class="sheet-tab-button">Voie sanguinaire</button>

    </div>
  </div>
  
  <!-- Contenu des onglets -->
  <div class="sheet-tab-content sheet-sort">
    <!-- Ton contenu Sort/Capacité ici -->
  </div>
  
</div>




<!-- Conteneurs d’onglets -->
<div class="sheet-tab-content sheet-profils">
  <div class="sheet-box-wrapper"> <!-- ENCADREMENT GLOBAL -->

    <!-- ========== BLOC PRINCIPAL IDENTITÉ + RAPPEL ========== -->
    <div class="sheet-carac-block">
      <div class="section-wrapper">
        
        <!-- TABLEAU IDENTITÉ AVEC POINTS D'ACTION -->
        <table class="sheet-id-table">
          <thead>
            <tr>
              <th>Nom & Prénom</th>
              <th>LV</th>
              <th>&#9889; PA</th>
              <th>Avantage</th>
              <th>Désavantage</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" name="attr_nom" /></td>
              <td><input type="number" name="attr_level" /></td>
              <td><input type="number" name="attr_points_action" min="0" max="20" class="sheet-pa-input" /></td>
              <td><input type="number" name="attr_avantage" class="sheet-avantage-input" /></td>
              <td><input type="number" name="attr_desavantage" class="sheet-desavantage-input" /></td>
            </tr>
          </tbody>
        </table>

        <!-- SECTION RAPPEL DÉPLIABLE AVEC DETAILS/SUMMARY -->
        <details class="sheet-rappel-wrapper sheet-aide-section">

          <summary class="sheet-rappel-title">&#127922; Avantages & Désavantages - Rappel</summary>
          
          <div class="sheet-rappel-container">
            
            <!-- SOUS-SECTION AVANTAGES DÉPLIABLE -->
            <details class="sheet-advantage-wrapper">
              <summary class="sheet-advantage-title">&#9989; Avantages</summary>
              <div class="sheet-advantage-content">
                <div class="sheet-rule-description">
                  <p><strong>Les joueurs peuvent obtenir un avantage en réalisant une action risquée, impressionnante ou stratégiquement brillante. Un avantage doit être annoncé avant le lancer de dé, et offre l'un des effets suivants au choix :</strong></p>
                  <ul class="sheet-effect-list">
                    <li><span class="sheet-effect-highlight">+10 au résultat du jet</span> (ne modifie pas les chances de critique).</li>
                    <li><span class="sheet-effect-highlight">+5 % de chances de succès critique</span> sur ce jet.</li>
                    <li><span class="sheet-effect-highlight">Si un Dé de Destin est utilisé :</span> le joueur peut modifier son effet d'un cran, à la hausse ou à la baisse (par exemple transformer un 3 en 4 ou un 4 en 3).</li>
                  </ul>
                </div>
              </div>
            </details>

            <!-- SOUS-SECTION DÉSAVANTAGES DÉPLIABLE -->
            <details class="sheet-disadvantage-wrapper">
              <summary class="sheet-disadvantage-title">&#10060; Désavantages</summary>
              <div class="sheet-disadvantage-content">
                <div class="sheet-rule-description">
                  <p><strong>Le MJ peut imposer un désavantage en cas :</strong></p>
                  <ul class="sheet-cause-list">
                    <li><span class="sheet-cause-highlight">d'action imprudente,</span></li>
                    <li><span class="sheet-cause-highlight">d'échec critique,</span></li>
                    <li><span class="sheet-cause-highlight">ou de situation défavorable</span> (ex. : terrain, stress, pression narrative).</li>
                  </ul>
                  <p><strong>Un désavantage s'applique avant le jet, et entraîne l'un des effets suivants :</strong></p>
                  <ul class="sheet-effect-list">
                    <li><span class="sheet-effect-highlight">-10 au résultat du jet.</span></li>
                    <li><span class="sheet-effect-highlight">Échec critique élargi :</span> le seuil passe de 1 à 10 (tout résultat entre 1 et 10 devient un échec critique).</li>
                    <li><span class="sheet-effect-highlight">Si un Dé de Fatalité est utilisé :</span> le MJ peut modifier son effet d'un cran, à la hausse ou à la baisse (ex. : changer un 3 en 4).</li>
                  </ul>
                </div>
              </div>
            </details>

          </div>
        </details>

      </div>
    </div>

    <div class="sheet-pv-table-wrapper">
        
        
        <table class="sheet-pv-table">
  <thead>
    <tr>
      <th>⚔️ Stat</th>
      <th>❤️ Base</th>
      <th>✨ Bonus</th>
      <th>Total</th>
      <th>Actuel</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="stat-label red">❤️ PV</td>
      <td><input type="number" name="attr_pv_base" /></td>
      <td><input type="number" name="attr_pv_bonus" /></td>
      <td><input type="number" name="attr_pv_total" readonly /></td>
      <td><input type="number" name="attr_pv_actuel" /></td>
    </tr>
    <tr>
      <td class="stat-label blue">✨ PM</td>
      <td><input type="number" name="attr_pm_base" /></td>
      <td><input type="number" name="attr_pm_bonus" /></td>
      <td><input type="number" name="attr_pm_total" readonly /></td>
      <td><input type="number" name="attr_pm_actuel" /></td>
    </tr>
    <tr>
      <td class="stat-label green">⚡ PE</td>
      <td><input type="number" name="attr_pe_base" /></td>
      <td><input type="number" name="attr_pe_bonus" /></td>
      <td><input type="number" name="attr_pe_total" readonly /></td>
      <td><input type="number" name="attr_pe_actuel" /></td>
    </tr>
  </tbody>
</table>
        

        <details class="sheet-box-wrapper"> 
          <summary class="sheet-section-title">Dés de montée de niveau</summary>
          <table class="sheet-pv-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Formule de base</th>
                <th>Formule de jet</th>
                <th>Lancer</th>
              </tr>
            </thead>
            <tbody>
              <!-- PV -->
              <tr>
                <td>Dés de gain PV</td>
                <td><input type="text" name="attr_formule_pv_base" placeholder="ex: 1d10" /></td>
                <td><input type="text" name="attr_gain_pv_dice" placeholder="ex: 1d10+1" /></td>
                <td><button type="action" name="act_gain_pv">&#127922;</button></td>
              </tr>
              <!-- PM -->
              <tr>
                <td>Dés de gain PM</td>
                <td><input type="text" name="attr_formule_pm_base" placeholder="ex: 1d8" /></td>
                <td><input type="text" name="attr_gain_pm_dice" placeholder="ex: 1d8+1" /></td>
                <td><button type="action" name="act_gain_pm">&#127922;</button></td>
              </tr>
              <!-- PE -->
              <tr>
                <td>Dés de gain PE</td>
                <td><input type="text" name="attr_formule_pe_base" placeholder="ex: 1d6" /></td>
                <td><input type="text" name="attr_gain_pe_dice" placeholder="ex: 1d6+2" /></td>
                <td><button type="action" name="act_gain_pe">&#127922;</button></td>
              </tr>
            </tbody>
          </table>
        </details>

    </div>





<!-- Partie fiche : TABLE ID -->
<div class="sheet-id-wrapper">
  <div class="section-wrapper">
    <table class="sheet-id-table">
      <thead>
        <tr>
          <th>Classe Principale</th>
          <th>Classe Secondaire</th>
          <th>Race</th>
          <th>&#201;l&#233;ments</th>
          <th>Faveur du destin</th>
          <th class="neant-header">Appel du n&#233;ant</th>
        </tr>
      </thead>
      <tbody>
        <tr class="class-row">
          <td class="class-primary">
            <input type="text" name="attr_classe_principale" placeholder="Guerrier, Mage..." />
          </td>
          <td class="class-secondary">
            <input type="text" name="attr_classe_secondaire" placeholder="Optionnel" />
          </td>
          <td>
            <input type="text" name="attr_race" placeholder="Elfe, Humain..." />
          </td>
          <td>
            <input type="text" name="attr_elements" placeholder="Feu, Terre..." />
          </td>
          <td>
            <input type="number" name="attr_faveur_destin" placeholder="0" />
          </td>
          <td class="neant-cell">
            <input type="number" name="attr_neant" placeholder="0" />
          </td>
        </tr>
        <tr class="info-row">
          <td colspan="3">
            <label>M&#233;tier :</label>
            <input type="text" name="attr_metier_info" placeholder="Forgeron, &#201;rudit..." />
          </td>
          <td colspan="3">
            <label>&#201;tat actuel :</label>
            <input type="text" name="attr_etat_actuel" placeholder="En bonne sant&#233;, Bless&#233;..." />
          </td>
        </tr>
      </tbody>
    </table>

    <!-- SECTION EXPLICATIVE FAVEUR DU DESTIN (INTÉGRÉE) -->
    <details class="sheet-faveur-explicative-wrapper sheet-aide-section">

      <summary class="sheet-faveur-explicative-title">
        &#11088; R&#232;gles : Faveur du Destin (Destiny's Favor)
      </summary>
      <div class="sheet-faveur-explicative-content">
        
        <!-- Relance -->
        <div class="sheet-faveur-explicative-rule">
          <div class="sheet-faveur-explicative-rule-header">
            <span class="sheet-faveur-explicative-icon">&#128257;</span>
            <strong>Relance (1 point)</strong>
          </div>
          <div class="sheet-faveur-explicative-rule-text">
            Faites relancer un jet (vous, un alli&#233; ou un adversaire).
            <ul>
              <li><strong>Vous / alli&#233; :</strong> Relance et garde le meilleur r&#233;sultat.</li>
              <li><strong>Adversaire :</strong> Relance et garde le pire r&#233;sultat.</li>
            </ul>
            <em class="sheet-faveur-explicative-limit">&#9888; Limite : 1 Faveur par cible et par sc&#232;ne/combat (exception : vous pouvez l'utiliser plusieurs fois sur vous-m&#234;me si vous avez les points).</em>
          </div>
        </div>

        <!-- Échapper à la mort -->
        <div class="sheet-faveur-explicative-rule">
          <div class="sheet-faveur-explicative-rule-header">
            <span class="sheet-faveur-explicative-icon">&#10084;&#65039;</span>
            <strong>&#201;chapper &#224; la mort (1 point, 1/session)</strong>
          </div>
          <div class="sheet-faveur-explicative-rule-text">
            Quand vous tomberiez &#224; 0 PV ou seriez tu&#233; par une derni&#232;re attaque/effet, d&#233;pensez 1 point pour vous en tirer.
            <ul>
              <li>Lancez <strong>Xd6</strong> (X = &#8968;R&#233;silience/2&#8969;).</li>
              <li>Le r&#233;sultat en <strong>%</strong> devient des PV rendus sur vos PV de base (hors bonus).</li>
            </ul>
            <em class="sheet-faveur-explicative-example">Exemple : 17 &#8594; +17% PV de base r&#233;cup&#233;r&#233;s.</em>
          </div>
        </div>

        <!-- Attaque spéciale Brave -->
        <div class="sheet-faveur-explicative-rule">
          <div class="sheet-faveur-explicative-rule-header">
            <span class="sheet-faveur-explicative-icon">&#9876;</span>
            <strong>Attaque sp&#233;ciale Brave (1 point)</strong>
          </div>
          <div class="sheet-faveur-explicative-rule-text">
            Si vous poss&#233;dez une <strong>Attaque sp&#233;ciale Brave</strong>, vous pouvez la d&#233;clencher sans remplir ses pr&#233;requis.
            <ul>
              <li>&#9888; Uniquement en <strong>situation de crise</strong>.</li>
            </ul>
          </div>
        </div>

      </div>
    </details>

  </div>
</div>
<!-- =====================================================
     HTML INITIATIVE - SIMPLIFIÉ (sans lock/unlock)
     ===================================================== -->

<details class="sheet-initiative-wrapper" open>
  <summary class="sheet-initiative-header">
    <span class="sheet-initiative-icon">⚔️</span>
    <span class="sheet-initiative-title">Système d'Initiative</span>
  </summary>

  <div class="sheet-initiative-container">
    
    <!-- ========== FORMULE D'INITIATIVE ========== -->
    <div class="sheet-initiative-formula-section">
      <div class="sheet-formula-header">
        <h3 class="sheet-formula-title"> Formule d'Initiative</h3>
      </div>
      
      <div class="sheet-formula-display">
        <div class="sheet-formula-text">
          <!-- d20 TOTAL (1 de base + bonus) -->
          <span name="attr_initiative_d20_display" class="sheet-formula-base">1d20</span>
          
          <!-- d10 TOTAL (niveau + bonus) -->
          <span class="sheet-formula-operator"> + </span>
          <span name="attr_initiative_d10_display" class="sheet-formula-value">0d10</span>
          
          <!-- Mod PER -->
          <span class="sheet-formula-operator"> + </span>
          <span name="attr_per_mod" class="sheet-formula-value">0</span>
          <span class="sheet-formula-label"> (PER)</span>
          
          <!-- Réactivité -->
          <span class="sheet-formula-operator"> + </span>
          <span name="attr_initiative_reactivity_bonus" class="sheet-formula-value">0</span>
          <span class="sheet-formula-label"> (Réac/10)</span>
          
          <!-- BONUS FIXES - Tous affichés séparément -->
          <span name="attr_all_bonuses_display" class="sheet-formula-bonuses"></span>
        </div>
        
        <div class="sheet-formula-total">
          <span class="sheet-total-label">Total estimé :</span>
          <span name="attr_initiative_total_display" class="sheet-total-value">+0</span>
        </div>
      </div>
    </div>

    <!-- ========== CONTRÔLES PRINCIPAUX ========== -->
    <div class="sheet-initiative-controls">
      
      <!-- Colonne gauche : Stats de base -->
      <div class="sheet-initiative-stats">
        <div class="sheet-stat-group">
          <label class="sheet-stat-label">Niveau du personnage</label>
          <input type="number" name="attr_level" value="1" min="1" class="sheet-stat-input" readonly />
          <span class="sheet-stat-help">Détermine le nombre de d10 bonus</span>
        </div>
        
        <div class="sheet-stat-group">
          <label class="sheet-stat-label">Réactivité (finale)</label>
          <input type="number" name="attr_rea_final" value="0" min="0" class="sheet-stat-input" readonly />
          <span class="sheet-stat-help">La dizaine donne un bonus (ex: 25 → +2)</span>
        </div>
        
        <div class="sheet-stat-group">
          <label class="sheet-stat-label">Modificateur PER</label>
          <input type="number" name="attr_per_mod" value="0" class="sheet-stat-input" readonly />
        </div>
      </div>

      <!-- Colonne droite : Avantage/Désavantage/Jet MJ + Bouton -->
      <div class="sheet-initiative-actions">
        
        <!-- Avantage/Désavantage/Jet MJ -->
        <div class="sheet-advantage-section">
          <div class="sheet-advantage-group">
            <label class="sheet-advantage-label">
              <input type="checkbox" name="attr_initiative_advantage" class="sheet-advantage-checkbox" />
              <span class="sheet-advantage-icon">⬆️</span>
              <span class="sheet-advantage-text">Avantage</span>
            </label>
            <span class="sheet-advantage-help">Lance 2 fois, garde le meilleur</span>
          </div>
          
          <div class="sheet-advantage-group">
            <label class="sheet-advantage-label">
              <input type="checkbox" name="attr_initiative_disadvantage" class="sheet-advantage-checkbox" />
              <span class="sheet-advantage-icon">⬇️</span>
              <span class="sheet-advantage-text">Désavantage</span>
            </label>
            <span class="sheet-advantage-help">Lance 2 fois, garde le pire</span>
          </div>
          
          <div class="sheet-advantage-group">
            <label class="sheet-advantage-label sheet-whisper-label">
              <input type="checkbox" name="attr_initiative_whisper" class="sheet-advantage-checkbox" />
              <span class="sheet-advantage-icon"></span>
              <span class="sheet-advantage-text">Jet MJ</span>
            </label>
            <span class="sheet-advantage-help">Jet visible uniquement par le MJ</span>
          </div>
        </div>

        <!-- Bouton de lancement -->
        <button type="roll" 
          name="roll_initiative_advanced"
          class="sheet-initiative-roll-button"
          value="@{initiative_roll_formula}">
          <span class="sheet-button-icon"></span>
          <span class="sheet-button-text">Lancer Initiative</span>
        </button>
        
      </div>
    </div>

    <!-- ========== BONUS PERSONNALISÉS ========== -->
    <div class="sheet-initiative-bonuses-section">
      <div class="sheet-bonuses-header">
        <h3 class="sheet-bonuses-title">⚡ Bonus & Effets Personnalisés</h3>
      </div>

      <!-- Table des bonus -->
      <div class="sheet-bonuses-table-wrapper">
        <table class="sheet-bonuses-table">
          <thead>
            <tr>
              <th class="sheet-col-name">Nom de l'effet</th>
              <th class="sheet-col-type">Type de bonus</th>
              <th class="sheet-col-value">Valeur</th>
              <th class="sheet-col-active">Actif</th>
            </tr>
          </thead>
          
          <tbody>
            
            <!-- ========== LIGNE DE BASE (toujours présente) ========== -->
            <tr class="sheet-bonus-row-base">
              <td class="sheet-bonus-cell sheet-cell-name">
                <input type="text" 
                  name="attr_base_bonus_name" 
                  placeholder="Ex: Talent Éclair"
                  value=""
                  class="sheet-bonus-name-input" />
              </td>
              
              <td class="sheet-bonus-cell sheet-cell-type">
                <select name="attr_base_bonus_type" class="sheet-bonus-type-select">
                  <option value="d20">1d20 (Gros dé)</option>
                  <option value="d10">1d10 (Petit dé)</option>
                  <option value="fixed">Bonus fixe</option>
                </select>
              </td>
              
              <td class="sheet-bonus-cell sheet-cell-value">
                <input type="text" 
                  name="attr_base_bonus_value" 
                  placeholder="Ex: 5 ou 1d6"
                  value=""
                  class="sheet-bonus-value-input" />
              </td>
              
              <td class="sheet-bonus-cell sheet-cell-active">
                <label class="sheet-bonus-active-label">
                  <input type="checkbox" name="attr_base_bonus_active" class="sheet-bonus-active-checkbox" />
                  <span class="sheet-checkbox-custom"></span>
                </label>
              </td>
            </tr>
            
          </tbody>
        </table>

        <!-- ========== REPEATING SECTION (lignes ajoutables) ========== -->
        <fieldset class="repeating_initiativebonus">
          <table class="sheet-bonuses-table sheet-bonuses-table-repeating">
            <tbody>
              <tr class="sheet-bonus-row">
                
                <!-- Nom de l'effet -->
                <td class="sheet-bonus-cell sheet-cell-name">
                  <input type="text" 
                    name="attr_bonus_name" 
                    placeholder="Ex: Potion de Rapidité" 
                    class="sheet-bonus-name-input" />
                </td>

                <!-- Type de bonus -->
                <td class="sheet-bonus-cell sheet-cell-type">
                  <select name="attr_bonus_type" class="sheet-bonus-type-select">
                    <option value="d20">1d20 (Gros dé)</option>
                    <option value="d10">1d10 (Petit dé)</option>
                    <option value="fixed">Bonus fixe</option>
                  </select>
                </td>

                <!-- Valeur (toujours éditable) -->
                <td class="sheet-bonus-cell sheet-cell-value">
                  <input type="text" 
                    name="attr_bonus_value" 
                    placeholder="Ex: 5 ou 1d6" 
                    class="sheet-bonus-value-input" />
                </td>

                <!-- Actif -->
                <td class="sheet-bonus-cell sheet-cell-active">
                  <label class="sheet-bonus-active-label">
                    <input type="checkbox" name="attr_bonus_active" class="sheet-bonus-active-checkbox" />
                    <span class="sheet-checkbox-custom"></span>
                  </label>
                </td>

              </tr>
            </tbody>
          </table>
        </fieldset>
        
      </div>
    </div>

    <!-- ========== INPUTS CACHÉS (calculs) ========== -->
    <input type="hidden" name="attr_initiative_level_dice" value="0" />
    <input type="hidden" name="attr_initiative_level_dice_display" value="0d10" />
    <input type="hidden" name="attr_initiative_d20_display" value="1d20" />
    <input type="hidden" name="attr_initiative_d10_display" value="0d10" />
    <input type="hidden" name="attr_all_bonuses_display" value="" />
    <input type="hidden" name="attr_initiative_reactivity_bonus" value="0" />
    <input type="hidden" name="attr_initiative_total_display" value="+0" />
    <input type="hidden" name="attr_initiative_roll_formula" value="" />

  </div>
</details>













<!-- Dés de Destin et Fatalité avec Règles Intégrées -->
<details class="sheet-box-wrapper">
  <summary class="sheet-section-title">Dés de Destin et de Fatalité</summary>
  
  <!-- TABLE DES DÉS -->
  <table class="sheet-dice-table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Lancer</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Dés de Destin</td>
        <td><button type="action" name="act_des_destin">&#127922;</button></td>
      </tr>
      <tr>
        <td>Dés de Fatalité</td>
        <td><button type="action" name="act_des_fatalite">&#127922;</button></td>
      </tr>
    </tbody>
  </table>
  
  <!-- SECTION EXPLICATIVE DES RÈGLES -->
  <div class="sheet-dice-info-container sheet-aide-section">

    
    <!-- SOUS-SECTION : DÉS DE DESTIN -->
    <details class="sheet-dice-subsection sheet-dice-destin">
      <summary class="sheet-dice-subsection-title">
        <span class="sheet-subsection-icon">&#11088;</span>
        <span class="sheet-subsection-text">Dés de Destin : Favoriser les Opportunités</span>
      </summary>
      
      <div class="sheet-dice-subsection-content">
        <p class="sheet-dice-intro">
          Les <strong>Dés de Destin</strong> permettent aux joueurs de maximiser leurs chances ou de surmonter des situations critiques. Avant un jet standard, un joueur peut déclarer qu'il utilise un Dé de Destin, puis lancer un <strong>d6 &#127922;</strong> pour obtenir l'un des effets suivants :
        </p>
        
        <div class="sheet-dice-effects">
          <div class="sheet-dice-effect">
            <div class="sheet-effect-range">1-2</div>
            <div class="sheet-effect-content">
              <div class="sheet-effect-name">Chance incroyable ➡️</div>
              <div class="sheet-effect-desc">Ajoute <strong>+15</strong> au résultat final, transformant potentiellement un échec en succès ou un succès en succès critique.</div>
            </div>
          </div>
          
          <div class="sheet-dice-effect">
            <div class="sheet-effect-range">3-4</div>
            <div class="sheet-effect-content">
              <div class="sheet-effect-name">Reprise inespérée ➡️</div>
              <div class="sheet-effect-desc">Permet de relancer le jet initial, en gardant le <strong>meilleur</strong> des deux résultats.</div>
            </div>
          </div>
          
          <div class="sheet-dice-effect">
            <div class="sheet-effect-range">5-6</div>
            <div class="sheet-effect-content">
              <div class="sheet-effect-name">Sûreté inespérée ➡️</div>
              <div class="sheet-effect-desc">Annule un échec critique, protégeant le joueur des pires conséquences.</div>
            </div>
          </div>
        </div>
      </div>
    </details>
    
    <!-- SOUS-SECTION : DÉS DE FATALITÉ -->
    <details class="sheet-dice-subsection sheet-dice-fatalite">
      <summary class="sheet-dice-subsection-title">
        <span class="sheet-subsection-icon">&#128128;</span>
        <span class="sheet-subsection-text">Dés de Fatalité : Semer des Complications</span>
      </summary>
      
      <div class="sheet-dice-subsection-content">
        <p class="sheet-dice-intro">
          Les <strong>Dés de Fatalité</strong> permettent au MJ d'introduire des défis imprévus. Lorsqu'une situation devient tendue, le MJ peut lancer un <strong>d6 &#127922;</strong> pour appliquer l'un des effets suivants :
        </p>
        
        <div class="sheet-dice-effects">
          <div class="sheet-dice-effect">
            <div class="sheet-effect-range">1-2</div>
            <div class="sheet-effect-content">
              <div class="sheet-effect-name">Malchance incroyable ➡️</div>
              <div class="sheet-effect-desc">Soustrait <strong>-10</strong> au jet du joueur, transformant un succès en échec.</div>
            </div>
          </div>
          
          <div class="sheet-dice-effect">
            <div class="sheet-effect-range">3-4</div>
            <div class="sheet-effect-content">
              <div class="sheet-effect-name">Reprise malencontreuse ➡️</div>
              <div class="sheet-effect-desc">Oblige le joueur à relancer le jet et à conserver le <strong>pire</strong> résultat.</div>
            </div>
          </div>
          
          <div class="sheet-dice-effect">
            <div class="sheet-effect-range">5-6</div>
            <div class="sheet-effect-content">
              <div class="sheet-effect-name">Panique incontrôlable ➡️</div>
              <div class="sheet-effect-desc">Le joueur perd l'accès à ses compétences pendant <strong>1 tour</strong>.</div>
            </div>
          </div>
        </div>
      </div>
    </details>
    
    <!-- SOUS-SECTION : GESTION DES DÉS -->
    <details class="sheet-dice-subsection sheet-dice-gestion">
      <summary class="sheet-dice-subsection-title">
        <span class="sheet-subsection-icon">&#9881;</span>
        <span class="sheet-subsection-text">Gestion des Dés</span>
      </summary>
      
      <div class="sheet-dice-subsection-content">
        <div class="sheet-dice-rules">
          <div class="sheet-dice-rule">
            <div class="sheet-rule-icon">&#128736;</div>
            <div class="sheet-rule-content">
              <div class="sheet-rule-title">Départ de l'Aventure</div>
              <div class="sheet-rule-desc">Chaque groupe commence avec <strong>2 Dés de Destin</strong> et <strong>2 Dés de Fatalité</strong>.</div>
            </div>
          </div>
          
          <div class="sheet-dice-rule">
            <div class="sheet-rule-icon">&#9878;</div>
            <div class="sheet-rule-content">
              <div class="sheet-rule-title">Équilibre des Dés</div>
              <div class="sheet-rule-desc">Lorsqu'un <strong>Dé de Destin</strong> est utilisé, il devient un <strong>Dé de Fatalité</strong>, et vice-versa.</div>
            </div>
          </div>
          
          <div class="sheet-dice-rule">
            <div class="sheet-rule-icon">&#127917;</div>
            <div class="sheet-rule-content">
              <div class="sheet-rule-title">Attribution par le MJ</div>
              <ul class="sheet-rule-list">
                <li>Les <strong>Dés de Destin</strong> sont attribués pour des choix stratégiques ou des actions héroïques.</li>
                <li>Les <strong>Dés de Fatalité</strong> sont donnés pour des actions risquées ou des échecs spectaculaires.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </details>
    
  </div>
</details>
    

    <table class="sheet-profile-grid" style="width:100%; table-layout:fixed; border-collapse:separate; border-spacing:1em;">
      <tr>
        <td style="vertical-align:top; width:50%;">
          <div class="sheet-carac-wrapper">
              
              
<div class="sheet-carac-block" id="carac-block">
  
  <table class="sheet-carac-table">
    <thead>
      <tr class="sheet-carac-title-row">
        <th colspan="6" class="sheet-carac-title-cell">
          <div class="sheet-carac-title-text">Caractéristiques de Combat</div>
          <div class="sheet-carac-title-space"></div>
        </th>
      </tr>
      
<tr>
  <th colspan="6" style="padding: 0; border: none;">
    <div class="sheet-carac-options-wrapper" style="display: flex; gap: 20px; justify-content: center; align-items: center; padding: 8px;">
      
      <!-- CHECKBOX MARGE -->
      <div class="sheet-margin-option">
        <label>
          <input type="checkbox" name="attr_showcaracmargin" value="1" />
          <span>Afficher la marge de réussite</span>
        </label>
      </div>
      
      <!-- CHECKBOX WHISPER -->
      <div class="sheet-whisper-option">
        <label>
          <input type="checkbox" name="attr_whispercarac" value="1" />
          <span>Jet chuchoté au MJ</span>
        </label>
      </div>
      
      <!-- ✅ NOUVEAU : AVANTAGE -->
      <div class="sheet-avantage-option">
        <label style="color: #4caf50; font-weight: bold;">
          <input type="checkbox" name="attr_avantage_carac" value="1" />
          <span>&#11014; Avantage (2d100, meilleur)</span>
        </label>
      </div>
      
      <!-- ✅ NOUVEAU : DÉSAVANTAGE -->
      <div class="sheet-desavantage-option">
        <label style="color: #f44336; font-weight: bold;">
          <input type="checkbox" name="attr_desavantage_carac" value="1" />
          <span>&#11015; Désavantage (2d100, pire)</span>
        </label>
      </div>
      
    </div>
  </th>
</tr>
      
      <tr>
        <th colspan="2">Carac (1d100)</th>
        <th>Mod</th>
        <th>Bonus/Malus</th>
        <th>Difficulté</th>
        <th>Dés</th>
      </tr>
    </thead>
    <tbody>
      <!-- FOR -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_for_principal" id="for_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_for_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="for_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Force</span>
          </label>
        </td>
        <td><input type="number" name="attr_for" /></td>
        <td><input type="number" name="attr_for_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_for_bonus" /></td>
        <td><input type="number" name="attr_for_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracfor">&#127922;</button>
          <input type="hidden" name="attr_for_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- CST -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_cst_principal" id="cst_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_cst_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="cst_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Constitution</span>
          </label>
        </td>
        <td><input type="number" name="attr_cst" /></td>
        <td><input type="number" name="attr_cst_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_cst_bonus" /></td>
        <td><input type="number" name="attr_cst_diff" /></td>
        <td>
          <button type="action" name="act_rollcaraccst">&#127922;</button>
          <input type="hidden" name="attr_cst_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- DEX -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_dex_principal" id="dex_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_dex_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="dex_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Dextérité</span>
          </label>
        </td>
        <td><input type="number" name="attr_dex" /></td>
        <td><input type="number" name="attr_dex_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_dex_bonus" /></td>
        <td><input type="number" name="attr_dex_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracdex">&#127922;</button>
          <input type="hidden" name="attr_dex_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- INT -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_int_principal" id="int_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_int_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="int_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Intelligence</span>
          </label>
        </td>
        <td><input type="number" name="attr_int" /></td>
        <td><input type="number" name="attr_int_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_int_bonus" /></td>
        <td><input type="number" name="attr_int_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracint">&#127922;</button>
          <input type="hidden" name="attr_int_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- SAG -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_sag_principal" id="sag_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_sag_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="sag_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Sagesse</span>
          </label>
        </td>
        <td><input type="number" name="attr_sag" /></td>
        <td><input type="number" name="attr_sag_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_sag_bonus" /></td>
        <td><input type="number" name="attr_sag_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracsag">&#127922;</button>
          <input type="hidden" name="attr_sag_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- PER -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_per_principal" id="per_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_per_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="per_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Perception</span>
          </label>
        </td>
        <td><input type="number" name="attr_per" /></td>
        <td><input type="number" name="attr_per_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_per_bonus" /></td>
        <td><input type="number" name="attr_per_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracper">&#127922;</button>
          <input type="hidden" name="attr_per_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- CHA -->
      <tr class="sheet-carac-row">
        <td class="sheet-carac-name-cell">
          <input type="checkbox" name="attr_cha_principal" id="cha_principal_checkbox" class="sheet-carac-principal-checkbox" value="1" />
          <input type="hidden" name="attr_cha_row_highlight" class="sheet-row-highlight" value="0" />
          <label for="cha_principal_checkbox" class="sheet-carac-name-label">
            <span class="sheet-carac-star">⭐</span>
            <span class="sheet-carac-name-text">Charisme</span>
          </label>
        </td>
        <td><input type="number" name="attr_cha" /></td>
        <td><input type="number" name="attr_cha_mod" readonly class="sheet-mod-readonly" /></td>
        <td><input type="number" name="attr_cha_bonus" /></td>
        <td><input type="number" name="attr_cha_diff" /></td>
        <td>
          <button type="action" name="act_rollcaraccha">&#127922;</button>
          <input type="hidden" name="attr_cha_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- SÉPARATEUR CARACTÉRISTIQUES PRINCIPALES / SECONDAIRES -->
      <tr class="sheet-carac-separator-row">
        <td colspan="6" class="sheet-carac-separator-cell">
          <div class="sheet-carac-separator"></div>
          <div class="sheet-carac-separator-title">&#9876;&#65039; Caractéristiques Secondaires</div>
        </td>
      </tr>

      <!-- RESM -->
      <tr>
        <td>Résistance Mentale</td>
        <td><input type="number" name="attr_rm_base" /></td>
        <td><input type="number" name="attr_rm_final" readonly /></td>
        <td><input type="number" name="attr_rm_bonus" /></td>
        <td><input type="number" name="attr_rm_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracrm">&#127922;</button>
          <input type="hidden" name="attr_rm_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- REAC -->
      <tr>
        <td>Réactivité</td>
        <td><input type="number" name="attr_rea_base" /></td>
        <td><input type="number" name="attr_rea_final" readonly /></td>
        <td><input type="number" name="attr_rea_bonus" /></td>
        <td><input type="number" name="attr_rea_diff" /></td>
        <td>
          <button type="action" name="act_rollcaracrea">&#127922;</button>
          <input type="hidden" name="attr_rea_diff_effectif" value="0" />
        </td>
      </tr>

      <!-- LIGNE POINTS DE RÉACTION AVEC GESTION NÉGATIFS -->
      <tr>
        <td>Points de Réaction</td>
        <td>
          <div class="sheet-pr-container">
            <label class="sheet-pr-label"></label>
            <input type="number" name="attr_pr_max" class="sheet-pr-max-input" value="4" min="0" max="20" />
          </div>
        </td>
        <td>
          <div class="sheet-pr-container">
            <input type="text" name="attr_pr_display" class="sheet-pr-display-input" value="4/4" readonly />
          </div>
        </td>
        <td>
          <div class="sheet-pr-btn-container">
            <button type="action" name="act_pr_plus" class="sheet-pr-btn sheet-pr-btn-plus" title="Récupérer 1 PR">+1</button>
          </div>
        </td>
        <td>
          <div class="sheet-pr-btn-container">
            <button type="action" name="act_pr_minus" class="sheet-pr-btn sheet-pr-btn-minus" title="Consommer 1 PR">-1</button>
          </div>
        </td>
        <td>
          <div class="sheet-pr-btn-container">
            <button type="action" name="act_pr_reset" class="sheet-pr-btn sheet-pr-btn-reset" title="Reset PR au maximum">&#8634;</button>
          </div>
        </td>
      </tr>
      
      <tr>
        <td style="background-color:#f3dfd3;">Mouvement</td>
        <td colspan="2"><input type="text" name="attr_mov" value="0 ft" readonly /></td>
        <td><input type="number" name="attr_mov_bonus" /><span style="font-size:0.75em;">Bonus</span></td>
        <td><input type="number" name="attr_mov_base" value="20" /><span style="font-size:0.75em;">Base</span></td>
        <td>
          <button type="action" 
                  name="act_course"
                  style="background: #d4a574; color: #2c1e0f; border: 1px solid #8b4513; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: bold; cursor: pointer; width: 100%;"
                  title="Utiliser Course (-1 PR)">
            &#127939; Course
          </button>
        </td>
      </tr>
    </tbody>
  </table>

</div>


</div>
        </td>
        
        <td style="vertical-align:top; width:50%;">
          <div class="sheet-id-wrapper">
            <table class="sheet-id-table">
              <thead>
                <tr>
                  <th colspan="2">Image du personnage</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="2" style="text-align:center;">
                    <div class="sheet-character-image-preview">
                      <img src="@{image_url}" alt="Portrait du personnage" name="attr_image_url" />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td colspan="2" style="text-align:center;">
                    <input type="text" name="attr_image_url"  />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      
      <tr>
        <!-- ZONE DES COMPÉTENCES -->
        <td style="vertical-align:top; width:50%;">
          <div class="sheet-competence-wrapper">

            <!-- COMPÉTENCE -->
            <details class="sheet-competence-wrapper">
              <summary class="sheet-competence-header">Zone des compétences</summary>
              <fieldset class="repeating_competences">
                <div class="sheet-double-competence">
                  <!-- Colonne 1 -->
                  <div class="sheet-competence-group">
                    <input type="text" name="attr_comp_nom" placeholder="Nom" />
                    <input type="number" name="attr_comp_bonus" placeholder="Bonus" />
                    <input type="checkbox" name="attr_comp_active" />
                  </div>
                  <!-- Colonne 2 -->
                  <div class="sheet-competence-group">
                    <input type="text" name="attr_comp_nom2" placeholder="Nom" />
                    <input type="number" name="attr_comp_bonus2" placeholder="Bonus" />
                    <input type="checkbox" name="attr_comp_active2" />
                  </div>
                </div>
              </fieldset>
            </details>

            <!-- COMPÉTENCE DE TRAIT SPÉCIFIQUE -->
            <details class="sheet-competence-trait-wrapper">
              <summary class="sheet-competence-subheader">Compétence de trait spécifique</summary>
              <fieldset class="repeating_traitcompetences">
                <div class="sheet-double-competence">
                  <!-- Colonne 1 -->
                  <div class="sheet-competence-group">
                    <input type="text" name="attr_trait_comp_nom1" placeholder="Nom" />
                    <input type="number" name="attr_trait_comp_bonus1" placeholder="Bonus" />
                    <input type="checkbox" name="attr_trait_comp_active1" />
                  </div>
                  <!-- Colonne 2 -->
                  <div class="sheet-competence-group">
                    <input type="text" name="attr_trait_comp_nom2" placeholder="Nom" />
                    <input type="number" name="attr_trait_comp_bonus2" placeholder="Bonus" />
                    <input type="checkbox" name="attr_trait_comp_active2" />
                  </div>
                </div>
              </fieldset>
            </details>

          </div>
        </td>

        <td style="vertical-align:top; width:50%;">
              <!-- Section Traits spécifiques avec pliage/dépliage -->
<!-- Section Traits spécifiques avec pliage/dépliage -->
<details class="sheet-traits-wrapper" open>
  <summary class="sheet-section-title">Trait spécifique</summary>
  
  <!-- WRAPPER POUR LES DEUX OPTIONS CÔTE À CÔTE -->
  <div class="sheet-trait-options-wrapper">
    <!-- CHECKBOX MARGE -->
    <div class="sheet-margin-option">
      <label>
        <input type="checkbox" name="attr_showtraitmargin" value="1" />
        <span>Afficher la marge de réussite</span>
      </label>
    </div>
    
    <!-- CHECKBOX WHISPER -->
    <div class="sheet-whisper-option">
      <label>
        <input type="checkbox" name="attr_whisper_gm" value="1" />
        <span>Jet chuchoté au MJ</span>
      </label>
    </div>
    <!-- ✅ AVANTAGE TRAITS -->
<div class="sheet-avantage-option">
  <label>
    <input type="checkbox" name="attr_avantage_trait" value="1" />
    <span>&#11014; Avantage (2dX, meilleur)</span>
  </label>
</div>

<!-- ⚠️ DÉSAVANTAGE TRAITS -->
<div class="sheet-desavantage-option">
  <label>
    <input type="checkbox" name="attr_desavantage_trait" value="1" />
    <span>&#11015; Désavantage (2dX, pire)</span>
  </label>
</div>
  </div>
  
  <table class="sheet-traits-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Valeur</th>
        <th>Bonus</th>
        <th>Type de dé</th>
        <th>Lancer</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Résilience</td>
        <td><input type="number" name="attr_resi" min="0" max="20" /></td>
        <td><input type="number" name="attr_resibonus" /></td>
        <td><input type="text" name="attr_residice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitresi">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Finesse</td>
        <td><input type="number" name="attr_fin" min="0" max="20" /></td>
        <td><input type="number" name="attr_finbonus" /></td>
        <td><input type="text" name="attr_findice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitfin">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Instinct</td>
        <td><input type="number" name="attr_ins" min="0" max="20" /></td>
        <td><input type="number" name="attr_insbonus" /></td>
        <td><input type="text" name="attr_insdice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitins">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Savoir</td>
        <td><input type="number" name="attr_sav" min="0" max="20" /></td>
        <td><input type="number" name="attr_savbonus" /></td>
        <td><input type="text" name="attr_savdice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitsav">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Social</td>
        <td><input type="number" name="attr_soc" min="0" max="20" /></td>
        <td><input type="number" name="attr_socbonus" /></td>
        <td><input type="text" name="attr_socdice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitsoc">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Puissance</td>
        <td><input type="number" name="attr_pui" min="0" max="20" /></td>
        <td><input type="number" name="attr_puibonus" /></td>
        <td><input type="text" name="attr_puidice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitpui">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Métier</td>
        <td><input type="number" name="attr_metier" min="0" max="20" /></td>
        <td><input type="number" name="attr_metierbonus" /></td>
        <td><input type="text" name="attr_metierdice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitmetier">&#127922;</button>
        </td>
      </tr>
      <tr>
        <td>Sang-Froid</td>
        <td><input type="number" name="attr_san" min="0" max="20" /></td>
        <td><input type="number" name="attr_sanbonus" /></td>
        <td><input type="text" name="attr_sandice" placeholder="1d12" /></td>
        <td>
          <button type="action" name="act_rolltraitsan">&#127922;</button>
        </td>
      </tr>
    </tbody>
  </table>
</details>
            </td>
          </tr>
        </table>

    <!-- CHAMPS CACHÉS POUR LES CALCULS -->
    <input type="hidden" name="attr_pr_current" value="4" />
    <input type="hidden" name="attr_competence_bonus_total" />
    <input type="hidden" name="attr_trait_competence_bonus_total" />


<details class="sheet-langues-wrapper">
  <summary class="sheet-section-title">
    &#127760; Langues Connues
  </summary>
  <div class="sheet-langues-container">
    
    <!-- LIGNE FIXE (4 colonnes) -->
    <div class="sheet-langues-grid sheet-langues-fixed">
      <div class="sheet-langue-col">
        <label>&#128172; Langue</label>
        <input type="text" name="attr_langue_1" placeholder="Langue 1" />
      </div>
      <div class="sheet-langue-col">
        <label>&#128172; Langue</label>
        <input type="text" name="attr_langue_2" placeholder="Langue 2" />
      </div>
      <div class="sheet-langue-col">
        <label>&#128172; Langue</label>
        <input type="text" name="attr_langue_3" placeholder="Langue 3" />
      </div>
      <div class="sheet-langue-col">
        <label>&#128172; Langue</label>
        <input type="text" name="attr_langue_4" placeholder="Langue 4" />
      </div>
    </div>
    
    <!-- SÉPARATEUR AVEC TEXTE RÉEL (pas de ::after) -->
<div class="sheet-langues-separator">
  <span class="sheet-langues-separator-text">⚜️ Langues Supplémentaires ⚜️</span>
</div>
    
    <!-- REPEATING SECTION (lignes ajoutables) -->
    <fieldset class="repeating_langues_custom">
      <div class="sheet-langues-grid sheet-langues-repeating">
        <div class="sheet-langue-col">
          <input type="text" name="attr_langue_custom_1" placeholder="Langue supplémentaire" />
        </div>
        <div class="sheet-langue-col">
          <input type="text" name="attr_langue_custom_2" placeholder="Langue supplémentaire" />
        </div>
        <div class="sheet-langue-col">
          <input type="text" name="attr_langue_custom_3" placeholder="Langue supplémentaire" />
        </div>
        <div class="sheet-langue-col">
          <input type="text" name="attr_langue_custom_4" placeholder="Langue supplémentaire" />
        </div>
      </div>
    </fieldset>
    
  </div>
</details>





<!-- Système de monnaie amélioré -->
<details class="sheet-currency-section">
  <summary class="sheet-section-title">&#128176; Système Monétaire</summary>
  
  <!-- Convertisseur et Total INTÉGRÉ EN UNE SEULE LIGNE -->
  <div class="sheet-currency-summary">
    <div class="sheet-wealth-display">
      <!-- RICHESSE TOTALE - GAUCHE -->
      <div class="sheet-wealth-item">
        <label>Richesse Totale :</label>
        <span name="attr_total_wealth_display" class="sheet-total-wealth">0 PG</span>
      </div>
      
      <!-- TAUX DE CHANGE - CENTRE -->
      <div class="sheet-exchange-rates">
        <h4>&#128202; Taux de Change</h4>
        <div class="sheet-rates-grid">
          <div class="sheet-rate-item">
            <label>1 PGI =</label>
            <input type="number" name="attr_rate_pgi_to_pg" value="220" min="1" max="1000" />
            <span>PG</span>
          </div>
          <div class="sheet-rate-item">
            <label>1 PC =</label>
            <input type="number" name="attr_rate_pc_to_pg" value="30800" min="1" max="100000" class="sheet-pc-rate-input" />
            <span>PG</span>
          </div>
        </div>
      </div>
      
      <!-- NIVEAU DE RICHESSE - DROITE -->
      <div class="sheet-wealth-level">
        <label>Niveau :</label>
        <span name="attr_wealth_level_display" class="sheet-wealth-status">Pauvre</span>
      </div>
    </div>
  </div>

  <!-- Tableau principal des monnaies -->
  <div class="sheet-currency-main">
    <table class="sheet-currency-table">
      <thead>
        <tr>
          <th class="sheet-currency-header pg">&#10052; Pièce de Givre (PG)</th>
          <th class="sheet-currency-header pgi">&#128309; Pièce de Glace Indigo (PGI)</th>
          <th class="sheet-currency-header pc">&#128142; Pièce de Cryosse (PC)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Valeurs actuelles -->
        <tr class="sheet-currency-values">
          <td>
            <input type="text" name="attr_pg_total" placeholder="ex: 5d80+150 PG" class="sheet-currency-input" />
          </td>
          <td>
            <input type="text" name="attr_pgi_total" placeholder="ex: 1d3 PGI" class="sheet-currency-input" />
          </td>
          <td>
            <input type="text" name="attr_pc_total" placeholder="ex: 0 PC" class="sheet-currency-input" />
          </td>
        </tr>
        
        <!-- Valeurs calculées (si formules de dés) -->
        <tr class="sheet-currency-calculated">
          <td>
            <span class="sheet-calc-label">Valeur calculée :</span>
            <span name="attr_pg_calculated" class="sheet-calc-value">0</span>
          </td>
          <td>
            <span class="sheet-calc-label">Valeur calculée :</span>
            <span name="attr_pgi_calculated" class="sheet-calc-value">0</span>
          </td>
          <td>
            <span class="sheet-calc-label">Valeur calculée :</span>
            <span name="attr_pc_calculated" class="sheet-calc-value">0</span>
          </td>
        </tr>
        
        <!-- Contrôles de transaction -->
        <tr class="sheet-currency-controls">
          <td>
            <div class="sheet-transaction-control">
              <input type="number" name="attr_pg_transaction_amount" placeholder="Montant" class="sheet-transaction-input" min="0" />
              <div class="sheet-transaction-buttons">
                <button type="action" name="act_pg_add" class="sheet-transaction-btn add">&#10133;</button>
                <button type="action" name="act_pg_subtract" class="sheet-transaction-btn subtract">&#10134;</button>
              </div>
            </div>
          </td>
          <td>
            <div class="sheet-transaction-control">
              <input type="number" name="attr_pgi_transaction_amount" placeholder="Montant" class="sheet-transaction-input" min="0" />
              <div class="sheet-transaction-buttons">
                <button type="action" name="act_pgi_add" class="sheet-transaction-btn add">&#10133;</button>
                <button type="action" name="act_pgi_subtract" class="sheet-transaction-btn subtract">&#10134;</button>
              </div>
            </div>
          </td>
          <td>
            <div class="sheet-transaction-control">
              <input type="number" name="attr_pc_transaction_amount" placeholder="Montant" class="sheet-transaction-input" min="0" />
              <div class="sheet-transaction-buttons">
                <button type="action" name="act_pc_add" class="sheet-transaction-btn add">&#10133;</button>
                <button type="action" name="act_pc_subtract" class="sheet-transaction-btn subtract">&#10134;</button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Monnaies personnalisées (repeating) - DÉPLIABLES -->
  <details class="sheet-custom-currencies">
    <summary class="sheet-custom-currencies-title">&#127970; Monnaies Personnalisées</summary>
    
    <fieldset class="repeating_currency_custom">
      <div class="sheet-custom-currency-block">
        <table class="sheet-currency-table custom">
          <thead>
            <tr>
              <th>
                <input type="text" name="attr_custom_currency_1_name" placeholder="Nom monnaie 1" class="sheet-currency-name-input" />
              </th>
              <th>
                <input type="text" name="attr_custom_currency_2_name" placeholder="Nom monnaie 2" class="sheet-currency-name-input" />
              </th>
              <th>
                <input type="text" name="attr_custom_currency_3_name" placeholder="Nom monnaie 3" class="sheet-currency-name-input" />
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Valeurs actuelles seulement -->
            <tr class="sheet-currency-values">
              <td>
                <input type="text" name="attr_custom_currency_1_value" placeholder="Valeur" class="sheet-currency-input" />
              </td>
              <td>
                <input type="text" name="attr_custom_currency_2_value" placeholder="Valeur" class="sheet-currency-input" />
              </td>
              <td>
                <input type="text" name="attr_custom_currency_3_value" placeholder="Valeur" class="sheet-currency-input" />
              </td>
            </tr>
            
            <!-- Taux de change pour monnaies personnalisées seulement -->
            <tr class="sheet-custom-rates">
              <td>
                <div class="sheet-custom-rate">
                  <label>Taux (en PG) :</label>
                  <input type="number" name="attr_custom_1_rate" value="1" min="0.01" step="0.01" class="sheet-rate-input" />
                </div>
              </td>
              <td>
                <div class="sheet-custom-rate">
                  <label>Taux (en PG) :</label>
                  <input type="number" name="attr_custom_2_rate" value="1" min="0.01" step="0.01" class="sheet-rate-input" />
                </div>
              </td>
              <td>
                <div class="sheet-custom-rate">
                  <label>Taux (en PG) :</label>
                  <input type="number" name="attr_custom_3_rate" value="1" min="0.01" step="0.01" class="sheet-rate-input" />
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </fieldset>
  </details>

  <!-- Journal des Transactions intégré - DÉPLIABLE -->
  <details class="sheet-transaction-journal">
    <summary class="sheet-transaction-title">&#128220; Journal des Transactions</summary>
    
    <div class="sheet-transaction-container">
      <div class="sheet-transaction-table-main">
        
        <!-- Header unique et centré -->
        <div class="sheet-transaction-header">
          <span class="sheet-transaction-col-date">Date</span>
          <span class="sheet-transaction-col-gamedate">Date de jeux</span>
          <span class="sheet-transaction-col-type">Type</span>
          <span class="sheet-transaction-col-amount">Montant</span>
          <span class="sheet-transaction-col-desc">Description</span>
        </div>
        
        <!-- Items 1-10 -->
        <div class="sheet-transaction-item" data-index="1">
          <span name="attr_transaction_1_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_1_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 15 Nivôse" />
          <span name="attr_transaction_1_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_1_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_1_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="2">
          <span name="attr_transaction_2_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_2_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 16 Nivôse" />
          <span name="attr_transaction_2_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_2_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_2_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="3">
          <span name="attr_transaction_3_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_3_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 17 Nivôse" />
          <span name="attr_transaction_3_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_3_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_3_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="4">
          <span name="attr_transaction_4_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_4_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 18 Nivôse" />
          <span name="attr_transaction_4_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_4_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_4_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="5">
          <span name="attr_transaction_5_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_5_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 19 Nivôse" />
          <span name="attr_transaction_5_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_5_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_5_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="6">
          <span name="attr_transaction_6_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_6_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 20 Nivôse" />
          <span name="attr_transaction_6_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_6_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_6_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="7">
          <span name="attr_transaction_7_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_7_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 21 Nivôse" />
          <span name="attr_transaction_7_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_7_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_7_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="8">
          <span name="attr_transaction_8_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_8_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 22 Nivôse" />
          <span name="attr_transaction_8_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_8_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_8_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="9">
          <span name="attr_transaction_9_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_9_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 23 Nivôse" />
          <span name="attr_transaction_9_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_9_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_9_desc" class="sheet-transaction-desc">--</span>
        </div>
        
        <div class="sheet-transaction-item" data-index="10">
          <span name="attr_transaction_10_date" class="sheet-transaction-date">--</span>
          <input type="text" name="attr_transaction_10_gamedate" class="sheet-transaction-gamedate" placeholder="Ex: 24 Nivôse" />
          <span name="attr_transaction_10_type" class="sheet-transaction-type">--</span>
          <span name="attr_transaction_10_amount" class="sheet-transaction-amount">--</span>
          <span name="attr_transaction_10_desc" class="sheet-transaction-desc">--</span>
        </div>
        
      </div>
    </div>
    
    <!-- Résumé financier -->
    <div class="sheet-financial-summary">
      <div class="sheet-summary-item">
        <label>Total des revenus (récents) :</label>
        <span name="attr_monthly_income" class="sheet-summary-value income">0 PG</span>
      </div>
      <div class="sheet-summary-item">
        <label>Total des dépenses (récentes) :</label>
        <span name="attr_monthly_expenses" class="sheet-summary-value expenses">0 PG</span>
      </div>
      <div class="sheet-summary-item">
        <label>Balance :</label>
        <span name="attr_monthly_balance" class="sheet-summary-value balance">0 PG</span>
      </div>
      <div class="sheet-summary-actions">
        <button type="action" name="act_clear_transactions" class="sheet-clear-history-btn">
          &#129529; Effacer Historique
        </button>
      </div>
    </div>
  </details>

</details>




    <details class="sheet-dnd-section">
      <summary class="sheet-dnd-header">Réputation des organisations</summary>
      <fieldset class="repeating_reputation">
        <table class="sheet-dnd-table">
          <thead>
            <tr>
              <th>Organisation</th>
              <th>Niveau</th>
              <th>Titre</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" name="attr_organisation_nom" /></td>
              <td><input type="number" name="attr_organisation_rep" min="-50" max="150" /></td>
              <td>
                <select name="attr_organisation_titre">
                  <option value="Infamie">Infamie</option>
                  <option value="Mauvaise réputation">Mauvaise réputation</option>
                  <option value="Inconnue">Inconnue</option>
                  <option value="Connue">Connue</option>
                  <option value="Respecté">Respecté</option>
                  <option value="Influant">Influant</option>
                  <option value="Célèbre">Célèbre</option>
                  <option value="Stars">Stars</option>
                </select>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <label><strong>Faits marquants :</strong></label>
                <textarea name="attr_organisation_faits" rows="2"></textarea>
              </td>
            </tr>
          </tbody>
        </table>
      </fieldset>
    </details>

    <!-- Blessures Handicapantes -->
    <div class="sheet-box-wrapper">
      <details class="sheet-blessures-block">
        <summary class="sheet-section-title">☠️ Blessures Handicapantes</summary>

        <table class="sheet-blessures-grid">
          <thead>
            <tr>
              <th>FOR</th><th>CST</th><th>DEX</th><th>INT</th>
              <th>SAG</th><th>PER</th><th>CHA</th><th>RESM</th><th>REAC</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <!-- FOR -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_for_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_for_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_for_rouge" /></label>
                <input type="number" name="attr_blessure_for_val" />
              </td>
              <!-- CST -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_cst_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_cst_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_cst_rouge" /></label>
                <input type="number" name="attr_blessure_cst_val" />
              </td>
              <!-- DEX -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_dex_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_dex_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_dex_rouge" /></label>
                <input type="number" name="attr_blessure_dex_val" />
              </td>
              <!-- INT -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_int_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_int_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_int_rouge" /></label>
                <input type="number" name="attr_blessure_int_val" />
              </td>
              <!-- SAG -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_sag_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_sag_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_sag_rouge" /></label>
                <input type="number" name="attr_blessure_sag_val" />
              </td>
              <!-- PER -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_per_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_per_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_per_rouge" /></label>
                <input type="number" name="attr_blessure_per_val" />
              </td>
              <!-- CHA -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_cha_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_cha_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_cha_rouge" /></label>
                <input type="number" name="attr_blessure_cha_val" />
              </td>
              <!-- RESM -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_resm_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_resm_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_resm_rouge" /></label>
                <input type="number" name="attr_blessure_resm_val" />
              </td>
              <!-- REAC -->
              <td>
                <label class="color-toggle jaune"><input type="checkbox" name="attr_reac_jaune" /></label>
                <label class="color-toggle orange"><input type="checkbox" name="attr_reac_orange" /></label>
                <label class="color-toggle rouge"><input type="checkbox" name="attr_reac_rouge" /></label>
                <input type="number" name="attr_blessure_reac_val" />
              </td>
            </tr>
          </tbody>
        </table>
      </details>
    </div>

    <!-- Causes des Blessures Handicapantes -->
    <div class="sheet-box-wrapper">
      <details class="sheet-causes-blessures-block">
        <summary class="sheet-section-title">&#9888;&#65039;Causes des Blessures Handicapantes</summary>

        <table class="sheet-causes-blessures-grid">
          <tr>
            <td>FOR</td>
            <td><input type="text" name="attr_cause_for" /></td>
            <td>CST</td>
            <td><input type="text" name="attr_cause_cst" /></td>
            <td>DEX</td>
            <td><input type="text" name="attr_cause_dex" /></td>
          </tr>
          <tr>
            <td>INT</td>
            <td><input type="text" name="attr_cause_int" /></td>
            <td>SAG</td>
            <td><input type="text" name="attr_cause_sag" /></td>
            <td>PER</td>
            <td><input type="text" name="attr_cause_per" /></td>
          </tr>
          <tr>
            <td>CHA</td>
            <td><input type="text" name="attr_cause_cha" /></td>
            <td>RESM</td>
            <td><input type="text" name="attr_cause_resm" /></td>
            <td>REAC</td>
            <td><input type="text" name="attr_cause_reac" /></td>
          </tr>
          <tr>
            <td colspan="6">
              <label><strong>Autre :</strong></label>
              <textarea name="attr_effets_blessures" placeholder="Effets globaux ou notes supplémentaires..."></textarea>
            </td>
          </tr>
        </table>
      </details>
    </div>
  </div> <!-- Fin sheet-box-wrapper -->
</div> 
<!-- Fin sheet-tab-content sheet-profils -->


<div class="sheet-tab-content sheet-combat">

  <!-- ==================== SECTION REPOS ==================== -->
  <details class="sheet-combat-v2-wrapper">
    <summary class="sheet-combat-v2-title">
      Repos
    </summary>
    
    <table class="sheet-combat-v2-repos-table">
      <thead>
        <tr>
          <th class="sheet-combat-v2-repos-header-action">Action</th>
          <th class="sheet-combat-v2-repos-header-bonus">Bonus/Malus</th>
          <th class="sheet-combat-v2-repos-header-launch">Lancer</th>
        </tr>
      </thead>
      <tbody>
        <!-- Repos Court -->
        <tr class="sheet-combat-v2-repos-row">
          <td class="sheet-combat-v2-repos-action">
            <div class="sheet-combat-v2-repos-action-label">Repos Court</div>
          </td>
          <td class="sheet-combat-v2-repos-bonus">
            <div class="sheet-combat-v2-repos-input-container">
              <input type="number" name="attr_bonus_repos_court" value="0" class="sheet-combat-v2-repos-input" />
            </div>
          </td>
          <td class="sheet-combat-v2-repos-launch">
            <button type="action" name="act_repos_court" class="sheet-combat-v2-repos-btn">
              <span class="sheet-combat-v2-repos-icon">&#128564;</span>
            </button>
          </td>
        </tr>
        <!-- Repos Long -->
        <tr class="sheet-combat-v2-repos-row">
          <td class="sheet-combat-v2-repos-action">
            <div class="sheet-combat-v2-repos-action-label">Repos Long</div>
          </td>
          <td class="sheet-combat-v2-repos-bonus">
            <div class="sheet-combat-v2-repos-input-container">
              <input type="number" name="attr_bonus_repos_long" value="0" class="sheet-combat-v2-repos-input" />
            </div>
          </td>
          <td class="sheet-combat-v2-repos-launch">
            <button type="action" name="act_repos_long" class="sheet-combat-v2-repos-btn">
              <span class="sheet-combat-v2-repos-icon">&#127962;</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- QUALITÉ DU REPOS AMÉLIORÉE -->
    <div class="sheet-combat-v2-repos-quality">
      <h4 class="sheet-combat-v2-repos-quality-title">Qualité du repos</h4>
      <div class="sheet-combat-v2-repos-quality-container">
        <div class="sheet-combat-v2-repos-options">
          <label class="sheet-combat-v2-repos-option sheet-combat-v2-repos-execrable">
            <input type="radio" name="attr_qualite_repos" value="-20" />
            <span class="sheet-combat-v2-repos-radio"></span>
            <span class="sheet-combat-v2-repos-text">Repos exécrable</span>
            <span class="sheet-combat-v2-repos-value">(-20)</span>
          </label>
          
          <label class="sheet-combat-v2-repos-option sheet-combat-v2-repos-mauvais">
            <input type="radio" name="attr_qualite_repos" value="-10" />
            <span class="sheet-combat-v2-repos-radio"></span>
            <span class="sheet-combat-v2-repos-text">Mauvais repos</span>
            <span class="sheet-combat-v2-repos-value">(-10)</span>
          </label>
          
          <label class="sheet-combat-v2-repos-option sheet-combat-v2-repos-normal">
            <input type="radio" name="attr_qualite_repos" value="0" checked />
            <span class="sheet-combat-v2-repos-radio"></span>
            <span class="sheet-combat-v2-repos-text">Repos normal</span>
            <span class="sheet-combat-v2-repos-value">(0)</span>
          </label>
          
          <label class="sheet-combat-v2-repos-option sheet-combat-v2-repos-bon">
            <input type="radio" name="attr_qualite_repos" value="10" />
            <span class="sheet-combat-v2-repos-radio"></span>
            <span class="sheet-combat-v2-repos-text">Bon repos</span>
            <span class="sheet-combat-v2-repos-value">(+10)</span>
          </label>
          
          <label class="sheet-combat-v2-repos-option sheet-combat-v2-repos-apaisant">
            <input type="radio" name="attr_qualite_repos" value="20" />
            <span class="sheet-combat-v2-repos-radio"></span>
            <span class="sheet-combat-v2-repos-text">Repos apaisant</span>
            <span class="sheet-combat-v2-repos-value">(+20)</span>
          </label>
        </div>
      </div>
    </div>
  </details>
  <!-- FIN SECTION REPOS -->





<!-- ================================================================= -->
<!-- ================= SECTION JETS D'ATTAQUE ET DÉFENSE ============ -->
<!-- ================================================================= -->

<div class="sheet-combat-v2-wrapper">
  <details>
    <summary class="sheet-combat-v2-title">
      &#9876;&#65039; Jets d'Attaque et de Défense
    </summary>

    <div class="sheet-combat-v2-content">
      <!-- TABLEAU REPEATING SECTION -->
      <fieldset class="repeating_attackdefense">
        <table class="sheet-combat-v2-attack-table">
          <thead>
            <tr>
              <th class="sheet-combat-v2-header-nom">Nom</th>
              <th class="sheet-combat-v2-header-base">Base jet</th>
              <th class="sheet-combat-v2-header-bonus-mod">Bonus de mods</th>
              <th class="sheet-combat-v2-header-bonus-classe">Bonus de classe d'arme</th>
              <th class="sheet-combat-v2-header-bonus-pct">Bonus %</th>
              <th class="sheet-combat-v2-header-nature">Nature</th>
              <th class="sheet-combat-v2-header-type">Type</th>
              <th class="sheet-combat-v2-header-dice">Dés</th>
            </tr>
          </thead>
          <tbody>
            <tr class="sheet-combat-v2-attack-row">
              
              <!-- NOM -->
              <td class="sheet-combat-v2-cell-nom">
                <input type="text" 
                       name="attr_attack_nom" 
                       placeholder="Nom de l'attaque"
                       class="sheet-combat-v2-input-nom" />
              </td>

              <!-- BASE JET -->
              <td class="sheet-combat-v2-cell-base">
                <input type="text" 
                       name="attr_attack_base_jet" 
                       placeholder="1d20"
                       class="sheet-combat-v2-input-base" />
              </td>

              <!-- BONUS DE MODS -->
              <td class="sheet-combat-v2-cell-bonus-mod">
                <input type="text" 
                       name="attr_attack_bonus_mod" 
                       placeholder="+0 ou 2d6"
                       class="sheet-combat-v2-input-bonus" />
              </td>

              <!-- BONUS DE CLASSE D'ARME -->
              <td class="sheet-combat-v2-cell-bonus-classe">
                <input type="text"
                       name="attr_attack_bonus_classe"
                       placeholder="0 ou 1d2+1"
                       class="sheet-combat-v2-input-bonus" />
              </td>

              <!-- BONUS EN POURCENTAGE -->
              <td class="sheet-combat-v2-cell-bonus-pct">
                <div class="sheet-combat-v2-bonus-pct-container">
                  <input type="number" 
                         name="attr_attack_bonus_pct" 
                         value="0"
                         min="-100"
                         max="100"
                         class="sheet-combat-v2-input-bonus-pct" />
                  <span class="sheet-combat-v2-pct-symbol">%</span>
                </div>
              </td>

              <!-- NATURE (champ texte) -->
              <td class="sheet-combat-v2-cell-nature">
                <input type="text" 
                       name="attr_attack_nature" 
                       placeholder="Ex: Physique"
                       class="sheet-combat-v2-input-nature" />
              </td>

              <!-- TYPE (champ texte) -->
              <td class="sheet-combat-v2-cell-type">
                <input type="text" 
                       name="attr_attack_type" 
                       placeholder="Ex: Mêlée"
                       class="sheet-combat-v2-input-type" />
              </td>

              <!-- BOUTON LANCER DE DÉS -->
<td class="sheet-combat-v2-cell-dice">
  <button type="roll" 
          name="roll_attack_defense"
          class="sheet-combat-v2-dice-btn"
          value="&{template:attack} {{name=@{attack_nom}}} {{character=@{character_name}}} {{attack=[[floor(((@{attack_base_jet}) + (@{attack_bonus_mod}) + (@{attack_bonus_classe})) * (100 + @{attack_bonus_pct})/100)]]}} {{nature=@{attack_nature}}} {{type=@{attack_type}}} {{bonus_pct=@{attack_bonus_pct}%}}"
          title="Lancer l'attaque">
    <span class="sheet-combat-v2-dice-icon">&#127922;</span>
  </button>
</td>

            </tr>

            <!-- SECTION INFOS DÉPLIABLE -->
            <tr class="sheet-combat-v2-infos-row">
              <td colspan="8" class="sheet-combat-v2-infos-td">
                <details class="sheet-combat-v2-infos-details">
                  <summary class="sheet-combat-v2-infos-summary">
                    &#128203; Infos
                  </summary>
                  
                  <div class="sheet-combat-v2-infos-content">
                    
                    <!-- MOD UTILISÉ -->
                    <div class="sheet-combat-v2-info-field">
                      <label class="sheet-combat-v2-info-label">&#127919; Mod utilisé :</label>
                      <select name="attr_attack_mod_source" class="sheet-combat-v2-info-input">
                        <option value="">— choisir —</option>
                        <option value="att_phy">Mod d'attaque physique</option>
                        <option value="att_mag">Mod d'attaque magique</option>
                        <option value="def_phy">Mod de défense physique</option>
                        <option value="def_mag">Mod de défense magique</option>
                      </select>
                    </div>

                    <!-- NIVEAU DE CLASSE D'ARME -->
                    <div class="sheet-combat-v2-info-field">
                      <label class="sheet-combat-v2-info-label">&#9876;&#65039; Niveau de classe d'arme :</label>
                      <select name="attr_attack_classe_niveau" class="sheet-combat-v2-info-input">
                        <option value="">— aucun —</option>
                        <option value="E">E (0)</option>
                        <option value="D">D (1d2+1)</option>
                        <option value="C">C (2d2+2)</option>
                        <option value="B">B (3d3+3)</option>
                        <option value="A">A (4d3+4)</option>
                        <option value="S">S (5d3+5)</option>
                        <option value="SS">SS (6d4+5)</option>
                        <option value="SSS">SSS (7d4+5)</option>
                      </select>
                    </div>

                  </div>
                </details>
              </td>
            </tr>

          </tbody>
        </table>
      </fieldset>
      
    </div>
  </details>
</div>



<!-- ==================== BONUS DES MODS ==================== -->
<details class="sheet-combat-v2-wrapper">
  <summary class="sheet-combat-v2-title">
    Bonus des mods
  </summary>
  
  <div class="sheet-combat-v2-bonus-grid">
    <div class="sheet-combat-v2-bonus-container-centered">
      
      <!-- SECTION DÉFENSE -->
      <div class="sheet-combat-v2-bonus-section-defense">
        <div class="sheet-combat-v2-bonus-section-title">Défense</div>
        
        <!-- Défense Physique -->
        <div class="sheet-combat-v2-bonus-stat-row">
          <div class="sheet-combat-v2-bonus-stat-label">Déf Physique</div>
          <div class="sheet-combat-v2-bonus-stat-input">
            <input type="number" name="attr_cst_mod" value="0" />
          </div>
          <div class="sheet-combat-v2-bonus-stat-total">
            <!-- attribut réel + affichage -->
            <input type="hidden" name="attr_def_phy_total" value="0" />
            <span name="attr_def_phy_total">0</span>
          </div>
        </div>
        
        <!-- Défense Magique -->
        <div class="sheet-combat-v2-bonus-stat-row">
          <div class="sheet-combat-v2-bonus-stat-label">Déf Magique</div>
          <div class="sheet-combat-v2-bonus-stat-input">
            <input type="number" name="attr_sag_mod" value="0" />
          </div>
          <div class="sheet-combat-v2-bonus-stat-total">
            <input type="hidden" name="attr_def_mag_total" value="0" />
            <span name="attr_def_mag_total">0</span>
          </div>
        </div>

        <!-- Détails Défense Physique -->
        <details class="sheet-combat-v2-bonus-details">
          <summary class="sheet-combat-v2-bonus-details-title">
            Détails Déf Physique
          </summary>
          <div class="sheet-combat-v2-bonus-details-content">
            <div class="sheet-combat-v2-bonus-notes">
              <div class="sheet-combat-v2-bonus-notes-label">Notes générales</div>
              <textarea name="attr_note_bonus_def_phy" class="sheet-combat-v2-bonus-notes-textarea" placeholder="Notes sur la défense physique..."></textarea>
            </div>
            <div class="sheet-combat-v2-bonus-details-grid">
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 1</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_phy_bonus1_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_phy_bonus1_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 2</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_phy_bonus2_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_phy_bonus2_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 3</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_phy_bonus3_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_phy_bonus3_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 4</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_phy_bonus4_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_phy_bonus4_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
            </div>
          </div>
        </details>

        <!-- Détails Défense Magique -->
        <details class="sheet-combat-v2-bonus-details">
          <summary class="sheet-combat-v2-bonus-details-title">
            Détails Déf Magique
          </summary>
          <div class="sheet-combat-v2-bonus-details-content">
            <div class="sheet-combat-v2-bonus-notes">
              <div class="sheet-combat-v2-bonus-notes-label">Notes générales</div>
              <textarea name="attr_note_bonus_def_mag" class="sheet-combat-v2-bonus-notes-textarea" placeholder="Notes sur la défense magique..."></textarea>
            </div>
            <div class="sheet-combat-v2-bonus-details-grid">
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 1</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_mag_bonus1_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_mag_bonus1_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 2</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_mag_bonus2_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_mag_bonus2_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 3</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_mag_bonus3_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_mag_bonus3_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 4</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_def_mag_bonus4_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_def_mag_bonus4_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
            </div>
          </div>
        </details>
      </div>
      
      <!-- SECTION ATTAQUE -->
      <div class="sheet-combat-v2-bonus-section-attack">
        <div class="sheet-combat-v2-bonus-section-title">Attaque</div>
        
        <!-- Attaque Physique -->
        <div class="sheet-combat-v2-bonus-stat-row">
          <div class="sheet-combat-v2-bonus-stat-label">Att Physique</div>
          <div class="sheet-combat-v2-bonus-stat-input">
            <input type="number" name="attr_for_mod" value="0" />
          </div>
          <div class="sheet-combat-v2-bonus-stat-total">
            <input type="hidden" name="attr_att_phy_total" value="0" />
            <span name="attr_att_phy_total">0</span>
          </div>
        </div>
        
        <!-- Attaque Magique -->
        <div class="sheet-combat-v2-bonus-stat-row">
          <div class="sheet-combat-v2-bonus-stat-label">Att Magique</div>
          <div class="sheet-combat-v2-bonus-stat-input">
            <input type="number" name="attr_int_mod" value="0" />
          </div>
          <div class="sheet-combat-v2-bonus-stat-total">
            <input type="hidden" name="attr_att_mag_total" value="0" />
            <span name="attr_att_mag_total">0</span>
          </div>
        </div>

        <!-- Détails Attaque Physique -->
        <details class="sheet-combat-v2-bonus-details">
          <summary class="sheet-combat-v2-bonus-details-title">
            Détails Att Physique
          </summary>
          <div class="sheet-combat-v2-bonus-details-content">
            <div class="sheet-combat-v2-bonus-notes">
              <div class="sheet-combat-v2-bonus-notes-label">Notes générales</div>
              <textarea name="attr_note_bonus_att_phy" class="sheet-combat-v2-bonus-notes-textarea" placeholder="Notes sur l'attaque physique..."></textarea>
            </div>
            <div class="sheet-combat-v2-bonus-details-grid">
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 1</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_phy_bonus1_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_phy_bonus1_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 2</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_phy_bonus2_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_phy_bonus2_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 3</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_phy_bonus3_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_phy_bonus3_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 4</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_phy_bonus4_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_phy_bonus4_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
            </div>
          </div>
        </details>

        <!-- Détails Attaque Magique -->
        <details class="sheet-combat-v2-bonus-details">
          <summary class="sheet-combat-v2-bonus-details-title">
            Détails Att Magique
          </summary>
          <div class="sheet-combat-v2-bonus-details-content">
            <div class="sheet-combat-v2-bonus-notes">
              <div class="sheet-combat-v2-bonus-notes-label">Notes générales</div>
              <textarea name="attr_note_bonus_att_mag" class="sheet-combat-v2-bonus-notes-textarea" placeholder="Notes sur l'attaque magique..."></textarea>
            </div>
            <div class="sheet-combat-v2-bonus-details-grid">
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 1</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_mag_bonus1_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_mag_bonus1_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 2</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_mag_bonus2_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_mag_bonus2_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 3</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_mag_bonus3_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_mag_bonus3_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
              <div class="sheet-combat-v2-bonus-detail-card">
                <div class="sheet-combat-v2-bonus-detail-header">Bonus 4</div>
                <div class="sheet-combat-v2-bonus-detail-content">
                  <input type="text" name="attr_att_mag_bonus4_name" placeholder="Nom du bonus" class="sheet-combat-v2-bonus-detail-name" />
                  <input type="number" name="attr_att_mag_bonus4_val" placeholder="0" class="sheet-combat-v2-bonus-detail-value" />
                </div>
              </div>
            </div>
          </div>
        </details>
      </div>

    </div>
  </div>
</details>
<!-- FIN BONUS DES MODS -->






  <!-- ==================== TECHNIQUES DE COMBAT ==================== -->
  <div class="sheet-combat-v2-techniques-container">
    <details class="sheet-combat-v2-techniques-wrapper">
      <summary class="sheet-combat-v2-title">
        Statistique de Techniques de Combat
      </summary>
      
      <fieldset class="repeating_techniquecombat">
        <details class="sheet-combat-v2-technique">
          <summary class="sheet-combat-v2-technique-title">
            <input type="text" name="attr_technique_nom" placeholder="Ex : Coup de griffe" class="sheet-combat-v2-technique-name" />
            <button type="roll" title="Lancer l'attaque" class="sheet-combat-v2-technique-btn"
              value="&{template:macroTechniquecorps} {{nom=@{technique_nom}}} {{type=attaque}} {{jet=[[ ((@{technique_formule} * @{mod_mult}) + @{bonus_degats}) * (1 + (@{technique_multpourcent} / 100)) ]]}} {{nature=@{technique_nature}}} {{effet=@{technique_effet}}}">
              &#128737;
            </button>
          </summary>
          
          <div class="sheet-combat-v2-technique-details">
            <table class="sheet-combat-v2-technique-table">
              <thead>
                <tr>
                  <th>Formule Brute</th>
                  <th>Formule Ajustée</th>
                  <th>× Mult.</th>
                  <th>+ Dégâts</th>
                  <th>% Altération</th>
                  <th>Élément</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input type="text" name="attr_technique_off" placeholder="Ex : 2d6+1" /></td>
                  <td><input type="text" name="attr_technique_formule" placeholder="Ex : 2d6+4" /></td>
                  <td><input type="number" name="attr_mod_mult" value="1" class="sheet-combat-v2-short-input" /></td>
                  <td><input type="text" name="attr_bonus_degats" placeholder="Ex : 1d8" /></td>
                  <td><input type="number" name="attr_technique_multpourcent" value="0" class="sheet-combat-v2-short-input" /></td>
                  <td>
                    <input type="text" name="attr_technique_nature" placeholder="Ex : Feu, Eau, Physique..." class="sheet-combat-v2-nature-input" />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="sheet-combat-v2-effet-section">
            <div class="sheet-combat-v2-effet-title">Effets</div>
            <div class="sheet-combat-v2-effet-content">
              <textarea name="attr_technique_effet" placeholder="Effets particuliers de l'attaque…" class="sheet-combat-v2-effet-textarea"></textarea>
            </div>
          </div>
        </details>
      </fieldset>
    </details>
  </div>
  <!-- FIN TECHNIQUES DE COMBAT -->




<!-- ==================== CLASSE D'ARME ==================== -->
<details class="sheet-combat-v2-wrapper">
  <summary class="sheet-combat-v2-title">
    Classe d'arme
  </summary>

  <fieldset class="repeating_arme">
    <div class="sheet-combat-v2-weapon-columns">
      
      <!-- ============ COLONNE 1 ============ -->
      <div class="sheet-combat-v2-weapon-card">
        <!-- Sélection du type d'arme -->
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Type d'arme</label>
          <select name="attr_weapon_type1" class="sheet-combat-v2-weapon-select-type">
            <option value="">-- Sélectionner --</option>
            <option value="Arc">Arc</option>
            <option value="Arbalète">Arbalète (rechargement lent)</option>
            <option value="Arme à feu (1M)">Arme à feu (1M)</option>
            <option value="Arme à feu (2M)">Arme à feu (2M)</option>
            <option value="Bâton">Bâton (hampe simple)</option>
            <option value="Chakram">Chakram</option>
            <option value="Dague">Dague</option>
            <option value="Dague de lancé">Dague de lancé</option>
            <option value="Épée (1M)">Épée (1M)</option>
            <option value="Épée à deux mains">Épée à deux mains (espadon)</option>
            <option value="Faux de combat">Faux de combat</option>
            <option value="Faux-cie">Faux-cie</option>
            <option value="Fouet">Fouet</option>
            <option value="Griffes de combat">Griffes de combat (armes de poing)</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Hache (1M)">Hache (1M)</option>
            <option value="Hache de guerre (2M)">Hache de guerre (2M)</option>
            <option value="Hache de lancé">Hache de lancé</option>
            <option value="Javelot">Javelot</option>
            <option value="Lame Jumelle">Lame Jumelle</option>
            <option value="Lance">Lance</option>
            <option value="Marteau (1M)">Marteau (1M)</option>
            <option value="Marteau de guerre (2M)">Marteau de guerre (2M)</option>
            <option value="Masse / Gourdin (1M)">Masse / Gourdin (1M)</option>
            <option value="Rapière">Rapière</option>
            <option value="Sabre">Sabre</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <!-- flag d'affichage (auto) -->
        <input type="hidden" name="attr_weapon_custom1_show" value="0" />

        <!-- Champ personnalisé -->
        <div class="sheet-combat-v2-weapon-field sheet-weapon-custom-field">
          <label class="sheet-combat-v2-weapon-label">Nom personnalisé</label>
          <input type="text" name="attr_weapon_custom1" placeholder="Nom de l'arme personnalisée" class="sheet-combat-v2-weapon-input" />
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Classe</label>
          <select name="attr_weapon_classe1" class="sheet-combat-v2-weapon-select">
            <option value="E">E</option>
            <option value="D">D</option>
            <option value="C">C</option>
            <option value="B">B</option>
            <option value="A">A</option>
            <option value="S">S</option>
            <option value="SS">SS</option>
            <option value="SSS">SSS</option>
          </select>
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Bonus</label>
          <input type="text" name="attr_weapon_bonus1" placeholder="Bonus" class="sheet-combat-v2-weapon-input" readonly />
        </div>
      </div>

      <!-- ============ COLONNE 2 ============ -->
      <div class="sheet-combat-v2-weapon-card">
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Type d'arme</label>
          <select name="attr_weapon_type2" class="sheet-combat-v2-weapon-select-type">
            <option value="">-- Sélectionner --</option>
            <option value="Arc">Arc</option>
            <option value="Arbalète">Arbalète (rechargement lent)</option>
            <option value="Arme à feu (1M)">Arme à feu (1M)</option>
            <option value="Arme à feu (2M)">Arme à feu (2M)</option>
            <option value="Bâton">Bâton (hampe simple)</option>
            <option value="Chakram">Chakram</option>
            <option value="Dague">Dague</option>
            <option value="Dague de lancé">Dague de lancé</option>
            <option value="Épée (1M)">Épée (1M)</option>
            <option value="Épée à deux mains">Épée à deux mains (espadon)</option>
            <option value="Faux de combat">Faux de combat</option>
            <option value="Faux-cie">Faux-cie</option>
            <option value="Fouet">Fouet</option>
            <option value="Griffes de combat">Griffes de combat (armes de poing)</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Hache (1M)">Hache (1M)</option>
            <option value="Hache de guerre (2M)">Hache de guerre (2M)</option>
            <option value="Hache de lancé">Hache de lancé</option>
            <option value="Javelot">Javelot</option>
            <option value="Lame Jumelle">Lame Jumelle</option>
            <option value="Lance">Lance</option>
            <option value="Marteau (1M)">Marteau (1M)</option>
            <option value="Marteau de guerre (2M)">Marteau de guerre (2M)</option>
            <option value="Masse / Gourdin (1M)">Masse / Gourdin (1M)</option>
            <option value="Rapière">Rapière</option>
            <option value="Sabre">Sabre</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <input type="hidden" name="attr_weapon_custom2_show" value="0" />

        <div class="sheet-combat-v2-weapon-field sheet-weapon-custom-field">
          <label class="sheet-combat-v2-weapon-label">Nom personnalisé</label>
          <input type="text" name="attr_weapon_custom2" placeholder="Nom de l'arme personnalisée" class="sheet-combat-v2-weapon-input" />
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Classe</label>
          <select name="attr_weapon_classe2" class="sheet-combat-v2-weapon-select">
            <option value="E">E</option>
            <option value="D">D</option>
            <option value="C">C</option>
            <option value="B">B</option>
            <option value="A">A</option>
            <option value="S">S</option>
            <option value="SS">SS</option>
            <option value="SSS">SSS</option>
          </select>
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Bonus</label>
          <input type="text" name="attr_weapon_bonus2" placeholder="Bonus" class="sheet-combat-v2-weapon-input" readonly />
        </div>
      </div>

      <!-- ============ COLONNE 3 ============ -->
      <div class="sheet-combat-v2-weapon-card">
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Type d'arme</label>
          <select name="attr_weapon_type3" class="sheet-combat-v2-weapon-select-type">
            <option value="">-- Sélectionner --</option>
            <option value="Arc">Arc</option>
            <option value="Arbalète">Arbalète (rechargement lent)</option>
            <option value="Arme à feu (1M)">Arme à feu (1M)</option>
            <option value="Arme à feu (2M)">Arme à feu (2M)</option>
            <option value="Bâton">Bâton (hampe simple)</option>
            <option value="Chakram">Chakram</option>
            <option value="Dague">Dague</option>
            <option value="Dague de lancé">Dague de lancé</option>
            <option value="Épée (1M)">Épée (1M)</option>
            <option value="Épée à deux mains">Épée à deux mains (espadon)</option>
            <option value="Faux de combat">Faux de combat</option>
            <option value="Faux-cie">Faux-cie</option>
            <option value="Fouet">Fouet</option>
            <option value="Griffes de combat">Griffes de combat (armes de poing)</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Hache (1M)">Hache (1M)</option>
            <option value="Hache de guerre (2M)">Hache de guerre (2M)</option>
            <option value="Hache de lancé">Hache de lancé</option>
            <option value="Javelot">Javelot</option>
            <option value="Lame Jumelle">Lame Jumelle</option>
            <option value="Lance">Lance</option>
            <option value="Marteau (1M)">Marteau (1M)</option>
            <option value="Marteau de guerre (2M)">Marteau de guerre (2M)</option>
            <option value="Masse / Gourdin (1M)">Masse / Gourdin (1M)</option>
            <option value="Rapière">Rapière</option>
            <option value="Sabre">Sabre</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <input type="hidden" name="attr_weapon_custom3_show" value="0" />

        <div class="sheet-combat-v2-weapon-field sheet-weapon-custom-field">
          <label class="sheet-combat-v2-weapon-label">Nom personnalisé</label>
          <input type="text" name="attr_weapon_custom3" placeholder="Nom de l'arme personnalisée" class="sheet-combat-v2-weapon-input" />
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Classe</label>
          <select name="attr_weapon_classe3" class="sheet-combat-v2-weapon-select">
            <option value="E">E</option>
            <option value="D">D</option>
            <option value="C">C</option>
            <option value="B">B</option>
            <option value="A">A</option>
            <option value="S">S</option>
            <option value="SS">SS</option>
            <option value="SSS">SSS</option>
          </select>
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Bonus</label>
          <input type="text" name="attr_weapon_bonus3" placeholder="Bonus" class="sheet-combat-v2-weapon-input" readonly />
        </div>
      </div>

      <!-- ============ COLONNE 4 ============ -->
      <div class="sheet-combat-v2-weapon-card">
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Type d'arme</label>
          <select name="attr_weapon_type4" class="sheet-combat-v2-weapon-select-type">
            <option value="">-- Sélectionner --</option>
            <option value="Arc">Arc</option>
            <option value="Arbalète">Arbalète (rechargement lent)</option>
            <option value="Arme à feu (1M)">Arme à feu (1M)</option>
            <option value="Arme à feu (2M)">Arme à feu (2M)</option>
            <option value="Bâton">Bâton (hampe simple)</option>
            <option value="Chakram">Chakram</option>
            <option value="Dague">Dague</option>
            <option value="Dague de lancé">Dague de lancé</option>
            <option value="Épée (1M)">Épée (1M)</option>
            <option value="Épée à deux mains">Épée à deux mains (espadon)</option>
            <option value="Faux de combat">Faux de combat</option>
            <option value="Faux-cie">Faux-cie</option>
            <option value="Fouet">Fouet</option>
            <option value="Griffes de combat">Griffes de combat (armes de poing)</option>
            <option value="Hallebarde">Hallebarde</option>
            <option value="Hache (1M)">Hache (1M)</option>
            <option value="Hache de guerre (2M)">Hache de guerre (2M)</option>
            <option value="Hache de lancé">Hache de lancé</option>
            <option value="Javelot">Javelot</option>
            <option value="Lame Jumelle">Lame Jumelle</option>
            <option value="Lance">Lance</option>
            <option value="Marteau (1M)">Marteau (1M)</option>
            <option value="Marteau de guerre (2M)">Marteau de guerre (2M)</option>
            <option value="Masse / Gourdin (1M)">Masse / Gourdin (1M)</option>
            <option value="Rapière">Rapière</option>
            <option value="Sabre">Sabre</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <input type="hidden" name="attr_weapon_custom4_show" value="0" />

        <div class="sheet-combat-v2-weapon-field sheet-weapon-custom-field">
          <label class="sheet-combat-v2-weapon-label">Nom personnalisé</label>
          <input type="text" name="attr_weapon_custom4" placeholder="Nom de l'arme personnalisée" class="sheet-combat-v2-weapon-input" />
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Classe</label>
          <select name="attr_weapon_classe4" class="sheet-combat-v2-weapon-select">
            <option value="E">E</option>
            <option value="D">D</option>
            <option value="C">C</option>
            <option value="B">B</option>
            <option value="A">A</option>
            <option value="S">S</option>
            <option value="SS">SS</option>
            <option value="SSS">SSS</option>
          </select>
        </div>
        
        <div class="sheet-combat-v2-weapon-field">
          <label class="sheet-combat-v2-weapon-label">Bonus</label>
          <input type="text" name="attr_weapon_bonus4" placeholder="Bonus" class="sheet-combat-v2-weapon-input" readonly />
        </div>
      </div>
      
    </div>
  </fieldset>
</details>
<!-- FIN CLASSE D'ARME -->









<!-- ==================== RÉSISTANCES MAGIQUES STYLISÉES ==================== -->
<details class="sheet-combat-v2-wrapper">
  <summary class="sheet-combat-v2-title">
    Résistances magiques du personnage
  </summary>

  <!-- SECTION D'AIDE (cachée par défaut) -->
  <div class="sheet-aide-section sheet-resistance-aide">
    <div class="sheet-resistance-aide-content">
      <div class="sheet-resistance-aide-icon">&#128161;</div>
      <div class="sheet-resistance-aide-text">
        <strong>Comment ça marche ?</strong><br>
        Le calcul est simple : après le jet de résistance magique du lanceur, on prend les dégâts restants et on les ajuste — à la baisse ou à la hausse — selon le pourcentage de résistance (ou de faiblesse) correspondant à la nature de l'attaque.
      </div>
    </div>
  </div>

  <table class="sheet-combat-v2-resistances-table">
    <!-- LIGNE 1 : 4 résistances -->
    <tr>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-magie-pure">
        <div class="sheet-combat-v2-res-label">Magie pure</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_magie_pure" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-feu">
        <div class="sheet-combat-v2-res-label">Feu</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_feu" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-eau">
        <div class="sheet-combat-v2-res-label">Eau</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_eau" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-vent">
        <div class="sheet-combat-v2-res-label">Vent</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_vent" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
    </tr>
    
    <!-- LIGNE 2 : 4 résistances -->
    <tr>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-terre">
        <div class="sheet-combat-v2-res-label">Terre</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_terre" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-foudre">
        <div class="sheet-combat-v2-res-label">Foudre</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_foudre" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-glace">
        <div class="sheet-combat-v2-res-label">Glace</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_glace" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-sang">
        <div class="sheet-combat-v2-res-label">Sang (infection)</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_sang_infection" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
    </tr>
    
    <!-- LIGNE 3 : 4 résistances -->
    <tr>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-toxine">
        <div class="sheet-combat-v2-res-label">Toxine</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_toxine" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-ombre">
        <div class="sheet-combat-v2-res-label">Ombre</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_ombre" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-tenebres">
        <div class="sheet-combat-v2-res-label">Ténèbres</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_tenebres" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-lumiere">
        <div class="sheet-combat-v2-res-label">Lumière</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_lumiere" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
    </tr>
    
    <!-- LIGNE 4 : 4 résistances -->
    <tr>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-vegetation">
        <div class="sheet-combat-v2-res-label">Végétation</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_vegetation" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-necrotique">
        <div class="sheet-combat-v2-res-label">Nécrotique</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_necrotique" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-corruption">
        <div class="sheet-combat-v2-res-label">Corruption</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_corruption" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
      <td class="sheet-combat-v2-res-cell sheet-combat-v2-res-abysses">
        <div class="sheet-combat-v2-res-label">Abysses</div>
        <div class="sheet-combat-v2-res-input-wrap">
          <input type="number" class="sheet-combat-v2-res-input" name="attr_res_abysses" min="-100" max="100" value="0" />
          <span>%</span>
        </div>
      </td>
    </tr>
  </table>
</details>
<!-- FIN RÉSISTANCES MAGIQUES -->

</div>
<!-- FIN sheet-tab-content sheet-combat -->


<div class="sheet-tab-content sheet-talent">
  <div class="sheet-tlnt-section">

    <!-- ENCADREMENT GENERAL : ATOUT + TALENT -->
    <div class="sheet-tlnt-box-wrapper">

      <!-- ATOUT DE L'ÊTRE -->
      <details class="sheet-tlnt-atout-wrapper">
        <summary class="sheet-tlnt-section-title">Atout de l'être</summary>
        <fieldset class="repeating_atouts">
          <div class="sheet-tlnt-triple-column-row">
            <div class="sheet-tlnt-col">
              <details>
                <summary><input type="text" name="attr_atout_nom1" placeholder="Nom de l'atout" /></summary>
                <textarea name="attr_atout_effet1" placeholder="Effet de l'atout..." class="sheet-tlnt-effet-zone"></textarea>
              </details>
            </div>
            <div class="sheet-tlnt-col">
              <details>
                <summary><input type="text" name="attr_atout_nom2" placeholder="Nom de l'atout" /></summary>
                <textarea name="attr_atout_effet2" placeholder="Effet de l'atout..." class="sheet-tlnt-effet-zone"></textarea>
              </details>
            </div>
            <div class="sheet-tlnt-col">
              <details>
                <summary><input type="text" name="attr_atout_nom3" placeholder="Nom de l'atout" /></summary>
                <textarea name="attr_atout_effet3" placeholder="Effet de l'atout..." class="sheet-tlnt-effet-zone"></textarea>
              </details>
            </div>
          </div>
        </fieldset>
      </details>

      <!-- TALENTS -->
      <details class="sheet-tlnt-talents-wrapper">
        <summary class="sheet-tlnt-section-title">Talents</summary>
        <fieldset class="repeating_talents">
          <div class="sheet-tlnt-triple-column-row">
            <div class="sheet-tlnt-col">
              <details>
                <summary><input type="text" name="attr_talent_nom1" placeholder="Nom du talent" /></summary>
                <textarea name="attr_talent_effet1" placeholder="Effet du talent..." class="sheet-tlnt-effet-zone"></textarea>
              </details>
            </div>
            <div class="sheet-tlnt-col">
              <details>
                <summary><input type="text" name="attr_talent_nom2" placeholder="Nom du talent" /></summary>
                <textarea name="attr_talent_effet2" placeholder="Effet du talent..." class="sheet-tlnt-effet-zone"></textarea>
              </details>
            </div>
            <div class="sheet-tlnt-col">
              <details>
                <summary><input type="text" name="attr_talent_nom3" placeholder="Nom du talent" /></summary>
                <textarea name="attr_talent_effet3" placeholder="Effet du talent..." class="sheet-tlnt-effet-zone"></textarea>
              </details>
            </div>
          </div>
        </fieldset>
      </details>

    </div> <!-- Fin encadrement atout + talent -->

    <!-- ENCADREMENT TALENTS UNIQUES -->
    <div class="sheet-tlnt-box-wrapper">
      <div class="sheet-tlnt-talents-uniques-wrapper">

        <!-- TALENTS DE COMBAT -->
        <details class="sheet-tlnt-combat-talents-wrapper">
          <summary class="sheet-tlnt-section-title">Talents de combat Brave</summary>
          <fieldset class="repeating_talentcombat">
            <details class="sheet-tlnt-talent-block sheet-tlnt-aura-combat">
              <summary class="sheet-tlnt-talent-summary">
                <div class="sheet-tlnt-talent-header">
                  <input type="text" name="attr_talent_combat_nom" placeholder="Nom du talent" />
                  
                  <button type="roll" class="sheet-tlnt-activate-btn"
                    value="&{template:talent} {{nom=@{talent_combat_nom}}} {{type=@{talent_combat_type}}} {{effet=@{talent_combat_effet}}} {{categorie=Combat}}">
                    Activer
                  </button>
                  
                  <select name="attr_talent_combat_type" class="sheet-tlnt-talent-type">
                    <option value="Passif">Passif</option>
                    <option value="Actif">Actif</option>
                  </select>
                </div>
              </summary>
              <div class="sheet-tlnt-talent-content">
                <textarea name="attr_talent_combat_effet" class="sheet-tlnt-effet-zone" placeholder="Effet du talent de combat..."></textarea>
              </div>
            </details>
          </fieldset>
        </details>

        <!-- TALENTS HORS COMBAT -->
        <details class="sheet-tlnt-horscombat-talents-wrapper">
          <summary class="sheet-tlnt-section-title">Talents hors combat Brave</summary>
          <fieldset class="repeating_talenthorscombat">
            <details class="sheet-tlnt-talent-block sheet-tlnt-talent-givre">
              <summary class="sheet-tlnt-talent-summary">
                <div class="sheet-tlnt-talent-header">
                  <input type="text" name="attr_talent_horscombat_nom" placeholder="Nom du talent" />
                  
                  <button type="roll" class="sheet-tlnt-activate-btn"
                    value="&{template:talent} {{nom=@{talent_horscombat_nom}}} {{type=@{talent_horscombat_type}}} {{effet=@{talent_horscombat_effet}}} {{categorie=Hors Combat}}">
                    Activer
                  </button>
                  
                  <select name="attr_talent_horscombat_type" class="sheet-tlnt-talent-type">
                    <option value="Passif">Passif</option>
                    <option value="Actif">Actif</option>
                  </select>
                </div>
              </summary>
              <div class="sheet-tlnt-talent-content">
                <textarea name="attr_talent_horscombat_effet" class="sheet-tlnt-effet-zone" placeholder="Effet du talent hors combat..."></textarea>
              </div>
            </details>
          </fieldset>
        </details>

        <!-- TALENTS SPÉCIAUX -->
        <details class="sheet-tlnt-special-talents-wrapper">
          <summary class="sheet-tlnt-section-title">Talents spéciaux</summary>
          <fieldset class="repeating_talentspecial">
            <details class="sheet-tlnt-talent-block">
              <summary class="sheet-tlnt-talent-summary">
                <div class="sheet-tlnt-talent-header">
                  <input type="text" name="attr_talent_special_nom" placeholder="Nom du talent" />
                  
                  <button type="roll" class="sheet-tlnt-activate-btn"
                    value="&{template:talent} {{nom=@{talent_special_nom}}} {{type=@{talent_special_type}}} {{effet=@{talent_special_effet}}} {{categorie=Spécial}}">
                    Activer
                  </button>
                  
                  <select name="attr_talent_special_type" class="sheet-tlnt-talent-type">
                    <option value="Passif">Passif</option>
                    <option value="Actif">Actif</option>
                  </select>
                </div>
              </summary>
              <div class="sheet-tlnt-talent-content">
                <textarea name="attr_talent_special_effet" class="sheet-tlnt-effet-zone" placeholder="Effet du talent spécial..."></textarea>
              </div>
            </details>
          </fieldset>
        </details>

      </div> <!-- Fin talents uniques -->
    </div> <!-- Fin encadrement talents uniques -->

  </div> <!-- Fin talent-section -->
</div> <!-- Fin tab-content -->


<div class="sheet-tab-content sheet-sort">
  <div class="sheet-box-wrapper"> <!-- ENCADREMENT GLOBAL -->

    <div class="sheet-capacite-sorts">
        
        
<!-- CAPACITÉ RESTRUCTURÉE SIMPLIFIÉE -->
<details class="sheet-capacite-bloc">
  <summary class="sheet-section-title">Capacité</summary>
        <fieldset class="repeating_capacites">
  <!-- SUPPRESSION DU FIELDSET REPEATING -->
  <details class="sheet-capacite-block">
    <summary class="sheet-capacite-summary">
      <div class="sheet-capacite-header">
        <input type="text" name="attr_capacite_nom" placeholder="Nom de la capacité" />
        <!-- BOUTON CORRIGÉ: nom correspondant exactement au sheet worker -->
           
  <!-- NOUVEAU : Badge de niveau -->
  <div class="sheet-niveau-badge">
    <div class="sheet-niveau-label">Niv.</div>
    <select name="attr_capacite_niveau" class="sheet-niveau-select">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <div class="sheet-niveau-arrow">▼</div>
  </div>
  
        <button type="action" name="act_jet" class="sheet-capacite-roll-btn">
  &#127922;
</button>
      </div>
    </summary>
    
    <!-- SECTION JETS DÉPLIABLE -->
    <details class="sheet-jets-block">
      <summary class="sheet-jets-title">&#127922; Jets</summary>
      <div class="sheet-jets-container">
        
        
        <!-- EN-TÊTES DU TABLEAU -->
        <div class="sheet-jets-header">
          <div class="sheet-jet-col">Nom de l'Effet</div>
          <div class="sheet-jet-col">Formule du Jet</div>
          <div class="sheet-jet-col">Bonus de %</div>
          <div class="sheet-jet-col">Type</div>
          <div class="sheet-jet-col">Nature</div>
          <div class="sheet-jet-col">Actif</div>
        </div>
        
        <!-- LIGNE PRINCIPALE FIXE -->
    <div class="sheet-jet-row sheet-jet-principal" data-jet="principal">
      <div class="sheet-jet-col">
        <input type="text" name="attr_capacite_nom_effet_principal" placeholder="Effet principal" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_capacite_formula_principal" placeholder="ex: 2d6+4" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_capacite_bonus_principal" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_capacite_type_principal" placeholder="ex: Dégâts" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_capacite_nature_principal" placeholder="ex: Feu" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_capacite_actif_principal" value="1" checked />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR LE JET PRINCIPAL -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_capacite_color_type_principal" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_capacite_color_nature_principal" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNES SECONDAIRES -->
        
        <!-- LIGNE 1 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet1">
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet1_nom_effet" placeholder="Effet secondaire 1" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet1_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_jet1_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet1_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet1_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_jet1_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET1 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet1_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet1_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 2 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet2">
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet2_nom_effet" placeholder="Effet secondaire 2" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet2_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_jet2_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet2_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet2_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_jet2_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET2 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet2_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet2_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 3 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet3">
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet3_nom_effet" placeholder="Effet secondaire 3" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet3_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_jet3_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet3_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet3_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_jet3_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET3 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet3_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet3_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 4 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet4">
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet4_nom_effet" placeholder="Effet secondaire 4" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet4_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_jet4_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet4_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet4_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_jet4_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET4 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet4_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet4_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 5 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet5">
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet5_nom_effet" placeholder="Effet secondaire 5" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet5_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_jet5_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet5_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_jet5_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_jet5_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET5 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet5_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_jet5_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
      </div>
    </details>

    <!-- SECTION COÛTS ET EFFETS UNIFIÉE -->
    <details class="sheet-couts-effets-block">
      <summary class="sheet-couts-effets-title">&#9889; Coûts et Effets</summary>
      <div class="sheet-couts-effets-container">
        
<!-- SECTION COÛTS D'ACTIVATION DÉPLIABLE -->
<details class="sheet-sous-section">
  <summary class="sheet-sous-titre">
    <span class="sheet-sous-icone">&#128176;</span>
    <span class="sheet-sous-label">Coûts d'Activation</span>
  </summary>
  <div class="sheet-cout-grid">
    
    <!-- POINTS DE VIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#10084;</div>
      <label class="sheet-cout-title">Points de Vie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_capacite_cout_pv" min="0" value="0" /></td>
            <td><input type="number" name="attr_capacite_cout_pv_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS DE MAGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128302;</div>
      <label class="sheet-cout-title">Points de Magie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_capacite_cout_pm" min="0" value="0" /></td>
            <td><input type="number" name="attr_capacite_cout_pm_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS D'ÉNERGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#9889;</div>
      <label class="sheet-cout-title">Points d'Énergie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_capacite_cout_pe" min="0" value="0" /></td>
            <td><input type="number" name="attr_capacite_cout_pe_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- AUTRE COÛT -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128295;</div>
      <label class="sheet-cout-title">Autre Coût</label>
      <input type="text" name="attr_capacite_cout_autre" placeholder="ex: 2 tours, 1 composant..." class="sheet-cout-autre-input" />
    </div>
    
  </div>
</details>
        <!-- BLOC EFFET ET ALTÉRATION -->
        <details class="sheet-effet-alteration-block">
          <summary class="sheet-effet-alteration-title">&#128128; Effet et Altération</summary>
          <div class="sheet-effet-alteration-container">
            
            <div class="sheet-alterations-grid">
              
              <!-- SAIGNEMENT -->
              <label class="sheet-alteration-item" data-alteration="saignement">
                <input type="checkbox" name="attr_saignement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#129656; Saignement</div>
                  <input type="number" name="attr_saignement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_saignement_des" placeholder="ex: 2d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EMPOISONNEMENT -->
              <label class="sheet-alteration-item" data-alteration="empoisonnement">
                <input type="checkbox" name="attr_empoisonnement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#9762; Empoisonnement</div>
                  <input type="number" name="attr_empoisonnement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_empoisonnement_des" placeholder="ex: 1d6" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- DESTRUCTION D'ARMURE -->
              <label class="sheet-alteration-item" data-alteration="destruction_armure">
                <input type="checkbox" name="attr_destruction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Destruction d'armure</div>
                  <input type="number" name="attr_destruction_armure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- BRÛLURE -->
              <label class="sheet-alteration-item" data-alteration="brulure">
                <input type="checkbox" name="attr_brulure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Brûlure</div>
                  <input type="number" name="attr_brulure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- FRAGILISATION -->
              <label class="sheet-alteration-item" data-alteration="fragilisation">
                <input type="checkbox" name="attr_fragilisation_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fragilisation</div>
                  <input type="number" name="attr_fragilisation_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- CORROSION -->
              <label class="sheet-alteration-item" data-alteration="corrosion">
                <input type="checkbox" name="attr_corrosion_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Corrosion</div>
                  <input type="number" name="attr_corrosion_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_corrosion_des" placeholder="ex: 1d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- RÉDUCTION D'ARMURE AVEC SÉLECTION -->
              <label class="sheet-alteration-item sheet-alteration-double" data-alteration="reduction_armure">
                <input type="checkbox" name="attr_reduction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128737; Réduction d'armure</div>
                  <input type="number" name="attr_reduction_armure_valeur" placeholder="Valeur" min="0" />
                  <div class="sheet-custom-select">
                    <select name="attr_reduction_armure_type">
                      <option value="globale">Réduction d'armure globale</option>
                      <option value="legere">Réduction d'armure légère</option>
                      <option value="moyenne">Réduction d'armure moyenne</option>
                      <option value="lourde">Réduction d'armure lourde</option>
                    </select>
                    <div class="sheet-select-arrow">&#9660;</div>
                  </div>
                </div>
              </label>
              
              <!-- ATTAQUE SOURNOISE -->
              <label class="sheet-alteration-item" data-alteration="attaque_sournoise">
                <input type="checkbox" name="attr_attaque_sournoise_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128298; Attaque sournoise</div>
                </div>
              </label>
              
              <!-- FRACTURE -->
              <label class="sheet-alteration-item" data-alteration="fracture">
                <input type="checkbox" name="attr_fracture_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fracture</div>
                  <input type="number" name="attr_fracture_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_fracture_des" placeholder="ex: 1d8" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EFFET LIBRE -->
              <label class="sheet-alteration-item" data-alteration="effet_libre">
                <input type="checkbox" name="attr_effet_libre_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">
                    <input type="text" name="attr_effet_libre_nom" placeholder="Nom de l'effet" class="sheet-effet-libre-nom" />
                  </div>
                  <input type="number" name="attr_effet_libre_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
            </div>
            
          </div>
        </details>

        <!-- SECTION EFFETS CÔTE À CÔTE -->
<div class="sheet-effets-row">
  <!-- EFFET DE LA CAPACITÉ (GAUCHE) -->
  <details class="sheet-sous-section sheet-effet-gauche">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">&#128220;</span>
      <span class="sheet-sous-label">Effet de la Capacité</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_capacite_effet" placeholder="Décrire l'effet de la capacité en détail..."></textarea>
    </div>
  </details>
  
  <!-- EFFET ACTIF (DROITE) -->
  <details class="sheet-sous-section sheet-effet-droite">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">⚡</span>
      <span class="sheet-sous-label">Effet Actif</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_capacite_effet_actif" placeholder="Décrire l'effet actif de la capacité (apparaîtra dans le template)..."></textarea>
    </div>
  </details>
</div>

      </div>
    </details>
    
  </details>
  </fieldset>
</details>








    
      
      
      
      
      
      
      
      
      
      
      


    <!-- SORT RESTRUCTURÉ SIMPLIFIÉE -->
<details class="sheet-capacite-bloc">
  <summary class="sheet-section-title">Sort</summary>
        <fieldset class="repeating_sorts">
  <!-- SUPPRESSION DU FIELDSET REPEATING -->
  <details class="sheet-capacite-block">
    <summary class="sheet-capacite-summary">
      <div class="sheet-capacite-header">
        <input type="text" name="attr_sort_nom" placeholder="Nom du sort" />
        <!-- BOUTON CORRIGÉ: nom correspondant exactement au sheet worker -->
           
  <!-- NOUVEAU : Badge de niveau -->
  <div class="sheet-niveau-badge">
    <div class="sheet-niveau-label">Niv.</div>
    <select name="attr_capacite_niveau" class="sheet-niveau-select">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <div class="sheet-niveau-arrow">▼</div>
  </div>
        <button type="action" name="act_jet" class="sheet-capacite-roll-btn">
  &#127922;
</button>
      </div>
    </summary>
    
    <!-- SECTION JETS DÉPLIABLE -->
    <details class="sheet-jets-block">
      <summary class="sheet-jets-title">&#127922; Jets</summary>
      <div class="sheet-jets-container">
        
        
        <!-- EN-TÊTES DU TABLEAU -->
        <div class="sheet-jets-header">
          <div class="sheet-jet-col">Nom de l'Effet</div>
          <div class="sheet-jet-col">Formule du Jet</div>
          <div class="sheet-jet-col">Bonus de %</div>
          <div class="sheet-jet-col">Type</div>
          <div class="sheet-jet-col">Nature</div>
          <div class="sheet-jet-col">Actif</div>
        </div>
        
        <!-- LIGNE PRINCIPALE FIXE -->
    <div class="sheet-jet-row sheet-jet-principal" data-jet="principal">
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_nom_effet_principal" placeholder="Effet principal" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_formula_principal" placeholder="ex: 2d6+4" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_sort_bonus_principal" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_type_principal" placeholder="ex: Dégâts" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_nature_principal" placeholder="ex: Feu" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_sort_actif_principal" value="1" checked />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR LE JET PRINCIPAL -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_color_type_principal" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_color_nature_principal" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNES SECONDAIRES -->
        
        <!-- LIGNE 1 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet1">
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet1_nom_effet" placeholder="Effet secondaire 1" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet1_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_sort_jet1_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet1_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet1_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_sort_jet1_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET1 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet1_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet1_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 2 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet2">
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet2_nom_effet" placeholder="Effet secondaire 2" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet2_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_sort_jet2_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet2_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet2_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_sort_jet2_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET2 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet2_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet2_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 3 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet3">
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet3_nom_effet" placeholder="Effet secondaire 3" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet3_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_sort_jet3_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet3_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet3_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_sort_jet3_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET3 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet3_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet3_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 4 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet4">
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet4_nom_effet" placeholder="Effet secondaire 4" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet4_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_sort_jet4_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet4_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet4_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_sort_jet4_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET4 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet4_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet4_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 5 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet5">
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet5_nom_effet" placeholder="Effet secondaire 5" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet5_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_sort_jet5_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet5_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_sort_jet5_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_sort_jet5_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET5 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet5_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_sort_jet5_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
      </div>
    </details>

    <!-- SECTION COÛTS ET EFFETS UNIFIÉE -->
    <details class="sheet-couts-effets-block">
      <summary class="sheet-couts-effets-title">&#9889; Coûts et Effets</summary>
      <div class="sheet-couts-effets-container">
        
<!-- SECTION COÛTS D'ACTIVATION DÉPLIABLE POUR SORT -->
<details class="sheet-sous-section">
  <summary class="sheet-sous-titre">
    <span class="sheet-sous-icone">&#128176;</span>
    <span class="sheet-sous-label">Coûts d'Activation</span>
  </summary>
  <div class="sheet-cout-grid">
    
    <!-- POINTS DE VIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#10084;</div>
      <label class="sheet-cout-title">Points de Vie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_sort_cout_pv" min="0" value="0" /></td>
            <td><input type="number" name="attr_sort_cout_pv_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS DE MAGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128302;</div>
      <label class="sheet-cout-title">Points de Magie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_sort_cout_pm" min="0" value="0" /></td>
            <td><input type="number" name="attr_sort_cout_pm_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS D'ÉNERGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#9889;</div>
      <label class="sheet-cout-title">Points d'Énergie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_sort_cout_pe" min="0" value="0" /></td>
            <td><input type="number" name="attr_sort_cout_pe_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- AUTRE COÛT -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128295;</div>
      <label class="sheet-cout-title">Autre Coût</label>
      <input type="text" name="attr_sort_cout_autre" placeholder="ex: 2 tours, 1 composant..." class="sheet-cout-autre-input" />
    </div>
    
  </div>
</details>

        <!-- BLOC EFFET ET ALTÉRATION -->
        <details class="sheet-effet-alteration-block">
          <summary class="sheet-effet-alteration-title">&#128128; Effet et Altération</summary>
          <div class="sheet-effet-alteration-container">
            
            <div class="sheet-alterations-grid">
              
              <!-- SAIGNEMENT -->
              <label class="sheet-alteration-item" data-alteration="saignement">
                <input type="checkbox" name="attr_sort_saignement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#129656; Saignement</div>
                  <input type="number" name="attr_sort_saignement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_sort_saignement_des" placeholder="ex: 2d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EMPOISONNEMENT -->
              <label class="sheet-alteration-item" data-alteration="empoisonnement">
                <input type="checkbox" name="attr_sort_empoisonnement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#9762; Empoisonnement</div>
                  <input type="number" name="attr_sort_empoisonnement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_sort_empoisonnement_des" placeholder="ex: 1d6" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- DESTRUCTION D'ARMURE -->
              <label class="sheet-alteration-item" data-alteration="destruction_armure">
                <input type="checkbox" name="attr_sort_destruction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Destruction d'armure</div>
                  <input type="number" name="attr_sort_destruction_armure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- BRÛLURE -->
              <label class="sheet-alteration-item" data-alteration="brulure">
                <input type="checkbox" name="attr_sort_brulure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Brûlure</div>
                  <input type="number" name="attr_sort_brulure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- FRAGILISATION -->
              <label class="sheet-alteration-item" data-alteration="fragilisation">
                <input type="checkbox" name="attr_sort_fragilisation_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fragilisation</div>
                  <input type="number" name="attr_sort_fragilisation_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- CORROSION -->
              <label class="sheet-alteration-item" data-alteration="corrosion">
                <input type="checkbox" name="attr_sort_corrosion_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Corrosion</div>
                  <input type="number" name="attr_sort_corrosion_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_sort_corrosion_des" placeholder="ex: 1d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- RÉDUCTION D'ARMURE AVEC SÉLECTION -->
              <label class="sheet-alteration-item sheet-alteration-double" data-alteration="reduction_armure">
                <input type="checkbox" name="attr_sort_reduction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128737; Réduction d'armure</div>
                  <input type="number" name="attr_sort_reduction_armure_valeur" placeholder="Valeur" min="0" />
                  <div class="sheet-custom-select">
                    <select name="attr_sort_reduction_armure_type">
                      <option value="globale">Réduction d'armure globale</option>
                      <option value="legere">Réduction d'armure légère</option>
                      <option value="moyenne">Réduction d'armure moyenne</option>
                      <option value="lourde">Réduction d'armure lourde</option>
                      
                    </select>
                    <div class="sheet-select-arrow">&#9660;</div>
                  </div>
                </div>
              </label>
              
              <!-- ATTAQUE SOURNOISE -->
              <label class="sheet-alteration-item" data-alteration="attaque_sournoise">
                <input type="checkbox" name="attr_sort_attaque_sournoise_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128298; Attaque sournoise</div>
                </div>
              </label>
              
              <!-- FRACTURE -->
              <label class="sheet-alteration-item" data-alteration="fracture">
                <input type="checkbox" name="attr_sort_fracture_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fracture</div>
                  <input type="number" name="attr_sort_fracture_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_sort_fracture_des" placeholder="ex: 1d8" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EFFET LIBRE -->
              <label class="sheet-alteration-item" data-alteration="effet_libre">
                <input type="checkbox" name="attr_sort_effet_libre_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">
                    <input type="text" name="attr_sort_effet_libre_nom" placeholder="Nom de l'effet" class="sheet-effet-libre-nom" />
                  </div>
                  <input type="number" name="attr_sort_effet_libre_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
            </div>
            
          </div>
        </details>

       <!-- SECTION EFFETS CÔTE À CÔTE POUR SORT -->
<div class="sheet-effets-row">
  <!-- EFFET DU SORT (GAUCHE) -->
  <details class="sheet-sous-section sheet-effet-gauche">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">&#128220;</span>
      <span class="sheet-sous-label">Effet du Sort</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_sort_effet" placeholder="Décrire l'effet du sort en détail..."></textarea>
    </div>
  </details>
  
  <!-- EFFET ACTIF (DROITE) -->
  <details class="sheet-sous-section sheet-effet-droite">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">⚡</span>
      <span class="sheet-sous-label">Effet Actif</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_sort_effet_actif" placeholder="Décrire l'effet actif du sort (apparaîtra dans le template)..."></textarea>
    </div>
  </details>
</div>

      </div>
    </details>
    
  </details>
  </fieldset>
</details>








    <!-- SKILL D'OBJET -->
      <!-- SKILL D'OBJET RESTRUCTURÉ SIMPLIFIÉE -->
<details class="sheet-capacite-bloc">
  <summary class="sheet-section-title">Skill d'Objet</summary>
        <fieldset class="repeating_skillobjet">
  <!-- SUPPRESSION DU FIELDSET REPEATING -->
  <details class="sheet-capacite-block">
    <summary class="sheet-capacite-summary">
      <div class="sheet-capacite-header">
        <input type="text" name="attr_skill_objet_nom" placeholder="Nom de la compétence d'objet" />
        <!-- BOUTON CORRIGÉ: nom correspondant exactement au sheet worker -->
           
  <!-- NOUVEAU : Badge de niveau -->
  <div class="sheet-niveau-badge">
    <div class="sheet-niveau-label">Niv.</div>
    <select name="attr_capacite_niveau" class="sheet-niveau-select">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <div class="sheet-niveau-arrow">▼</div>
  </div>
        <button type="action" name="act_jet" class="sheet-capacite-roll-btn">

  &#127922;
</button>
      </div>
    </summary>
    
    <!-- SECTION JETS DÉPLIABLE -->
    <details class="sheet-jets-block">
      <summary class="sheet-jets-title">&#127922; Jets</summary>
      <div class="sheet-jets-container">
        
        
        <!-- EN-TÊTES DU TABLEAU -->
        <div class="sheet-jets-header">
          <div class="sheet-jet-col">Nom de l'Effet</div>
          <div class="sheet-jet-col">Formule du Jet</div>
          <div class="sheet-jet-col">Bonus de %</div>
          <div class="sheet-jet-col">Type</div>
          <div class="sheet-jet-col">Nature</div>
          <div class="sheet-jet-col">Actif</div>
        </div>
        
        <!-- LIGNE PRINCIPALE FIXE -->
    <div class="sheet-jet-row sheet-jet-principal" data-jet="principal">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_nom_effet_principal" placeholder="Effet principal" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_formula_principal" placeholder="ex: 2d6+4" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_objet_bonus_principal" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_type_principal" placeholder="ex: Dégâts" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_nature_principal" placeholder="ex: Feu" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_objet_actif_principal" value="1" checked />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR LE JET PRINCIPAL -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_color_type_principal" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_color_nature_principal" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNES SECONDAIRES -->
        
        <!-- LIGNE 1 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet1">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet1_nom_effet" placeholder="Effet secondaire 1" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet1_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_objet_jet1_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet1_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet1_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_objet_jet1_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET1 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet1_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet1_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 2 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet2">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet2_nom_effet" placeholder="Effet secondaire 2" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet2_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_objet_jet2_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet2_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet2_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_objet_jet2_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET2 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet2_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet2_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 3 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet3">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet3_nom_effet" placeholder="Effet secondaire 3" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet3_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_objet_jet3_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet3_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet3_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_objet_jet3_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET3 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet3_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet3_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 4 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet4">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet4_nom_effet" placeholder="Effet secondaire 4" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet4_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_objet_jet4_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet4_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet4_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_objet_jet4_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET4 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet4_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet4_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 5 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet5">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet5_nom_effet" placeholder="Effet secondaire 5" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet5_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_objet_jet5_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet5_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_objet_jet5_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_objet_jet5_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET5 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet5_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_objet_jet5_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
      </div>
    </details>

    <!-- SECTION COÛTS ET EFFETS UNIFIÉE -->
    <details class="sheet-couts-effets-block">
      <summary class="sheet-couts-effets-title">&#9889; Coûts et Effets</summary>
      <div class="sheet-couts-effets-container">
        
<!-- SECTION COÛTS D'ACTIVATION DÉPLIABLE POUR SKILL D'OBJET -->
<details class="sheet-sous-section">
  <summary class="sheet-sous-titre">
    <span class="sheet-sous-icone">&#128176;</span>
    <span class="sheet-sous-label">Coûts d'Activation</span>
  </summary>
  <div class="sheet-cout-grid">
    
    <!-- POINTS DE VIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#10084;</div>
      <label class="sheet-cout-title">Points de Vie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_skill_objet_cout_pv" min="0" value="0" /></td>
            <td><input type="number" name="attr_skill_objet_cout_pv_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS DE MAGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128302;</div>
      <label class="sheet-cout-title">Points de Magie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_skill_objet_cout_pm" min="0" value="0" /></td>
            <td><input type="number" name="attr_skill_objet_cout_pm_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS D'ÉNERGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#9889;</div>
      <label class="sheet-cout-title">Points d'Énergie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_skill_objet_cout_pe" min="0" value="0" /></td>
            <td><input type="number" name="attr_skill_objet_cout_pe_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- AUTRE COÛT -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128295;</div>
      <label class="sheet-cout-title">Autre Coût</label>
      <input type="text" name="attr_skill_objet_cout_autre" placeholder="ex: 2 tours, 1 composant..." class="sheet-cout-autre-input" />
    </div>
    
  </div>
</details>

        <!-- BLOC EFFET ET ALTÉRATION -->
        <details class="sheet-effet-alteration-block">
          <summary class="sheet-effet-alteration-title">&#128128; Effet et Altération</summary>
          <div class="sheet-effet-alteration-container">
            
            <div class="sheet-alterations-grid">
              
              <!-- SAIGNEMENT -->
              <label class="sheet-alteration-item" data-alteration="saignement">
                <input type="checkbox" name="attr_skill_objet_saignement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#129656; Saignement</div>
                  <input type="number" name="attr_skill_objet_saignement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_objet_saignement_des" placeholder="ex: 2d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EMPOISONNEMENT -->
              <label class="sheet-alteration-item" data-alteration="empoisonnement">
                <input type="checkbox" name="attr_skill_objet_empoisonnement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#9762; Empoisonnement</div>
                  <input type="number" name="attr_skill_objet_empoisonnement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_objet_empoisonnement_des" placeholder="ex: 1d6" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- DESTRUCTION D'ARMURE -->
              <label class="sheet-alteration-item" data-alteration="destruction_armure">
                <input type="checkbox" name="attr_skill_objet_destruction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Destruction d'armure</div>
                  <input type="number" name="attr_skill_objet_destruction_armure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- BRÛLURE -->
              <label class="sheet-alteration-item" data-alteration="brulure">
                <input type="checkbox" name="attr_skill_objet_brulure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Brûlure</div>
                  <input type="number" name="attr_skill_objet_brulure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- FRAGILISATION -->
              <label class="sheet-alteration-item" data-alteration="fragilisation">
                <input type="checkbox" name="attr_skill_objet_fragilisation_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fragilisation</div>
                  <input type="number" name="attr_skill_objet_fragilisation_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- CORROSION -->
              <label class="sheet-alteration-item" data-alteration="corrosion">
                <input type="checkbox" name="attr_skill_objet_corrosion_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Corrosion</div>
                  <input type="number" name="attr_skill_objet_corrosion_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_objet_corrosion_des" placeholder="ex: 1d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- RÉDUCTION D'ARMURE AVEC SÉLECTION -->
              <label class="sheet-alteration-item sheet-alteration-double" data-alteration="reduction_armure">
                <input type="checkbox" name="attr_skill_objet_reduction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128737; Réduction d'armure</div>
                  <input type="number" name="attr_skill_objet_reduction_armure_valeur" placeholder="Valeur" min="0" />
                  <div class="sheet-custom-select">
                    <select name="attr_skill_objet_reduction_armure_type">
                      <option value="globale">Réduction d'armure globale</option>
                      <option value="legere">Réduction d'armure légère</option>
                      <option value="moyenne">Réduction d'armure moyenne</option>
                      <option value="lourde">Réduction d'armure lourde</option>
                      
                    </select>
                    <div class="sheet-select-arrow">&#9660;</div>
                  </div>
                </div>
              </label>
              
              <!-- ATTAQUE SOURNOISE -->
              <label class="sheet-alteration-item" data-alteration="attaque_sournoise">
                <input type="checkbox" name="attr_skill_objet_attaque_sournoise_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128298; Attaque sournoise</div>
                </div>
              </label>
              
              <!-- FRACTURE -->
              <label class="sheet-alteration-item" data-alteration="fracture">
                <input type="checkbox" name="attr_skill_objet_fracture_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fracture</div>
                  <input type="number" name="attr_skill_objet_fracture_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_objet_fracture_des" placeholder="ex: 1d8" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EFFET LIBRE -->
              <label class="sheet-alteration-item" data-alteration="effet_libre">
                <input type="checkbox" name="attr_skill_objet_effet_libre_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">
                    <input type="text" name="attr_skill_objet_effet_libre_nom" placeholder="Nom de l'effet" class="sheet-effet-libre-nom" />
                  </div>
                  <input type="number" name="attr_skill_objet_effet_libre_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
            </div>
            
          </div>
        </details>

        <!-- SECTION EFFETS CÔTE À CÔTE POUR SKILL OBJET -->
<div class="sheet-effets-row">
  <!-- EFFET DE LA COMPÉTENCE D'OBJET (GAUCHE) -->
  <details class="sheet-sous-section sheet-effet-gauche">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">&#128220;</span>
      <span class="sheet-sous-label">Effet de la Compétence d'Objet</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_skill_objet_effet" placeholder="Décrire l'effet de la compétence d'objet en détail..."></textarea>
    </div>
  </details>
  
  <!-- EFFET ACTIF (DROITE) -->
  <details class="sheet-sous-section sheet-effet-droite">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">⚡</span>
      <span class="sheet-sous-label">Effet Actif</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_skill_objet_effet_actif" placeholder="Décrire l'effet actif de la compétence d'objet (apparaîtra dans le template)..."></textarea>
    </div>
  </details>
</div>

      </div>
    </details>
    
  </details>
  </fieldset>
</details>

   <!-- SKILL SPÉCIAL RESTRUCTURÉ SIMPLIFIÉE -->
<details class="sheet-capacite-bloc">
  <summary class="sheet-section-title">Skill spécial</summary>
        <fieldset class="repeating_skillspecial">
  <!-- SUPPRESSION DU FIELDSET REPEATING -->
  <details class="sheet-capacite-block">
    <summary class="sheet-capacite-summary">
      <div class="sheet-capacite-header">
        <input type="text" name="attr_skill_special_nom" placeholder="Nom de la compétence spéciale" />
        <!-- BOUTON CORRIGÉ: nom correspondant exactement au sheet worker -->
           
  <!-- NOUVEAU : Badge de niveau -->
  <div class="sheet-niveau-badge">
    <div class="sheet-niveau-label">Niv.</div>
    <select name="attr_capacite_niveau" class="sheet-niveau-select">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <div class="sheet-niveau-arrow">▼</div>
  </div>
        <button type="action" name="act_jet" class="sheet-capacite-roll-btn">
  &#127922;
</button>
      </div>
    </summary>
    
    <!-- SECTION JETS DÉPLIABLE -->
    <details class="sheet-jets-block">
      <summary class="sheet-jets-title">&#127922; Jets</summary>
      <div class="sheet-jets-container">
        
        
        <!-- EN-TÊTES DU TABLEAU -->
        <div class="sheet-jets-header">
          <div class="sheet-jet-col">Nom de l'Effet</div>
          <div class="sheet-jet-col">Formule du Jet</div>
          <div class="sheet-jet-col">Bonus de %</div>
          <div class="sheet-jet-col">Type</div>
          <div class="sheet-jet-col">Nature</div>
          <div class="sheet-jet-col">Actif</div>
        </div>
        
        <!-- LIGNE PRINCIPALE FIXE -->
    <div class="sheet-jet-row sheet-jet-principal" data-jet="principal">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_nom_effet_principal" placeholder="Effet principal" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_formula_principal" placeholder="ex: 2d6+4" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_special_bonus_principal" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_type_principal" placeholder="ex: Dégâts" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_nature_principal" placeholder="ex: Feu" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_special_actif_principal" value="1" checked />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR LE JET PRINCIPAL -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_color_type_principal" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_color_nature_principal" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNES SECONDAIRES -->
        
        <!-- LIGNE 1 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet1">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet1_nom_effet" placeholder="Effet secondaire 1" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet1_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_special_jet1_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet1_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet1_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_special_jet1_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET1 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet1_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET1 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet1_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 2 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet2">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet2_nom_effet" placeholder="Effet secondaire 2" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet2_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_special_jet2_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet2_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet2_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_special_jet2_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET2 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet2_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET2 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet2_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 3 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet3">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet3_nom_effet" placeholder="Effet secondaire 3" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet3_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_special_jet3_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet3_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet3_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_special_jet3_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET3 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet3_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET3 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet3_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 4 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet4">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet4_nom_effet" placeholder="Effet secondaire 4" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet4_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_special_jet4_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet4_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet4_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_special_jet4_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET4 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet4_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET4 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet4_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
        <!-- LIGNE 5 -->
    <div class="sheet-jet-row sheet-jet-secondaire" data-jet="jet5">
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet5_nom_effet" placeholder="Effet secondaire 5" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet5_formula" placeholder="ex: 1d4+2" />
      </div>
      <div class="sheet-jet-col">
        <input type="number" name="attr_skill_special_jet5_bonus" placeholder="0" value="0" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet5_type" placeholder="ex: Soin" />
      </div>
      <div class="sheet-jet-col">
        <input type="text" name="attr_skill_special_jet5_nature" placeholder="ex: Magie" />
      </div>
      <div class="sheet-jet-col sheet-checkbox-col">
        <div class="sheet-checkbox-center">
          <label class="sheet-custom-checkbox">
            <input type="checkbox" name="attr_skill_special_jet5_actif" value="1" />
            <span class="sheet-checkmark"></span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- ZONE COULEUR DE TEMPLATE POUR JET5 -->
    <div class="sheet-jet-color-zone">
      <details class="sheet-color-section">
        <summary class="sheet-color-title">
          <span class="sheet-color-icon">&#127912;</span>
          <span class="sheet-color-label">Zone Couleur de Template</span>
        </summary>
        
        <div class="sheet-color-container">
          
          <!-- SÉLECTION COULEUR TYPE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-type-icon">&#128308;</span>
              Couleur Type
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet5_color_type" class="sheet-color-select">
                <option value="blanc_argente">&#9898; Blanc Argenté (Défaut)</option>
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
          <!-- SÉLECTION COULEUR NATURE JET5 -->
          <div class="sheet-color-group">
            <label class="sheet-color-group-label">
              <span class="sheet-color-nature-icon">&#10024;</span>
              Couleur Nature
            </label>
            <div class="sheet-color-select-wrapper">
              <select name="attr_skill_special_jet5_color_nature" class="sheet-color-select">
                <option value="rouge_ecarlate">&#128308; Rouge Écarlate (Défaut)</option>
                <option value="blanc_argente">&#9898; Blanc Argenté</option>
                <option value="orange_incandescent">&#128992; Orange Incandescent</option>
                <option value="bleu_azur_profond">&#128309; Bleu Azur Profond</option>
                <option value="turquoise_clair">&#128994; Turquoise Clair</option>
                <option value="bleu_ciel_mouvant">&#127744; Bleu Ciel Mouvant</option>
                <option value="brun_pierre">&#129704; Brun Pierre</option>
                <option value="ocre_dore">&#128993; Ocre Doré</option>
                <option value="jaune_electrique">&#9889; Jaune Électrique</option>
                <option value="violet_orage">&#9854; Violet Orage</option>
                <option value="vert_tendre_lumineux">&#127795; Vert Tendre Lumineux</option>
                <option value="bleu_glace">&#10052; Bleu Glacé</option>
                <option value="blanc_cristallin">&#10052; Blanc Cristallin</option>
                <option value="rouge_sombre_carmin">&#128312; Rouge Sombre Carmin</option>
                <option value="vert_acide">&#128999; Vert Acide</option>
                <option value="verdatre_maladif">&#129001; Verdâtre Maladif</option>
                <option value="gris_anthracite">&#9899; Gris Anthracite</option>
                <option value="violet_tenebreux">&#128311; Violet Ténébreux</option>
                <option value="noir_absolu_pourpre">&#11035; Noir Absolu Pourpres</option>
                <option value="blanc_pur">&#11039; Blanc Pur</option>
                <option value="dore_rayonnant">&#127775; Doré Rayonnant</option>
                <option value="vert_emeraude_profond">&#128310; Vert Émeraude Profond</option>
                <option value="vert_feuillu">&#127807; Vert Feuillu</option>
              </select>
              <div class="sheet-color-arrow">&#9660;</div>
            </div>
          </div>
          
        </div>
      </details>
    </div>
        
      </div>
    </details>

    <!-- SECTION COÛTS ET EFFETS UNIFIÉE -->
    <details class="sheet-couts-effets-block">
      <summary class="sheet-couts-effets-title">&#9889; Coûts et Effets</summary>
      <div class="sheet-couts-effets-container">
        
<!-- SECTION COÛTS D'ACTIVATION DÉPLIABLE POUR SKILL SPÉCIAL -->
<details class="sheet-sous-section">
  <summary class="sheet-sous-titre">
    <span class="sheet-sous-icone">&#128176;</span>
    <span class="sheet-sous-label">Coûts d'Activation</span>
  </summary>
  <div class="sheet-cout-grid">
    
    <!-- POINTS DE VIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#10084;</div>
      <label class="sheet-cout-title">Points de Vie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_skill_special_cout_pv" min="0" value="0" /></td>
            <td><input type="number" name="attr_skill_special_cout_pv_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS DE MAGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128302;</div>
      <label class="sheet-cout-title">Points de Magie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_skill_special_cout_pm" min="0" value="0" /></td>
            <td><input type="number" name="attr_skill_special_cout_pm_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- POINTS D'ÉNERGIE -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#9889;</div>
      <label class="sheet-cout-title">Points d'Énergie</label>
      <table class="sheet-cout-table">
        <thead>
          <tr>
            <th>Valeur actuelle</th>
            <th>Valeur originale</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="attr_skill_special_cout_pe" min="0" value="0" /></td>
            <td><input type="number" name="attr_skill_special_cout_pe_original" min="0" value="0" /></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- AUTRE COÛT -->
    <div class="sheet-cout-item-large">
      <div class="sheet-cout-icon">&#128295;</div>
      <label class="sheet-cout-title">Autre Coût</label>
      <input type="text" name="attr_skill_special_cout_autre" placeholder="ex: 2 tours, 1 composant..." class="sheet-cout-autre-input" />
    </div>
    
  </div>
</details>

        <!-- BLOC EFFET ET ALTÉRATION -->
        <details class="sheet-effet-alteration-block">
          <summary class="sheet-effet-alteration-title">&#128128; Effet et Altération</summary>
          <div class="sheet-effet-alteration-container">
            
            <div class="sheet-alterations-grid">
              
              <!-- SAIGNEMENT -->
              <label class="sheet-alteration-item" data-alteration="saignement">
                <input type="checkbox" name="attr_skill_special_saignement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#129656; Saignement</div>
                  <input type="number" name="attr_skill_special_saignement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_special_saignement_des" placeholder="ex: 2d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EMPOISONNEMENT -->
              <label class="sheet-alteration-item" data-alteration="empoisonnement">
                <input type="checkbox" name="attr_skill_special_empoisonnement_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#9762; Empoisonnement</div>
                  <input type="number" name="attr_skill_special_empoisonnement_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_special_empoisonnement_des" placeholder="ex: 1d6" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- DESTRUCTION D'ARMURE -->
              <label class="sheet-alteration-item" data-alteration="destruction_armure">
                <input type="checkbox" name="attr_skill_special_destruction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Destruction d'armure</div>
                  <input type="number" name="attr_skill_special_destruction_armure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- BRÛLURE -->
              <label class="sheet-alteration-item" data-alteration="brulure">
                <input type="checkbox" name="attr_skill_special_brulure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128293; Brûlure</div>
                  <input type="number" name="attr_skill_special_brulure_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- FRAGILISATION -->
              <label class="sheet-alteration-item" data-alteration="fragilisation">
                <input type="checkbox" name="attr_skill_special_fragilisation_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fragilisation</div>
                  <input type="number" name="attr_skill_special_fragilisation_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
              <!-- CORROSION -->
              <label class="sheet-alteration-item" data-alteration="corrosion">
                <input type="checkbox" name="attr_skill_special_corrosion_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Corrosion</div>
                  <input type="number" name="attr_skill_special_corrosion_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_special_corrosion_des" placeholder="ex: 1d4" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- RÉDUCTION D'ARMURE AVEC SÉLECTION -->
              <label class="sheet-alteration-item sheet-alteration-double" data-alteration="reduction_armure">
                <input type="checkbox" name="attr_skill_special_reduction_armure_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128737; Réduction d'armure</div>
                  <input type="number" name="attr_skill_special_reduction_armure_valeur" placeholder="Valeur" min="0" />
                  <div class="sheet-custom-select">
                    <select name="attr_skill_special_reduction_armure_type">
                      <option value="globale">Réduction d'armure globale</option>
                      <option value="legere">Réduction d'armure légère</option>
                      <option value="moyenne">Réduction d'armure moyenne</option>
                      <option value="lourde">Réduction d'armure lourde</option>
                      
                    </select>
                    <div class="sheet-select-arrow">&#9660;</div>
                  </div>
                </div>
              </label>
              
              <!-- ATTAQUE SOURNOISE -->
              <label class="sheet-alteration-item" data-alteration="attaque_sournoise">
                <input type="checkbox" name="attr_skill_special_attaque_sournoise_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128298; Attaque sournoise</div>
                </div>
              </label>
              
              <!-- FRACTURE -->
              <label class="sheet-alteration-item" data-alteration="fracture">
                <input type="checkbox" name="attr_skill_special_fracture_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">&#128165; Fracture</div>
                  <input type="number" name="attr_skill_special_fracture_valeur" placeholder="Valeur" min="0" />
                  <input type="text" name="attr_skill_special_fracture_des" placeholder="ex: 1d8" class="sheet-des-input" />
                </div>
              </label>
              
              <!-- EFFET LIBRE -->
              <label class="sheet-alteration-item" data-alteration="effet_libre">
                <input type="checkbox" name="attr_skill_special_effet_libre_actif" value="1" class="sheet-alteration-checkbox" />
                <div class="sheet-alteration-content">
                  <div class="sheet-alteration-label">
                    <input type="text" name="attr_skill_special_effet_libre_nom" placeholder="Nom de l'effet" class="sheet-effet-libre-nom" />
                  </div>
                  <input type="number" name="attr_skill_special_effet_libre_valeur" placeholder="Valeur" min="0" />
                </div>
              </label>
              
            </div>
            
          </div>
        </details>

        <!-- SECTION EFFETS CÔTE À CÔTE POUR SKILL SPÉCIAL -->
<div class="sheet-effets-row">
  <!-- EFFET DE LA COMPÉTENCE SPÉCIALE (GAUCHE) -->
  <details class="sheet-sous-section sheet-effet-gauche">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">&#128220;</span>
      <span class="sheet-sous-label">Effet de la Compétence Spéciale</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_skill_special_effet" placeholder="Décrire l'effet de la compétence spéciale en détail..."></textarea>
    </div>
  </details>
  
  <!-- EFFET ACTIF (DROITE) -->
  <details class="sheet-sous-section sheet-effet-droite">
    <summary class="sheet-sous-titre">
      <span class="sheet-sous-icone">⚡</span>
      <span class="sheet-sous-label">Effet Actif</span>
    </summary>
    <div class="sheet-effet-content">
      <textarea name="attr_skill_special_effet_actif" placeholder="Décrire l'effet actif de la compétence spéciale (apparaîtra dans le template)..."></textarea>
    </div>
  </details>
</div>

      </div>
    </details>
    
  </details>
  </fieldset>
</details>
      
<!-- PASSIF -->
<details class="sheet-capacite-bloc">
  <summary class="sheet-section-title">Passif</summary>
  <fieldset class="repeating_passifs">
    <details class="sheet-capacite-block">
      <summary class="sheet-capacite-summary" style="display: flex; justify-content: space-between; align-items: center; gap: 0.5em;">
        <input type="text" name="attr_passif_nom" placeholder="Nom du passif" style="flex: 1;" />
        <input type="text" name="attr_passif_note" placeholder="0/100 ???" style="width: 100px;" />
      </summary>
      <table class="sheet-sort-table">
        <thead>
          <tr>
            <th>Effet</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <textarea name="attr_passif_effet" placeholder="Effet du passif"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
    </details>
  </fieldset>
</details>


    </div>
  </div>
</div>


<!-- === SECTION INVENTAIRE - STRUCTURE MODIFIÉE === -->
<div class="sheet-tab-content sheet-inventaire">
  <div class="sheet-box-wrapper">

    <!-- === INVENTAIRE PRINCIPAL === -->
    <details class="sheet-inventory-wrapper">
      <summary class="sheet-section-title">Inventaire</summary>

      <div class="sheet-inventory-columns">
        
        <!-- === COLONNE GAUCHE === -->
        <div class="sheet-inventory-left-column">

          <!-- Gros Sac AVEC COMPTEUR -->
          <details class="sheet-inventory-block">
            <summary class="sheet-inventory-summary-with-counter">
              <input type="text" name="attr_nom_gros_sac" class="sheet-inventory-title-input" value="Gros Sac d'aventure" />
              <span class="sheet-inventory-counter-display">
                <input type="text" name="attr_gros_sac_counter" class="sheet-counter-readonly" readonly value="0/0" />
              </span>
            </summary>
            <fieldset class="repeating_sac">
              <div class="sheet-inventory-row">
                <input type="text" name="attr_item_nom" placeholder="Nom de l'objet..." />
                <input type="number" name="attr_item_quantite" placeholder="Qté" min="0" />
                <input type="text" name="attr_item_effet" placeholder="Effet..." />
              </div>
            </fieldset>
          </details>

          <!-- Partie campement SANS COMPTEUR -->
          <details class="sheet-inventory-block">
            <summary class="sheet-inventory-summary-simple">
              <span class="sheet-section-title-text">Partie campement</span>
            </summary>
            <fieldset class="repeating_campement">
              <div class="sheet-inventory-row">
                <input type="text" name="attr_camp_item_nom" placeholder="Nom de l'objet..." />
                <input type="number" name="attr_camp_item_quantite" placeholder="Qté" min="0" />
                <input type="text" name="attr_camp_item_effet" placeholder="Effet..." />
              </div>
            </fieldset>
          </details>

          <!-- Sac bonus AVEC COMPTEUR -->
          <details class="sheet-inventory-block">
            <summary class="sheet-inventory-summary-with-counter">
              <input type="text" name="attr_nom_bonus_sac" class="sheet-inventory-title-input" value="Sac bonus" />
              <span class="sheet-inventory-counter-display">
                <input type="text" name="attr_bonus_sac_counter" class="sheet-counter-readonly" readonly value="0/0" />
              </span>
            </summary>
            <fieldset class="repeating_sacbonus">
              <div class="sheet-inventory-row">
                <input type="text" name="attr_bonus_item_nom" placeholder="Nom de l'objet..." />
                <input type="number" name="attr_bonus_item_quantite" placeholder="Qté" min="0" />
                <input type="text" name="attr_bonus_item_effet" placeholder="Effet..." />
              </div>
            </fieldset>
          </details>

        </div>

        <!-- === COLONNE DROITE === -->
        <div class="sheet-inventory-right-column">

          <!-- Équipement -->
          <details class="sheet-inventory-block">
            <summary class="sheet-section-title">Équipement</summary>

            <!-- Armes équipées (pliable) -->
            <details class="sheet-subsection sheet-weapons-section">
              <summary class="sheet-subsection-title">Armes équipées</summary>
              
              <div class="sheet-weapons-container">
                <!-- ARME PRINCIPALE -->
                <div class="sheet-weapon-container">
                  <div class="sheet-inventory-row sheet-weapon-row-no-qty">
                    <input type="text" name="attr_arme_principale_nom" placeholder="Arme principale..." class="sheet-weapon-name-input" />
                    <input type="text" name="attr_arme_principale_effet" placeholder="Effet..." class="sheet-weapon-effect-input" />
                    
                    <!-- CHECKBOX À DEUX MAINS -->
                    <label class="sheet-twohands-label">
                      <input type="checkbox" name="attr_arme_twohands" class="sheet-twohands-checkbox" value="1" />
                      <span class="sheet-twohands-text">À deux mains</span>
                    </label>
                  </div>
                  
                  <!-- Ligne dégâts avec checkbox magique -->
                  <div class="sheet-damage-row">
                    <div class="sheet-damage-inputs">
                      <input type="text" name="attr_arme_principale_degats" placeholder="Jet de dégâts (ex: 2d6+3)" class="sheet-damage-input" />
                      <input type="text" name="attr_arme_principale_degats_mag" placeholder="Dégâts magiques (ex: 1d8)" class="sheet-damage-magic-input" />
                    </div>
                    <label class="sheet-magic-damage-label">
                      <input type="checkbox" name="attr_arme_principale_magic" class="sheet-magic-damage-checkbox" value="1" />
                      <span>Dégâts magiques</span>
                    </label>
                  </div>
                  
                  <!-- BLOC BONUS ARME PRINCIPALE -->
                  <details class="sheet-bonus-block">
                    <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                    <div class="sheet-bonus-table-container">
                      <table class="sheet-bonus-table">
                        <thead>
                          <tr>
                            <th>Stat</th>
                            <th>Valeur</th>
                            <th>Appliquer</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>PV</td>
                            <td><input type="number" name="attr_arme_principale_pv_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_principale_pv_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                          <tr>
                            <td>PM</td>
                            <td><input type="number" name="attr_arme_principale_pm_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_principale_pm_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                          <tr>
                            <td>PE</td>
                            <td><input type="number" name="attr_arme_principale_pe_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_principale_pe_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                          <tr>
                            <td>Mouvement</td>
                            <td><input type="number" name="attr_arme_principale_mov_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_principale_mov_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </details>
                </div>
                
                <!-- ARME SECONDAIRE -->
                <div class="sheet-weapon-container sheet-arme-secondaire-container">
                  <div class="sheet-inventory-row sheet-weapon-row-no-qty">
                    <input type="text" name="attr_arme_secondaire_nom" placeholder="Arme secondaire..." class="sheet-weapon-name-input" />
                    <input type="text" name="attr_arme_secondaire_effet" placeholder="Effet..." class="sheet-weapon-effect-input" />
                  </div>
                  
                  <!-- Ligne dégâts avec checkbox magique -->
                  <div class="sheet-damage-row">
                    <div class="sheet-damage-inputs">
                      <input type="text" name="attr_arme_secondaire_degats" placeholder="Jet de dégâts (ex: 1d6)" class="sheet-damage-input" />
                      <input type="text" name="attr_arme_secondaire_degats_mag" placeholder="Dégâts magiques (ex: 1d4)" class="sheet-damage-magic-input" />
                    </div>
                    <label class="sheet-magic-damage-label">
                      <input type="checkbox" name="attr_arme_secondaire_magic" class="sheet-magic-damage-checkbox" value="1" />
                      <span>Dégâts magiques</span>
                    </label>
                  </div>
                  
                  <!-- BLOC BONUS ARME SECONDAIRE -->
                  <details class="sheet-bonus-block">
                    <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                    <div class="sheet-bonus-table-container">
                      <table class="sheet-bonus-table">
                        <thead>
                          <tr>
                            <th>Stat</th>
                            <th>Valeur</th>
                            <th>Appliquer</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>PV</td>
                            <td><input type="number" name="attr_arme_secondaire_pv_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_secondaire_pv_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                          <tr>
                            <td>PM</td>
                            <td><input type="number" name="attr_arme_secondaire_pm_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_secondaire_pm_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                          <tr>
                            <td>PE</td>
                            <td><input type="number" name="attr_arme_secondaire_pe_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_secondaire_pe_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                          <tr>
                            <td>Mouvement</td>
                            <td><input type="number" name="attr_arme_secondaire_mov_bonus_val" value="0" /></td>
                            <td>
                              <label class="sheet-bonus-check-label">
                                <input type="checkbox" name="attr_arme_secondaire_mov_bonus_on" value="1" />
                                <span class="sheet-check-icon">✓</span>
                              </label>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </details>
                </div>
              </div>
              
            </details>

            <!-- Autres équipements (repeating, pliable) -->
            <details class="sheet-subsection">
              <summary class="sheet-subsection-title">Autres équipements</summary>
              <fieldset class="repeating_equipement">
                <div class="sheet-inventory-row">
                  <input type="text" name="attr_eq_nom" placeholder="Nom de l'équipement..." />
                  <input type="number" name="attr_eq_quantite" placeholder="Qté" min="0" value="1" />
                  <input type="text" name="attr_eq_effet" placeholder="Effet..." />
                </div>
              </fieldset>
            </details>

          </details>

          <!-- Extras équipement -->
          <details class="sheet-inventory-block">
            <summary class="sheet-section-title">Extras équipement</summary>

            <!-- Armure équipée (pliable) -->
            <details class="sheet-subsection">
              <summary class="sheet-subsection-title">Armure équipée</summary>
              
              <div class="sheet-armor-container">
                <div class="sheet-inventory-row sheet-armor-row-no-qty">
                  <input type="text" name="attr_armure_nom" placeholder="Nom de l'armure..." class="sheet-armor-name-input" />
                  <input type="text" name="attr_armure_effet" placeholder="Effet..." class="sheet-armor-effect-input" />
                </div>
                
                <!-- Ligne défense avec checkbox magique -->
                <div class="sheet-defense-row">
                  <div class="sheet-defense-inputs">
                    <input type="text" name="attr_armure_defense" placeholder="Jet de défense (ex: +5 CA)" class="sheet-defense-input" />
                    <input type="text" name="attr_armure_defense_mag" placeholder="Défense magique (ex: +3 RM)" class="sheet-defense-magic-input" />
                  </div>
                  <label class="sheet-magic-defense-label">
                    <input type="checkbox" name="attr_armure_magic" class="sheet-magic-defense-checkbox" value="1" />
                    <span>Défense magique</span>
                  </label>
                </div>
                
                <!-- BLOC BONUS ARMURE -->
                <details class="sheet-bonus-block">
                  <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                  <div class="sheet-bonus-table-container">
                    <table class="sheet-bonus-table">
                      <thead>
                        <tr>
                          <th>Stat</th>
                          <th>Valeur</th>
                          <th>Appliquer</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>PV</td>
                          <td><input type="number" name="attr_armure_pv_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_armure_pv_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PM</td>
                          <td><input type="number" name="attr_armure_pm_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_armure_pm_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PE</td>
                          <td><input type="number" name="attr_armure_pe_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_armure_pe_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>Mouvement</td>
                          <td><input type="number" name="attr_armure_mov_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_armure_mov_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </details>
              </div>
              
            </details>

            <!-- Tenue Civile -->
            <details class="sheet-subsection">
              <summary class="sheet-subsection-title">Tenue Civile</summary>
              
              <div class="sheet-armor-container">
                <div class="sheet-inventory-row sheet-armor-row-no-qty">
                  <input type="text" name="attr_tenue_civile_nom" placeholder="Nom de la tenue civile..." class="sheet-armor-name-input" />
                  <input type="text" name="attr_tenue_civile_effet" placeholder="Effet..." class="sheet-armor-effect-input" />
                </div>
                
                <!-- Ligne défense avec checkbox magique -->
                <div class="sheet-defense-row">
                  <div class="sheet-defense-inputs">
                    <input type="text" name="attr_tenue_civile_defense" placeholder="Jet de défense (ex: +2 CA)" class="sheet-defense-input" />
                    <input type="text" name="attr_tenue_civile_defense_mag" placeholder="Défense magique (ex: +1 RM)" class="sheet-defense-magic-input" />
                  </div>
                  <label class="sheet-magic-defense-label">
                    <input type="checkbox" name="attr_tenue_civile_magic" class="sheet-magic-defense-checkbox" value="1" />
                    <span>Défense magique</span>
                  </label>
                </div>
                
                <!-- BLOC BONUS TENUE CIVILE -->
                <details class="sheet-bonus-block">
                  <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                  <div class="sheet-bonus-table-container">
                    <table class="sheet-bonus-table">
                      <thead>
                        <tr>
                          <th>Stat</th>
                          <th>Valeur</th>
                          <th>Appliquer</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>PV</td>
                          <td><input type="number" name="attr_tenue_civile_pv_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_tenue_civile_pv_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PM</td>
                          <td><input type="number" name="attr_tenue_civile_pm_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_tenue_civile_pm_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PE</td>
                          <td><input type="number" name="attr_tenue_civile_pe_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_tenue_civile_pe_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>Mouvement</td>
                          <td><input type="number" name="attr_tenue_civile_mov_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_tenue_civile_mov_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </details>
              </div>
              
            </details>

            <!-- Extras (repeating, pliable) -->
            <details class="sheet-subsection">
              <summary class="sheet-subsection-title">Extras</summary>
              <fieldset class="repeating_extraequipement">
                <div class="sheet-inventory-row">
                  <input type="text" name="attr_extraeq_nom" placeholder="Nom de l'objet..." />
                  <input type="number" name="attr_extraeq_quantite" placeholder="Qté" min="0" value="1" />
                  <input type="text" name="attr_extraeq_effet" placeholder="Effet..." />
                </div>
                
                <!-- BLOC BONUS EXTRA -->
                <details class="sheet-bonus-block">
                  <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                  <div class="sheet-bonus-table-container">
                    <table class="sheet-bonus-table">
                      <thead>
                        <tr>
                          <th>Stat</th>
                          <th>Valeur</th>
                          <th>Appliquer</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>PV</td>
                          <td><input type="number" name="attr_extraeq_pv_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_extraeq_pv_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PM</td>
                          <td><input type="number" name="attr_extraeq_pm_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_extraeq_pm_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PE</td>
                          <td><input type="number" name="attr_extraeq_pe_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_extraeq_pe_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>Mouvement</td>
                          <td><input type="number" name="attr_extraeq_mov_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_extraeq_mov_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </details>
              </fieldset>
            </details>

          </details>

          <!-- Bijoux -->
          <details class="sheet-inventory-block">
            <summary class="sheet-section-title">Bijoux</summary>

            <!-- Collier équipé (pliable) -->
            <details class="sheet-subsection">
              <summary class="sheet-subsection-title">Collier équipé</summary>
              <div class="sheet-inventory-row">
                <input type="text" name="attr_collier_nom" placeholder="Nom du collier..." />
                <input type="number" name="attr_collier_quantite" placeholder="Qté" min="0" value="1" />
                <input type="text" name="attr_collier_effet" placeholder="Effet..." />
              </div>
              
              <!-- BLOC BONUS COLLIER -->
              <details class="sheet-bonus-block">
                <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                <div class="sheet-bonus-table-container">
                  <table class="sheet-bonus-table">
                    <thead>
                      <tr>
                        <th>Stat</th>
                        <th>Valeur</th>
                        <th>Appliquer</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>PV</td>
                        <td><input type="number" name="attr_collier_pv_bonus_val" value="0" /></td>
                        <td>
                          <label class="sheet-bonus-check-label">
                            <input type="checkbox" name="attr_collier_pv_bonus_on" value="1" />
                            <span class="sheet-check-icon">✓</span>
                          </label>
                        </td>
                      </tr>
                      <tr>
                        <td>PM</td>
                        <td><input type="number" name="attr_collier_pm_bonus_val" value="0" /></td>
                        <td>
                          <label class="sheet-bonus-check-label">
                            <input type="checkbox" name="attr_collier_pm_bonus_on" value="1" />
                            <span class="sheet-check-icon">✓</span>
                          </label>
                        </td>
                      </tr>
                      <tr>
                        <td>PE</td>
                        <td><input type="number" name="attr_collier_pe_bonus_val" value="0" /></td>
                        <td>
                          <label class="sheet-bonus-check-label">
                            <input type="checkbox" name="attr_collier_pe_bonus_on" value="1" />
                            <span class="sheet-check-icon">✓</span>
                          </label>
                        </td>
                      </tr>
                      <tr>
                        <td>Mouvement</td>
                        <td><input type="number" name="attr_collier_mov_bonus_val" value="0" /></td>
                        <td>
                          <label class="sheet-bonus-check-label">
                            <input type="checkbox" name="attr_collier_mov_bonus_on" value="1" />
                            <span class="sheet-check-icon">✓</span>
                          </label>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </details>
            </details>

            <!-- Bagues (repeating, pliable) -->
            <details class="sheet-subsection">
              <summary class="sheet-subsection-title">Bagues</summary>
              <fieldset class="repeating_bijoux">
                <div class="sheet-inventory-row">
                  <input type="text" name="attr_bijou_nom" placeholder="Nom de la bague..." />
                  <input type="number" name="attr_bijou_quantite" placeholder="Qté" min="0" value="1" />
                  <input type="text" name="attr_bijou_effet" placeholder="Effet..." />
                </div>
                
                <!-- BLOC BONUS BAGUE -->
                <details class="sheet-bonus-block">
                  <summary class="sheet-bonus-summary">⭐ Bonus de stats</summary>
                  <div class="sheet-bonus-table-container">
                    <table class="sheet-bonus-table">
                      <thead>
                        <tr>
                          <th>Stat</th>
                          <th>Valeur</th>
                          <th>Appliquer</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>PV</td>
                          <td><input type="number" name="attr_bijou_pv_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_bijou_pv_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PM</td>
                          <td><input type="number" name="attr_bijou_pm_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_bijou_pm_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>PE</td>
                          <td><input type="number" name="attr_bijou_pe_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_bijou_pe_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                        <tr>
                          <td>Mouvement</td>
                          <td><input type="number" name="attr_bijou_mov_bonus_val" value="0" /></td>
                          <td>
                            <label class="sheet-bonus-check-label">
                              <input type="checkbox" name="attr_bijou_mov_bonus_on" value="1" />
                              <span class="sheet-check-icon">✓</span>
                            </label>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </details>
              </fieldset>
            </details>

          </details>

        </div>
      </div>
    </details>

    <!-- === EFFETS DES OBJETS === -->
    <details class="sheet-item-effects-wrapper">
      <summary class="sheet-section-title">Effets des Objets</summary>

      <div class="sheet-item-effects-grid">

        <!-- === COLONNE GAUCHE === -->
        <div class="sheet-item-column-left">

          <!-- Équipement porté -->
          <details class="sheet-subsection">
            <summary class="sheet-subsection-title">Équipement porté</summary>
            <fieldset class="repeating_equipport">
              <details class="sheet-inventory-block">
                <summary>
                  <input type="text" name="attr_equip_port_nom" placeholder="Nom de l'équipement..." />
                </summary>
                <div class="sheet-effect-content">
                  <textarea name="attr_equip_port_effet" placeholder="Effet de l'équipement..."></textarea>
                </div>
              </details>
            </fieldset>
          </details>

          <!-- Bijoux -->
          <details class="sheet-subsection">
            <summary class="sheet-subsection-title">Bijoux</summary>
            <fieldset class="repeating_bijoux_effet">
              <details class="sheet-inventory-block">
                <summary>
                  <input type="text" name="attr_bijoux_effet_nom" placeholder="Nom du bijou..." />
                </summary>
                <div class="sheet-effect-content">
                  <textarea name="attr_bijoux_effet_description" placeholder="Effet du bijou..."></textarea>
                </div>
              </details>
            </fieldset>
          </details>

          <!-- Potions -->
          <details class="sheet-subsection">
            <summary class="sheet-subsection-title">Potions</summary>
            <fieldset class="repeating_potions">
              <details class="sheet-inventory-block">
                <summary>
                  <input type="text" name="attr_potion_nom" placeholder="Nom de la potion..." />
                </summary>
                <div class="sheet-effect-content">
                  <textarea name="attr_potion_effet" placeholder="Effet de la potion..."></textarea>
                </div>
              </details>
            </fieldset>
          </details>

        </div>

        <!-- === COLONNE DROITE === -->
        <div class="sheet-item-column-right">

          <!-- Équipement non porté -->
          <details class="sheet-subsection">
            <summary class="sheet-subsection-title">Équipement non porté</summary>
            <fieldset class="repeating_equipnonport">
              <details class="sheet-inventory-block">
                <summary>
                  <input type="text" name="attr_equip_nonport_nom" placeholder="Nom de l'équipement..." />
                </summary>
                <div class="sheet-effect-content">
                  <textarea name="attr_equip_nonport_effet" placeholder="Effet de l'objet entreposé..."></textarea>
                </div>
              </details>
            </fieldset>
          </details>

          <!-- Objets magiques -->
          <details class="sheet-subsection">
            <summary class="sheet-subsection-title">Objets magiques</summary>
            <fieldset class="repeating_objetmagique">
              <details class="sheet-inventory-block">
                <summary>
                  <input type="text" name="attr_objetmagique_nom" placeholder="Nom de l'objet magique..." />
                </summary>
                <div class="sheet-effect-content">
                  <textarea name="attr_objetmagique_effet" placeholder="Effet magique..."></textarea>
                </div>
              </details>
            </fieldset>
          </details>

          <!-- Divers -->
          <details class="sheet-subsection">
            <summary class="sheet-subsection-title">Divers</summary>
            <fieldset class="repeating_divers">
              <details class="sheet-inventory-block">
                <summary>
                  <input type="text" name="attr_divers_nom" placeholder="Nom de l'objet..." />
                </summary>
                <div class="sheet-effect-content">
                  <textarea name="attr_divers_effet" placeholder="Effet divers..."></textarea>
                </div>
              </details>
            </fieldset>
          </details>

        </div>
      </div>
    </details>

    <!-- === ⭐ RÉSERVE (COFFRES) - 2 COLONNES PAR LIGNE === -->
    <details class="sheet-inventory-wrapper sheet-reserve-section">
      <summary class="sheet-section-title">Réserve</summary>

      <div class="sheet-reserve-content">
        
        <!-- Coffre (repeating) -->
        <fieldset class="repeating_coffres">
          <details class="sheet-coffre-block">
            <summary class="sheet-coffre-summary">
              <input type="text" name="attr_coffre_nom" class="sheet-coffre-title-input" value="Coffre" placeholder="Nom du coffre..." />
            </summary>

            <!-- ⭐ UN SEUL REPEATING AVEC 2 COLONNES CÔTE À CÔTE -->
            <fieldset class="repeating_coffreitems">
              <div class="sheet-coffre-double-row">
                
                <!-- === COLONNE GAUCHE === -->
                <div class="sheet-coffre-item-wrapper">
                  <!-- Ligne principale gauche -->
                  <div class="sheet-coffre-item-row">
                    <input type="text" name="attr_coffre_item_nom_g" placeholder="Nom..." class="sheet-coffre-item-nom" />
                    <input type="number" name="attr_coffre_item_nombre_g" placeholder="Qté" min="0" value="1" class="sheet-coffre-item-nombre" />
                    <input type="text" name="attr_coffre_item_effet_g" placeholder="Effet..." class="sheet-coffre-item-effet" />
                    
                    <!-- Checkbox gauche -->
                    <label class="sheet-coffre-detail-toggle">
                      <input type="checkbox" name="attr_coffre_item_detail_g" class="sheet-coffre-detail-check" value="1" />
                      <span class="sheet-check-box"></span>
                    </label>
                  </div>

                  <!-- Zone effet complet gauche -->
                  <div class="sheet-coffre-detail-zone">
                    <details class="sheet-coffre-detail-block">
                      <summary class="sheet-coffre-detail-summary">✨ Effet complet</summary>
                      <div class="sheet-coffre-detail-content">
                        <textarea name="attr_coffre_item_effet_complet_g" placeholder="Description complète de l'effet..." class="sheet-coffre-detail-textarea"></textarea>
                      </div>
                    </details>
                  </div>
                </div>

                <!-- === COLONNE DROITE === -->
                <div class="sheet-coffre-item-wrapper">
                  <!-- Ligne principale droite -->
                  <div class="sheet-coffre-item-row">
                    <input type="text" name="attr_coffre_item_nom_d" placeholder="Nom..." class="sheet-coffre-item-nom" />
                    <input type="number" name="attr_coffre_item_nombre_d" placeholder="Qté" min="0" value="1" class="sheet-coffre-item-nombre" />
                    <input type="text" name="attr_coffre_item_effet_d" placeholder="Effet..." class="sheet-coffre-item-effet" />
                    
                    <!-- Checkbox droite -->
                    <label class="sheet-coffre-detail-toggle">
                      <input type="checkbox" name="attr_coffre_item_detail_d" class="sheet-coffre-detail-check" value="1" />
                      <span class="sheet-check-box"></span>
                    </label>
                  </div>

                  <!-- Zone effet complet droite -->
                  <div class="sheet-coffre-detail-zone">
                    <details class="sheet-coffre-detail-block">
                      <summary class="sheet-coffre-detail-summary">✨ Effet complet</summary>
                      <div class="sheet-coffre-detail-content">
                        <textarea name="attr_coffre_item_effet_complet_d" placeholder="Description complète de l'effet..." class="sheet-coffre-detail-textarea"></textarea>
                      </div>
                    </details>
                  </div>
                </div>

              </div> <!-- Fin coffre-double-row -->
            </fieldset>

          </details>
        </fieldset>

      </div> <!-- Fin reserve-content -->
    </details>

  </div> <!-- Fin sheet-box-wrapper -->
</div> <!-- Fin sheet-tab-content sheet-inventaire -->


<div class="sheet-tab-content sheet-entrainement">
    <div class="charsheet">
        <h1>&#9876; Entrainement &#9876;</h1>
        
        <!-- ========== CARTE DE BASE (NON-REPEATING) ========== -->
        <details class="sheet-entrainement-card">
            <summary class="sheet-entrainement-summary">
                <h3>&#9876; Entrainement Principal</h3>
                <div class="sheet-nom-container">
                    <div class="sheet-nom-label">Nom :</div>
                    <input type="text" name="attr_base_nom" placeholder="Nom de l'entrainement..." class="sheet-nom-input" />
                    <span class="sheet-toggle-arrow">▼</span>
                </div>
            </summary>
            
            <div class="sheet-toggle-content">
                <!-- Catégorie et Rang -->
                <div class="sheet-row">
                    <div class="sheet-col">
                        <label>Catégorie :</label>
                        <select name="attr_base_categorie" class="sheet-categorie-select">
                            <option value="">-- Sélectionner --</option>
                            <option value="amélioration_caractéristique">&#128170; Amélioration d'une caractéristique</option>
                            <option value="amélioration_sort_capacité">&#9889; Amélioration de Sort/Capacité</option>
                            <option value="obtention_sort_capacité">&#10024; Obtention de Sort/Capacité</option>
                            <option value="amélioration_talent">&#127775; Amélioration d'un talent</option>
                            <option value="obtention_talent">&#11088; Obtention d'un Talent</option>
                            <option value="amélioration_connaissance">&#128218; Amélioration d'une connaissance</option>
                            <option value="obtention_connaissance">&#128214; Obtention d'une connaissance</option>
                            <option value="obtention_langue">&#128172; Obtention d'une nouvelle langue</option>
                            <option value="amélioration_classe_arme">&#9876; Amélioration d'un cran de la classe d'arme</option>
                            <option value="obtention_classe_secondaire">&#127942; Obtention de Classe secondaire</option>
                            <option value="obtention_réputation">&#129351; Obtention de Réputation</option>
                            <option value="amélioration_talent_métier">&#128736; Amélioration de talent de métier</option>
                        </select>
                    </div>
                    <div class="sheet-col">
                        <label>Rang de Difficulté :</label>
                        <select name="attr_base_rang">
                            <option value="">--</option>
                            <option value="1">Rang 1 (aucun malus)</option>
                            <option value="2">Rang 2 (-5)</option>
                            <option value="3">Rang 3 (-10)</option>
                            <option value="4">Rang 4 (-15)</option>
                            <option value="5">Rang 5 (-20)</option>
                        </select>
                    </div>
                </div>
                
                <input type="hidden" name="attr_base_rang_malus" value="0" />

                <!-- Section Points d'Apprentissage -->
                <div class="sheet-pa-section">
                    <h4>&#128142; Points d'Apprentissage</h4>
                    <div class="sheet-row">
                        <div class="sheet-col">
                            <label>PA Actuels :</label>
                            <input type="number" name="attr_base_pa_actuel" value="0" min="0" />
                        </div>
                        <div class="sheet-col">
                            <label>PA Objectif :</label>
                            <input type="number" name="attr_base_pa_cible" value="100" min="1" />
                        </div>
                    </div>
                    
                    <div class="sheet-progress-container">
                        <input type="hidden" name="attr_base_progress" value="0" class="sheet-progress-value" />
                        <input type="hidden" name="attr_base_progress_text" value="0%" />
                        
                        <div class="sheet-progress-bar">
                            <div class="sheet-progress-bg"></div>
                            <div class="sheet-progress-fill"></div>
                            <span class="sheet-progress-label"><span name="attr_base_progress_text">0%</span></span>
                        </div>
                    </div>
                </div>

                <!-- Section Actions -->
                <div class="sheet-actions">
                    <div class="sheet-action-group">
                        <h4>&#127922; Jet d'Entrainement</h4>
                        <label>Bonus/Malus :</label>
                        <input type="number" name="attr_base_bonus_malus" value="0" />
                        <div class="sheet-malus-info">
                            Malus de Rang : <span name="attr_base_rang_malus_display">0</span>
                        </div>
                        <button type="roll" name="roll_base_jet" 
                                value="&{template:jet_entrainement} {{name=@{base_nom}}} {{categorie=@{base_categorie}}} {{rang=@{base_rang}}} {{bonus=@{base_bonus_malus}}} {{malus_rang=@{base_rang_malus}}} {{jet=[[1d100+@{base_bonus_malus}+@{base_rang_malus}]]}}">
                            Lancer 1d100
                        </button>
                    </div>

                    <div class="sheet-action-group">
                        <h4>&#10024; Gain de PA</h4>
                        <div class="sheet-row">
                            <div class="sheet-col">
                                <label>Nombre de Dés :</label>
                                <input type="number" name="attr_base_nb_des" value="1" min="1" max="10" />
                            </div>
                            <div class="sheet-col">
                                <label>Type de Dé :</label>
                                <select name="attr_base_type_de">
                                    <option value="6">d6</option>
                                    <option value="8">d8</option>
                                    <option value="10">d10</option>
                                </select>
                            </div>
                        </div>
                        <div class="sheet-row">
                            <div class="sheet-col">
                                <label>Bonus Flat :</label>
                                <input type="number" name="attr_base_bonus_flat" value="0" />
                            </div>
                            <div class="sheet-col">
                                <label>Bonus % :</label>
                                <input type="number" name="attr_base_bonus_pourcent" value="0" />
                            </div>
                        </div>
                        <button type="roll" name="roll_base_gain"
                                value="&{template:gain_pa} {{name=@{base_nom}}} {{gain_final=[[floor((@{base_nb_des}d@{base_type_de}+@{base_bonus_flat}*@{base_nb_des})*(1+@{base_bonus_pourcent}/100))]]}}">
                            Gagner PA
                        </button>
                    </div>
                </div>
                
                <!-- Section Objectif -->
                <div class="sheet-objectif-section">
                    <h4>&#129351; Objectif de l'entrainement</h4>
                    <textarea name="attr_base_objectif" placeholder="Décrivez l'objectif de cet entrainement..." rows="2"></textarea>
                </div>
            </div>
        </details>

        <!-- ========== SECTIONS RÉPÉTABLES ========== -->
        <h2>&#9876; Entrainements Secondaires</h2>
        <fieldset class="repeating_entrainement">
            <details class="sheet-entrainement-card sheet-repeating">
                <summary class="sheet-entrainement-summary">
                    <div class="sheet-nom-container">
                        <div class="sheet-nom-label">Nom :</div>
                        <input type="text" name="attr_nom" placeholder="Nom de l'entrainement..." class="sheet-nom-input" />
                        <span class="sheet-toggle-arrow">▼</span>
                    </div>
                </summary>
                
                <div class="sheet-toggle-content">
                    <!-- Catégorie et Rang -->
                    <div class="sheet-row">
                        <div class="sheet-col">
                            <label>Catégorie :</label>
                            <select name="attr_categorie" class="sheet-categorie-select">
                                <option value="">-- Sélectionner --</option>
                                <option value="amélioration_caractéristique">&#128170; Amélioration d'une caractéristique</option>
                                <option value="amélioration_sort_capacité">&#9889; Amélioration de Sort/Capacité</option>
                                <option value="obtention_sort_capacité">&#10024; Obtention de Sort/Capacité</option>
                                <option value="amélioration_talent">&#127775; Amélioration d'un talent</option>
                                <option value="obtention_talent">&#11088; Obtention d'un Talent</option>
                                <option value="amélioration_connaissance">&#128218; Amélioration d'une connaissance</option>
                                <option value="obtention_connaissance">&#128214; Obtention d'une connaissance</option>
                                <option value="obtention_langue">&#128172; Obtention d'une nouvelle langue</option>
                                <option value="amélioration_classe_arme">&#9876; Amélioration d'un cran de la classe d'arme</option>
                                <option value="obtention_classe_secondaire">&#127942; Obtention de Classe secondaire</option>
                                <option value="obtention_réputation">&#129351; Obtention de Réputation</option>
                                <option value="amélioration_talent_métier">&#128736; Amélioration de talent de métier</option>
                            </select>
                        </div>
                        <div class="sheet-col">
                            <label>Rang de Difficulté :</label>
                            <select name="attr_rang">
                                <option value="">--</option>
                                <option value="1">Rang 1 (aucun malus)</option>
                                <option value="2">Rang 2 (-5)</option>
                                <option value="3">Rang 3 (-10)</option>
                                <option value="4">Rang 4 (-15)</option>
                                <option value="5">Rang 5 (-20)</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" name="attr_rang_malus" value="0" />

                    <!-- Section Points d'Apprentissage -->
                    <div class="sheet-pa-section">
                        <h4>&#128142; Points d'Apprentissage</h4>
                        <div class="sheet-row">
                            <div class="sheet-col">
                                <label>PA Actuels :</label>
                                <input type="number" name="attr_pa_actuel" value="0" min="0" />
                            </div>
                            <div class="sheet-col">
                                <label>PA Objectif :</label>
                                <input type="number" name="attr_pa_cible" value="100" min="1" />
                            </div>
                        </div>
                        
                        <div class="sheet-progress-container">
                            <input type="hidden" name="attr_progress" value="0" class="sheet-progress-value" />
                            <input type="hidden" name="attr_progress_text" value="0%" />
                            
                            <div class="sheet-progress-bar">
                                <div class="sheet-progress-bg"></div>
                                <div class="sheet-progress-fill"></div>
                                <span class="sheet-progress-label"><span name="attr_progress_text">0%</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Section Actions -->
                    <div class="sheet-actions">
                        <div class="sheet-action-group">
                            <h4>&#127922; Jet d'Entrainement</h4>
                            <label>Bonus/Malus :</label>
                            <input type="number" name="attr_bonus_malus" value="0" />
                            <div class="sheet-malus-info">
                                Malus de Rang : <span name="attr_rang_malus_display">0</span>
                            </div>
                            <button type="roll" name="roll_jet" 
                                    value="&{template:jet_entrainement} {{name=@{nom}}} {{categorie=@{categorie}}} {{rang=@{rang}}} {{bonus=@{bonus_malus}}} {{malus_rang=@{rang_malus}}} {{jet=[[1d100+@{bonus_malus}+@{rang_malus}]]}}">
                                Lancer 1d100
                            </button>
                        </div>

                        <div class="sheet-action-group">
                            <h4>&#10024; Gain de PA</h4>
                            <div class="sheet-row">
                                <div class="sheet-col">
                                    <label>Nombre de Dés :</label>
                                    <input type="number" name="attr_nb_des" value="1" min="1" max="10" />
                                </div>
                                <div class="sheet-col">
                                    <label>Type de Dé :</label>
                                    <select name="attr_type_de">
                                        <option value="6">d6</option>
                                        <option value="8">d8</option>
                                        <option value="10">d10</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sheet-row">
                                <div class="sheet-col">
                                    <label>Bonus Flat :</label>
                                    <input type="number" name="attr_bonus_flat" value="0" />
                                </div>
                                <div class="sheet-col">
                                    <label>Bonus % :</label>
                                    <input type="number" name="attr_bonus_pourcent" value="0" />
                                </div>
                            </div>
                            <button type="roll" name="roll_gain"
                                    value="&{template:gain_pa} {{name=@{nom}}} {{gain_final=[[floor((@{nb_des}d@{type_de}+@{bonus_flat}*@{nb_des})*(1+@{bonus_pourcent}/100))]]}}">
                                Gagner PA
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section Objectif -->
                    <div class="sheet-objectif-section">
                        <h4>&#129351; Objectif de l'entrainement</h4>
                        <textarea name="attr_objectif" placeholder="Décrivez l'objectif de cet entrainement..." rows="2"></textarea>
                    </div>
                </div>
            </details>
        </fieldset>

        <!-- ========== SECTION TALENTS D'ENTRAINEMENT ========== -->
        <h1>&#11088; Talents d'Entrainement</h1>
        <details class="sheet-subdetails">
            <summary class="sheet-section-title">Talents d'Entrainement</summary>
            <fieldset class="repeating_talententrainement">
                <details class="sheet-talent-block">
                    <summary class="sheet-talent-summary">
                        <div class="sheet-talent-header">
                            <input type="text" name="attr_talent_entrainement_nom" placeholder="Nom du talent d'entrainement" />
                            
                            <select name="attr_talent_entrainement_type" class="sheet-talent-type">
                                <option value="Passif">Passif</option>
                                <option value="Actif">Actif</option>
                            </select>
                        </div>
                    </summary>
                    <div class="sheet-talent-content">
                        <textarea name="attr_talent_entrainement_effet" class="sheet-effet-zone" placeholder="Effet du talent d'entrainement..."></textarea>
                    </div>
                </details>
            </fieldset>
        </details>
        
    </div>
    <!-- Fin .charsheet -->
</div>
<!-- Fin .sheet-tab-content -->


<div class="sheet-tab-content sheet-connaissance">
  <!-- Section principale des connaissances -->
  <div class="sheet-box-wrapper">
    <details class="sheet-subdetails">
      <summary class="sheet-section-title">Connaissances du personnage</summary>
      <fieldset class="repeating_connaissances">
        <div class="sheet-connaissances-group">
          <!-- Connaissance 1 -->
          <div class="sheet-connaissance-item">
            <input type="text" name="attr_type1" placeholder="Ex : Histoire..." />
            <select name="attr_niveau1">
              <option value="">—</option>
              <option value="Mineur">Mineur</option>
              <option value="Modéré">Modéré</option>
              <option value="Moyen">Moyen</option>
              <option value="Intermédiaire">Intermédiaire</option>
              <option value="Majeur">Majeur</option>
              <option value="Parfait">Parfait</option>
            </select>
          </div>
          <!-- Connaissance 2 -->
          <div class="sheet-connaissance-item">
            <input type="text" name="attr_type2" placeholder="Ex : Alchimie..." />
            <select name="attr_niveau2">
              <option value="">—</option>
              <option value="Mineur">Mineur</option>
              <option value="Modéré">Modéré</option>
              <option value="Moyen">Moyen</option>
              <option value="Intermédiaire">Intermédiaire</option>
              <option value="Majeur">Majeur</option>
              <option value="Parfait">Parfait</option>
            </select>
          </div>
          <!-- Connaissance 3 -->
          <div class="sheet-connaissance-item">
            <input type="text" name="attr_type3" placeholder="Ex : Magie ancienne..." />
            <select name="attr_niveau3">
              <option value="">—</option>
              <option value="Mineur">Mineur</option>
              <option value="Modéré">Modéré</option>
              <option value="Moyen">Moyen</option>
              <option value="Intermédiaire">Intermédiaire</option>
              <option value="Majeur">Majeur</option>
              <option value="Parfait">Parfait</option>
            </select>
          </div>
        </div>
      </fieldset>
    </details>
  </div>

  <!-- Section explicative des niveaux de connaissance -->
  <div class="sheet-box-wrapper">
    <details class="sheet-subdetails">
      <summary class="sheet-section-title"> &#128218; Guide des Niveaux de Connaissance</summary>
      
      <div class="sheet-knowledge-guide">
        <div class="sheet-knowledge-intro">
          <p class="sheet-knowledge-description">
            Chaque domaine de connaissance suit une progression hiérarchique de maîtrise, 
            reflétant le niveau d'expertise d'un personnage. Découvrez les différents niveaux 
            et les exigences pour progresser.
          </p>
        </div>

        <!-- Niveau 0 : Sans Connaissance -->
        <details class="sheet-knowledge-level sheet-level-none">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-none">0</span>
            <span class="sheet-level-name">Sans Connaissance</span>
            <span class="sheet-level-bonus">Aucun bonus</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>Le personnage n'a aucune expertise particulière dans le domaine. Ses informations sont limitées à des faits basiques accessibles à quiconque. Il peut manquer de précision lorsqu'il tente d'aborder des sujets complexes dans ce domaine.</p>
          </div>
        </details>

        <!-- Niveau 1 : Connaissance Mineure -->
        <details class="sheet-knowledge-level sheet-level-minor">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-minor">1</span>
            <span class="sheet-level-name">Connaissance Mineure</span>
            <span class="sheet-level-bonus">+1 en Savoir</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>Le personnage possède des notions de base suffisantes pour comprendre des concepts simples et accomplir des tâches élémentaires. Cependant, sa compréhension reste limitée.</p>
            <div class="sheet-progression-info">
              <strong>Progression :</strong> <span class="sheet-cost-badge">1 point de connaissance</span> pour passer au niveau suivant.
            </div>
          </div>
        </details>

        <!-- Niveau 2 : Connaissance Modérée -->
        <details class="sheet-knowledge-level sheet-level-moderate">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-moderate">2</span>
            <span class="sheet-level-name">Connaissance Modérée</span>
            <span class="sheet-level-bonus">+2 en Savoir</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>À ce niveau, le personnage a acquis une compréhension plus solide. Il est capable de gérer des tâches de complexité moyenne et de prendre des décisions éclairées.</p>
            <div class="sheet-progression-info">
              <strong>Progression :</strong> <span class="sheet-cost-badge">1 point de connaissance</span> pour passer du stade mineur à modéré.
            </div>
          </div>
        </details>

        <!-- Niveau 3 : Connaissance Moyenne -->
        <details class="sheet-knowledge-level sheet-level-average">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-average">3</span>
            <span class="sheet-level-name">Connaissance Moyenne</span>
            <span class="sheet-level-bonus">+3 en Savoir</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>Le personnage a atteint un niveau intermédiaire, lui permettant de résoudre des problèmes plus complexes. Il est considéré comme une source fiable d'information et peut accomplir des tâches de complexité moyenne à élevée.</p>
            <div class="sheet-progression-info">
              <strong>Progression :</strong> <span class="sheet-cost-badge">2 points de connaissance</span> pour atteindre ce niveau à partir du niveau modéré.
            </div>
          </div>
        </details>

        <!-- Niveau 4 : Connaissance Intermédiaire -->
        <details class="sheet-knowledge-level sheet-level-intermediate">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-intermediate">4</span>
            <span class="sheet-level-name">Connaissance Intermédiaire</span>
            <span class="sheet-level-bonus">+4 en Savoir</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>Ce niveau reflète une expertise avancée mais encore en développement. Le personnage est capable de traiter des problèmes complexes et de fournir des solutions innovantes.</p>
            <div class="sheet-progression-info">
              <strong>Progression :</strong> <span class="sheet-cost-badge">3 points de connaissance</span> pour passer du niveau moyen à intermédiaire.
            </div>
          </div>
        </details>

        <!-- Niveau 5 : Connaissance Majeure -->
        <details class="sheet-knowledge-level sheet-level-major">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-major">5</span>
            <span class="sheet-level-name">Connaissance Majeure</span>
            <span class="sheet-level-bonus">+5 en Savoir</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>Le personnage est un expert reconnu dans son domaine. Il peut gérer des tâches très complexes et est souvent consulté comme une autorité sur le sujet.</p>
            <div class="sheet-progression-info">
              <strong>Progression :</strong> <span class="sheet-cost-badge">4 points de connaissance</span> pour atteindre ce niveau.
            </div>
          </div>
        </details>

        <!-- Niveau 6 : Connaissance Parfaite -->
        <details class="sheet-knowledge-level sheet-level-perfect">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-perfect">6</span>
            <span class="sheet-level-name">Connaissance Parfaite</span>
            <span class="sheet-level-bonus">+6 en Savoir</span>
          </summary>
          <div class="sheet-knowledge-content">
            <p>Le personnage a atteint le plus haut niveau possible de maîtrise dans ce domaine. Son expertise est exceptionnelle et quasi exhaustive. Il peut résoudre des problèmes exceptionnellement difficiles et est une référence incontestée.</p>
            <div class="sheet-progression-info">
              <strong>Progression :</strong> <span class="sheet-cost-badge">5 points de connaissance</span> pour passer du niveau majeur à parfait.
            </div>
          </div>
        </details>

        <!-- Tableau récapitulatif -->
        <details class="sheet-knowledge-level sheet-level-summary">
          <summary class="sheet-knowledge-summary">
            <span class="sheet-level-badge sheet-badge-summary"></span>
            <span class="sheet-level-name">Tableau Récapitulatif</span>
            <span class="sheet-level-bonus">Progression</span>
          </summary>
          <div class="sheet-knowledge-content">
            <div class="sheet-progression-table">
              <div class="sheet-table-header">
                <div class="sheet-col-level">Niveau</div>
                <div class="sheet-col-name">Nom</div>
                <div class="sheet-col-bonus">Bonus</div>
                <div class="sheet-col-cost">Coût</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">0</div>
                <div class="sheet-col-name">Sans Connaissance</div>
                <div class="sheet-col-bonus">+0</div>
                <div class="sheet-col-cost">—</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">1</div>
                <div class="sheet-col-name">Mineure</div>
                <div class="sheet-col-bonus">+1</div>
                <div class="sheet-col-cost">1 pt</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">2</div>
                <div class="sheet-col-name">Modérée</div>
                <div class="sheet-col-bonus">+2</div>
                <div class="sheet-col-cost">1 pt</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">3</div>
                <div class="sheet-col-name">Moyenne</div>
                <div class="sheet-col-bonus">+3</div>
                <div class="sheet-col-cost">2 pts</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">4</div>
                <div class="sheet-col-name">Intermédiaire</div>
                <div class="sheet-col-bonus">+4</div>
                <div class="sheet-col-cost">3 pts</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">5</div>
                <div class="sheet-col-name">Majeure</div>
                <div class="sheet-col-bonus">+5</div>
                <div class="sheet-col-cost">4 pts</div>
              </div>
              <div class="sheet-table-row">
                <div class="sheet-col-level">6</div>
                <div class="sheet-col-name">Parfaite</div>
                <div class="sheet-col-bonus">+6</div>
                <div class="sheet-col-cost">5 pts</div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </details>
  </div>
</div>


<div class="sheet-tab-content sheet-infos">
  <div class="sheet-box-wrapper"> <!-- ENCADREMENT GLOBAL -->

    <!-- Personnalité -->
    <details class="sheet-subdetails">
      <summary class="sheet-section-title">Personnalité</summary>
      <table class="sheet-table-supplementaires">
        <tr>
          <td><label>Taille</label></td>
          <td><input type="text" name="attr_taille" /></td>
          <td><label>Activité passée</label></td>
          <td><input type="text" name="attr_activite_passee" /></td>
        </tr>
        <tr>
          <td><label>Caractère</label></td>
          <td><input type="text" name="attr_caractere" /></td>
          <td><label>Faction</label></td>
          <td><input type="text" name="attr_faction" /></td>
        </tr>
        <tr>
          <td><label>Âge</label></td>
          <td><input type="text" name="attr_age" /></td>
          <td><label>Classe initiale</label></td>
          <td><input type="text" name="attr_classe_initiale" /></td>
        </tr>
        <tr>
          <td><label>Plan d'origine</label></td>
          <td><input type="text" name="attr_plan_origine" /></td>
          <td><label>Métier</label></td>
          <td><input type="text" name="attr_metiere" /></td>
        </tr>
        <tr>
          <td colspan="4">
            <label>Chose que le personnage aime</label>
            <textarea name="attr_aime" class="expandable"></textarea>
          </td>
        </tr>
        <tr>
          <td colspan="4">
            <label>Chose que le personnage n'aime pas</label>
            <textarea name="attr_naime_pas" class="expandable"></textarea>
          </td>
        </tr>
        <tr>
          <td colspan="4">
            <label>Gimmick (s'il y en a)</label>
            <textarea name="attr_gimmick" class="expandable"></textarea>
          </td>
        </tr>
      </table>
    </details>

    <!-- Objectifs -->
    <details class="sheet-subdetails">
      <summary class="sheet-section-title">Objectif du personnage</summary>
      <table class="sheet-table-supplementaires">
        <tr>
          <td><label>Objectif principal</label></td>
          <td><input type="text" name="attr_objectif_principal" /></td>
        </tr>
        <tr>
          <td><label>Objectif secondaire</label></td>
          <td><input type="text" name="attr_objectif_secondaire" /></td>
        </tr>
      </table>
    </details>

    <!-- Histoire -->
    <details class="sheet-subdetails">
      <summary class="sheet-section-title">Histoire du personnage</summary>
      <div class="sheet-zone-histoire">
        <textarea name="attr_histoire"></textarea>
      </div>
    </details>

    <!-- CONTACTS IMPORTANTS - VERSION RESTRUCTURÉE -->
    <details class="sheet-subdetails">
      <summary class="sheet-section-title">Contacts d'aventure importants</summary>

      <fieldset class="repeating_contacts">
        <div class="sheet-double-contact">

          <!-- CONTACT 1 -->
          <details class="sheet-contact-card">
            <summary class="sheet-contact-header">
              <span class="contact-chevron">⯈</span>
              <input type="text" name="attr_contact_nom1" placeholder="Nom du contact" />
            </summary>
            <div class="sheet-contact-body">
              
              <!-- IMAGE CONTACT -->
              <div class="sheet-contact-image">
                <input type="text" name="attr_contact_image1" placeholder="URL de l'image" />
                <div class="sheet-contact-img" name="attr_contact_image1"></div>
              </div>
              
              <!-- INFORMATIONS RESTRUCTURÉES -->
              <div class="sheet-contact-infos">
                <div class="sheet-contact-field">
                  <label>Relations :</label>
                  <input type="text" name="attr_contact_relations1" placeholder="Allié, ennemi, neutre..." />
                </div>
                
                <div class="sheet-contact-field">
                  <label>Statut de l'individu :</label>
                  <input type="text" name="attr_contact_statut_individu1" placeholder="Noble, marchand, garde..." />
                </div>
                
                <div class="sheet-contact-field">
                  <label>Lieux connus :</label>
                  <input type="text" name="attr_contact_lieux1" placeholder="Taverne, palais, quartier..." />
                </div>
              </div>
              
              <!-- NOTES PERSONNAGE -->
              <div class="sheet-contact-notes">
                <label>Notes du personnage :</label>
                <textarea name="attr_contact_notes1" placeholder="Détails, secrets, informations marquantes, impressions du personnage..."></textarea>
              </div>
              
            </div>
          </details>

          <!-- CONTACT 2 -->
          <details class="sheet-contact-card">
            <summary class="sheet-contact-header">
              <span class="contact-chevron">⯈</span>
              <input type="text" name="attr_contact_nom2" placeholder="Nom du contact" />
            </summary>
            <div class="sheet-contact-body">
              
              <!-- IMAGE CONTACT -->
              <div class="sheet-contact-image">
                <input type="text" name="attr_contact_image2" placeholder="URL de l'image" />
                <div class="sheet-contact-img" name="attr_contact_image2"></div>
              </div>
              
              <!-- INFORMATIONS RESTRUCTURÉES -->
              <div class="sheet-contact-infos">
                <div class="sheet-contact-field">
                  <label>Relations :</label>
                  <input type="text" name="attr_contact_relations2" placeholder="Allié, ennemi, neutre..." />
                </div>
                
                <div class="sheet-contact-field">
                  <label>Statut de l'individu :</label>
                  <input type="text" name="attr_contact_statut_individu2" placeholder="Noble, marchand, garde..." />
                </div>
                
                <div class="sheet-contact-field">
                  <label>Lieux connus :</label>
                  <input type="text" name="attr_contact_lieux2" placeholder="Taverne, palais, quartier..." />
                </div>
              </div>
              
              <!-- NOTES PERSONNAGE -->
              <div class="sheet-contact-notes">
                <label>Notes du personnage :</label>
                <textarea name="attr_contact_notes2" placeholder="Détails, secrets, informations marquantes, impressions du personnage..."></textarea>
              </div>
              
            </div>
          </details>

        </div>
      </fieldset>
    </details>

  </div>
</div>


<div class="sheet-tab-content sheet-tableau">
  <div class="sheet-box-wrapper"> <!-- ENCADREMENT GLOBAL -->

  <!-- MISSIONS AVEC TOKENS INTÉGRÉS -->
<details class="sheet-subdetails">
  <summary class="sheet-section-title">Missions</summary>

  <div class="sheet-tableau-board">
    <fieldset class="repeating_tableaudata">
      <details class="sheet-dashboard-block">
        <summary class="sheet-dashboard-subtitle">
          <div class="sheet-subtitle-wrapper">
            <span class="chevron">▶</span>
            <input type="text" name="attr_titre_tableau" placeholder="Titre de la mission" class="sheet-mission-title" />
          </div>
        </summary>

        <div class="sheet-mission-content">
          
          <!-- INFORMATIONS GÉNÉRALES -->
          <div class="sheet-mission-section">
            <h4 class="sheet-mission-section-title">Informations générales</h4>
            
            <div class="sheet-mission-row-group">
              <!-- État et Priorité sur la même ligne -->
              <div class="sheet-mission-double-row">
                
                <div class="sheet-mission-field">
                  <label class="sheet-field-label">État</label>
                  <select name="attr_etat_mission" class="etat-mission">
                    <option value="en-cours">En cours</option>
                    <option value="reussie">Réussie</option>
                    <option value="echec">Échec</option>
                    <option value="abandonnee">Abandonnée</option>
                  </select>
                </div>
                
                <div class="sheet-mission-field">
                  <label class="sheet-field-label">Priorité</label>
                  <select name="attr_priorite" class="priority-selector">
                    <option value="">—</option>
                    <option value="basse">Basse</option>
                    <option value="normale">Normale</option>
                    <option value="urgente">Urgente</option>
                    <option value="critique">Critique</option>
                  </select>
                </div>
                
              </div>

              <!-- Dates sur la même ligne -->
              <div class="sheet-mission-double-row">
                <div class="sheet-mission-field">
                  <label class="sheet-field-label">Date d'obtention</label>
                  <input type="text" name="attr_date_obtention" placeholder="12/06/2025" class="sheet-date-input" />
                </div>
                
                <div class="sheet-mission-field">
                  <label class="sheet-field-label">Date de fin</label>
                  <input type="text" name="attr_date_fin" placeholder="20/07/2025" class="sheet-date-input" />
                </div>
              </div>
            </div>
          </div>

          <!-- OBJECTIFS ACCOMPLIS EN GRILLE -->
          <div class="sheet-mission-section">
            <h4 class="sheet-mission-section-title">Objectifs accomplis</h4>
            
            <div class="sheet-mission-objectives">
              
              <!-- LIGNE 1 : Missions de combat/action -->
              <div class="sheet-objectives-row">
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj1" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission d'élimination</span>
                </label>
                
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj2" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission de mercenariat</span>
                </label>
                
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj3" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission d'escorte</span>
                </label>
              </div>
              
              <!-- LIGNE 2 : Missions d'investigation/sociale -->
              <div class="sheet-objectives-row">
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj4" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission d'enquête</span>
                </label>
                
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj5" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission de recherche</span>
                </label>
                
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj6" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission de sauvetage</span>
                </label>
              </div>
              
              <!-- LIGNE 3 : Missions spécialisées -->
              <div class="sheet-objectives-row">
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj7" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Mission de métier</span>
                </label>
                
                <label class="sheet-objective-item">
                  <input type="checkbox" name="attr_obj8" />
                  <span class="checkmark"></span>
                  <span class="objective-text">Autre mission</span>
                </label>
                
                <!-- Espace équilibrant -->
                <div class="sheet-objective-spacer"></div>
              </div>
              
            </div>
          </div>

          <!-- NOTES DE MISSION -->
          <div class="sheet-mission-section">
            <h4 class="sheet-mission-section-title">Notes de mission</h4>
            <div class="sheet-mission-notes-wrapper">
              <textarea name="attr_notes_mission" 
                        class="sheet-mission-notes" 
                        placeholder="Déroulement, complications, éléments marquants, récompenses obtenues, contacts rencontrés..."></textarea>
            </div>
          </div>

        </div>
      </details>
    </fieldset>
  </div>
</details>
    <!--  ZONE : NOTES GÉNÉRALES -->
<details class="sheet-subdetails">
  <summary class="sheet-section-title">Notes générales</summary>

  <div class="sheet-tableau-board">
    <fieldset class="repeating_notegenerale">
      <details class="sheet-dashboard-block">
        <summary class="sheet-dashboard-subtitle">
          <div class="sheet-subtitle-wrapper">
            <span class="chevron"></span>
            <input type="text" name="attr_titre_note" placeholder="Titre de la note (ex : PNJ, lieu, secret...)" />
          </div>
        </summary>

        <div class="sheet-dashboard-row">
          <textarea name="attr_contenu_note" class="sheet-dashboard-text" placeholder="Contenu de la note..."></textarea>
        </div>
      </details>
    </fieldset>
  </div>
</details>

  </div>
  
</div>


<div class="sheet-tab-content sheet-metier">
    
    <!-- INPUTS RADIO REPOSITIONNÉS AU DÉBUT POUR LES SÉLECTEURS CSS -->
    <input type="radio" name="attr_grade_niveau" value="1" class="sheet-grade-radio" id="grade1" />
    <input type="radio" name="attr_grade_niveau" value="2" class="sheet-grade-radio" id="grade2" />
    <input type="radio" name="attr_grade_niveau" value="3" class="sheet-grade-radio" id="grade3" />
    <input type="radio" name="attr_grade_niveau" value="4" class="sheet-grade-radio" id="grade4" />
    <input type="radio" name="attr_grade_niveau" value="5" class="sheet-grade-radio" id="grade5" />

    <div class="sheet-metier-block">

        <!-- === ZONE DE MÉTIER === -->
        <details class="sheet-box-wrapper" open>
            <summary class="sheet-section-title">Zone de Métier</summary>
            
            <div class="sheet-metier-info-grid">
                <div>
                    <label>Nom du métier de base :</label>
                    <input type="text" name="attr_metier_base" placeholder="ex: Forgeron" />
                </div>
                <div>
                    <label>Métier de grade actuel :</label>
                    <input type="text" name="attr_metier_grade_actuel" placeholder="ex: Maître Forgeron" />
                </div>
            </div>

            <!-- Expérience avec barre de progression visuelle (SANS BOUTONS +/-) -->
            <div class="sheet-experience-bar">
                <label class="sheet-inline-label">Expérience :</label>
                
                <!-- Inputs SANS boutons +/- -->
                <div class="sheet-exp-inputs-container">
                    <div class="sheet-exp-input-group">
                        <input type="number" name="attr_experience_actuelle" class="sheet-experience-input" placeholder="0" min="0" />
                    </div>
                    
                    <span class="sheet-exp-separator">/</span>
                    
                    <div class="sheet-exp-input-group">
                        <input type="number" name="attr_experience_max" class="sheet-experience-input" placeholder="100" min="1" />
                        <span class="sheet-exp-unit">PE</span>
                    </div>
                </div>
                
                <!-- BARRE DE PROGRESSION INTÉGRÉE -->
                <div class="sheet-exp-progress-container">
                    <div class="sheet-exp-progress-bar">
                        <!-- Champs cachés pour les calculs -->
                        <input type="hidden" name="attr_exp_percentage" value="0" />
                        <input type="hidden" name="attr_exp_color_zone" value="critical" />
                        <input type="hidden" name="attr_exp_display" value="0/100 (0%)" />
                        
                        <!-- Fond avec graduations -->
                        <div class="sheet-exp-progress-background">
                            <div class="sheet-exp-graduation exp-25">25%</div>
                            <div class="sheet-exp-graduation exp-50">50%</div>
                            <div class="sheet-exp-graduation exp-75">75%</div>
                        </div>
                        
                        <!-- Barre de remplissage -->
                        <div class="sheet-exp-progress-fill"></div>
                        
                        <!-- Texte superposé -->
                        <div class="sheet-exp-progress-text">
                            <span name="attr_exp_text_display">0/100 PE (0%)</span>
                        </div>
                    </div>
                    
                    <!-- Indicateur de progression vers le niveau suivant -->
                    <div class="sheet-exp-level-indicator">
                        <span class="sheet-exp-level-text">Vers niveau supérieur</span>
                    </div>
                </div>
            </div>

        </details>

        <!-- === SYSTÈME DE GRADES === -->
        <details class="sheet-box-wrapper" open>
            <summary class="sheet-section-title">Système de Grades</summary>
            
            <label>Sélectionnez votre niveau de grade :</label>
            <div class="sheet-metier-grades">
                <div class="sheet-grade-step">
                    <label for="grade1" class="sheet-grade-checkbox">
                        <span class="sheet-grade-number">1</span>
                        <span class="sheet-grade-label">Apprenti</span>
                    </label>
                </div>
                
                <div class="sheet-grade-step">
                    <label for="grade2" class="sheet-grade-checkbox">
                        <span class="sheet-grade-number">2</span>
                        <span class="sheet-grade-label">Confirmé</span>
                    </label>
                </div>
                
                <div class="sheet-grade-step">
                    <label for="grade3" class="sheet-grade-checkbox">
                        <span class="sheet-grade-number">3</span>
                        <span class="sheet-grade-label">Compagnon</span>
                    </label>
                </div>
                
                <div class="sheet-grade-step">
                    <label for="grade4" class="sheet-grade-checkbox">
                        <span class="sheet-grade-number">4</span>
                        <span class="sheet-grade-label">Expert</span>
                    </label>
                </div>
                
                <div class="sheet-grade-step">
                    <label for="grade5" class="sheet-grade-checkbox">
                        <span class="sheet-grade-number">5</span>
                        <span class="sheet-grade-label">Maître</span>
                    </label>
                </div>
            </div>
        </details>

        <!-- === MISSIONS === -->
        <details class="sheet-box-wrapper sheet-animated-section">
            <summary class="sheet-section-title">Missions</summary>

            <!-- Mission Hebdomadaire -->
<div class="sheet-mission-hebdo">
    <label>Mission Hebdomadaire</label>
    <div class="sheet-mission-hebdo-grid">
        <input type="text" name="attr_mission_hebdo" placeholder="Description de la mission hebdomadaire" />
        <input type="text" name="attr_mission_hebdo_pe" placeholder="PE" />
    </div>
    
    <!-- NOUVELLE ZONE DE TEXTE POUR ÉCRIRE LES MISSIONS -->
    <div class="sheet-mission-hebdo-details">
        <label>Détails des missions :</label>
        <textarea name="attr_mission_hebdo_details" placeholder="Écrivez ici les détails de vos missions hebdomadaires..."></textarea>
    </div>
</div>

            <!-- Missions Spéciales -->
<label>Missions Spéciales</label>
<fieldset class="repeating_missionsspeciales">
    <details class="sheet-mission-special">
        <summary class="sheet-mission-summary">
            <span class="sheet-mission-arrow">▶</span>
            <input type="text" name="attr_mission_nom" placeholder="Nom de la mission" />
        </summary>
        <div class="sheet-mission-content">
            <!-- ACTION EN PLEINE LARGEUR -->
            <div class="sheet-mission-action-section">
                <label>Action :</label>
                <textarea name="attr_mission_action" placeholder="Que faut-il faire ?"></textarea>
            </div>
            
            <!-- STATISTIQUES SUR UNE SEULE LIGNE - 4 COLONNES -->
            <div class="sheet-mission-stats-grid">
                <div class="sheet-mission-stat-item">
                    <label>Gain XPM :</label>
                    <input type="text" name="attr_mission_gain_xpm" placeholder="5" />
                </div>
                <div class="sheet-mission-stat-item">
                    <label>Nb fois :</label>
                    <input type="text" name="attr_mission_nb_fois" placeholder="2x" />
                </div>
                <div class="sheet-mission-stat-item">
                    <label>Points requis :</label>
                    <input type="text" name="attr_mission_points_requis" placeholder="10" />
                </div>
                <div class="sheet-mission-stat-item">
                    <label>Récompense spéciale :</label>
                    <input type="text" name="attr_mission_recompense_speciale" placeholder="Objet rare..." />
                </div>
            </div>
        </div>
    </details>
</fieldset>
        </details>

        <!-- === TALENTS DE MÉTIER === -->
        <details class="sheet-box-wrapper sheet-animated-section">
            <summary class="sheet-section-title">Talents de Métier</summary>

            <!-- Talents de Métier Standards -->
            <div class="sheet-talent-section">
                <label>Talents de Métier</label>
                <fieldset class="repeating_talentsmetier">
                    <div class="sheet-talent-grid">
                        <details class="sheet-talent-detail">
                            <summary class="sheet-talent-summary">
                                <span class="sheet-talent-arrow">▶</span>
                                <input type="text" name="attr_talent_nom_1" placeholder="Nom du talent 1" />
                            </summary>
                            <div class="sheet-talent-content">
                                <textarea name="attr_talent_effet_1" placeholder="Effet et description du talent..."></textarea>
                            </div>
                        </details>
                        
                        <details class="sheet-talent-detail">
                            <summary class="sheet-talent-summary">
                                <span class="sheet-talent-arrow">▶</span>
                                <input type="text" name="attr_talent_nom_2" placeholder="Nom du talent 2" />
                            </summary>
                            <div class="sheet-talent-content">
                                <textarea name="attr_talent_effet_2" placeholder="Effet et description du talent..."></textarea>
                            </div>
                        </details>
                        
                        <details class="sheet-talent-detail">
                            <summary class="sheet-talent-summary">
                                <span class="sheet-talent-arrow">▶</span>
                                <input type="text" name="attr_talent_nom_3" placeholder="Nom du talent 3" />
                            </summary>
                            <div class="sheet-talent-content">
                                <textarea name="attr_talent_effet_3" placeholder="Effet et description du talent..."></textarea>
                            </div>
                        </details>
                    </div>
                </fieldset>
            </div>

            <!-- Talents de Grade -->
            <div class="sheet-talent-section">
                <label>Talents de Grade</label>
                <fieldset class="repeating_talentsgrade">
                    <div class="sheet-talent-grid">
                        <details class="sheet-talent-detail sheet-talent-grade-detail">
                            <summary class="sheet-talent-summary">
                                <span class="sheet-talent-arrow">▶</span>
                                <input type="text" name="attr_talent_grade_nom_1" placeholder="Nom du talent de grade 1" />
                            </summary>
                            <div class="sheet-talent-content">
                                <textarea name="attr_talent_grade_effet_1" placeholder="Effet et description du talent de grade..."></textarea>
                            </div>
                        </details>
                        
                        <details class="sheet-talent-detail sheet-talent-grade-detail">
                            <summary class="sheet-talent-summary">
                                <span class="sheet-talent-arrow">▶</span>
                                <input type="text" name="attr_talent_grade_nom_2" placeholder="Nom du talent de grade 2" />
                            </summary>
                            <div class="sheet-talent-content">
                                <textarea name="attr_talent_grade_effet_2" placeholder="Effet et description du talent de grade..."></textarea>
                            </div>
                        </details>
                        
                        <details class="sheet-talent-detail sheet-talent-grade-detail">
                            <summary class="sheet-talent-summary">
                                <span class="sheet-talent-arrow">▶</span>
                                <input type="text" name="attr_talent_grade_nom_3" placeholder="Nom du talent de grade 3" />
                            </summary>
                            <div class="sheet-talent-content">
                                <textarea name="attr_talent_grade_effet_3" placeholder="Effet et description du talent de grade..."></textarea>
                            </div>
                        </details>
                    </div>
                </fieldset>
            </div>
        </details>

        <!-- === PASSIFS ET CAPACITÉS === -->
        <details class="sheet-box-wrapper sheet-animated-section">
            <summary class="sheet-section-title">Passifs & Capacités de Métier</summary>

            <fieldset class="repeating_passifsmetier">
                <div class="sheet-passif-item">
                    <div class="sheet-passif-header">
                        <input type="text" name="attr_passif_nom" placeholder="Nom du passif ou capacité" />
                        <input type="text" name="attr_passif_cout" placeholder="Coût PE" />
                    </div>
                    <textarea name="attr_passif_effet" placeholder="Description de l'effet du passif ou de la capacité..."></textarea>
                </div>
            </fieldset>
        </details>

        <!-- === TITRES DE MÉTIER (NOMS CORRIGÉS) === -->
        <details class="sheet-box-wrapper sheet-exploit-section sheet-animated-section">
            <summary class="sheet-section-title">Titres de Métier</summary>
            
            <div class="sheet-exploit-container">
                <p class="sheet-exploit-desc">Vos titres et réalisations marquantes dans votre métier :</p>
                <div class="sheet-exploit-grade-info">
                    <strong>Disponible à partir du grade Compagnon (niveau 3)</strong>
                </div>
                
                <!-- === TITRE ACTUEL (READONLY AVEC TRACKING) === -->
                <div class="sheet-titre-section">
                    <h4 class="sheet-titre-section-header">Titre Actuel</h4>
                    <div class="sheet-titre-actuel">
                        <!-- Champ caché pour tracker l'ID de la section sélectionnée -->
                        <input type="hidden" name="attr_titre_actuel_section_id" value="" />
                        
                        <div class="sheet-titre-header">
                            <input type="text" name="attr_titre_actuel_nom" placeholder="Aucun titre sélectionné" readonly />
                        </div>
                        <div class="sheet-titre-content">
                            <label>Effet du titre :</label>
                            <textarea name="attr_titre_actuel_effet" placeholder="Aucun effet actif..." readonly></textarea>
                        </div>
                    </div>
                </div>

                <!-- === TITRES OBTENUS DURANT L'AVENTURE (NOM CORRIGÉ) === -->
                <details class="sheet-titre-section sheet-titre-aventure-section">
                    <summary class="sheet-titre-section-header-collapsible">Titres Obtenus durant l'aventure</summary>
                    
                    <!-- Information explicative -->
                    <div class="sheet-titre-aventure-info">
                        <p><strong>Instructions :</strong> Cochez la case "Titre Actuel" pour activer automatiquement un titre. Les informations seront transférées instantanément dans la section "Titre Actuel" ci-dessus. Un seul titre peut être actif à la fois.</p>
                    </div>
                    
                    <!-- CORRECTION PRINCIPALE : nom de section cohérent -->
                    <fieldset class="repeating_titresaventure">
                        <div class="sheet-titre-aventure">
                            <div class="sheet-titre-select-header">
                                <!-- CHECKBOX OPTIMISÉE pour sélection unique -->
                                <input type="checkbox" name="attr_titre_actuel_selected" class="sheet-titre-radio" value="1" />
                                <span class="sheet-titre-checkbox-label">Titre Actuel</span>
                                <input type="text" name="attr_titre_aventure_nom" placeholder="Nom du titre obtenu" />
                            </div>
                            <div class="sheet-titre-content">
                                <label>Effet du titre :</label>
                                <textarea name="attr_titre_aventure_effet" placeholder="Description de l'effet du titre..."></textarea>
                            </div>
                        </div>
                    </fieldset>
                </details>

                <!-- === OBTENTION DE TITRE (DÉPLIABLE) === -->
                <details class="sheet-titre-section sheet-obtention-section">
                    <summary class="sheet-titre-section-header-collapsible">Obtention de Titre</summary>
                    <fieldset class="repeating_obtentiontitres">
                        <div class="sheet-obtention-titre">
                            <!-- Voie et Titre Obtenable -->
                            <div class="sheet-obtention-header">
                                <div class="sheet-voie-info">
                                    <label>Voie du :</label>
                                    <input type="text" name="attr_voie_metier" placeholder="Forgeron" />
                                </div>
                                <div class="sheet-titre-obtenable">
                                    <label>Titre Obtenable :</label>
                                    <input type="text" name="attr_titre_obtenable" placeholder="« Maître de Tout acier »" />
                                </div>
                                <div class="sheet-cout-achat">
                                    <label>Coût d'achat :</label>
                                    <input type="text" name="attr_cout_achat" placeholder="20 xp" />
                                </div>
                            </div>

                            <!-- Conditions -->
                            <div class="sheet-conditions">
                                <label>Condition :</label>
                                <textarea name="attr_conditions" placeholder="avoir le grade lv 2 du métier de forgeron et avoir le talent de métier « Amour de la forge »"></textarea>
                            </div>

                            <!-- Missions -->
                            <div class="sheet-missions-titre">
                                <!-- Première Mission -->
                                <div class="sheet-mission-titre">
                                    <div class="sheet-mission-numero">Première mission :</div>
                                    <textarea name="attr_premiere_mission" placeholder="Description de la première mission..."></textarea>
                                    <div class="sheet-mission-recompense">
                                        <label>Récompense :</label>
                                        <input type="text" name="attr_premiere_recompense" placeholder="25 points d'expérience" />
                                    </div>
                                </div>

                                <!-- Deuxième Mission -->
                                <div class="sheet-mission-titre">
                                    <div class="sheet-mission-numero">Deuxième mission :</div>
                                    <textarea name="attr_deuxieme_mission" placeholder="Description de la deuxième mission..."></textarea>
                                    <div class="sheet-mission-recompense">
                                        <label>Récompense :</label>
                                        <input type="text" name="attr_deuxieme_recompense" placeholder="1 point de destin ou 1 amélioration de deux niveau d'un talent de métier au choix" />
                                    </div>
                                </div>

                                <!-- Troisième Mission -->
                                <div class="sheet-mission-titre">
                                    <div class="sheet-mission-numero">Troisième mission :</div>
                                    <textarea name="attr_troisieme_mission" placeholder="Description de la troisième mission..."></textarea>
                                    <div class="sheet-mission-recompense">
                                        <label>Récompense :</label>
                                        <input type="text" name="attr_troisieme_recompense" placeholder="Titre « Maître de Tout acier »" />
                                    </div>
                                </div>
                            </div>

                            <!-- Effet du Titre Final -->
                            <div class="sheet-effet-titre-final">
                                <label>Effet du titre :</label>
                                <div class="sheet-titre-final-content">
                                    <input type="text" name="attr_titre_final_nom" placeholder="Maître de tout acier" />
                                    <textarea name="attr_titre_final_effet" placeholder="Description de l'effet du titre final..."></textarea>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </details>
                
            </div>
        </details>

    </div>
</div>


</div>
</div>


<div class="sheet-tab-content sheet-corruption">
<!-- ==================== PAGE VERROUILLÉE DLC ==================== -->
<div class="sheet-dlc-locked-container">
  
  <!-- Cadenas décoratifs dans les coins -->
  <div class="sheet-dlc-lock sheet-dlc-lock-topleft">&#128274;</div>
  <div class="sheet-dlc-lock sheet-dlc-lock-topright">&#128274;</div>
  <div class="sheet-dlc-lock sheet-dlc-lock-bottomleft">&#128274;</div>
  <div class="sheet-dlc-lock sheet-dlc-lock-bottomright">&#128274;</div>
  
  <!-- Cadenas central principal -->
  <div class="sheet-dlc-lock-central">
    <div class="sheet-dlc-lock-icon">&#128272;</div>
    <div class="sheet-dlc-lock-chain">&#9939;&#65039;</div>
  </div>
  
  <!-- Message principal -->
  <div class="sheet-dlc-message-box">
    <div class="sheet-dlc-title">CONTENU VERROUILLÉ</div>
    <div class="sheet-dlc-subtitle">Indisponible pour le moment</div>
    <div class="sheet-dlc-text">Attendez que le DLC sorte</div>
    <div class="sheet-dlc-coming-soon">&#127922; Bientôt disponible &#127922;</div>
  </div>
  
  <!-- Overlay de scellement -->
  <div class="sheet-dlc-overlay"></div>
  
</div>
<!-- FIN PAGE VERROUILLÉE -->
</div>


<!-- ========================================
     ONGLET ÉVOLUTION VAMPIRIQUE - ROLL20
     VERSION 2.4 CORRIGÉE - Boutons et checkboxes fonctionnels
     ======================================== -->

<!-- CONTENU DE L'ONGLET ÉVOLUTION -->
<div class="sheet-tab-content sheet-voie-sanguinaire">
  <div class="sheet-box-wrapper">
    
    <!-- ========== INPUTS CACHÉS POUR LA PROGRESSION ========== -->
    <input type="number" name="attr_progression_percentage" value="0" class="sheet-hidden" />
    <input type="number" name="attr_progression_completed_steps" value="0" class="sheet-hidden" />
    <input type="number" name="attr_progression_current_tier" value="1" class="sheet-hidden" />

    <!-- Radio buttons pour contrôler l'affichage des tiers (0 = aucun, 1-7 = tier complété) -->
    <input type="radio" name="attr_progression_tier_display" value="0" class="sheet-hidden" checked />
    <input type="radio" name="attr_progression_tier_display" value="1" class="sheet-hidden" />
    <input type="radio" name="attr_progression_tier_display" value="2" class="sheet-hidden" />
    <input type="radio" name="attr_progression_tier_display" value="3" class="sheet-hidden" />
    <input type="radio" name="attr_progression_tier_display" value="4" class="sheet-hidden" />
    <input type="radio" name="attr_progression_tier_display" value="5" class="sheet-hidden" />
    <input type="radio" name="attr_progression_tier_display" value="6" class="sheet-hidden" />
    <input type="radio" name="attr_progression_tier_display" value="7" class="sheet-hidden" />

    <input type="checkbox" name="attr_progression_has_warning" value="1" class="sheet-hidden" />
    <input type="text" name="attr_progression_last_label" value="Aucune progression" class="sheet-hidden" />
    <input type="text" name="attr_progression_warning_message" value="" class="sheet-hidden" />
    
    <!-- ========== BARRE DE PROGRESSION VERTICALE ========== -->
    <div class="sheet-progression-bar-container">
      <div class="sheet-progression-bar-wrapper">
        
        <!-- Barre de fond grise -->
        <div class="sheet-progression-bar-background"></div>
        
        <!-- Barre continue remplie selon le nombre d'étapes complétées -->
        <div class="sheet-progression-bars">
          <div class="sheet-progression-fill"></div>
        </div>
        
        <!-- Marqueurs de paliers -->
        <div class="sheet-tier-markers">
          <div class="sheet-tier-marker" data-tier="1" title="Palier 1 : Goule (0-20)">1</div>
          <div class="sheet-tier-marker" data-tier="2" title="Palier 2 : Vampire Nouveau-né (21-40)">2</div>
          <div class="sheet-tier-marker" data-tier="3" title="Palier 3 : Vampire (41-65)">3</div>
          <div class="sheet-tier-marker" data-tier="4" title="Palier 4 : Vampire Aguerri (66-90)">4</div>
          <div class="sheet-tier-marker" data-tier="5" title="Palier 5 : Vampire Ancien (91-130)">5</div>
          <div class="sheet-tier-marker" data-tier="6" title="Palier 6 : Vampire Seigneur (131-165)">6</div>
          <div class="sheet-tier-marker" data-tier="7" title="Palier 7 : Seigneur Vampire (165-250)">7</div>
        </div>
        
        <!-- Indicateur de progression -->
        <div class="sheet-progression-indicator">
          <div class="sheet-progression-percent">
            <span name="attr_progression_percentage">0</span>%
          </div>
          <div class="sheet-progression-text">
            <span name="attr_progression_last_label">Aucune progression</span>
          </div>
          <div class="sheet-progression-warning">
            &#9888; Choix manquants
          </div>
          <div class="sheet-progression-stats">
            Étape <span name="attr_progression_completed_steps">0</span>/37
          </div>
        </div>
        
      </div>
    </div>

    <!-- ========== HEADER VAMPIRIQUE ========== -->
    <div class="sheet-vampire-header">
      <h2 class="sheet-vampire-title">&#9790; Arbre d'Évolution Vampirique &#9790;</h2>
      <p class="sheet-vampire-subtitle">De Goule Maudite à Seigneur des Ténèbres</p>
    </div>





    <!-- ========== SECTION 1 : SUIVI DES RESSOURCES ========== -->
    <div class="sheet-section-title-vampire">&#9829; Ressources d'Évolution</div>
    
    <div class="sheet-evolution-resources">
      <div class="sheet-evolution-resources-inner">
        <table class="sheet-pv-table">
          <colgroup>
            <col class="sheet-col-ressource" />
            <col class="sheet-col-valeur" />
            <col class="sheet-col-info" />
          </colgroup>
          <thead>
            <tr>
              <th>Ressource</th>
              <th>Valeur<br />actuelle</th>
              <th>Informations</th>
            </tr>
          </thead>
          <tbody>
            <!-- Points de Sangsure -->
            <tr class="sheet-blood-row">
              <td class="sheet-stat-label">
                <span class="sheet-stat-icon">&#9829;</span>
                <span class="sheet-stat-text">Points de Sangsure</span>
              </td>
              <td class="sheet-stat-value">
                <input type="number" name="attr_sangsure_points" value="0" min="0" max="250" />
              </td>
              <td class="sheet-info-cell">
                <div class="sheet-info-line">
                  <span class="sheet-info-label">Palier :</span>
                  <input type="text" name="attr_sangsure_palier" readonly class="sheet-palier-display" />
                  <span class="sheet-info-separator">—</span>
                  <span class="sheet-info-label">Niveau :</span>
                  <input type="text" name="attr_sangsure_niveau" readonly class="sheet-niveau-display" />
                </div>
              </td>
            </tr>

            <!-- Larmes de Sang -->
            <tr class="sheet-tears-row">
              <td class="sheet-stat-label">
                <span class="sheet-stat-icon">&#9830;</span>
                <span class="sheet-stat-text">Larmes de Sang (LS)</span>
              </td>
              <td class="sheet-stat-value">
                <input type="number" name="attr_larmes_sang" value="0" min="0" />
              </td>
              <td class="sheet-info-cell">
                <div class="sheet-info-line">
                  Monnaie spéciale pour la boutique d'Alucarne
                </div>
              </td>
            </tr>

            <!-- Taux de Rage -->
            <tr class="sheet-rage-row">
              <td class="sheet-stat-label">
                <span class="sheet-stat-icon">&#9889;</span>
                <span class="sheet-stat-text">Taux de Rage (%)</span>
              </td>
              <td class="sheet-stat-value">
                <input type="number" name="attr_taux_rage_base" value="50" step="1" />
              </td>
              <td class="sheet-info-cell">
                <div class="sheet-info-line">
                  <span class="sheet-info-label">Modifié :</span>
                  <input type="number" name="attr_taux_rage_total" readonly class="sheet-rage-display" />
                  <span class="sheet-info-suffix">%</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>








<!-- ========== SECTION 1bis : OBTENTION DES POINTS D'ÉVOLUTION ========== -->
<details class="sheet-obtention-wrapper" open>
  <summary class="sheet-section-title-vampire">
    &#9878; Obtention des Points d'Évolution
  </summary>

  <div class="sheet-obtention-section">

    <!-- ============================
         CATÉGORIE : GOULE
         ============================ -->
    <div class="sheet-obtention-block">
      <div class="sheet-obtention-header">
        <span class="sheet-obtention-title">Catégorie : Goule</span>
        <div class="sheet-obtention-header-buttons">
          <button type="action" name="act_goule_obtention_roll" class="sheet-obtention-roll-button">
            &#9856; Lancer les jets
          </button>
          <button type="action" name="act_goule_gain_roll" class="sheet-obtention-gain-button">
            &#9873; Gains de points
          </button>
          <button type="action" name="act_obtention_reset_ps" class="sheet-obtention-reset-button">
            &#10006; Réinitialiser
          </button>
        </div>
      </div>

      <table class="sheet-obtention-table">
        <thead>
          <tr>
            <th>Méthode</th>
            <th>Condition d'obtention</th>
            <th>PS (Points de Sangsure)</th>
            <th>LS (Larmes de Sang)</th>
          </tr>
        </thead>

        <tbody>

  <!-- 1. Consommation de Sang -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_cons_sang_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Consommation de Sang</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_cons_sang_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En buvant le sang de ses victimes mortes récemment, la goule renforce son pouvoir.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_cons_sang_ps_chance" value="60" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_cons_sang_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_cons_sang_ls_chance" value="70" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_cons_sang_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_cons_sang_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">

          <!-- PS -->
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>

            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_cons_sang_ps_jet" value="1" />
            </div>

            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>

            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_cons_sang_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>

            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_cons_sang_ps_bonus_flat" value="0" />
            </div>
          </div>

          <!-- LS -->
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>

            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_cons_sang_ls_jet" value="1d3" />
            </div>

            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>

            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_cons_sang_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>

            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_cons_sang_ls_bonus_flat" value="0" />
            </div>
          </div>

        </div>
      </div>
    </td>
  </tr>

  <!-- 2. Absorption de Sang au Combat -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_absorb_combat_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Absorption de Sang au Combat</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_absorb_combat_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      Une morsure critique en combat permet à la goule de drainer la force vitale de sa proie.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_absorb_combat_ps_chance" value="25" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_absorb_combat_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_absorb_combat_ls_chance" value="35" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_absorb_combat_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_absorb_combat_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_absorb_combat_ps_jet" value="1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_absorb_combat_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_absorb_combat_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_absorb_combat_ls_jet" value="1d2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_absorb_combat_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_absorb_combat_ls_bonus_flat" value="0" />
            </div>
          </div>

        </div>
      </div>
    </td>
  </tr>

  <!-- 3. Inhalation de Sang Pestilentiel -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_inhalation_pest_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Inhalation de Sang Pestilentiel</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_inhalation_pest_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      Boire le sang d'une créature infectée augmente la puissance de la goule, avec un risque de contamination.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_inhalation_pest_ps_chance" value="35" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_inhalation_pest_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_inhalation_pest_ls_chance" value="45" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_inhalation_pest_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_inhalation_pest_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_inhalation_pest_ps_jet" value="2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_inhalation_pest_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_inhalation_pest_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_inhalation_pest_ls_jet" value="2d2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_inhalation_pest_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_inhalation_pest_ls_bonus_flat" value="0" />
            </div>
          </div>

        </div>
      </div>
    </td>
  </tr>

  <!-- 4. Chasse Nocturne -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_chasse_nocturne_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Chasse Nocturne</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_chasse_nocturne_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En chassant sous la lune, la goule se connecte aux énergies nocturnes.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_chasse_nocturne_ps_chance" value="35" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_chasse_nocturne_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_chasse_nocturne_ls_chance" value="45" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_chasse_nocturne_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_chasse_nocturne_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_chasse_nocturne_ps_jet" value="1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_chasse_nocturne_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_chasse_nocturne_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_chasse_nocturne_ls_jet" value="1d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_chasse_nocturne_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_chasse_nocturne_ls_bonus_flat" value="0" />
            </div>
          </div>

        </div>
      </div>
    </td>
  </tr>

  <!-- 5. Victoire dans un Combat Difficile -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_combat_difficile_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Victoire dans un Combat Difficile</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_combat_difficile_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En vainquant des ennemis dotés de capacités sombres, la goule peut puiser de la puissance.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_combat_difficile_ps_chance" value="55" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_combat_difficile_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_combat_difficile_ls_chance" value="65" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_combat_difficile_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_combat_difficile_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_combat_difficile_ps_jet" value="1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_combat_difficile_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_combat_difficile_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_combat_difficile_ls_jet" value="1d3+2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_combat_difficile_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_combat_difficile_ls_bonus_flat" value="0" />
            </div>
          </div>

        </div>
      </div>
    </td>
  </tr>

  <!-- 6. Fête Sanglante -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_fete_sanglante_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Fête Sanglante</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_fete_sanglante_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En massacrant un groupe d'humanoïdes faibles, la goule obtient de l'énergie.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_fete_sanglante_ps_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_fete_sanglante_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_fete_sanglante_ls_chance" value="60" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_fete_sanglante_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_fete_sanglante_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_fete_sanglante_ps_jet" value="1d2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_fete_sanglante_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_fete_sanglante_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_fete_sanglante_ls_jet" value="2d3+1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_fete_sanglante_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_fete_sanglante_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 7. Dévorer un Cœur Battant -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_coeur_battant_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Dévorer un Cœur Battant</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_coeur_battant_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En arrachant et dévorant le cœur d'une créature vivante, la goule absorbe son énergie vitale.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_coeur_battant_ps_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_coeur_battant_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_coeur_battant_ls_chance" value="60" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_coeur_battant_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_coeur_battant_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_coeur_battant_ps_jet" value="1d2+1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_coeur_battant_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_coeur_battant_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_coeur_battant_ls_jet" value="1d4+3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_coeur_battant_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_coeur_battant_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 8. Absorption dans une Crypte Maudite -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_crypte_maudite_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Absorption dans une Crypte Maudite</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_crypte_maudite_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En passant la nuit dans une crypte chargée de magie noire, la goule se renforce.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_crypte_maudite_ps_chance" value="55" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_crypte_maudite_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_crypte_maudite_ls_chance" value="65" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_crypte_maudite_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_crypte_maudite_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_crypte_maudite_ps_jet" value="1d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_crypte_maudite_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_crypte_maudite_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_crypte_maudite_ls_jet" value="1d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_crypte_maudite_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_crypte_maudite_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 9. Récupération via un Pacte Sombre -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_goule_pacte_sombre_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Récupération via un Pacte Sombre</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_goule_pacte_sombre_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En servant un vampire ou un nécromancien puissant, la goule reçoit une récompense d'énergie sombre.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_pacte_sombre_ps_chance" value="60" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_pacte_sombre_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_goule_pacte_sombre_ls_chance" value="75" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_goule_pacte_sombre_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_goule_pacte_sombre_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_pacte_sombre_ps_jet" value="2d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_pacte_sombre_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_pacte_sombre_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_goule_pacte_sombre_ls_jet" value="3d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_goule_pacte_sombre_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_goule_pacte_sombre_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

</tbody>

      </table>
    </div>


    <!-- ============================
         CATÉGORIE : VAMPIRE
         ============================ -->
    <div class="sheet-obtention-block">
      <div class="sheet-obtention-header">
        <span class="sheet-obtention-title">Catégorie : Vampire</span>
        <div class="sheet-obtention-header-buttons">
          <button type="action" name="act_vampire_obtention_roll" class="sheet-obtention-roll-button">
            &#9856; Lancer les jets
          </button>
          <button type="action" name="act_vampire_gain_roll" class="sheet-obtention-gain-button">
            &#9873; Gains de points
          </button>
          <button type="action" name="act_obtention_reset_ps" class="sheet-obtention-reset-button">
            &#10006; Réinitialiser
          </button>
        </div>
      </div>

      <table class="sheet-obtention-table">
        <thead>
          <tr>
            <th>Méthode</th>
            <th>Condition d'obtention</th>
            <th>PS (Points de Sangsure)</th>
            <th>LS (Larmes de Sang)</th>
          </tr>
        </thead>

        <tbody>

  <!-- 1. Bénédiction des Anciens -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_benediction_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Bénédiction des Anciens</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_benediction_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      Lors d'une nouvelle lune, le vampire accomplit un rituel de communion avec ses ancêtres.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_benediction_ps_chance" value="30" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_benediction_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_benediction_ls_chance" value="40" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_benediction_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_benediction_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_benediction_ps_jet" value="2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_benediction_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_benediction_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_benediction_ls_jet" value="1d3+1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_benediction_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_benediction_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 2. Drain de Force d'une Créature Noble -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_drain_noble_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Drain de Force d'une Créature Noble</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_drain_noble_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      Boire le sang d'une créature noble ou d'une lignée puissante renforce le vampire.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_drain_noble_ps_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_drain_noble_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_drain_noble_ls_chance" value="60" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_drain_noble_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_drain_noble_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_drain_noble_ps_jet" value="2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_drain_noble_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_drain_noble_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_drain_noble_ls_jet" value="1d5+2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_drain_noble_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_drain_noble_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 3. Union de Sang avec un Allié Maudit -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_union_maudit_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Union de Sang avec un Allié Maudit</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_union_maudit_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      Sceller un pacte temporaire en échangeant du sang avec une créature maudite.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_union_maudit_ps_chance" value="45" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_union_maudit_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_union_maudit_ls_chance" value="55" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_union_maudit_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_union_maudit_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_union_maudit_ps_jet" value="2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_union_maudit_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_union_maudit_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_union_maudit_ls_jet" value="1d6" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_union_maudit_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_union_maudit_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 4. Absorption après un Duel à Mort -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_duel_mort_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Absorption après un Duel à Mort</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_duel_mort_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En tuant un vampire rival dans un duel et en buvant son sang, le vampire renforce son essence.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_duel_mort_ps_chance" value="80" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_duel_mort_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_duel_mort_ls_chance" value="90" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_duel_mort_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_duel_mort_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_duel_mort_ps_jet" value="3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_duel_mort_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_duel_mort_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_duel_mort_ls_jet" value="3d4+2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_duel_mort_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_duel_mort_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 5. Initiation d'un Nouveau Serviteur -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_nouveau_serviteur_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Initiation d'un Nouveau Serviteur</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_nouveau_serviteur_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En transformant une victime en goule ou en vampire mineur, le vampire regagne une partie de son pouvoir.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_nouveau_serviteur_ps_chance" value="40" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_nouveau_serviteur_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_nouveau_serviteur_ls_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_nouveau_serviteur_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_nouveau_serviteur_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_nouveau_serviteur_ps_jet" value="1d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_nouveau_serviteur_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_nouveau_serviteur_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_nouveau_serviteur_ls_jet" value="2d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_nouveau_serviteur_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_nouveau_serviteur_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 6. Échange de Sang entre Alliés -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_echange_allies_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Échange de Sang entre Alliés</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_echange_allies_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En partageant du sang avec un autre vampire, les alliés augmentent mutuellement leurs forces.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_echange_allies_ps_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_echange_allies_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_echange_allies_ls_chance" value="60" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_echange_allies_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_echange_allies_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_echange_allies_ps_jet" value="1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_echange_allies_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_echange_allies_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_echange_allies_ls_jet" value="1d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_echange_allies_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_echange_allies_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 7. Festin Cérémoniel sur un Lieu Maudit -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_festin_maudit_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Festin Cérémoniel sur un Lieu Maudit</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_festin_maudit_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En se nourrissant dans un lieu chargé de magie noire, le vampire amplifie le pouvoir du sang.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_festin_maudit_ps_chance" value="65" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_festin_maudit_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_festin_maudit_ls_chance" value="75" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_festin_maudit_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_festin_maudit_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_festin_maudit_ps_jet" value="2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_festin_maudit_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_festin_maudit_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_festin_maudit_ls_jet" value="1d3+1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_festin_maudit_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_festin_maudit_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 8. Infiltration dans le Rêve d'une Victime -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_reve_victime_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Infiltration dans le Rêve d'une Victime</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_reve_victime_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      En pénétrant les rêves d'une victime puis en buvant son sang, le vampire renforce sa connexion mystique.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_reve_victime_ps_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_reve_victime_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_reve_victime_ls_chance" value="55" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_reve_victime_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_reve_victime_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_reve_victime_ps_jet" value="1" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_reve_victime_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_reve_victime_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_reve_victime_ls_jet" value="2d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_reve_victime_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_reve_victime_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

  <!-- 9. Synergie Sanguine de Clan -->
  <tr class="sheet-obtention-main-row">
    <td class="sheet-obtention-method">
      <div class="sheet-obtention-method-stack">
        <label class="sheet-obtention-pick">
          <input type="checkbox" name="attr_vamp_synergie_clan_active" class="sheet-obtention-select" value="1" />
          <span class="sheet-obtention-method-btn"><strong>Synergie Sanguine de Clan</strong></span>
        </label>

        <label class="sheet-bonus-toggle-label">
          <input type="checkbox" name="attr_vamp_synergie_clan_bonus_open" class="sheet-bonus-toggle" value="1" />
          <span class="sheet-bonus-toggle-box"></span>
          <span class="sheet-bonus-toggle-text">Récompenses</span>
        </label>
      </div>
    </td>

    <td class="sheet-obtention-desc">
      Se nourrir en présence de son clan permet de partager et d'amplifier l'énergie vitale absorbée.
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_synergie_clan_ps_chance" value="40" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_synergie_clan_ps_result" value="0" min="0" readonly />
      </div>
    </td>

    <td class="sheet-obtention-col">
      <div class="sheet-obtention-inline">
        <span>Pourcentage de base</span>
        <input type="number" name="attr_vamp_synergie_clan_ls_chance" value="50" min="0" max="100" />
      </div>
      <div class="sheet-obtention-inline">
        <span>Valeur obtenue</span>
        <input type="number" name="attr_vamp_synergie_clan_ls_result" value="0" min="0" readonly />
      </div>
    </td>
  </tr>

  <tr class="sheet-obtention-bonus-row">
    <td colspan="4" class="sheet-obtention-bonus-cell">
      <input type="checkbox" name="attr_vamp_synergie_clan_bonus_open" class="sheet-bonus-master sheet-hidden" value="1" />
      <div class="sheet-bonus-content">
        <div class="sheet-bonus-grid sheet-bonus-grid-2">
          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Point Sangsure</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_synergie_clan_ps_jet" value="1d2" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_synergie_clan_ps_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_synergie_clan_ps_bonus_flat" value="0" />
            </div>
          </div>

          <div class="sheet-bonus-col">
            <div class="sheet-bonus-head">Larmes de Sang</div>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Dé (Gain)</div>
              <input type="text" name="attr_vamp_synergie_clan_ls_jet" value="1d3" />
            </div>
            <div class="sheet-bonus-sep"></div>
            <div class="sheet-bonus-subhead">Bonus direct</div>
            <label class="sheet-bonus-switch">
              <input type="checkbox" name="attr_vamp_synergie_clan_ls_bonus_on" value="1" />
              <span>Activer le bonus</span>
            </label>
            <div class="sheet-bonus-field">
              <div class="sheet-bonus-field-label">Bonus manuel</div>
              <input type="text" name="attr_vamp_synergie_clan_ls_bonus_flat" value="0" />
            </div>
          </div>
        </div>
      </div>
    </td>
  </tr>

</tbody>

      </table>
    </div>

  </div>
</details>
















    <!-- ========== SECTION 2 : PROGRESSION PAR PALIER ========== -->
    <details class="sheet-box-wrapper" open>
      <summary class="sheet-section-title-vampire">&#9876; Progression et Choix d'Évolution</summary>
      
      <!-- ============================================================
           PALIER 1 : GOULE DÉVOREUR (0-20)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-1" data-palier="1">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 1 : Goule Dévoreur (0-20 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> La goule ressent les premiers effets de sa transformation. 
            Elle devient plus robuste et ses capacités de régénération s'améliorent.
          </p>

          <!-- CHOIX DE LA SOUS-BRANCHE -->
          <div class="sheet-choice-section">
            <label class="sheet-choice-label">&#10070; Choix de Sous-Branche :</label>
            <select name="attr_palier1_branche">
              <option value="">-- Non choisi --</option>
              <option value="devoreur">Goule Dévoreur (+1 dégâts griffes/morsures)</option>
              <option value="sang">Goule de Sang (utiliser son sang comme arme)</option>
              <option value="nuit">Goule de Nuit (+3 Embuscade nocturne)</option>
            </select>
          </div>

          <!-- RÉCOMPENSES PAR SEUIL -->
          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses aux seuils de points</h4>
            
            <!-- 5 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier1_5pts_unlocked" disabled />
                <strong>■ 5 Points</strong> - Choix entre :
              </label>
              <select name="attr_palier1_5pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="griffes">Griffes Aiguisées (+2 dégâts griffes)</option>
                <option value="sang_maudit">Sang Maudit (1d4 dégâts physiques)</option>
                <option value="cape">Cape des Ombres (+3 Discrétion nocturne)</option>
              </select>
            </div>

            <!-- 10 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier1_10pts_unlocked" disabled />
                <strong>■ 10 Points</strong> - Choix entre :
              </label>
              <select name="attr_palier1_10pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="morsure">Morsure Dévoreuse (+2 dégâts morsure)</option>
                <option value="corrosif">Sang Corrosif (1d6 dégâts acide)</option>
                <option value="saut">Saut Silencieux (+2 DEX, +2ft saut, Jeune Maître du Saut)</option>
              </select>
            </div>

            <!-- 15 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier1_15pts_unlocked" disabled />
                <strong>■ 15 Points</strong> - Choix entre :
              </label>
              <select name="attr_palier1_15pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="peau">Peau de Goule Renforcée (+3 Déf. Physique ou Magique)</option>
                <option value="psyche">Psyché de Goule (+3 RM, +2 INT ou SAG)</option>
                <option value="sens">Sens Aiguisés (+2 PER, +2 Réactivité)</option>
              </select>
            </div>

            <!-- 20 Points - ÉVOLUTION -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier1_20pts_unlocked" disabled />
                <strong>&#11088; 20 Points - ÉVOLUTION vers Palier 2</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains permanents :</strong> +2 FOR, +2 DEX, +1 CST, +2 RM, +2 pts compétence, -2% Rage, +10 LS
              </p>
              <select name="attr_palier1_20pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="grignoteur">Grignoteur d'Essence (20% chance +1 Sangsure)</option>
                <option value="marcheur">Marcheur Blanc (-2% Rage, relance Maîtrise Affamé)</option>
                <option value="rage">Rage Incontrôlée (+7% Rage, +10 Réactivité en Rage, +1 Réaction)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- ============================================================
           PALIER 2 : GOULE DE SANG (21-40)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-2" data-palier="2">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 2 : Goule de Sang (21-40 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> La goule approfondit son contrôle du sang. 
            Ses pouvoirs de régénération augmentent, mais sa soif grandit.
          </p>

          <!-- CHOIX DE LA SOUS-BRANCHE -->
          <div class="sheet-choice-section">
            <label class="sheet-choice-label">&#10070; Choix de Sous-Branche :</label>
            <select name="attr_palier2_branche">
              <option value="">-- Non choisi --</option>
              <option value="devoreur">Grande Goule Dévoreur (+1 morsure, +2 amélio crocs/griffes)</option>
              <option value="sanguinaire">Goule Sanguinaire (attaque sang, +2 amélio sang)</option>
              <option value="nocturne">Goule Nocturne (Pistage mineur, +3 PER, +1 amélio)</option>
            </select>
          </div>

          <!-- RÉCOMPENSES -->
          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses aux seuils</h4>
            
            <!-- 25 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier2_25pts_unlocked" disabled />
                <strong>■ 25 Points</strong>
              </label>
              <select name="attr_palier2_25pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="regeneration">Régénération Sanguine (+10 PV au prochain repos 2h)</option>
                <option value="puissance">Puissance Sanguine (amélio mineure tous pouvoirs sang)</option>
                <option value="frappe">Frappe Nocturne (+5 Attaque Surprise, +2 pts compétence)</option>
              </select>
            </div>

            <!-- 30 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier2_30pts_unlocked" disabled />
                <strong>■ 30 Points</strong>
              </label>
              <select name="attr_palier2_30pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="main_rouge">Main Rouge (saignement/vampirisme +1 niveau)</option>
                <option value="glacant">Sang Glaçant (dégâts givre, +15% rés. froid/glace)</option>
                <option value="affamee">Bête Affamée (+10% dégâts Rage, +2 FOR/DEX, -2 INT/SAG)</option>
              </select>
            </div>

            <!-- 35 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier2_35pts_unlocked" disabled />
                <strong>■ 35 Points</strong>
              </label>
              <select name="attr_palier2_35pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="antipoison">Globule Anti-Poison (-50% dégâts poison, +1 RES)</option>
                <option value="windress">Enfant de Windress (+15% rés. glace/froid)</option>
                <option value="rouge">Enfant Rouge (Rassasié 4h, +10 jet repos critique)</option>
              </select>
            </div>

            <!-- 40 Points - ÉVOLUTION -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier2_40pts_unlocked" disabled />
                <strong>&#11088; 40 Points - ÉVOLUTION vers Palier 3</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> +3 FOR/DEX, +3 INT, +2 SAG, +3 RM, +1 Instinct/Sang-Froid, 
                Dé de vie +1, +15 LS, +4 RM, -3% Rage, +1 Point Vampirique
              </p>
              <select name="attr_palier2_40pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="chercheur">Chercheur de Sang (50% chance +1 Sangsure si 1 seul)</option>
                <option value="bataille">Ce n'était pas ma bataille (-10 CHA, +5 PER/SAG/CST, -2% Rage Affamé)</option>
                <option value="first_blood">First Blood (1 action extra en Rage, +2% Rage)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- ============================================================
           PALIER 3 : GOULE DE NUIT (41-65)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-3" data-palier="3">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 3 : Goule de Nuit (41-65 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> Prédateur des ombres, la goule excelle dans les attaques furtives 
            et développe des pièges sanglants.
          </p>

          <!-- CHOIX DE LA SOUS-BRANCHE -->
          <div class="sheet-choice-section">
            <label class="sheet-choice-label">&#10070; Choix de Sous-Branche :</label>
            <select name="attr_palier3_branche">
              <option value="">-- Non choisi --</option>
              <option value="sombrestele">Goule Sombrestèle (Furtivité, +1 dé PE/niveau, +1 dé PE)</option>
              <option value="piege_sang">Goule Piège-Sang (Modulation Sang, +1 dé PV/niveau, +1 dé PV)</option>
              <option value="croc_nocturne">Goule Croc Nocturne (Croc paralysant 30%, +1 dé PM/niveau, +1 dé PM)</option>
            </select>
          </div>

          <!-- RÉCOMPENSES -->
          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses aux seuils</h4>
            
            <!-- 45 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier3_45pts_unlocked" disabled />
                <strong>■ 45 Points</strong>
              </label>
              <select name="attr_palier3_45pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="pas_silencieux">Pas Silencieux (+3 Discrétion, +1 jet PE)</option>
                <option value="sang_puissant">Sang Puissant (+3 CST, +1 jet PV)</option>
                <option value="nuit_protectrice">Nuit Protectrice (+4 RM, +1 jet PM)</option>
              </select>
            </div>

            <!-- 50 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier3_50pts_unlocked" disabled />
                <strong>■ 50 Points</strong>
              </label>
              <select name="attr_palier3_50pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="toxique">Buveur Toxique (dégâts poison, +10% rés. toxines)</option>
                <option value="bouillant">Sang Bouillant (dégâts feu maudit, +10% rés. feu)</option>
                <option value="noir">Sang Noir (drain mana 1d3*Mod.INT, +5% rés. Ténèbres)</option>
              </select>
            </div>

            <!-- 55 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier3_55pts_unlocked" disabled />
                <strong>■ 55 Points</strong>
              </label>
              <select name="attr_palier3_55pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="nouvelle_vie">Nouvelle Vie Supérieure (+1 Point Vampirique, +1 tous traits)</option>
                <option value="bourreau">Bourreau de la Nuit (+2 DEX, +1 Mouvement, +10% rés. Ombre)</option>
                <option value="incontrolable">Créature Incontrôlable (4 SAG → FOR/DEX/PER/CST en Rage)</option>
                <option value="faim">Faim Insatiable (relance attaque morsure ratée Affamé, +20% crit)</option>
              </select>
            </div>

            <!-- 60 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier3_60pts_unlocked" disabled />
                <strong>■ 60 Points - Maturation</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> +2 FOR/DEX/CST, +1 INT/SAG/PER, +1 Instinct/Sang-Froid/Résilience
              </p>
            </div>

            <!-- 65 Points - ÉVOLUTION JEUNE VAMPIRE -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier3_65pts_unlocked" disabled />
                <strong>&#11088; 65 Points - ÉVOLUTION vers Jeune Vampire (Palier 4)</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> +2 toutes caracs, +1 FOR/DEX, +2 INT/SAG, +3 PER/CHA, +2 CST, 
                +5 RM, +3 Réactivité, +1 Mouvement, amélio sang, +1 dégâts Morsure, -1 dégâts Griffes, 
                +20 LS, -3% Rage
              </p>
              <select name="attr_palier3_65pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="sens">Sens Aiguisés (+2 Instinct/Social, Vampire Sanguinaire 40% saignement)</option>
                <option value="corps">Corps de Vampire (+2 Finesse/Sang-Froid, Optimisation -5% PM sang)</option>
                <option value="mental">Force Mentale (+2 Puissance/Résilience, Volonté relance RM)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- ============================================================
           PALIER 4 : JEUNE VAMPIRE (66-90)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-4" data-palier="4">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 4 : Jeune Vampire (66-90 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> Devenu jeune vampire, développe des pouvoirs vampiriques avancés.
            <br><strong>&#9760; Passif ADN Monstre débloqué :</strong> Ponction Sang ADN (40% sorts aléatoires, absorbe capacités monstres)
          </p>

          <!-- CHOIX DE LA SOUS-BRANCHE -->
          <div class="sheet-choice-section">
            <label class="sheet-choice-label">&#10070; Choix de Sous-Branche :</label>
            <select name="attr_palier4_branche">
              <option value="">-- Non choisi --</option>
              <option value="guerrier">Jeune Vampire Guerrier (tous dés +2, dé Vie +4, maîtrise arme)</option>
              <option value="manipulateur">Jeune Vampire Manipulateur (dés +2, dé Magie +4, Influence créatures)</option>
              <option value="sanguinaire">Jeune Vampire Sanguinaire (dés +2, dé Magie +4, Magie Sang +1 sort)</option>
              <option value="adn">Jeune Vampire ADN (dés +2, dé PE +4, amélio ADN +5%, 2 ponctions/cible)</option>
            </select>
          </div>

          <!-- RÉCOMPENSES -->
          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses aux seuils</h4>
            
            <!-- 70 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier4_70pts_unlocked" disabled />
                <strong>■ 70 Points</strong>
              </label>
              <select name="attr_palier4_70pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="puissance">Puissance Jeune Vampire (2 amélio capacités, +3 FOR/INT)</option>
                <option value="charmeur">Jeune Charmeur (+3 CHA, -15% PM influence, +1 sort)</option>
                <option value="apprenti">Apprenti Sanguin (maîtrise sang +1, +1 sort, -5% coût sang)</option>
                <option value="fragment">Fragment de Sort (+15% absorb sort, 10% bonus perma aléa)</option>
              </select>
            </div>

            <!-- 75 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier4_75pts_unlocked" disabled />
                <strong>■ 75 Points</strong>
              </label>
              <select name="attr_palier4_75pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="repos">Repos Vampirique (Régénération Vampirique +10 repos, +2d12 PV)</option>
                <option value="audela">Corps vers l'Au-Delà (+1 Destin, +1 Appel Néant)</option>
                <option value="puissance_adn">Puissance ADN (sort ADN perma +1 amélio gratuite)</option>
                <option value="leger">Corps Léger (Agilité/Acrobatie, +1 Mouvement, +3 DEX)</option>
              </select>
            </div>

            <!-- 80 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier4_80pts_unlocked" disabled />
                <strong>■ 80 Points</strong>
              </label>
              <select name="attr_palier4_80pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="esprit">Esprit Dominant (+5 RM, amélio sorts influence, rés. influence)</option>
                <option value="arcanique">Sang Arcanique (+10% rés. magie pure, +3 Déf. Magique)</option>
                <option value="feu">Sang de Feu (flamme maudite attaques sang, -20% faiblesse feu)</option>
                <option value="volonte">Volonté Vampirique (supprime malus RM division)</option>
                <option value="croc">Croc Véritable (+3 dégâts morsure, +1d12 PE max)</option>
              </select>
            </div>

            <!-- 85 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier4_85pts_unlocked" disabled />
                <strong>■ 85 Points - Maturation</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> +2 INT/FOR/DEX, +1 CST/SAG/CHA, +1 Instinct/Puissance/Finesse
              </p>
            </div>

            <!-- 90 Points - ÉVOLUTION VÉRITABLE VAMPIRE -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier4_90pts_unlocked" disabled />
                <strong>&#11088; 90 Points - ÉVOLUTION vers Véritable Vampire (Palier 5)</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> -10% faiblesse Feu/Lumière, +1 tous traits, +2 Puissance/Instinct/Résilience/Finesse, 
                +3 Déf. Phys/Mag, +2 Att. Phys/Mag, +4 pts compétence, +25 LS, +1 Point Origine (récompense ancienne), 
                Corps Véritable Vampire, -3% Rage
              </p>
              <select name="attr_palier4_90pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="ponction">Ponction Véritable (+15% Sangsure, +1 si jet &lt;50%)</option>
                <option value="reserve">Réserve Sanguinaire (Affamé contrôlé plusieurs jours, -3% Rage)</option>
                <option value="selfcontrol">Self-Control (+4% Rage, contrôle en Rage, pause 10min)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- ============================================================
           PALIER 5 : VÉRITABLE VAMPIRE (91-130)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-5" data-palier="5">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 5 : Véritable Vampire (91-130 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> Enfant véritable de la nuit, puissant et rusé. 
            Révèle sa nature aux yeux du monde de l'ombre.
          </p>

          <!-- CHOIX DE LA SOUS-BRANCHE -->
          <div class="sheet-choice-section">
            <label class="sheet-choice-label">&#10070; Choix de Sous-Branche :</label>
            <select name="attr_palier5_branche">
              <option value="">-- Non choisi --</option>
              <option value="cruel">Le Cruel Vampire (Terreur Vampirique, +5% 2 rés. élémentaires, +4 FOR/CST/CHA)</option>
              <option value="premier_sang">Premier Enfant du Sang (Magie Sang Vampirique, +10% rés. Sang/Eau, +4 INT/PER/DEX)</option>
              <option value="jeunesse">Jeunesse Immortelle (Charme Vampirique, +5 RM, +1 Social, +4 CST/CHA/INT)</option>
              <option value="tenebres">Sang Originel Ténèbres (Magie Ténèbres Vamp., +10% rés. Ténèbres/Ombre, +4 INT/SAG/CST)</option>
            </select>
          </div>

          <!-- RÉCOMPENSES -->
          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses aux seuils</h4>
            
            <!-- 95 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier5_95pts_unlocked" disabled />
                <strong>■ 95 Points</strong>
              </label>
              <select name="attr_palier5_95pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="cruaute">Cruauté et Terreur (Aura terrifiante, -10 jets cibles 1d3 tours, 1/tour)</option>
                <option value="sang_purifie">Don de Sang Purifié (Soigne allié 1d6+Mod.CST % PV, 1/jour)</option>
                <option value="diplomate">Jeune Diplomate de la Nuit (+2 négociation/manipulation, influence créatures inférieures)</option>
                <option value="deplacement">Déplacement de la Nuit (+2 Discrétion, déplacement silencieux 1 tour, 1pt Réaction)</option>
              </select>
            </div>

            <!-- 105 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier5_105pts_unlocked" disabled />
                <strong>■ 105 Points</strong>
              </label>
              <select name="attr_palier5_105pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="marche_terreur">Marche de Terreur (Ennemis proches niveau inférieur: -10 attaque/réactivité 1 tour, jet RM)</option>
                <option value="grand_sang">Porteur de Grand Sang (Détecte vampires/goules/sang 30ft, sans jet)</option>
                <option value="grace">Grâce Hypnotique (Hypnose 1 ennemi 1 tour, jet RM, 1/combat)</option>
                <option value="chauves_souris">Maître des Chauves-Souris (Communique avec elles, transformation 10min, 1/scène)</option>
              </select>
            </div>

            <!-- 115 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier5_115pts_unlocked" disabled />
                <strong>■ 115 Points</strong>
              </label>
              <select name="attr_palier5_115pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="brutalite">Source de Brutalité (+3 FOR/CST, +1 Puissance, 2 dés intimider créatures faibles)</option>
                <option value="griffe_sang">Griffe Sanguinaire (Griffes: 40% saignement 2d2 si dépasse 50% armure, +1 dégâts griffes)</option>
                <option value="mental_paradoxal">Mental Paradoxal (Jet RM malus: 2 dés meilleur; ennemi vs toi: 2 dés pire, 1/partie)</option>
                <option value="sens_combat">Sens du Combat Fils de la Nuit (+10 Réactivité nuit, +1 pt Réaction nuit)</option>
              </select>
            </div>

            <!-- 125 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier5_125pts_unlocked" disabled />
                <strong>■ 125 Points</strong>
              </label>
              <select name="attr_palier5_125pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="cauchemars">Cauchemars Vampiriques (Sorts Peur vs créatures inférieures: désavantage résistance)</option>
                <option value="origine">Origine Vampirique (Choisir 1 récompense palier inférieur non prise)</option>
                <option value="ombre_nuit">Ombre de la Nuit (Asservir créature nuit faible: 2 jets RM consécutifs, 1 cible max)</option>
                <option value="plongee_tenebres">Plongée dans les Ténèbres (Sorts Ténèbres: amélio +1, +1 sort si branche Ténèbres)</option>
              </select>
            </div>

            <!-- 130 Points - ÉVOLUTION GRAND VAMPIRE -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier5_130pts_unlocked" disabled />
                <strong>&#11088; 130 Points - ÉVOLUTION vers Grand Vampire (Palier 6)</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> +8 pts caracs libre (max +3/carac), +2 CHA, +2 PER, +2 CST, +2 SAG/INT, 
                +1 Résilience/Finesse, +1 Social/Savoir, +30 LS, -3% Rage
              </p>
              <select name="attr_palier5_130pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="pas_avant">Pas vers l'Avant (Choisir sous-branche palier 4/5 non prise, obtenir avantages)</option>
                <option value="pas_arriere">Pas en Arrière (Choisir sous-branche goule palier 1/2/3, +1 dégâts Griffes/Crocs)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- ============================================================
           PALIER 6 : GRAND VAMPIRE (131-165)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-6" data-palier="6">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 6 : Grand Vampire (131-165 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> Grand Vampire au prestige redoutable, étend son influence sur les créatures.
          </p>

          <div class="sheet-choice-section">
            <label class="sheet-choice-label">&#10070; Choix de Sous-Branche :</label>
            <select name="attr_palier6_branche">
              <option value="">-- Non choisi --</option>
              <option value="mirages">Vampire des Mirages (+2 CHA, Magie Illusion mineure, +1 sort illusion)</option>
              <option value="souverain">Vampire Souverain (Création Rejetons mineure, Domination Faibles, +2 CHA)</option>
              <option value="sanguinaire">Vampire Sanguinaire (Amélio générale magies sang, +2 sorts sang)</option>
              <option value="adn">Vampire Buveur ADN (2 ponctions/entité → 3 si déjà augmenté)</option>
            </select>
          </div>

          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses aux seuils</h4>
            
            <!-- 135 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier6_135pts_unlocked" disabled />
                <strong>■ 135 Points</strong>
              </label>
              <select name="attr_palier6_135pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="veteran">Vampire Vétéran (+3 INT, +3 CST, Analyse Stratégique +5, +1 capacité vampirique)</option>
                <option value="vol">Vol du Vampire (Lévitation, Vampire Walk: vitesse = course)</option>
                <option value="sorce_sang">Sorce-Sang (+1 sort majeur Sang dévastateur, 4 amélio sorts sang existants)</option>
                <option value="adaptation_adn">Adaptation ADN (30% chance amélioration sort/capacité absorbé)</option>
              </select>
            </div>

            <!-- 145 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier6_145pts_unlocked" disabled />
                <strong>■ 145 Points</strong>
              </label>
              <select name="attr_palier6_145pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="force_surhumaine">Force Surhumaine (+5 FOR, Puissance Vampirique +10)</option>
                <option value="charmeur_morts">Charmeur des Morts (Sort Marionnette Vampirique: contrôle mort 3 tours, -10 RM cible, +5 CHA, 45 PM)</option>
                <option value="anti_arcanique">Sang Anti-Arcanique (Attaques sang: dégradent/dissipent sorts mineurs ennemis)</option>
                <option value="esprit_mystique">Esprit Mystique (Relance jet RM: coût 5% PM max, 1/tour)</option>
              </select>
            </div>

            <!-- 155 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier6_155pts_unlocked" disabled />
                <strong>■ 155 Points</strong>
              </label>
              <select name="attr_palier6_155pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="origine_vamp">Origine Vampirique (Choisir 1 récompense palier inférieur non prise)</option>
                <option value="croc_parasite">Croc du Vampire Parasite (Morsure 20%+ PV + 20% PM: infecte vampirisme, coût 5% PM max perma)</option>
                <option value="sang_pur">Sang Pur (Rés. moyenne poisons/intoxications, immunité maladies, +3 RM)</option>
                <option value="adaptation_avancee">Adaptation ADN Avancée (Sorts/capacités absorbés: -10% coût PM, amélio légère)</option>
              </select>
            </div>

            <!-- 165 Points - ÉVOLUTION SEIGNEUR VAMPIRE -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier6_165pts_unlocked" disabled />
                <strong>&#11088; 165 Points - ÉVOLUTION vers Seigneur Vampire (Palier 7)</strong>
              </label>
              <p class="sheet-gains">
                <strong>Gains :</strong> +5 FOR/DEX/CST, +3 INT/SAG/PER, +2 CHA/FOR/CST, +1 toutes caracs base, 
                +5 Réactivité, +1 pt Réaction, +2 Finesse/Instinct/Sang-Froid, 3 traits spécifiques +1, 
                +5 RM, +40 LS, -3% Rage
              </p>
            </div>
          </div>
        </div>
      </details>

      <!-- ============================================================
           PALIER 7 : SEIGNEUR VAMPIRE (165-250)
           ============================================================ -->
      <details class="sheet-evolution-palier sheet-palier-7" data-palier="7">
        <summary class="sheet-subsection-title-vampire">&#9884; Palier 7 : Seigneur Vampire (165-250 points)</summary>
        
        <div class="sheet-palier-content">
          <p class="sheet-palier-desc">
            <strong>Description :</strong> Stade ultime. Pouvoirs quasi-divins, maîtrise absolue du sang et de la manipulation.
            Règne sur les créatures de la nuit avec autorité naturelle.
          </p>

          <div class="sheet-rewards-section">
            <h4 class="sheet-reward-title">&#9733; Récompenses finales</h4>
            
            <!-- 170 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier7_170pts_unlocked" disabled />
                <strong>■ 170 Points</strong>
              </label>
              <select name="attr_palier7_170pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="commandant">Commandant des Ténèbres (+5 CHA/PER/SAG/INT, +10% rés. Ténèbres/ombre/malédictions)</option>
                <option value="illusion_parfaite">Illusion Parfaite (Sorts illusion: -20% coût PM, +efficacité durée/portée/réalisme)</option>
                <option value="enfants_vamp">Enfants Vampiriques (Êtres infectés: deviennent Jeunes Vampires immédiatement, paliers 1-3 complets)</option>
                <option value="assimilation_maitre">Assimilation ADN Maître (+10% chance sort perma, +15% efficacité sorts temporaires absorbés)</option>
              </select>
            </div>

            <!-- 185 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier7_185pts_unlocked" disabled />
                <strong>■ 185 Points</strong>
              </label>
              <select name="attr_palier7_185pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="immortalite">Immortalité (PV 0 par dégâts physiques non-magiques: torpeur -15% PV, régénération, pas mort)</option>
                <option value="regeneration_absolue">Régénération Absolue (Régénère membres/organes si tête intacte, sauf magie Lumière/Ténèbres)</option>
                <option value="grande_origine">Grande Origine Vampirique (Choisir 1 récompense palier inférieur + 1 palier 6, non prises)</option>
                <option value="mutation_adn">Mutation ADN (Combine fragments sorts absorbés, ADN hybride, -15% coût sorts monstres)</option>
              </select>
            </div>

            <!-- 200 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier7_200pts_unlocked" disabled />
                <strong>■ 200 Points</strong>
              </label>
              <select name="attr_palier7_200pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="esprit_mortel">Ton esprit de mortel est à moi (Sonde esprit: désavantage RM cible, lire pensées/influencer émotions)</option>
                <option value="serviteur">Serviteur du Seigneur (Langage Esprits, Compréhension Morts, invoque serviteur vampirique/mort-vivant lié, 1/combat)</option>
                <option value="adn_absolu">ADN Absolu (+15% chance perma, +20% tempo, 1d3 sorts tempo + 1d2 perma par ponction)</option>
                <option value="survie_faibles">Survie des Faibles (Ressuscite mort récent niveau inférieur: 10% PV, sang versé, blessures non mortelles, 1/créature)</option>
              </select>
            </div>

            <!-- 215 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier7_215pts_unlocked" disabled />
                <strong>■ 215 Points</strong>
              </label>
              <select name="attr_palier7_215pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="seigneur_ombres">Seigneur des Ombres (Téléportation ombre→ombre 80ft, 1/tour, Pas Seigneur Vampirique)</option>
                <option value="souverain_sang">Souverain du Sang (Aura: créatures niveau inférieur -10 RM, -10% dégâts vs toi)</option>
                <option value="resurrection">Résurrection du Seigneur Vampire (PV &lt;0: sacrifie tour + 50% PM max → 50% PV, 1/combat)</option>
                <option value="gardien">Gardien du Seigneur (Invoque Gardien personnel ombre/démon majeur, 1/combat)</option>
              </select>
            </div>

            <!-- 235 Points -->
            <div class="sheet-reward-block">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier7_235pts_unlocked" disabled />
                <strong>■ 235 Points</strong>
              </label>
              <select name="attr_palier7_235pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="forme_ultime">Forme Ultime (Transformation démoniaque vampirique: ailes, griffes immenses, aura, Boss final, puis épuisé)</option>
                <option value="reincarnation">Réincarnation Vampirique (Mort véritable: explose en sang, renaît Jeune Vampire palier 4, stats 25%, traits moitié)</option>
                <option value="chef_guerre">Chef de Guerre Sanguinaire (Maître Naturel Toute Arme: +2 crans compétence chaque arme)</option>
              </select>
            </div>

            <!-- 250 Points - APOGÉE -->
            <div class="sheet-reward-block sheet-evolution-reward">
              <label class="sheet-reward-label">
                <input type="checkbox" name="attr_palier7_250pts_unlocked" disabled />
                <strong>&#9819; 250 Points - APOGÉE VAMPIRIQUE</strong>
              </label>
              <p class="sheet-gains">
                <strong>Au-delà de 250 points :</strong> Sommet de la puissance atteint ! 
                Plus d'évolution majeure. Évolutions futures via objets légendaires, quêtes divines, etc.
              </p>
              <select name="attr_palier7_250pts_choice">
                <option value="">-- Non choisi --</option>
                <option value="grande_origine2">Grande Origine Vampirique (Choisir 1 récompense n'importe quel palier non prise)</option>
                <option value="voie_originelle">Voie Originelle du Vampire (Choisir sous-branche goule/vampire palier inférieur/actuel, obtenir avantages)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

    </details>














<!-- =====================================================
     BOUTIQUE D’ALUCARNE — HTML (STRUCTURE)
     - Titre dépliable
     - Présentation
     - 7 paliers en mode boutique (tables)
     ===================================================== -->

<div class="sheet-alucarne-shop">

  <!-- LS dépensés (calcul) -->
  <input type="hidden" name="attr_larmes_sang_spent" value="0" />
  <!-- LS restant (calcul) -->
  <input type="hidden" name="attr_larmes_sang_available" value="0" />

  <details class="sheet-alucarne-root" open>
    <summary class="sheet-alucarne-summary">
      <div class="sheet-alucarne-sumrow">
        <div class="sheet-alucarne-sumtitle">
          La Crypte de l’éternelle Nuit – La boutique d’Alucarne
        </div>

        <div class="sheet-alucarne-lsbox">
          <span class="sheet-alucarne-lslabel">LS actuel :</span>
          <!-- ✅ Synchronisé avec la ressource principale de la fiche -->
          <input type="number" name="attr_larmes_sang_available" value="0" min="0" readonly tabindex="-1" />
        </div>
      </div>
    </summary>

    <!-- Présentation -->
    <div class="sheet-alucarne-intro">
      <p>
        La Boutique d’Alucarne est un lieu énigmatique, dissimulé au cœur des ombres et accessible uniquement aux créatures de la nuit.
        C’est un endroit presque immatériel, enfoui dans la profondeur même du sang des Enfants de la Nuit. Là, pour ceux qui en ont le potentiel,
        ce sang maudit révèle — et façonne — la force qui les anime.
      </p>
      <p>
        Par instants, l’Enfant de la Nuit est saisi d’une réflexion intense, comme s’il se retrouvait face à une présence qui lui ressemble :
        un être portant le même sang. Cette chose, cette entité, est prête à dévoiler le potentiel assoupi en vous… et à le faire éclore.
      </p>
      <p>
        Dans cette boutique, les aventuriers peuvent échanger leurs Larmes de Sang contre diverses récompenses :
      </p>
      <ul>
        <li>Talents et capacités : perfectionnez vos aptitudes de combat, d’infiltration ou de magie.</li>
        <li>Sorts anciens : apprenez des sortilèges oubliés, rares, aux effets uniques et redoutables.</li>
        <li>Classes spéciales : faites évoluer votre nature d’Enfant de la Nuit en trouvant votre propre voie.</li>
        <li>Et d’autres dons encore… que seul votre sang peut vous offrir.</li>
      </ul>
    </div>

    <!-- =========================
         PALLIER 1
         ========================= -->
    <details class="sheet-tier" open>
      <summary class="sheet-tier-summary">Pallier 1 : Goule Dévoreur</summary>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
<tr>
  <td>
    <input type="checkbox" name="attr_shop_t1_i01_canbuy" class="sheet-canbuy" checked />
    <span class="sheet-celltext">Bonus de point LS</span>
  </td>
  <td>
    <input type="checkbox" name="attr_shop_t1_i01_canbuy" class="sheet-canbuy" checked />
    <span class="sheet-celltext">9</span>
  </td>
  <td>
    <input type="hidden" name="attr_shop_t1_i01_cost" value="9" />
    <input type="checkbox" name="attr_shop_t1_i01_canbuy" class="sheet-canbuy" checked />
    <span class="sheet-buywrap">
      <input type="checkbox" name="attr_shop_t1_i01_bought" />
    </span>
  </td>
  <td>
    <input type="checkbox" name="attr_shop_t1_i01_canbuy" class="sheet-canbuy" checked />
    <span class="sheet-celltext">Sanguinaire Affamée I</span>
  </td>
</tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau Talent</span></td>
            <td><input type="hidden" name="attr_shop_t1_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">8</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i02_cost" value="8" />
              <input type="hidden" name="attr_shop_t1_i02_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i02_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Vivacité de goule : +2 en Réactivité</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité vampirique</span></td>
            <td><input type="hidden" name="attr_shop_t1_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">8</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i03_cost" value="8" />
              <input type="hidden" name="attr_shop_t1_i03_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i03_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+Nouvelle capacité</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Faim Vampirique</span></td>
            <td><input type="hidden" name="attr_shop_t1_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">11</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i04_cost" value="11" />
              <input type="hidden" name="attr_shop_t1_i04_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i04_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Gorge Insatiable I</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td>
            <td><input type="hidden" name="attr_shop_t1_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">10</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i05_cost" value="10" />
              <input type="hidden" name="attr_shop_t1_i05_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i05_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Transmutation Sanguine I</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Gain de states</span></td>
            <td><input type="hidden" name="attr_shop_t1_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">6</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i06_cost" value="6" />
              <input type="hidden" name="attr_shop_t1_i06_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i06_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Dent Pointue : +1 sur stats morsure</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amé. Sort/cap</span></td>
            <td><input type="hidden" name="attr_shop_t1_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">8</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i07_cost" value="8" />
              <input type="hidden" name="attr_shop_t1_i07_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i07_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">1 amélioration de sort/capacité</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td>
            <td><input type="hidden" name="attr_shop_t1_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">8</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i08_cost" value="8" />
              <input type="hidden" name="attr_shop_t1_i08_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i08_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 new talents</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td>
            <td><input type="hidden" name="attr_shop_t1_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">14</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i09_cost" value="14" />
              <input type="hidden" name="attr_shop_t1_i09_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i09_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Classe goule</span></td>
            <td><input type="hidden" name="attr_shop_t1_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">12</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i10_cost" value="12" />
              <input type="hidden" name="attr_shop_t1_i10_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i10_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule Barbare</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Classe goule</span></td>
            <td><input type="hidden" name="attr_shop_t1_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">12</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i11_cost" value="12" />
              <input type="hidden" name="attr_shop_t1_i11_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i11_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule Cracheur</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Classe goule</span></td>
            <td><input type="hidden" name="attr_shop_t1_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">12</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i12_cost" value="12" />
              <input type="hidden" name="attr_shop_t1_i12_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i12_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule chasseur</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amé. Sort/cap</span></td>
            <td><input type="hidden" name="attr_shop_t1_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">7</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i13_cost" value="7" />
              <input type="hidden" name="attr_shop_t1_i13_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i13_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">1 amélioration de sort/capacité</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Point vampirique</span></td>
            <td><input type="hidden" name="attr_shop_t1_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">14</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i14_cost" value="14" />
              <input type="hidden" name="attr_shop_t1_i14_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i14_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t1_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Vue net</span></td>
            <td><input type="hidden" name="attr_shop_t1_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">8</span></td>
            <td>
              <input type="hidden" name="attr_shop_t1_i15_cost" value="8" />
              <input type="hidden" name="attr_shop_t1_i15_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t1_i15_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t1_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en INT</span></td>
          </tr>
        </tbody>
      </table>
    </details>

    <!-- =========================
         PALLIER 2
         ========================= -->
    <details class="sheet-tier">
      <summary class="sheet-tier-summary">Pallier 2 : Goule de sang</summary>

      <div class="sheet-tier-note">
        Conditions : Avoir « Sanguinaire Affamée I »
      </div>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td><input type="hidden" name="attr_shop_t2_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Bonus de point LS</span></td>
            <td><input type="hidden" name="attr_shop_t2_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">25</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i01_cost" value="25" />
              <input type="hidden" name="attr_shop_t2_i01_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i01_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Sanguinaire Affamée II</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent brave vamp</span></td>
            <td><input type="hidden" name="attr_shop_t2_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">22</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i02_cost" value="22" />
              <input type="hidden" name="attr_shop_t2_i02_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i02_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obtient le talent « Régénération sanguinaire »</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité vampirique</span></td>
            <td><input type="hidden" name="attr_shop_t2_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i03_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i03_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i03_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouvelle capacité</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td>
            <td><input type="hidden" name="attr_shop_t2_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i04_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i04_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i04_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Mâchoires d’acier</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td>
            <td><input type="hidden" name="attr_shop_t2_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">24</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i05_cost" value="24" />
              <input type="hidden" name="attr_shop_t2_i05_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i05_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Extraction Optimisée</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Petit cerveau</span></td>
            <td><input type="hidden" name="attr_shop_t2_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i06_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i06_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i06_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en INT</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Compétence de goule</span></td>
            <td><input type="hidden" name="attr_shop_t2_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i07_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i07_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i07_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">3 point de compétence</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td>
            <td><input type="hidden" name="attr_shop_t2_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i08_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i08_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i08_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 new talents</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Point vampirique</span></td>
            <td><input type="hidden" name="attr_shop_t2_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">26</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i09_cost" value="26" />
              <input type="hidden" name="attr_shop_t2_i09_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i09_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent brave vamp.</span></td>
            <td><input type="hidden" name="attr_shop_t2_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">27</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i10_cost" value="27" />
              <input type="hidden" name="attr_shop_t2_i10_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i10_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Calme Rougeoyant (Conditions : avoir « Enfants Rouge »)</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td>
            <td><input type="hidden" name="attr_shop_t2_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">26</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i11_cost" value="26" />
              <input type="hidden" name="attr_shop_t2_i11_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i11_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Transmutation sanguine II (Conditions : Transmutation sanguine I)</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td>
            <td><input type="hidden" name="attr_shop_t2_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">21</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i12_cost" value="21" />
              <input type="hidden" name="attr_shop_t2_i12_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i12_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Instinct sauvage</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amé. Sort/cap</span></td>
            <td><input type="hidden" name="attr_shop_t2_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i13_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i13_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i13_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">1 amélioration de sort/capacité</span></td>
          </tr>

          <tr>
            <td><input type="hidden" name="attr_shop_t2_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule terrifiant</span></td>
            <td><input type="hidden" name="attr_shop_t2_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">18</span></td>
            <td>
              <input type="hidden" name="attr_shop_t2_i14_cost" value="18" />
              <input type="hidden" name="attr_shop_t2_i14_canbuy" class="sheet-canbuy" value="1" />
              <span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t2_i14_bought" /></span>
            </td>
            <td><input type="hidden" name="attr_shop_t2_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 CHA</span></td>
          </tr>
        </tbody>
      </table>
    </details>

    <!-- =========================================================
         IMPORTANT
         ---------------------------------------------------------
         À PARTIR D’ICI (PALIER 3 → 7), JE LAISSE TOUT IDENTIQUE
         SAUF LA COLONNE "ACHETÉ" :
         - j’ai ajouté <span class="sheet-buywrap"> autour du checkbox
         - et j’ai gardé/met juste avant un input hidden canbuy
         ========================================================= -->

    <!-- =========================
         PALLIER 3
         ========================= -->
    <details class="sheet-tier">
      <summary class="sheet-tier-summary">Pallier 3 : Goule de la nuit</summary>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
          <tr><td><input type="hidden" name="attr_shop_t3_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Bonus de point LS</span></td><td><input type="hidden" name="attr_shop_t3_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">30</span></td><td><input type="hidden" name="attr_shop_t3_i01_cost" value="30" /><input type="hidden" name="attr_shop_t3_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i01_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Volonté sanguinaire</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Vue des ombres</span></td><td><input type="hidden" name="attr_shop_t3_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">30</span></td><td><input type="hidden" name="attr_shop_t3_i02_cost" value="30" /><input type="hidden" name="attr_shop_t3_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i02_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nyctalopie</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouvelle sensation</span></td><td><input type="hidden" name="attr_shop_t3_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">31</span></td><td><input type="hidden" name="attr_shop_t3_i03_cost" value="31" /><input type="hidden" name="attr_shop_t3_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i03_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Agilité moyen</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Déplacement terrifiant</span></td><td><input type="hidden" name="attr_shop_t3_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">29</span></td><td><input type="hidden" name="attr_shop_t3_i04_cost" value="29" /><input type="hidden" name="attr_shop_t3_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i04_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en MOV</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité vampirique</span></td><td><input type="hidden" name="attr_shop_t3_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">33</span></td><td><input type="hidden" name="attr_shop_t3_i05_cost" value="33" /><input type="hidden" name="attr_shop_t3_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i05_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+Nouvelle capacité & 1 amélioration de celle ci</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t3_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">32</span></td><td><input type="hidden" name="attr_shop_t3_i06_cost" value="32" /><input type="hidden" name="attr_shop_t3_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i06_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Instincts de prédateurs sanguin</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Vif comme une goule</span></td><td><input type="hidden" name="attr_shop_t3_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">31</span></td><td><input type="hidden" name="attr_shop_t3_i07_cost" value="31" /><input type="hidden" name="attr_shop_t3_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i07_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+3 en Réactivité</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t3_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">34</span></td><td><input type="hidden" name="attr_shop_t3_i08_cost" value="34" /><input type="hidden" name="attr_shop_t3_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i08_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Extraction Optimisée II (Conditions : avoir « Extraction Optimisée »)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td><td><input type="hidden" name="attr_shop_t3_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">30</span></td><td><input type="hidden" name="attr_shop_t3_i09_cost" value="30" /><input type="hidden" name="attr_shop_t3_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i09_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 new talent</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t3_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">34</span></td><td><input type="hidden" name="attr_shop_t3_i10_cost" value="34" /><input type="hidden" name="attr_shop_t3_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i10_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Maladie empoisonnante (Conditions : « Buveur toxique »)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t3_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">34</span></td><td><input type="hidden" name="attr_shop_t3_i11_cost" value="34" /><input type="hidden" name="attr_shop_t3_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i11_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Flamme sanguine (Conditions : « Sang bouillant »)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t3_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">34</span></td><td><input type="hidden" name="attr_shop_t3_i12_cost" value="34" /><input type="hidden" name="attr_shop_t3_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i12_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Ponction énergétique (Conditions : « Sang Noir »)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Point vampirique</span></td><td><input type="hidden" name="attr_shop_t3_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">34</span></td><td><input type="hidden" name="attr_shop_t3_i13_cost" value="34" /><input type="hidden" name="attr_shop_t3_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i13_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande Amé. Sort/cap</span></td><td><input type="hidden" name="attr_shop_t3_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">30</span></td><td><input type="hidden" name="attr_shop_t3_i14_cost" value="30" /><input type="hidden" name="attr_shop_t3_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i14_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">2 amélioration de sort/capacité</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t3_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">31</span></td><td><input type="hidden" name="attr_shop_t3_i15_cost" value="31" /><input type="hidden" name="attr_shop_t3_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i15_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Transmutation sanguine III (Conditions : Transmutation sanguine II)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t3_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">32</span></td><td><input type="hidden" name="attr_shop_t3_i16_cost" value="32" /><input type="hidden" name="attr_shop_t3_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i16_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Ombre Agressive</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Cerveau en évolution</span></td><td><input type="hidden" name="attr_shop_t3_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">31</span></td><td><input type="hidden" name="attr_shop_t3_i17_cost" value="31" /><input type="hidden" name="attr_shop_t3_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i17_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+4 en INT (Conditions : avoir au moins 1 fois « Petit cerveau »)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grand Point vampirique</span></td><td><input type="hidden" name="attr_shop_t3_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">37</span></td><td><input type="hidden" name="attr_shop_t3_i18_cost" value="37" /><input type="hidden" name="attr_shop_t3_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i18_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Classe Goule</span></td><td><input type="hidden" name="attr_shop_t3_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">38</span></td><td><input type="hidden" name="attr_shop_t3_i19_cost" value="38" /><input type="hidden" name="attr_shop_t3_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i19_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule égorgeur (Conditions : sous-branche ou coût +50%)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Classe Goule</span></td><td><input type="hidden" name="attr_shop_t3_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">38</span></td><td><input type="hidden" name="attr_shop_t3_i20_cost" value="38" /><input type="hidden" name="attr_shop_t3_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i20_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule Maladique (Conditions : sous-branche ou coût +50%)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t3_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Classe Goule</span></td><td><input type="hidden" name="attr_shop_t3_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">38</span></td><td><input type="hidden" name="attr_shop_t3_i21_cost" value="38" /><input type="hidden" name="attr_shop_t3_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t3_i21_bought" /></span></td><td><input type="hidden" name="attr_shop_t3_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Goule Mortifère (Conditions : sous-branche ou coût +50%)</span></td></tr>
        </tbody>
      </table>
    </details>

    <!-- =========================
         PALLIER 4
         ========================= -->
    <details class="sheet-tier">
      <summary class="sheet-tier-summary">Pallier 4 : Jeune Vampire</summary>

      <div class="sheet-tier-note">
        Conditions : Avoir « Sanguinaire Affamée II »
      </div>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
          <tr><td><input type="hidden" name="attr_shop_t4_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Bonus de point LS</span></td><td><input type="hidden" name="attr_shop_t4_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">43</span></td><td><input type="hidden" name="attr_shop_t4_i01_cost" value="43" /><input type="hidden" name="attr_shop_t4_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i01_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Sanguinaire Affamée III</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Faim Vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">43</span></td><td><input type="hidden" name="attr_shop_t4_i02_cost" value="43" /><input type="hidden" name="attr_shop_t4_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i02_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Gorge Insatiable II (Conditions : Gorge Insatiable I)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande Amé. Sort/cap</span></td><td><input type="hidden" name="attr_shop_t4_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">44</span></td><td><input type="hidden" name="attr_shop_t4_i03_cost" value="44" /><input type="hidden" name="attr_shop_t4_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i03_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 amélioration de sort/capacité</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td><td><input type="hidden" name="attr_shop_t4_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">40</span></td><td><input type="hidden" name="attr_shop_t4_i04_cost" value="40" /><input type="hidden" name="attr_shop_t4_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i04_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Résistance élémentaire mineur (10%)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t4_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">45</span></td><td><input type="hidden" name="attr_shop_t4_i05_cost" value="45" /><input type="hidden" name="attr_shop_t4_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i05_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Double Drain</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t4_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">45</span></td><td><input type="hidden" name="attr_shop_t4_i06_cost" value="45" /><input type="hidden" name="attr_shop_t4_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i06_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Anticipateur d’échec vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Allure vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">40</span></td><td><input type="hidden" name="attr_shop_t4_i07_cost" value="40" /><input type="hidden" name="attr_shop_t4_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i07_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 soit en FIN ou SOC ou RES</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t4_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">48</span></td><td><input type="hidden" name="attr_shop_t4_i08_cost" value="48" /><input type="hidden" name="attr_shop_t4_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i08_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Extraction Optimisée III (Conditions : Extraction Optimisée II)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Puissance vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">42</span></td><td><input type="hidden" name="attr_shop_t4_i09_cost" value="42" /><input type="hidden" name="attr_shop_t4_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i09_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Maîtrise mineur de la magie de sang</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t4_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">46</span></td><td><input type="hidden" name="attr_shop_t4_i10_cost" value="46" /><input type="hidden" name="attr_shop_t4_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i10_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Jeune essence convergente</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Place dans l’estomac</span></td><td><input type="hidden" name="attr_shop_t4_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">41</span></td><td><input type="hidden" name="attr_shop_t4_i11_cost" value="41" /><input type="hidden" name="attr_shop_t4_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i11_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Augmente d’1 Litre sa limite de sang par jours</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Jeune force vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">38</span></td><td><input type="hidden" name="attr_shop_t4_i12_cost" value="38" /><input type="hidden" name="attr_shop_t4_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i12_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en FOR</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amélioration ADN</span></td><td><input type="hidden" name="attr_shop_t4_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">42</span></td><td><input type="hidden" name="attr_shop_t4_i13_cost" value="42" /><input type="hidden" name="attr_shop_t4_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i13_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Offre un bonus de +5% sur la ponction de sang ADN</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Jeune sage vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">40</span></td><td><input type="hidden" name="attr_shop_t4_i14_cost" value="40" /><input type="hidden" name="attr_shop_t4_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i14_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+3 en SAG</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Point vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">44</span></td><td><input type="hidden" name="attr_shop_t4_i15_cost" value="44" /><input type="hidden" name="attr_shop_t4_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i15_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t4_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">46</span></td><td><input type="hidden" name="attr_shop_t4_i16_cost" value="46" /><input type="hidden" name="attr_shop_t4_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i16_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Effusion de sang</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t4_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Origine vampirique</span></td><td><input type="hidden" name="attr_shop_t4_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">52</span></td><td><input type="hidden" name="attr_shop_t4_i17_cost" value="52" /><input type="hidden" name="attr_shop_t4_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t4_i17_bought" /></span></td><td><input type="hidden" name="attr_shop_t4_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 Origine Vampirique</span></td></tr>
        </tbody>
      </table>
    </details>

    <!-- =========================
         PALLIER 5
         ========================= -->
    <details class="sheet-tier">
      <summary class="sheet-tier-summary">Pallier 5 : Véritable Vampire</summary>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
          <tr><td><input type="hidden" name="attr_shop_t5_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Faculté Vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">55</span></td><td><input type="hidden" name="attr_shop_t5_i01_cost" value="55" /><input type="hidden" name="attr_shop_t5_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i01_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Maîtrise mineur de la magie de peur vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Faculté Vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">55</span></td><td><input type="hidden" name="attr_shop_t5_i02_cost" value="55" /><input type="hidden" name="attr_shop_t5_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i02_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Maîtrise mineur de la magie des ombres</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Finesse de chauve souris</span></td><td><input type="hidden" name="attr_shop_t5_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">50</span></td><td><input type="hidden" name="attr_shop_t5_i03_cost" value="50" /><input type="hidden" name="attr_shop_t5_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i03_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en DEX</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t5_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">56</span></td><td><input type="hidden" name="attr_shop_t5_i04_cost" value="56" /><input type="hidden" name="attr_shop_t5_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i04_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Morsure devancé</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amélioration ADN</span></td><td><input type="hidden" name="attr_shop_t5_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">54</span></td><td><input type="hidden" name="attr_shop_t5_i05_cost" value="54" /><input type="hidden" name="attr_shop_t5_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i05_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Offre un bonus de +5% sur la ponction de sang ADN</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td><td><input type="hidden" name="attr_shop_t5_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">50</span></td><td><input type="hidden" name="attr_shop_t5_i06_cost" value="50" /><input type="hidden" name="attr_shop_t5_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i06_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 new talent</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Faculté Vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">55</span></td><td><input type="hidden" name="attr_shop_t5_i07_cost" value="55" /><input type="hidden" name="attr_shop_t5_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i07_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Maîtrise mineur de la magie charme vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Puissance vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">52</span></td><td><input type="hidden" name="attr_shop_t5_i08_cost" value="52" /><input type="hidden" name="attr_shop_t5_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i08_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+Nouvelle capacité ou sort</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Regard Vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">52</span></td><td><input type="hidden" name="attr_shop_t5_i09_cost" value="52" /><input type="hidden" name="attr_shop_t5_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i09_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+3 en PER</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t5_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">40</span></td><td><input type="hidden" name="attr_shop_t5_i10_cost" value="40" /><input type="hidden" name="attr_shop_t5_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i10_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Litanie du sang</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t5_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">50</span></td><td><input type="hidden" name="attr_shop_t5_i11_cost" value="50" /><input type="hidden" name="attr_shop_t5_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i11_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Frénésie Adaptative I</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t5_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">53</span></td><td><input type="hidden" name="attr_shop_t5_i12_cost" value="53" /><input type="hidden" name="attr_shop_t5_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i12_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Essence Convergente (Conditions : Jeune essence convergente)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande Amé. Sort/cap</span></td><td><input type="hidden" name="attr_shop_t5_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">54</span></td><td><input type="hidden" name="attr_shop_t5_i13_cost" value="54" /><input type="hidden" name="attr_shop_t5_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i13_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 amélioration de sort/capacité</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Terreur vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">50</span></td><td><input type="hidden" name="attr_shop_t5_i14_cost" value="50" /><input type="hidden" name="attr_shop_t5_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i14_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en CHA</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grand Point vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">59</span></td><td><input type="hidden" name="attr_shop_t5_i15_cost" value="59" /><input type="hidden" name="attr_shop_t5_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i15_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Point vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">57</span></td><td><input type="hidden" name="attr_shop_t5_i16_cost" value="57" /><input type="hidden" name="attr_shop_t5_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i16_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Cœur Vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">60</span></td><td><input type="hidden" name="attr_shop_t5_i17_cost" value="60" /><input type="hidden" name="attr_shop_t5_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i17_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point de Destin</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Jeune Corps Vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">50</span></td><td><input type="hidden" name="attr_shop_t5_i18_cost" value="50" /><input type="hidden" name="attr_shop_t5_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i18_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 en CST</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Origine vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">58</span></td><td><input type="hidden" name="attr_shop_t5_i19_cost" value="58" /><input type="hidden" name="attr_shop_t5_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i19_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 Origine Vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Force vampirique</span></td><td><input type="hidden" name="attr_shop_t5_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">50</span></td><td><input type="hidden" name="attr_shop_t5_i20_cost" value="50" /><input type="hidden" name="attr_shop_t5_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i20_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+3 en FOR (Conditions : Jeune Force Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent brave Vamp.</span></td><td><input type="hidden" name="attr_shop_t5_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">57</span></td><td><input type="hidden" name="attr_shop_t5_i21_cost" value="57" /><input type="hidden" name="attr_shop_t5_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i21_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Puissance Monstrueuse</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">POWEEER</span></td><td><input type="hidden" name="attr_shop_t5_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">55</span></td><td><input type="hidden" name="attr_shop_t5_i22_cost" value="55" /><input type="hidden" name="attr_shop_t5_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i22_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Maîtrise mineur de la foudre vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t5_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave Vamp.</span></td><td><input type="hidden" name="attr_shop_t5_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">57</span></td><td><input type="hidden" name="attr_shop_t5_i23_cost" value="57" /><input type="hidden" name="attr_shop_t5_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t5_i23_bought" /></span></td><td><input type="hidden" name="attr_shop_t5_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Saignée</span></td></tr>
        </tbody>
      </table>
    </details>

    <!-- =========================
         PALLIER 6
         ========================= -->
    <details class="sheet-tier">
      <summary class="sheet-tier-summary">Pallier 6 : Grand Vampire</summary>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
          <tr><td><input type="hidden" name="attr_shop_t6_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Corps du Vampire</span></td><td><input type="hidden" name="attr_shop_t6_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i01_cost" value="65" /><input type="hidden" name="attr_shop_t6_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i01_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en CST et Bonus en def phy de +3 (Conditions : Jeune corps Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Regard de la nuit</span></td><td><input type="hidden" name="attr_shop_t6_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i02_cost" value="65" /><input type="hidden" name="attr_shop_t6_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i02_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en PER et +1 en INST (Conditions : Regard Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t6_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i03_cost" value="68" /><input type="hidden" name="attr_shop_t6_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i03_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Écho Sanguin</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Faim Vampirique</span></td><td><input type="hidden" name="attr_shop_t6_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">71</span></td><td><input type="hidden" name="attr_shop_t6_i04_cost" value="71" /><input type="hidden" name="attr_shop_t6_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i04_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Gorge Insatiable III (Conditions : Gorge Insatiable II)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Agilité du vampire</span></td><td><input type="hidden" name="attr_shop_t6_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i05_cost" value="65" /><input type="hidden" name="attr_shop_t6_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i05_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 DEX et +2,5 MOV (Conditions : Finesse de la chauve souris)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Sage vampirique</span></td><td><input type="hidden" name="attr_shop_t6_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i06_cost" value="65" /><input type="hidden" name="attr_shop_t6_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i06_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en SAG et +3 en RM (Conditions : Jeune sage vampire)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Vie sous marine</span></td><td><input type="hidden" name="attr_shop_t6_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i07_cost" value="68" /><input type="hidden" name="attr_shop_t6_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i07_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Respiration aquatique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td><td><input type="hidden" name="attr_shop_t6_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">63</span></td><td><input type="hidden" name="attr_shop_t6_i08_cost" value="63" /><input type="hidden" name="attr_shop_t6_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i08_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 new talent et amélioration de talent</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t6_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i09_cost" value="68" /><input type="hidden" name="attr_shop_t6_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i09_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Échos du sombre passé</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t6_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">72</span></td><td><input type="hidden" name="attr_shop_t6_i10_cost" value="72" /><input type="hidden" name="attr_shop_t6_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i10_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Voile Miroitant (Conditions : Vampire des mirages)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t6_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">72</span></td><td><input type="hidden" name="attr_shop_t6_i11_cost" value="72" /><input type="hidden" name="attr_shop_t6_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i11_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Main du souverain (Conditions : Vampire Souverain)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Puissance Vampirique</span></td><td><input type="hidden" name="attr_shop_t6_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">62</span></td><td><input type="hidden" name="attr_shop_t6_i12_cost" value="62" /><input type="hidden" name="attr_shop_t6_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i12_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 Nouvelle capacité ou sort et 1 amé</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amélioration ADN</span></td><td><input type="hidden" name="attr_shop_t6_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">67</span></td><td><input type="hidden" name="attr_shop_t6_i13_cost" value="67" /><input type="hidden" name="attr_shop_t6_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i13_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Offre un bonus de +5% sur la ponction de sang ADN</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Nouveau talent</span></td><td><input type="hidden" name="attr_shop_t6_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i14_cost" value="65" /><input type="hidden" name="attr_shop_t6_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i14_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Résistance élémentaire mineur (10%)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Cruel vampire</span></td><td><input type="hidden" name="attr_shop_t6_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i15_cost" value="65" /><input type="hidden" name="attr_shop_t6_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i15_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en CHA et +1 en Social (Conditions : Terreur Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t6_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">74</span></td><td><input type="hidden" name="attr_shop_t6_i16_cost" value="74" /><input type="hidden" name="attr_shop_t6_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i16_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Marche rémanente Vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t6_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">71</span></td><td><input type="hidden" name="attr_shop_t6_i17_cost" value="71" /><input type="hidden" name="attr_shop_t6_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i17_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Frénésie adaptative II (Conditions : Frénésie adaptative I)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t6_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">72</span></td><td><input type="hidden" name="attr_shop_t6_i18_cost" value="72" /><input type="hidden" name="attr_shop_t6_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i18_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande Essence Convergente (Conditions : Essence convergente)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Force du grand vampire</span></td><td><input type="hidden" name="attr_shop_t6_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i19_cost" value="65" /><input type="hidden" name="attr_shop_t6_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i19_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en FOR et bonus +3 en dgts phy (Conditions : Force Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Cerveau Impérial</span></td><td><input type="hidden" name="attr_shop_t6_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i20_cost" value="65" /><input type="hidden" name="attr_shop_t6_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i20_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en INT et +3 bns dgts mag (Conditions : Cerveau en évolution)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Super Point vampirique</span></td><td><input type="hidden" name="attr_shop_t6_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">74</span></td><td><input type="hidden" name="attr_shop_t6_i21_cost" value="74" /><input type="hidden" name="attr_shop_t6_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i21_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Enfant des ombres</span></td><td><input type="hidden" name="attr_shop_t6_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">65</span></td><td><input type="hidden" name="attr_shop_t6_i22_cost" value="65" /><input type="hidden" name="attr_shop_t6_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i22_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Bonus de résistance élémentaire de 15%</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave vamp.</span></td><td><input type="hidden" name="attr_shop_t6_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">69</span></td><td><input type="hidden" name="attr_shop_t6_i23_cost" value="69" /><input type="hidden" name="attr_shop_t6_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i23_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande effusion de sang (Conditions : Effusion de sang)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande +Amé. Sort/cap</span></td><td><input type="hidden" name="attr_shop_t6_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i24_cost" value="68" /><input type="hidden" name="attr_shop_t6_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i24_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+3 amélioration de sort/capacité</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i25_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent brave Vamp.</span></td><td><input type="hidden" name="attr_shop_t6_i25_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i25_cost" value="68" /><input type="hidden" name="attr_shop_t6_i25_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i25_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i25_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grande Puissance monstrueuse (Conditions : Puissance monstrueuse)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i26_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave Vamp.</span></td><td><input type="hidden" name="attr_shop_t6_i26_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">70</span></td><td><input type="hidden" name="attr_shop_t6_i26_cost" value="70" /><input type="hidden" name="attr_shop_t6_i26_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i26_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i26_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Saignée +</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i27_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Talent Brave Vamp.</span></td><td><input type="hidden" name="attr_shop_t6_i27_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">70</span></td><td><input type="hidden" name="attr_shop_t6_i27_cost" value="70" /><input type="hidden" name="attr_shop_t6_i27_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i27_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i27_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Lucky ADN</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i28_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité Vamp</span></td><td><input type="hidden" name="attr_shop_t6_i28_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i28_cost" value="68" /><input type="hidden" name="attr_shop_t6_i28_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i28_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i28_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Transformation : petit animal</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i29_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité Vamp</span></td><td><input type="hidden" name="attr_shop_t6_i29_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i29_cost" value="68" /><input type="hidden" name="attr_shop_t6_i29_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i29_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i29_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Transformation : Brume</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t6_i30_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité Vamp</span></td><td><input type="hidden" name="attr_shop_t6_i30_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">68</span></td><td><input type="hidden" name="attr_shop_t6_i30_cost" value="68" /><input type="hidden" name="attr_shop_t6_i30_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t6_i30_bought" /></span></td><td><input type="hidden" name="attr_shop_t6_i30_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Transfo. Partielle : aile Vampirique</span></td></tr>
        </tbody>
      </table>
    </details>

    <!-- =========================
         PALLIER 7
         ========================= -->
    <details class="sheet-tier">
      <summary class="sheet-tier-summary">Pallier 7 : Seigneur Vampire</summary>

      <table class="sheet-shop-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Coût (LS)</th>
            <th>Acheté</th>
            <th>Récompense</th>
          </tr>
        </thead>

        <tbody>
          <tr><td><input type="hidden" name="attr_shop_t7_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grand Puissance vamp</span></td><td><input type="hidden" name="attr_shop_t7_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">76</span></td><td><input type="hidden" name="attr_shop_t7_i01_cost" value="76" /><input type="hidden" name="attr_shop_t7_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i01_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i01_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 Nouvelle capacité ou sort</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i02_cost" value="80" /><input type="hidden" name="attr_shop_t7_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i02_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i02_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Ponction du maître royaume des Ombres</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Regard du seigneur</span></td><td><input type="hidden" name="attr_shop_t7_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">78</span></td><td><input type="hidden" name="attr_shop_t7_i03_cost" value="78" /><input type="hidden" name="attr_shop_t7_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i03_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i03_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en PER et +1 en INST ou SANG (Conditions : Regard de la nuit)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Sens suprême</span></td><td><input type="hidden" name="attr_shop_t7_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i04_cost" value="80" /><input type="hidden" name="attr_shop_t7_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i04_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i04_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+10 en Réactivité et 1 point de réaction</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">82</span></td><td><input type="hidden" name="attr_shop_t7_i05_cost" value="82" /><input type="hidden" name="attr_shop_t7_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i05_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i05_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Chant des anciens</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">78</span></td><td><input type="hidden" name="attr_shop_t7_i06_cost" value="78" /><input type="hidden" name="attr_shop_t7_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i06_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i06_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Litanie du sang éternel (Conditions : Litanie du sang)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Corps seigneur vampire</span></td><td><input type="hidden" name="attr_shop_t7_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i07_cost" value="80" /><input type="hidden" name="attr_shop_t7_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i07_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i07_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+6 en CST, +1 en Rés ou +1,5 MOV (Conditions : Corps Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Finesse du seigneur</span></td><td><input type="hidden" name="attr_shop_t7_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i08_cost" value="80" /><input type="hidden" name="attr_shop_t7_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i08_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i08_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+6 en DEX, +1 en FIN ou INST (Conditions : Agilité du vampire)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Volée Talent</span></td><td><input type="hidden" name="attr_shop_t7_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">86</span></td><td><input type="hidden" name="attr_shop_t7_i09_cost" value="86" /><input type="hidden" name="attr_shop_t7_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i09_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i09_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+3 point de talent</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Immense Amé. Sort/cap</span></td><td><input type="hidden" name="attr_shop_t7_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">84</span></td><td><input type="hidden" name="attr_shop_t7_i10_cost" value="84" /><input type="hidden" name="attr_shop_t7_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i10_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i10_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+4 amélioration de sort/capacité</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Amélioration ADN</span></td><td><input type="hidden" name="attr_shop_t7_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">82</span></td><td><input type="hidden" name="attr_shop_t7_i11_cost" value="82" /><input type="hidden" name="attr_shop_t7_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i11_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i11_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Offre un bonus de +5% sur la ponction de sang ADN</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Cauchemars du monde</span></td><td><input type="hidden" name="attr_shop_t7_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i12_cost" value="80" /><input type="hidden" name="attr_shop_t7_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i12_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i12_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+6 en CHA et +1 en SOC (Conditions : Cruel vampire)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Peau ancien</span></td><td><input type="hidden" name="attr_shop_t7_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">73</span></td><td><input type="hidden" name="attr_shop_t7_i13_cost" value="73" /><input type="hidden" name="attr_shop_t7_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i13_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i13_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Résistance majeur au saignement</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">83</span></td><td><input type="hidden" name="attr_shop_t7_i14_cost" value="83" /><input type="hidden" name="attr_shop_t7_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i14_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i14_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Omniscience Sanguine</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grand sage Vampirique</span></td><td><input type="hidden" name="attr_shop_t7_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i15_cost" value="80" /><input type="hidden" name="attr_shop_t7_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i15_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i15_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+6 en SAG et +4 en RM (Conditions : Sage Vampirique)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">82</span></td><td><input type="hidden" name="attr_shop_t7_i16_cost" value="82" /><input type="hidden" name="attr_shop_t7_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i16_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i16_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Frénésie Adaptative III (Conditions : Frénésie Adaptative II)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Force du seigneur</span></td><td><input type="hidden" name="attr_shop_t7_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i17_cost" value="80" /><input type="hidden" name="attr_shop_t7_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i17_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i17_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+5 en FOR et +2 PUI (Conditions : Force du grand vampire)</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">86</span></td><td><input type="hidden" name="attr_shop_t7_i18_cost" value="86" /><input type="hidden" name="attr_shop_t7_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i18_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i18_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Marque de la destruction</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Savoir ancien</span></td><td><input type="hidden" name="attr_shop_t7_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">90</span></td><td><input type="hidden" name="attr_shop_t7_i19_cost" value="90" /><input type="hidden" name="attr_shop_t7_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i19_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i19_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+10 Point de connaissance</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Capacité du seigneur</span></td><td><input type="hidden" name="attr_shop_t7_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">100</span></td><td><input type="hidden" name="attr_shop_t7_i20_cost" value="100" /><input type="hidden" name="attr_shop_t7_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i20_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i20_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Sort vampirique : Soul Steal</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Origine vampirique</span></td><td><input type="hidden" name="attr_shop_t7_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">88</span></td><td><input type="hidden" name="attr_shop_t7_i21_cost" value="88" /><input type="hidden" name="attr_shop_t7_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i21_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i21_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 Origine Vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Grand Point vampirique</span></td><td><input type="hidden" name="attr_shop_t7_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">80</span></td><td><input type="hidden" name="attr_shop_t7_i22_cost" value="80" /><input type="hidden" name="attr_shop_t7_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i22_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i22_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+2 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Point vampirique</span></td><td><input type="hidden" name="attr_shop_t7_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">78</span></td><td><input type="hidden" name="attr_shop_t7_i23_cost" value="78" /><input type="hidden" name="attr_shop_t7_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i23_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i23_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">+1 point vampirique</span></td></tr>
          <tr><td><input type="hidden" name="attr_shop_t7_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Obt. de Point de LS</span></td><td><input type="hidden" name="attr_shop_t7_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">84</span></td><td><input type="hidden" name="attr_shop_t7_i24_cost" value="84" /><input type="hidden" name="attr_shop_t7_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-buywrap"><input type="checkbox" name="attr_shop_t7_i24_bought" /></span></td><td><input type="hidden" name="attr_shop_t7_i24_canbuy" class="sheet-canbuy" value="1" /><span class="sheet-celltext">Essence Originel Convergente (Conditions : Grande Essence convergente)</span></td></tr>
        </tbody>
      </table>
    </details>

  </details>
</div>











  </div>
</div>










<script type="text/worker">
// ===================================================================
// SYSTÈME DE TITRE ACTUEL - SÉLECTION UNIQUE
// ===================================================================

/**
 * Fonction principale : Gestion de la sélection unique des titres
 * Quand un titre est sélectionné :
 * 1. Désactive tous les autres titres
 * 2. Transfère le nom et l'effet dans "Titre Actuel"
 */
on("change:repeating_titresaventure:titre_actuel_selected", function(eventInfo) {
    console.log("=== CHANGEMENT TITRE ACTUEL ===");
    console.log("Event source:", eventInfo.sourceAttribute);
    
    // Extraire l'ID de la ligne qui a été modifiée
    var sourceAttr = eventInfo.sourceAttribute;
    var match = sourceAttr.match(/repeating_titresaventure_([^_]+)_/);
    
    if (!match) {
        console.error("Impossible d'extraire l'ID de section");
        return;
    }
    
    var selectedId = match[1];
    console.log("ID de la ligne sélectionnée:", selectedId);
    
    // Récupérer d'abord la valeur de la checkbox qui vient d'être modifiée
    var selectedCheckboxAttr = "repeating_titresaventure_" + selectedId + "_titre_actuel_selected";
    
    getAttrs([selectedCheckboxAttr], function(values) {
        var isChecked = values[selectedCheckboxAttr] === "1";
        console.log("Checkbox cochée?", isChecked);
        
        if (isChecked) {
            // La checkbox vient d'être cochée, on procède à la sélection unique
            handleTitreSelection(selectedId);
        } else {
            // La checkbox vient d'être décochée, on vide le titre actuel
            clearTitreActuel();
        }
    });
});

/**
 * Fonction : Gère la sélection d'un titre
 * - Désactive tous les autres titres
 * - Transfère les données du titre sélectionné
 */
function handleTitreSelection(selectedId) {
    console.log("Traitement de la sélection du titre:", selectedId);
    
    // Récupérer tous les IDs de la section repeating_titresaventure
    getSectionIDs("repeating_titresaventure", function(idArray) {
        console.log("IDs de titres trouvés:", idArray);
        
        // Construire la liste des attributs à récupérer
        var attrsToGet = [];
        
        // Pour chaque ID, on récupère la checkbox, le nom et l'effet
        idArray.forEach(function(id) {
            attrsToGet.push("repeating_titresaventure_" + id + "_titre_actuel_selected");
            attrsToGet.push("repeating_titresaventure_" + id + "_titre_aventure_nom");
            attrsToGet.push("repeating_titresaventure_" + id + "_titre_aventure_effet");
        });
        
        console.log("Attributs à récupérer:", attrsToGet);
        
        // Récupérer toutes les valeurs
        getAttrs(attrsToGet, function(values) {
            console.log("Valeurs récupérées:", values);
            
            var updates = {};
            
            // 1. Décocher toutes les autres checkboxes
            idArray.forEach(function(id) {
                if (id !== selectedId) {
                    updates["repeating_titresaventure_" + id + "_titre_actuel_selected"] = "0";
                }
            });
            
            // 2. S'assurer que la checkbox sélectionnée reste cochée
            updates["repeating_titresaventure_" + selectedId + "_titre_actuel_selected"] = "1";
            
            // 3. Récupérer les données du titre sélectionné
            var selectedNom = values["repeating_titresaventure_" + selectedId + "_titre_aventure_nom"] || "";
            var selectedEffet = values["repeating_titresaventure_" + selectedId + "_titre_aventure_effet"] || "";
            
            console.log("Titre sélectionné:", selectedNom);
            console.log("Effet sélectionné:", selectedEffet);
            
            // 4. Mettre à jour le "Titre Actuel" en haut
            updates["titre_actuel_nom"] = selectedNom;
            updates["titre_actuel_effet"] = selectedEffet;
            updates["titre_actuel_section_id"] = selectedId; // Stocker l'ID pour référence future
            
            // 5. Appliquer toutes les mises à jour
            // IMPORTANT: {silent: true} évite de déclencher un nouveau change event et donc une boucle infinie
            setAttrs(updates, {silent: true}, function() {
                console.log("✅ Titre actuel mis à jour avec succès");
                console.log("Nom:", selectedNom);
                console.log("Effet:", selectedEffet);
            });
        });
    });
}

/**
 * Fonction : Vide le titre actuel quand aucune checkbox n'est cochée
 */
function clearTitreActuel() {
    console.log("Vidage du titre actuel");
    
    setAttrs({
        "titre_actuel_nom": "",
        "titre_actuel_effet": "",
        "titre_actuel_section_id": ""
    }, {silent: true}, function() {
        console.log("✅ Titre actuel vidé");
    });
}

/**
 * Fonction : Synchronisation quand le nom ou l'effet d'un titre est modifié
 * Si ce titre est actuellement actif, on met à jour le titre actuel
 */
on("change:repeating_titresaventure:titre_aventure_nom change:repeating_titresaventure:titre_aventure_effet", function(eventInfo) {
    console.log("=== MODIFICATION D'UN TITRE ===");
    
    // Extraire l'ID de la ligne modifiée
    var sourceAttr = eventInfo.sourceAttribute;
    var match = sourceAttr.match(/repeating_titresaventure_([^_]+)_/);
    
    if (!match) {
        return;
    }
    
    var modifiedId = match[1];
    
    // Vérifier si ce titre est actuellement actif
    getAttrs([
        "titre_actuel_section_id",
        "repeating_titresaventure_" + modifiedId + "_titre_aventure_nom",
        "repeating_titresaventure_" + modifiedId + "_titre_aventure_effet"
    ], function(values) {
        
        var activeTitreId = values["titre_actuel_section_id"];
        
        // Si ce titre est actuellement actif, on met à jour le titre actuel
        if (activeTitreId === modifiedId) {
            console.log("Le titre modifié est actif, mise à jour du titre actuel");
            
            var newNom = values["repeating_titresaventure_" + modifiedId + "_titre_aventure_nom"] || "";
            var newEffet = values["repeating_titresaventure_" + modifiedId + "_titre_aventure_effet"] || "";
            
            setAttrs({
                "titre_actuel_nom": newNom,
                "titre_actuel_effet": newEffet
            }, {silent: true}, function() {
                console.log("✅ Titre actuel synchronisé");
            });
        }
    });
});

/**
 * Fonction : Initialisation à l'ouverture de la fiche
 * Vérifie qu'un seul titre est sélectionné
 */
on("sheet:opened", function() {
    console.log("=== OUVERTURE FICHE - VÉRIFICATION TITRES ===");
    
    getSectionIDs("repeating_titresaventure", function(idArray) {
        if (idArray.length === 0) {
            console.log("Aucun titre trouvé");
            return;
        }
        
        var attrsToGet = [];
        idArray.forEach(function(id) {
            attrsToGet.push("repeating_titresaventure_" + id + "_titre_actuel_selected");
        });
        
        getAttrs(attrsToGet, function(values) {
            var selectedIds = [];
            
            // Trouver tous les titres sélectionnés
            idArray.forEach(function(id) {
                if (values["repeating_titresaventure_" + id + "_titre_actuel_selected"] === "1") {
                    selectedIds.push(id);
                }
            });
            
            console.log("Titres sélectionnés trouvés:", selectedIds.length);
            
            // Si plusieurs titres sont sélectionnés, on ne garde que le premier
            if (selectedIds.length > 1) {
                console.warn("⚠️ Plusieurs titres sélectionnés, correction...");
                var updates = {};
                
                // Décocher tous sauf le premier
                for (var i = 1; i < selectedIds.length; i++) {
                    updates["repeating_titresaventure_" + selectedIds[i] + "_titre_actuel_selected"] = "0";
                }
                
                setAttrs(updates, {silent: true}, function() {
                    console.log("✅ Correction appliquée");
                    // Forcer la mise à jour du titre actuel avec le premier sélectionné
                    handleTitreSelection(selectedIds[0]);
                });
            } else if (selectedIds.length === 1) {
                // Un seul titre sélectionné, vérifier que le titre actuel est à jour
                handleTitreSelection(selectedIds[0]);
            }
        });
    });
});

console.log("✅ Sheet Workers de Titres chargés avec succès");
</script>

<script type="text/worker">
const stats = ["for", "cst", "dex", "int", "sag", "per", "cha", "resm", "reac"];

stats.forEach(stat => {
  on(`change:${stat}_jaune change:${stat}_orange change:${stat}_rouge change:blessure_${stat}_val change:${stat}_diff`, function () {
    const attrs = [
      `${stat}_jaune`, `${stat}_orange`, `${stat}_rouge`,
      `blessure_${stat}_val`, `${stat}_diff`
    ];

    getAttrs(attrs, values => {
      const active =
        values[`${stat}_jaune`] === "on" ||
        values[`${stat}_orange`] === "on" ||
        values[`${stat}_rouge`] === "on";

      const base = parseInt(values[`${stat}_diff`], 10) || 0;
      const malus = parseInt(values[`blessure_${stat}_val`], 10) || 0;
      const total = base + (active ? malus : 0);

      const update = {};
      update[`${stat}_diff_total`] = total;
      setAttrs(update);
    });
  });
});

</script>


<script type="text/worker">
const stats = [
  { base: "for", diff: "for_diff", bless: "blessure_for_val", checks: ["for_jaune", "for_orange", "for_rouge"] },
  { base: "cst", diff: "cst_diff", bless: "blessure_cst_val", checks: ["cst_jaune", "cst_orange", "cst_rouge"] },
  { base: "dex", diff: "dex_diff", bless: "blessure_dex_val", checks: ["dex_jaune", "dex_orange", "dex_rouge"] },
  { base: "int", diff: "int_diff", bless: "blessure_int_val", checks: ["int_jaune", "int_orange", "int_rouge"] },
  { base: "sag", diff: "sag_diff", bless: "blessure_sag_val", checks: ["sag_jaune", "sag_orange", "sag_rouge"] },
  { base: "per", diff: "per_diff", bless: "blessure_per_val", checks: ["per_jaune", "per_orange", "per_rouge"] },
  { base: "cha", diff: "cha_diff", bless: "blessure_cha_val", checks: ["cha_jaune", "cha_orange", "cha_rouge"] },
  { base: "rm", diff: "rm_diff", bless: "blessure_resm_val", checks: ["resm_jaune", "resm_orange", "resm_rouge"] },
  { base: "rea", diff: "rea_diff", bless: "blessure_reac_val", checks: ["reac_jaune", "reac_orange", "reac_rouge"] },
];

stats.forEach(stat => {
  const attrsToWatch = [...stat.checks, stat.diff, stat.bless];
  const eventStr = attrsToWatch.map(attr => `change:${attr}`).join(" ");

  on(eventStr, () => {
    getAttrs(attrsToWatch, values => {
      const isActive = stat.checks.some(check => values[check] === "on");
      const baseDiff = parseInt(values[stat.diff], 10) || 0;
      const bless = parseInt(values[stat.bless], 10) || 0;

      const total = isActive ? baseDiff + bless : baseDiff;

      setAttrs({
        [`${stat.base}_diff_effectif`]: total
      });
    });
  });
});
</script>


<script type="text/worker">
function updateTraitCompetenceBonus() {
  getSectionIDs("repeating_traitcompetences", function(ids) {
    if (!ids.length) {
      setAttrs({ trait_competence_bonus_total: 0 });
      return;
    }
    const fields = ids.reduce((arr, id) => {
      arr.push(
        `repeating_traitcompetences_${id}_trait_comp_bonus1`,
        `repeating_traitcompetences_${id}_trait_comp_active1`,
        `repeating_traitcompetences_${id}_trait_comp_bonus2`,
        `repeating_traitcompetences_${id}_trait_comp_active2`
      );
      return arr;
    }, []);
    getAttrs(fields, function(v) {
      let total = 0;
      ids.forEach(id => {
        if (v[`repeating_traitcompetences_${id}_trait_comp_active1`] === "on") {
          total += parseInt(v[`repeating_traitcompetences_${id}_trait_comp_bonus1`], 10) || 0;
        }
        if (v[`repeating_traitcompetences_${id}_trait_comp_active2`] === "on") {
          total += parseInt(v[`repeating_traitcompetences_${id}_trait_comp_bonus2`], 10) || 0;
        }
      });
      setAttrs({ trait_competence_bonus_total: total });
    });
  });
}

on("change:repeating_traitcompetences:trait_comp_bonus1 change:repeating_traitcompetences:trait_comp_active1 change:repeating_traitcompetences:trait_comp_bonus2 change:repeating_traitcompetences:trait_comp_active2 remove:repeating_traitcompetences", updateTraitCompetenceBonus);
</script>

<script type="text/worker">
/* ---------- Utilitaires ---------- */
const int = (v) => parseInt(v, 10) || 0;

/** Lancer un dé de gain et mettre à jour les valeurs
 *  typeLabel : "PV" | "PM" | "PE"
 *  diceAttr  : "gain_pv_dice" | "gain_pm_dice" | "gain_pe_dice"
 *  baseAttr  : "pv_base"      | "pm_base"      | "pe_base"
 *  bonusAttr : "pv_bonus"     | "pm_bonus"     | "pe_bonus"     (peut ne pas exister, on gère 0)
 *  totalAttr : "pv_total"     | "pm_total"     | "pe_total"
 *  curAttr   : "pv_actuel"    | "pm_actuel"    | "pe_actuel"
 */
function doGain(typeLabel, diceAttr, baseAttr, bonusAttr, totalAttr, curAttr) {
  getAttrs([diceAttr, baseAttr, bonusAttr], (v) => {
    const rollExpr = (v[diceAttr] || "").trim();
    const currentBase = int(v[baseAttr]);
    const bonus = int(v[bonusAttr]); // si l’attribut n’existe pas, ça vaudra 0

    if (!rollExpr) {
      // Rien à lancer
      sendChat("", `/w gm ⚠️ Aucun dé configuré pour ${typeLabel} (champ ${diceAttr}).`);
      return;
    }

    startRoll(`&{template:default} {{name=Gain ${typeLabel}}} {{Jet=[[${rollExpr}]]}}`, (results) => {
      const gain = int(results.results.Jet.result);
      const newBase = currentBase + gain;
      const newTotal = newBase + bonus;

      setAttrs({
        [baseAttr]:  newBase,
        [totalAttr]: newTotal,
        [curAttr]:   newTotal  // si tu ne veux pas remplir l’actuel, retire cette ligne
      });

      finishRoll(results.rollId, { Jet: gain });
    });
  });
}

/* ---------- Écouteurs des boutons ---------- */
on("clicked:gain_pv", () => doGain("PV", "gain_pv_dice", "pv_base", "pv_bonus", "pv_total", "pv_actuel"));
on("clicked:gain_pm", () => doGain("PM", "gain_pm_dice", "pm_base", "pm_bonus", "pm_total", "pm_actuel"));
on("clicked:gain_pe", () => doGain("PE", "gain_pe_dice", "pe_base", "pe_bonus", "pe_total", "pe_actuel"));

/* ---------- Recalcul auto des totaux quand base/bonus changent ---------- */
function autoTotal(baseAttr, bonusAttr, totalAttr, curAttr) {
  on(`change:${baseAttr} change:${bonusAttr}`, () => {
    getAttrs([baseAttr, bonusAttr], (v) => {
      const total = int(v[baseAttr]) + int(v[bonusAttr]);
      setAttrs({
        [totalAttr]: total,
        [curAttr]:   total // si tu ne veux pas sync l’actuel, retire cette ligne
      });
    });
  });
}
autoTotal("pv_base", "pv_bonus", "pv_total", "pv_actuel");
autoTotal("pm_base", "pm_bonus", "pm_total", "pm_actuel");
autoTotal("pe_base", "pe_bonus", "pe_total", "pe_actuel");
</script>
<!-- =========================
     SCRIPT LANCEMENT DÉS
     ========================= -->
<script type="text/worker">
// Tableaux d'effets
const effetsDestin = {
  1: "Chance incroyable ➡️ Offre un bonus de +15 au résultat.",
  2: "Chance incroyable ➡️ Offre un bonus de +15 au résultat.",
  3: "Reprise inespérée ➡️ Relance et conserve le meilleur résultat.",
  4: "Reprise inespérée ➡️ Relance et conserve le meilleur résultat.",
  5: "Sûreté inespérée ➡️ Annule un échec critique subi.",
  6: "Sûreté inespérée ➡️ Annule un échec critique subi."
};

const effetsFatalite = {
  1: "Malchance incroyable ➡️ Inflige un malus de -10 au résultat.",
  2: "Malchance incroyable ➡️ Inflige un malus de -10 au résultat.",
  3: "Reprise malencontreuse ➡️ Relance et garde le moins bon résultat.",
  4: "Reprise malencontreuse ➡️ Relance et garde le moins bon résultat.",
  5: "Panique incontrôlable ➡️ Perte de l'utilisation de toutes ces compétences pendant 1 tour.",
  6: "Panique incontrôlable ➡️ Perte de l'utilisation de toutes ces compétences pendant 1 tour."
};

// Fonction de lancement
function lancerDeSpecial(type) {
  const valeur = Math.floor(Math.random() * 6) + 1;
  
  if (type === 'destin') {
    const effet = effetsDestin[valeur];
    startRoll(`&{template:despecial} {{nom=Dé de Destin}} {{resultat=${valeur}}} {{effet=${effet}}}`, (results) => {
      finishRoll(results.rollId);
    });
  } else {
    const effet = effetsFatalite[valeur];
    startRoll(`&{template:despecial} {{nom=Dé de Fatalité}} {{resultat=${valeur}}} {{effet=${effet}}} {{fatalite=1}}`, (results) => {
      finishRoll(results.rollId);
    });
  }
}

// Events listeners
on("clicked:des_destin", function() {
  lancerDeSpecial('destin');
});

on("clicked:des_fatalite", function() {
  lancerDeSpecial('fatalite');
});
</script>

<script type="text/worker">

// ========== FONCTION DE CALCUL DES MODIFICATEURS ==========
function calculateModifier(caracValue) {
    const value = parseInt(caracValue) || 0;
    
    if (value < 1) return -4; // Sécurité pour valeurs négatives/nulles
    
    // 1-4 : -4
    if (value >= 1 && value <= 4) return -4;
    
    // 5-9 : -3
    if (value >= 5 && value <= 9) return -3;
    
    // 10-14 : -2
    if (value >= 10 && value <= 14) return -2;
    
    // 15-19 : -1
    if (value >= 15 && value <= 19) return -1;
    
    // 20-29 : 0
    if (value >= 20 && value <= 29) return 0;
    
    // 30-34 : +1
    if (value >= 30 && value <= 34) return 1;
    
    // 35-39 : +2
    if (value >= 35 && value <= 39) return 2;
    
    // 40-44 : +3
    if (value >= 40 && value <= 44) return 3;
    
    // 45-49 : +4
    if (value >= 45 && value <= 49) return 4;
    
    // 50+ : tranches de 10 pour +5, +6, +7, etc.
    if (value >= 50) {
        return 5 + Math.floor((value - 50) / 10);
    }
    
    return 0; // Fallback
}

// ========== LISTE DES CARACTÉRISTIQUES À CALCULER ==========
const characteristics = ['for', 'cst', 'dex', 'int', 'sag', 'per', 'cha'];

// ========== CRÉATION DES LISTENERS POUR CHAQUE CARACTÉRISTIQUE ==========
characteristics.forEach(carac => {
    on(`change:${carac}`, function(eventInfo) {
        const caracValue = eventInfo.newValue;
        const newMod = calculateModifier(caracValue);
        
        // Mise à jour du modificateur
        const updates = {};
        updates[`${carac}_mod`] = newMod;
        setAttrs(updates);
        
        // Log pour debug (à supprimer en production)
        console.log(`${carac.toUpperCase()}: ${caracValue} → Mod: ${newMod}`);
    });
});

// ========== CALCUL INITIAL AU CHARGEMENT DE LA FICHE ==========
on('sheet:opened', function() {
    // Récupérer toutes les valeurs de caractéristiques
    const attrNames = characteristics.map(carac => carac);
    
    getAttrs(attrNames, function(values) {
        const updates = {};
        
        // Calculer tous les modificateurs
        characteristics.forEach(carac => {
            const caracValue = values[carac] || 0;
            const newMod = calculateModifier(caracValue);
            updates[`${carac}_mod`] = newMod;
        });
        
        // Appliquer toutes les mises à jour
        setAttrs(updates);
        
        console.log('Modificateurs recalculés au chargement de la fiche');
    });
});

// ========== GESTION DES POINTS DE RÉACTION ==========

// Calcul de l'affichage PR (current/max)
function updatePRDisplay() {
    getAttrs(['pr_current', 'pr_max'], function(values) {
        const current = parseInt(values.pr_current) || 0;
        const max = parseInt(values.pr_max) || 4;
        
        setAttrs({
            'pr_display': `${current}/${max}`
        });
    });
}

// Bouton +1 PR
on('clicked:act_pr_plus', function() {
    getAttrs(['pr_current', 'pr_max'], function(values) {
        const current = parseInt(values.pr_current) || 0;
        const max = parseInt(values.pr_max) || 4;
        
        const newCurrent = Math.min(current + 1, max); // Ne pas dépasser le max
        
        setAttrs({
            'pr_current': newCurrent
        }, function() {
            updatePRDisplay();
        });
    });
});

// Bouton -1 PR
on('clicked:act_pr_minus', function() {
    getAttrs(['pr_current'], function(values) {
        const current = parseInt(values.pr_current) || 0;
        
        const newCurrent = current - 1; // Peut être négatif
        
        setAttrs({
            'pr_current': newCurrent
        }, function() {
            updatePRDisplay();
        });
    });
});

// Bouton Reset PR
on('clicked:act_pr_reset', function() {
    getAttrs(['pr_max'], function(values) {
        const max = parseInt(values.pr_max) || 4;
        
        setAttrs({
            'pr_current': max
        }, function() {
            updatePRDisplay();
        });
    });
});

// Mise à jour de l'affichage quand PR max change
on('change:pr_max', function() {
    updatePRDisplay();
});

// Mise à jour de l'affichage quand PR current change
on('change:pr_current', function() {
    updatePRDisplay();
});

// Initialisation PR au chargement
on('sheet:opened', function() {
    updatePRDisplay();
});

// ========== BOUTON COURSE ==========
on('clicked:act_course', function() {
    getAttrs(['pr_current'], function(values) {
        const current = parseInt(values.pr_current) || 0;
        
        if (current > 0) {
            // Consommer 1 PR et activer la course
            setAttrs({
                'pr_current': current - 1
            }, function() {
                updatePRDisplay();
                // Message dans le chat
                startRoll('/em utilise Course ! (-1 PR)', function(results) {
                    finishRoll(results.rollId);
                });
            });
        } else {
            // Pas assez de PR
            startRoll('/em ne peut pas utiliser Course (pas assez de PR)', function(results) {
                finishRoll(results.rollId);
            });
        }
    });
});

// ========== FONCTION DE TEST POUR DEBUG ==========
on('clicked:test_mods', function() {
    console.log('=== TEST DES MODIFICATEURS ===');
    const testValues = [1, 4, 5, 9, 10, 14, 15, 19, 20, 29, 30, 34, 35, 39, 40, 44, 45, 49, 50, 59, 60, 69, 70, 100];
    
    testValues.forEach(val => {
        const mod = calculateModifier(val);
        console.log(`Valeur ${val} → Mod ${mod >= 0 ? '+' : ''}${mod}`);
    });
    console.log('=== FIN TEST ===');
});

</script>

<script type="text/worker">
function lancerDe(tableEffets, nom) {
  const valeur = Math.floor(Math.random() * 6) + 1;
  const effet = tableEffets[valeur] || "Aucun effet.";

  startRoll(`&{template:despecial} {{name=${nom}}} {{resultat=${valeur}}} {{effet=${effet}}}`, (results) => {
    finishRoll(results.rollId);
  });
}
</script>

<script type="text/worker">
// === SHEET WORKER POINTS DE RÉACTION - VERSION OPTIMISÉE ===

// FONCTION PRINCIPALE : Mise à jour instantanée de l'affichage X/Y
const updateDisplay = () => {
    getAttrs(["pr_current", "pr_max"], (values) => {
        // Récupération directe des valeurs
        const prCurrent = parseInt(values.pr_current) || 0;
        const prMax = parseInt(values.pr_max) || 0;
        
        // NOUVELLE RÈGLE : -Y ≤ X ≤ Y (X peut être négatif jusqu'à -MAX)
        const prCurrentBorne = Math.max(-prMax, Math.min(prCurrent, prMax));
        
        // Affichage : X/Y où Y = pr_max TOUJOURS
        const affichage = `${prCurrentBorne}/${prMax}`;
        
        // Mise à jour immédiate
        const updates = {
            pr_display: affichage
        };
        
        // Correction de pr_current si hors limites
        if (prCurrentBorne !== prCurrent) {
            updates.pr_current = prCurrentBorne;
        }
        
        setAttrs(updates);
        console.log(` ${affichage} (limites: -${prMax} à +${prMax})`);
    });
};

// === ÉVÉNEMENTS INSTANTANÉS ===

// Changement de pr_max → mise à jour immédiate
on("change:pr_max", updateDisplay);

// Changement de pr_current → mise à jour immédiate
on("change:pr_current", updateDisplay);

// === BOUTONS OPTIMISÉS ===

// Bouton +1 : Augmente pr_current (limite : +MAX)
on("clicked:pr_plus", () => {
    getAttrs(["pr_current", "pr_max"], (values) => {
        const prCurrent = parseInt(values.pr_current) || 0;
        const prMax = parseInt(values.pr_max) || 0;
        const nouveauCurrent = Math.min(prCurrent + 1, prMax);
        
        if (nouveauCurrent !== prCurrent) {
            setAttrs({ pr_current: nouveauCurrent });
            console.log(`➕ +1: ${prCurrent} → ${nouveauCurrent}`);
        } else {
            console.log(`⚠️ Déjà au maximum: ${prCurrent}/${prMax}`);
        }
    });
});

// Bouton -1 : Diminue pr_current (limite : -MAX)
on("clicked:pr_minus", () => {
    getAttrs(["pr_current", "pr_max"], (values) => {
        const prCurrent = parseInt(values.pr_current) || 0;
        const prMax = parseInt(values.pr_max) || 0;
        const nouveauCurrent = Math.max(prCurrent - 1, -prMax);
        
        if (nouveauCurrent !== prCurrent) {
            setAttrs({ pr_current: nouveauCurrent });
            console.log(`➖ -1: ${prCurrent} → ${nouveauCurrent}`);
        } else {
            console.log(`⚠️ Déjà au minimum: ${prCurrent}/${prMax} (limite: -${prMax})`);
        }
    });
});

// Bouton Reset : pr_current = pr_max (valeur positive maximale)
on("clicked:pr_reset", () => {
    getAttrs(["pr_max"], (values) => {
        const prMax = parseInt(values.pr_max) || 0;
        setAttrs({ pr_current: prMax });
        console.log(` Reset: Current → ${prMax}`);
    });
});

// Bouton Course : MÊME LOGIQUE QUE pr_minus + rolltemplate
on("clicked:course", () => {
    getAttrs(["pr_current", "pr_max", "mov"], (values) => {
        const prCurrent = parseInt(values.pr_current) || 0;
        const prMax = parseInt(values.pr_max) || 0;
        const mouvement = values.mov || "0 ft";
        
        // EXACTEMENT la même logique que pr_minus
        const nouveauCurrent = Math.max(prCurrent - 1, -prMax);
        
        if (nouveauCurrent !== prCurrent) {
            setAttrs({ pr_current: nouveauCurrent }, () => {
                // APRÈS la mise à jour automatique, lancer le rolltemplate
                startRoll(`&{template:course-action} {{nom=Course}} {{mouvement=${mouvement}}} {{pr_apres=${nouveauCurrent}}}`, (results) => {
                    finishRoll(results.rollId);
                });
            });
            console.log(` Course: ${prCurrent} → ${nouveauCurrent}`);
        } else {
            console.log(`⚠️ Course impossible - déjà au minimum: ${prCurrent}/${prMax} (limite: -${prMax})`);
            // Afficher le rolltemplate même si pas de changement
            startRoll(`&{template:course-action} {{nom=Course}} {{mouvement=${mouvement}}} {{pr_apres=${prCurrent}}}`, (results) => {
                finishRoll(results.rollId);
            });
        }
    });
});

// === INITIALISATION RAPIDE ===

// À l'ouverture : initialisation minimale et rapide
on("sheet:opened", () => {
    getAttrs(["pr_max", "pr_current"], (values) => {
        const updates = {};
        
        // Valeurs par défaut UNIQUEMENT si inexistantes
        if (values.pr_max === undefined || values.pr_max === "") {
            updates.pr_max = 4;
        }
        if (values.pr_current === undefined || values.pr_current === "") {
            updates.pr_current = parseInt(updates.pr_max || values.pr_max) || 4;
        }
        
        if (Object.keys(updates).length > 0) {
            setAttrs(updates, updateDisplay);
        } else {
            updateDisplay();
        }
    });
});

// === VALIDATION INSTANTANÉE ===

// Validation pr_max : limites raisonnables
on("change:pr_max", (eventInfo) => {
    const newValue = parseInt(eventInfo.newValue);
    
    if (newValue < 0) {
        setAttrs({ pr_max: 0 });
    } else if (newValue > 50) {
        setAttrs({ pr_max: 50 });
    }
});

// Validation pr_current : respect des nouvelles limites (-MAX ≤ X ≤ +MAX)
on("change:pr_current", (eventInfo) => {
    const newValue = parseInt(eventInfo.newValue);
    
    // Récupération de pr_max pour définir les limites
    getAttrs(["pr_max"], (values) => {
        const prMax = parseInt(values.pr_max) || 0;
        
        if (newValue < -prMax) {
            setAttrs({ pr_current: -prMax });
            console.log(`⚠️ Valeur trop basse: ${newValue} → limite -${prMax}`);
        } else if (newValue > prMax) {
            setAttrs({ pr_current: prMax });
            console.log(`⚠️ Valeur trop haute: ${newValue} → limite ${prMax}`);
        }
    });
});

// === FONCTIONS BONUS ===

// Bouton pour aller directement au minimum (-MAX)
on("clicked:pr_minimum", () => {
    getAttrs(["pr_max"], (values) => {
        const prMax = parseInt(values.pr_max) || 0;
        const minimum = -prMax;
        setAttrs({ pr_current: minimum });
        console.log(`⬇️ Minimum: Current → ${minimum}`);
    });
});

// Debug rapide
on("clicked:pr_debug", () => {
    getAttrs(["pr_max", "pr_current", "pr_display"], (values) => {
        const prMax = parseInt(values.pr_max) || 0;
        console.log("===  DEBUG RAPIDE ===");
        console.log(`pr_max: ${values.pr_max}`);
        console.log(`pr_current: ${values.pr_current}`);
        console.log(`pr_display: ${values.pr_display}`);
        console.log(`Limites: -${prMax} ≤ X ≤ +${prMax}`);
        console.log("=======================");
    });
});
</script>   

<script type="text/worker">
// ========================================
// BONUS D'ÉQUIPEMENT GLOBAL — ES5 SAFE
// Gère : Armes, Armure, Collier, Bagues, Extras
// ========================================

var toInt = function (x) { return parseInt(x, 10) || 0; };

// ====================================
// FONCTION GLOBALE DE CALCUL DES BONUS
// ====================================
function calculateAllEquipmentBonuses() {
  
  // --- Attributs non-repeating à récupérer ---
  var baseAttrs = [
    // Arme principale
    'arme_principale_pv_bonus_val', 'arme_principale_pv_bonus_on',
    'arme_principale_pm_bonus_val', 'arme_principale_pm_bonus_on',
    'arme_principale_pe_bonus_val', 'arme_principale_pe_bonus_on',
    'arme_principale_mov_bonus_val', 'arme_principale_mov_bonus_on',
    
    // Arme secondaire
    'arme_secondaire_pv_bonus_val', 'arme_secondaire_pv_bonus_on',
    'arme_secondaire_pm_bonus_val', 'arme_secondaire_pm_bonus_on',
    'arme_secondaire_pe_bonus_val', 'arme_secondaire_pe_bonus_on',
    'arme_secondaire_mov_bonus_val', 'arme_secondaire_mov_bonus_on',
    
    // Armure
    'armure_pv_bonus_val', 'armure_pv_bonus_on',
    'armure_pm_bonus_val', 'armure_pm_bonus_on',
    'armure_pe_bonus_val', 'armure_pe_bonus_on',
    'armure_mov_bonus_val', 'armure_mov_bonus_on',
    
    // Collier
    'collier_pv_bonus_val', 'collier_pv_bonus_on',
    'collier_pm_bonus_val', 'collier_pm_bonus_on',
    'collier_pe_bonus_val', 'collier_pe_bonus_on',
    'collier_mov_bonus_val', 'collier_mov_bonus_on'
  ];

  // --- Récupération des IDs des sections repeating ---
  getSectionIDs('repeating_bijoux', function (bijouIds) {
    getSectionIDs('repeating_extraequipement', function (extraIds) {
      
      var repAttrs = [];
      
      // Attributs des bagues (repeating_bijoux)
      for (var i = 0; i < bijouIds.length; i++) {
        var pBijou = 'repeating_bijoux_' + bijouIds[i] + '_bijou_';
        repAttrs.push(
          pBijou + 'pv_bonus_val', pBijou + 'pv_bonus_on',
          pBijou + 'pm_bonus_val', pBijou + 'pm_bonus_on',
          pBijou + 'pe_bonus_val', pBijou + 'pe_bonus_on',
          pBijou + 'mov_bonus_val', pBijou + 'mov_bonus_on'
        );
      }
      
      // Attributs des extras (repeating_extraequipement)
      for (var j = 0; j < extraIds.length; j++) {
        var pExtra = 'repeating_extraequipement_' + extraIds[j] + '_extraeq_';
        repAttrs.push(
          pExtra + 'pv_bonus_val', pExtra + 'pv_bonus_on',
          pExtra + 'pm_bonus_val', pExtra + 'pm_bonus_on',
          pExtra + 'pe_bonus_val', pExtra + 'pe_bonus_on',
          pExtra + 'mov_bonus_val', pExtra + 'mov_bonus_on'
        );
      }
      
      // --- Récupération de tous les attributs ---
      getAttrs(baseAttrs.concat(repAttrs), function (v) {
        
        var pv = 0, pm = 0, pe = 0, mov = 0;
        
        // ===== ARME PRINCIPALE =====
        if ((v.arme_principale_pv_bonus_on || '0') === '1') {
          pv += toInt(v.arme_principale_pv_bonus_val);
        }
        if ((v.arme_principale_pm_bonus_on || '0') === '1') {
          pm += toInt(v.arme_principale_pm_bonus_val);
        }
        if ((v.arme_principale_pe_bonus_on || '0') === '1') {
          pe += toInt(v.arme_principale_pe_bonus_val);
        }
        if ((v.arme_principale_mov_bonus_on || '0') === '1') {
          mov += toInt(v.arme_principale_mov_bonus_val);
        }
        
        // ===== ARME SECONDAIRE =====
        if ((v.arme_secondaire_pv_bonus_on || '0') === '1') {
          pv += toInt(v.arme_secondaire_pv_bonus_val);
        }
        if ((v.arme_secondaire_pm_bonus_on || '0') === '1') {
          pm += toInt(v.arme_secondaire_pm_bonus_val);
        }
        if ((v.arme_secondaire_pe_bonus_on || '0') === '1') {
          pe += toInt(v.arme_secondaire_pe_bonus_val);
        }
        if ((v.arme_secondaire_mov_bonus_on || '0') === '1') {
          mov += toInt(v.arme_secondaire_mov_bonus_val);
        }
        
        // ===== ARMURE =====
        if ((v.armure_pv_bonus_on || '0') === '1') {
          pv += toInt(v.armure_pv_bonus_val);
        }
        if ((v.armure_pm_bonus_on || '0') === '1') {
          pm += toInt(v.armure_pm_bonus_val);
        }
        if ((v.armure_pe_bonus_on || '0') === '1') {
          pe += toInt(v.armure_pe_bonus_val);
        }
        if ((v.armure_mov_bonus_on || '0') === '1') {
          mov += toInt(v.armure_mov_bonus_val);
        }
        
        // ===== COLLIER =====
        if ((v.collier_pv_bonus_on || '0') === '1') {
          pv += toInt(v.collier_pv_bonus_val);
        }
        if ((v.collier_pm_bonus_on || '0') === '1') {
          pm += toInt(v.collier_pm_bonus_val);
        }
        if ((v.collier_pe_bonus_on || '0') === '1') {
          pe += toInt(v.collier_pe_bonus_val);
        }
        if ((v.collier_mov_bonus_on || '0') === '1') {
          mov += toInt(v.collier_mov_bonus_val);
        }
        
        // ===== BAGUES (repeating) =====
        for (var k = 0; k < bijouIds.length; k++) {
          var bPrefix = 'repeating_bijoux_' + bijouIds[k] + '_bijou_';
          
          if ((v[bPrefix + 'pv_bonus_on'] || '0') === '1') {
            pv += toInt(v[bPrefix + 'pv_bonus_val']);
          }
          if ((v[bPrefix + 'pm_bonus_on'] || '0') === '1') {
            pm += toInt(v[bPrefix + 'pm_bonus_val']);
          }
          if ((v[bPrefix + 'pe_bonus_on'] || '0') === '1') {
            pe += toInt(v[bPrefix + 'pe_bonus_val']);
          }
          if ((v[bPrefix + 'mov_bonus_on'] || '0') === '1') {
            mov += toInt(v[bPrefix + 'mov_bonus_val']);
          }
        }
        
        // ===== EXTRAS (repeating) =====
        for (var l = 0; l < extraIds.length; l++) {
          var ePrefix = 'repeating_extraequipement_' + extraIds[l] + '_extraeq_';
          
          if ((v[ePrefix + 'pv_bonus_on'] || '0') === '1') {
            pv += toInt(v[ePrefix + 'pv_bonus_val']);
          }
          if ((v[ePrefix + 'pm_bonus_on'] || '0') === '1') {
            pm += toInt(v[ePrefix + 'pm_bonus_val']);
          }
          if ((v[ePrefix + 'pe_bonus_on'] || '0') === '1') {
            pe += toInt(v[ePrefix + 'pe_bonus_val']);
          }
          if ((v[ePrefix + 'mov_bonus_on'] || '0') === '1') {
            mov += toInt(v[ePrefix + 'mov_bonus_val']);
          }
        }
        
        // --- Mise à jour des totaux ---
        setAttrs({
          pv_bonus: pv,
          pm_bonus: pm,
          pe_bonus: pe,
          mov_bonus: mov
        });
        
      });
    });
  });
}

// ====================================
// LISTENERS : ARME PRINCIPALE
// ====================================
on('change:arme_principale_pv_bonus_val change:arme_principale_pv_bonus_on ' +
   'change:arme_principale_pm_bonus_val change:arme_principale_pm_bonus_on ' +
   'change:arme_principale_pe_bonus_val change:arme_principale_pe_bonus_on ' +
   'change:arme_principale_mov_bonus_val change:arme_principale_mov_bonus_on',
   calculateAllEquipmentBonuses);

// ====================================
// LISTENERS : ARME SECONDAIRE
// ====================================
on('change:arme_secondaire_pv_bonus_val change:arme_secondaire_pv_bonus_on ' +
   'change:arme_secondaire_pm_bonus_val change:arme_secondaire_pm_bonus_on ' +
   'change:arme_secondaire_pe_bonus_val change:arme_secondaire_pe_bonus_on ' +
   'change:arme_secondaire_mov_bonus_val change:arme_secondaire_mov_bonus_on',
   calculateAllEquipmentBonuses);

// ====================================
// LISTENERS : ARMURE
// ====================================
on('change:armure_pv_bonus_val change:armure_pv_bonus_on ' +
   'change:armure_pm_bonus_val change:armure_pm_bonus_on ' +
   'change:armure_pe_bonus_val change:armure_pe_bonus_on ' +
   'change:armure_mov_bonus_val change:armure_mov_bonus_on',
   calculateAllEquipmentBonuses);

// ====================================
// LISTENERS : COLLIER
// ====================================
on('change:collier_pv_bonus_val change:collier_pv_bonus_on ' +
   'change:collier_pm_bonus_val change:collier_pm_bonus_on ' +
   'change:collier_pe_bonus_val change:collier_pe_bonus_on ' +
   'change:collier_mov_bonus_val change:collier_mov_bonus_on',
   calculateAllEquipmentBonuses);

// ====================================
// LISTENERS : BAGUES (repeating)
// ====================================
on('change:repeating_bijoux:bijou_pv_bonus_val change:repeating_bijoux:bijou_pv_bonus_on ' +
   'change:repeating_bijoux:bijou_pm_bonus_val change:repeating_bijoux:bijou_pm_bonus_on ' +
   'change:repeating_bijoux:bijou_pe_bonus_val change:repeating_bijoux:bijou_pe_bonus_on ' +
   'change:repeating_bijoux:bijou_mov_bonus_val change:repeating_bijoux:bijou_mov_bonus_on',
   calculateAllEquipmentBonuses);

on('remove:repeating_bijoux', calculateAllEquipmentBonuses);

// ====================================
// LISTENERS : EXTRAS (repeating)
// ====================================
on('change:repeating_extraequipement:extraeq_pv_bonus_val change:repeating_extraequipement:extraeq_pv_bonus_on ' +
   'change:repeating_extraequipement:extraeq_pm_bonus_val change:repeating_extraequipement:extraeq_pm_bonus_on ' +
   'change:repeating_extraequipement:extraeq_pe_bonus_val change:repeating_extraequipement:extraeq_pe_bonus_on ' +
   'change:repeating_extraequipement:extraeq_mov_bonus_val change:repeating_extraequipement:extraeq_mov_bonus_on',
   calculateAllEquipmentBonuses);

on('remove:repeating_extraequipement', calculateAllEquipmentBonuses);

// ====================================
// RESET : ARME PRINCIPALE
// ====================================
on('clicked:act_reset_arme_principale_bonus', function () {
  setAttrs({
    arme_principale_pv_bonus_val: 0,  arme_principale_pv_bonus_on: '0',
    arme_principale_pm_bonus_val: 0,  arme_principale_pm_bonus_on: '0',
    arme_principale_pe_bonus_val: 0,  arme_principale_pe_bonus_on: '0',
    arme_principale_mov_bonus_val: 0, arme_principale_mov_bonus_on: '0'
  }, {}, function () { calculateAllEquipmentBonuses(); });
});

// ====================================
// RESET : ARME SECONDAIRE
// ====================================
on('clicked:act_reset_arme_secondaire_bonus', function () {
  setAttrs({
    arme_secondaire_pv_bonus_val: 0,  arme_secondaire_pv_bonus_on: '0',
    arme_secondaire_pm_bonus_val: 0,  arme_secondaire_pm_bonus_on: '0',
    arme_secondaire_pe_bonus_val: 0,  arme_secondaire_pe_bonus_on: '0',
    arme_secondaire_mov_bonus_val: 0, arme_secondaire_mov_bonus_on: '0'
  }, {}, function () { calculateAllEquipmentBonuses(); });
});

// ====================================
// RESET : ARMURE
// ====================================
on('clicked:act_reset_armure_bonus', function () {
  setAttrs({
    armure_pv_bonus_val: 0,  armure_pv_bonus_on: '0',
    armure_pm_bonus_val: 0,  armure_pm_bonus_on: '0',
    armure_pe_bonus_val: 0,  armure_pe_bonus_on: '0',
    armure_mov_bonus_val: 0, armure_mov_bonus_on: '0'
  }, {}, function () { calculateAllEquipmentBonuses(); });
});

// ====================================
// RESET : COLLIER
// ====================================
on('clicked:act_reset_collier_bonus', function () {
  setAttrs({
    collier_pv_bonus_val: 0,  collier_pv_bonus_on: '0',
    collier_pm_bonus_val: 0,  collier_pm_bonus_on: '0',
    collier_pe_bonus_val: 0,  collier_pe_bonus_on: '0',
    collier_mov_bonus_val: 0, collier_mov_bonus_on: '0'
  }, {}, function () { calculateAllEquipmentBonuses(); });
});

// ====================================
// RESET : BAGUE (ligne individuelle)
// ====================================
on('clicked:repeating_bijoux:act_reset_bijou_bonus', function (e) {
  var m = /^repeating_bijoux_([^_]+)_/.exec(e.sourceAttribute);
  if (!m) { return; }
  var rowId = m[1];
  var p = 'repeating_bijoux_' + rowId + '_bijou_';
  var updates = {};
  updates[p + 'pv_bonus_val']  = 0; updates[p + 'pv_bonus_on']  = '0';
  updates[p + 'pm_bonus_val']  = 0; updates[p + 'pm_bonus_on']  = '0';
  updates[p + 'pe_bonus_val']  = 0; updates[p + 'pe_bonus_on']  = '0';
  updates[p + 'mov_bonus_val'] = 0; updates[p + 'mov_bonus_on'] = '0';
  setAttrs(updates, {}, function () { calculateAllEquipmentBonuses(); });
});

// ====================================
// RESET : EXTRA (ligne individuelle)
// ====================================
on('clicked:repeating_extraequipement:act_reset_extraeq_bonus', function (e) {
  var m = /^repeating_extraequipement_([^_]+)_/.exec(e.sourceAttribute);
  if (!m) { return; }
  var rowId = m[1];
  var p = 'repeating_extraequipement_' + rowId + '_extraeq_';
  var updates = {};
  updates[p + 'pv_bonus_val']  = 0; updates[p + 'pv_bonus_on']  = '0';
  updates[p + 'pm_bonus_val']  = 0; updates[p + 'pm_bonus_on']  = '0';
  updates[p + 'pe_bonus_val']  = 0; updates[p + 'pe_bonus_on']  = '0';
  updates[p + 'mov_bonus_val'] = 0; updates[p + 'mov_bonus_on'] = '0';
  setAttrs(updates, {}, function () { calculateAllEquipmentBonuses(); });
});

// ====================================
// INITIALISATION À L'OUVERTURE
// ====================================
on('sheet:opened', calculateAllEquipmentBonuses);

</script>

<script type="text/worker">
/* ============================================================
   SEED INVENTAIRE - ES5 SAFE
   Crée des lignes par défaut dans plusieurs repeating sections
   Une seule fois (flag init_inventory_seeded_v1)
   ============================================================ */

function seedRepeating(section, count, defaultsPerRow, done) {
  getSectionIDs(section, function(ids) {
    // Si la section a déjà des lignes, on ne fait rien
    if (ids && ids.length > 0) { if (done) done(); return; }

    var set = {}, rid, p, k, i;
    for (i = 0; i < count; i++) {
      rid = generateRowID();
      p   = 'repeating_' + section + '_' + rid + '_';
      for (k in defaultsPerRow) {
        if (defaultsPerRow.hasOwnProperty(k)) {
          set[p + k] = defaultsPerRow[k];
        }
      }
    }
    setAttrs(set, {}, function(){ if (done) done(); });
  });
}

function seedRepeatingFromList(section, rowsList, done) {
  getSectionIDs(section, function(ids) {
    if (ids && ids.length > 0) { if (done) done(); return; }

    var set = {}, rid, p, i, row;
    for (i = 0; i < rowsList.length; i++) {
      row = rowsList[i] || {};
      rid = generateRowID();
      p   = 'repeating_' + section + '_' + rid + '_';
      for (var key in row) {
        if (row.hasOwnProperty(key)) {
          set[p + key] = row[key];
        }
      }
    }
    setAttrs(set, {}, function(){ if (done) done(); });
  });
}

on('sheet:opened', function () {
  getAttrs(['init_inventory_seeded_v1'], function(v){
    if ((v.init_inventory_seeded_v1 || '') === '1') { return; }

    /* 1) GROS SAC : 10 lignes vides */
    seedRepeating('sac', 10, {
      'item_nom': '',
      'item_quantite': 0,
      'item_effet': ''
    }, function(){

      /* 2) PARTIE CAMPEMENT : 3 lignes préremplies */
      seedRepeatingFromList('campement', [
        {
          'camp_item_nom': 'Tente',
          'camp_item_quantite': 1,
          'camp_item_effet': 'Protège l’utilisateur des intempéries mineures'
        },
        {
          'camp_item_nom': 'Torche',
          'camp_item_quantite': 5,
          'camp_item_effet': 'Durée = 30 minutes à 1h selon la zone'
        },
        {
          'camp_item_nom': 'Sac de couchage',
          'camp_item_quantite': 1,
          'camp_item_effet': 'Offre le strict minimum de confort'
        }
      ], function(){

        /* 3) AUTRES ÉQUIPEMENTS : 3 lignes vides (Qté=1) */
        seedRepeating('equipement', 3, {
          'eq_nom': '',
          'eq_quantite': 1,
          'eq_effet': ''
        }, function(){

          /* 4) BIJOUX → BAGUES : 3 lignes vides (Qté=1) */
          seedRepeating('bijoux', 3, {
            'bijou_nom': '',
            'bijou_quantite': 1,
            'bijou_effet': ''
          }, function(){
            // Flag final : évite de reseeder à chaque ouverture
            setAttrs({ 'init_inventory_seeded_v1': '1' });
          });

        });

      });

    });
  });
});
</script>


<script type="text/worker">
// ================================================================= 
// =============== SHEET WORKER UNIFIÉ POUR 4 FICHES =============
// ================================================================= 

console.log("=== SHEET WORKER UNIFIÉ CHARGÉ ===");

// === FONCTION COMMUNE D'EXÉCUTION DU ROLL ===
function executeRoll(values, type = "capacite") {
    console.log("=== EXÉCUTION DU ROLL ===");
    console.log("Type:", type);
    
    // Determine le préfixe selon le type
    let prefix = "";
    let nomAttr = "capacite_nom";
    let effetActifAttr = "capacite_effet_actif";
    
    switch(type) {
        case "skill_special":
            prefix = "skill_special_";
            nomAttr = "skill_special_nom";
            effetActifAttr = "skill_special_effet_actif";
            break;
        case "skill_objet":
            prefix = "skill_objet_";
            nomAttr = "skill_objet_nom";
            effetActifAttr = "skill_objet_effet_actif";
            break;
        case "sort":
            prefix = "sort_";
            nomAttr = "sort_nom";
            effetActifAttr = "sort_effet_actif";
            break;
        case "capacite":
        default:
            prefix = "capacite_";
            nomAttr = "capacite_nom";
            effetActifAttr = "capacite_effet_actif";
            break;
    }
    
    // === DÉDUCTION DES COÛTS D'ABORD ===
    const coutPV = parseInt(values[`${prefix}cout_pv`]) || 0;
    const coutPM = parseInt(values[`${prefix}cout_pm`]) || 0; 
    const coutPE = parseInt(values[`${prefix}cout_pe`]) || 0;
    
    if (coutPV > 0 || coutPM > 0 || coutPE > 0) {
        const pvActuel = parseInt(values.pv_actuel) || 0;
        const pmActuel = parseInt(values.pm_actuel) || 0;
        const peActuel = parseInt(values.pe_actuel) || 0;
        
        const nouveauxPV = Math.max(0, pvActuel - coutPV);
        const nouveauxPM = Math.max(0, pmActuel - coutPM);
        const nouveauxPE = Math.max(0, peActuel - coutPE);
        
        setAttrs({
            pv_actuel: nouveauxPV,
            pm_actuel: nouveauxPM,
            pe_actuel: nouveauxPE
        });
        
        console.log(`Coûts déduits - PV: ${pvActuel} -> ${nouveauxPV}, PM: ${pmActuel} -> ${nouveauxPM}, PE: ${peActuel} -> ${nouveauxPE}`);
    }
    
    // === CONSTRUCTION DU ROLL ===
    let rollParts = [];
    rollParts.push("&{template:jets}");
    rollParts.push(`{{name=${values[nomAttr] || "Action Sans Nom"}}}`);
    
    // === EFFET ACTIF ===
    if (values[effetActifAttr] && values[effetActifAttr].trim()) {
        rollParts.push(`{{effet_actif=${values[effetActifAttr]}}}`);
    }
    
    // Jet principal
    const principalActif = values[`${prefix}actif_principal`] === "1";
    if (principalActif) {
        rollParts.push("{{principal_actif=1}}");
        rollParts.push(`{{principal_nom=${values[`${prefix}nom_effet_principal`] || "Effet principal"}}}`);
        
        if (values[`${prefix}type_principal`]) {
            rollParts.push(`{{principal_type=${values[`${prefix}type_principal`]}}}`);
            rollParts.push(`{{principal_type_color=${values[`${prefix}color_type_principal`] || "blanc_argente"}}}`);
        }
        if (values[`${prefix}nature_principal`]) {
            rollParts.push(`{{principal_nature=${values[`${prefix}nature_principal`]}}}`);
            rollParts.push(`{{principal_nature_color=${values[`${prefix}color_nature_principal`] || "rouge_ecarlate"}}}`);
        }
        
        let formula = values[`${prefix}formula_principal`] || "1d6";
        let bonus = parseInt(values[`${prefix}bonus_principal`]) || 0;
        rollParts.push(`{{principal_jet=[[ (${formula}) * (1 + ${bonus}/100) ]]}}`);
    }
    
    // Jets secondaires (1-5) - CORRIGÉ POUR LES COULEURS
    for (let i = 1; i <= 5; i++) {
        let jetActif, jetNom, jetFormula, jetBonus, jetType, jetNature, jetColorType, jetColorNature;
        
        if (type === "capacite") {
            // Pour les capacités, pas de préfixe pour les jets secondaires
            jetActif = values[`jet${i}_actif`];
            jetNom = values[`jet${i}_nom_effet`];
            jetFormula = values[`jet${i}_formula`];
            jetBonus = values[`jet${i}_bonus`];
            jetType = values[`jet${i}_type`];
            jetNature = values[`jet${i}_nature`];
            // ✅ CORRECTION : Lire les couleurs au lieu de valeurs codées en dur
            jetColorType = values[`jet${i}_color_type`] || "blanc_argente";
            jetColorNature = values[`jet${i}_color_nature`] || "rouge_ecarlate";
        } else {
            // Pour les autres types, avec préfixe
            jetActif = values[`${prefix}jet${i}_actif`];
            jetNom = values[`${prefix}jet${i}_nom_effet`];
            jetFormula = values[`${prefix}jet${i}_formula`];
            jetBonus = values[`${prefix}jet${i}_bonus`];
            jetType = values[`${prefix}jet${i}_type`];
            jetNature = values[`${prefix}jet${i}_nature`];
            jetColorType = values[`${prefix}jet${i}_color_type`] || "blanc_argente";
            jetColorNature = values[`${prefix}jet${i}_color_nature`] || "rouge_ecarlate";
        }
        
        if (jetActif === "1") {
            rollParts.push(`{{jet${i}_actif=1}}`);
            rollParts.push(`{{jet${i}_nom=${jetNom || `Effet ${i}`}}}`);
            
            if (jetType) {
                rollParts.push(`{{jet${i}_type=${jetType}}}`);
                rollParts.push(`{{jet${i}_type_color=${jetColorType}}}`);
            }
            if (jetNature) {
                rollParts.push(`{{jet${i}_nature=${jetNature}}}`);
                rollParts.push(`{{jet${i}_nature_color=${jetColorNature}}}`);
            }
            
            let formula = jetFormula || "1d6";
            let bonus = parseInt(jetBonus) || 0;
            rollParts.push(`{{jet${i}_jet=[[ (${formula}) * (1 + ${bonus}/100) ]]}}`);
        }
    }
    
    // === ALTÉRATIONS ===
    let hasAlterations = false;
    const alterations = [
        "saignement_actif", "empoisonnement_actif", "destruction_armure_actif",
        "brulure_actif", "fragilisation_actif", "corrosion_actif",
        "reduction_armure_actif", "attaque_sournoise_actif", "fracture_actif", "effet_libre_actif"
    ];
    
    // Vérifier si on a des altérations actives
    for (let alteration of alterations) {
        let alterationValue;
        if (type === "capacite") {
            alterationValue = values[alteration];
        } else {
            alterationValue = values[`${prefix}${alteration}`];
        }
        
        if (alterationValue === "1") {
            hasAlterations = true;
            break;
        }
    }
    
    if (hasAlterations) {
        rollParts.push("{{has_alterations=1}}");
        
        // Fonction helper pour récupérer la valeur d'altération
        function getAlterationValue(alterationName) {
            if (type === "capacite") {
                return values[alterationName];
            } else {
                return values[`${prefix}${alterationName}`];
            }
        }
        
        if (getAlterationValue("saignement_actif") === "1") {
            rollParts.push("{{saignement_actif=1}}");
            if (getAlterationValue("saignement_valeur")) rollParts.push(`{{saignement_valeur=${getAlterationValue("saignement_valeur")}}}`);
            if (getAlterationValue("saignement_des")) rollParts.push(`{{saignement_des=${getAlterationValue("saignement_des")}}}`);
        }
        
        if (getAlterationValue("empoisonnement_actif") === "1") {
            rollParts.push("{{empoisonnement_actif=1}}");
            if (getAlterationValue("empoisonnement_valeur")) rollParts.push(`{{empoisonnement_valeur=${getAlterationValue("empoisonnement_valeur")}}}`);
            if (getAlterationValue("empoisonnement_des")) rollParts.push(`{{empoisonnement_des=${getAlterationValue("empoisonnement_des")}}}`);
        }
        
        if (getAlterationValue("destruction_armure_actif") === "1") {
            rollParts.push("{{destruction_armure_actif=1}}");
            if (getAlterationValue("destruction_armure_valeur")) rollParts.push(`{{destruction_armure_valeur=${getAlterationValue("destruction_armure_valeur")}}}`);
        }
        
        if (getAlterationValue("brulure_actif") === "1") {
            rollParts.push("{{brulure_actif=1}}");
            if (getAlterationValue("brulure_valeur")) rollParts.push(`{{brulure_valeur=${getAlterationValue("brulure_valeur")}}}`);
        }
        
        if (getAlterationValue("fragilisation_actif") === "1") {
            rollParts.push("{{fragilisation_actif=1}}");
            if (getAlterationValue("fragilisation_valeur")) rollParts.push(`{{fragilisation_valeur=${getAlterationValue("fragilisation_valeur")}}}`);
        }
        
        if (getAlterationValue("corrosion_actif") === "1") {
            rollParts.push("{{corrosion_actif=1}}");
            if (getAlterationValue("corrosion_valeur")) rollParts.push(`{{corrosion_valeur=${getAlterationValue("corrosion_valeur")}}}`);
            if (getAlterationValue("corrosion_des")) rollParts.push(`{{corrosion_des=${getAlterationValue("corrosion_des")}}}`);
        }
        
        if (getAlterationValue("reduction_armure_actif") === "1") {
            rollParts.push("{{reduction_armure_actif=1}}");
            if (getAlterationValue("reduction_armure_valeur")) rollParts.push(`{{reduction_armure_valeur=${getAlterationValue("reduction_armure_valeur")}}}`);
            if (getAlterationValue("reduction_armure_type")) rollParts.push(`{{reduction_armure_type=${getAlterationValue("reduction_armure_type")}}}`);
        }
        
        if (getAlterationValue("attaque_sournoise_actif") === "1") {
            rollParts.push("{{attaque_sournoise_actif=1}}");
        }
        
        if (getAlterationValue("fracture_actif") === "1") {
            rollParts.push("{{fracture_actif=1}}");
            if (getAlterationValue("fracture_valeur")) rollParts.push(`{{fracture_valeur=${getAlterationValue("fracture_valeur")}}}`);
            if (getAlterationValue("fracture_des")) rollParts.push(`{{fracture_des=${getAlterationValue("fracture_des")}}}`);
        }
        
        if (getAlterationValue("effet_libre_actif") === "1") {
            rollParts.push("{{effet_libre_actif=1}}");
            if (getAlterationValue("effet_libre_nom")) rollParts.push(`{{effet_libre_nom=${getAlterationValue("effet_libre_nom")}}}`);
            if (getAlterationValue("effet_libre_valeur")) rollParts.push(`{{effet_libre_valeur=${getAlterationValue("effet_libre_valeur")}}}`);
        }
    }
    
    // === GARANTIR AU MOINS UN JET ===
    let rollCommand = rollParts.join(" ");
    if (!/\[\[.*\]\]/.test(rollCommand)) {
        rollParts.push('{{principal_actif=1}}');
        rollParts.push('{{principal_nom=Aucun jet actif}}');
        rollParts.push('{{principal_jet=[[0]]}}');
        rollCommand = rollParts.join(' ');
    }
    
    console.log("=== COMMANDE ROLL FINALE ===");
    console.log(rollCommand);
    
    // Exécution du roll
    try {
        startRoll(rollCommand, function(results) {
            console.log("Roll exécuté avec succès pour:", values[nomAttr]);
            finishRoll(results.rollId);
        });
    } catch (error) {
        console.error("Erreur roll:", error);
    }
}

// === FONCTION AVEC ID DE SECTION GÉNÉRIQUE ===
function buildActiveJetsWithSectionId(sectionName, sectionId, type) {
    console.log(`=== CONSTRUCTION DU ROLL AVEC SECTION ID ${sectionName} ===`);
    console.log("Section ID:", sectionId, "Type:", type);
    
    const prefix = `repeating_${sectionName}_${sectionId}_`;
    
    let typePrefix = "";
    let nomAttr = "";
    let effetActifAttr = "";
    
    switch(type) {
        case "skill_special":
            typePrefix = "skill_special_";
            nomAttr = `${prefix}skill_special_nom`;
            effetActifAttr = `${prefix}skill_special_effet_actif`;
            break;
        case "skill_objet":
            typePrefix = "skill_objet_";
            nomAttr = `${prefix}skill_objet_nom`;
            effetActifAttr = `${prefix}skill_objet_effet_actif`;
            break;
        case "sort":
            typePrefix = "sort_";
            nomAttr = `${prefix}sort_nom`;
            effetActifAttr = `${prefix}sort_effet_actif`;
            break;
        case "capacite":
            typePrefix = "capacite_";
            nomAttr = `${prefix}capacite_nom`;
            effetActifAttr = `${prefix}capacite_effet_actif`;
            break;
    }
    
    let attributesToGet = [
        // Attributs de base
        nomAttr,
        effetActifAttr,
        
        // Coûts
        `${prefix}${typePrefix}cout_pv`, 
        `${prefix}${typePrefix}cout_pm`, 
        `${prefix}${typePrefix}cout_pe`,
        
        // Ressources actuelles (attributs globaux)
        "pv_actuel", 
        "pm_actuel", 
        "pe_actuel",
        
        // Jet principal
        `${prefix}${typePrefix}actif_principal`, 
        `${prefix}${typePrefix}nom_effet_principal`, 
        `${prefix}${typePrefix}formula_principal`, 
        `${prefix}${typePrefix}bonus_principal`, 
        `${prefix}${typePrefix}type_principal`, 
        `${prefix}${typePrefix}nature_principal`,
        `${prefix}${typePrefix}color_type_principal`, 
        `${prefix}${typePrefix}color_nature_principal`,
        
        // Altérations
        `${prefix}${typePrefix}saignement_actif`, `${prefix}${typePrefix}saignement_valeur`, `${prefix}${typePrefix}saignement_des`,
        `${prefix}${typePrefix}empoisonnement_actif`, `${prefix}${typePrefix}empoisonnement_valeur`, `${prefix}${typePrefix}empoisonnement_des`,
        `${prefix}${typePrefix}destruction_armure_actif`, `${prefix}${typePrefix}destruction_armure_valeur`,
        `${prefix}${typePrefix}brulure_actif`, `${prefix}${typePrefix}brulure_valeur`,
        `${prefix}${typePrefix}fragilisation_actif`, `${prefix}${typePrefix}fragilisation_valeur`,
        `${prefix}${typePrefix}corrosion_actif`, `${prefix}${typePrefix}corrosion_valeur`, `${prefix}${typePrefix}corrosion_des`,
        `${prefix}${typePrefix}reduction_armure_actif`, `${prefix}${typePrefix}reduction_armure_valeur`, `${prefix}${typePrefix}reduction_armure_type`,
        `${prefix}${typePrefix}attaque_sournoise_actif`,
        `${prefix}${typePrefix}fracture_actif`, `${prefix}${typePrefix}fracture_valeur`, `${prefix}${typePrefix}fracture_des`,
        `${prefix}${typePrefix}effet_libre_actif`, `${prefix}${typePrefix}effet_libre_nom`, `${prefix}${typePrefix}effet_libre_valeur`
    ];
    
    // Jets secondaires - logique spéciale pour capacités
    for (let i = 1; i <= 5; i++) {
        if (type === "capacite") {
            // ✅ CORRECTION : Ajouter les attributs de couleur pour capacités
            attributesToGet.push(
                `${prefix}jet${i}_actif`, `${prefix}jet${i}_nom_effet`, `${prefix}jet${i}_formula`, 
                `${prefix}jet${i}_bonus`, `${prefix}jet${i}_type`, `${prefix}jet${i}_nature`,
                `${prefix}jet${i}_color_type`, `${prefix}jet${i}_color_nature`
            );
        } else {
            // Pour autres types : avec préfixe type
            attributesToGet.push(
                `${prefix}${typePrefix}jet${i}_actif`, `${prefix}${typePrefix}jet${i}_nom_effet`, 
                `${prefix}${typePrefix}jet${i}_formula`, `${prefix}${typePrefix}jet${i}_bonus`, 
                `${prefix}${typePrefix}jet${i}_type`, `${prefix}${typePrefix}jet${i}_nature`,
                `${prefix}${typePrefix}jet${i}_color_type`, `${prefix}${typePrefix}jet${i}_color_nature`
            );
        }
        
        // Altérations pour capacités (sans préfixe type)
        if (type === "capacite") {
            attributesToGet.push(
                `${prefix}saignement_actif`, `${prefix}saignement_valeur`, `${prefix}saignement_des`,
                `${prefix}empoisonnement_actif`, `${prefix}empoisonnement_valeur`, `${prefix}empoisonnement_des`,
                `${prefix}destruction_armure_actif`, `${prefix}destruction_armure_valeur`,
                `${prefix}brulure_actif`, `${prefix}brulure_valeur`,
                `${prefix}fragilisation_actif`, `${prefix}fragilisation_valeur`,
                `${prefix}corrosion_actif`, `${prefix}corrosion_valeur`, `${prefix}corrosion_des`,
                `${prefix}reduction_armure_actif`, `${prefix}reduction_armure_valeur`, `${prefix}reduction_armure_type`,
                `${prefix}attaque_sournoise_actif`,
                `${prefix}fracture_actif`, `${prefix}fracture_valeur`, `${prefix}fracture_des`,
                `${prefix}effet_libre_actif`, `${prefix}effet_libre_nom`, `${prefix}effet_libre_valeur`
            );
        }
    }
    
    getAttrs(attributesToGet, function(values) {
        console.log("=== VALEURS RÉCUPÉRÉES AVEC SECTION ID ===");
        console.log("Toutes les valeurs:", values);
        
        // Transformation des valeurs pour utiliser la fonction commune
        const cleanValues = {};
        for (let key in values) {
            if (key.startsWith(prefix)) {
                const cleanKey = key.replace(prefix, '');
                cleanValues[cleanKey] = values[key];
            } else {
                // Conserver les attributs globaux (ressources)
                cleanValues[key] = values[key];
            }
        }
        
        console.log("Valeurs nettoyées:", cleanValues);
        executeRoll(cleanValues, type);
    });
}

// === EVENT LISTENERS UNIFIÉS ===

// Skill Spécial
on("clicked:repeating_skillspecial:jet", function(eventinfo) {
    console.log("=== BOUTON SKILL SPECIAL CLIQUÉ ===");
    console.log("EventInfo:", eventinfo);
    
    let sectionId = null;
    if (eventinfo && eventinfo.sourceAttribute) {
        const match = eventinfo.sourceAttribute.match(/repeating_skillspecial_([^_]+)_/);
        if (match) {
            sectionId = match[1];
            console.log("ID de section extrait:", sectionId);
        }
    }
    
    if (sectionId) {
        buildActiveJetsWithSectionId("skillspecial", sectionId, "skill_special");
    } else {
        console.error("Impossible d'extraire l'ID de section pour skill_special");
    }
});

// Skill d'Objet
on("clicked:repeating_skillobjet:jet", function(eventinfo) {
    console.log("=== BOUTON SKILL OBJET CLIQUÉ ===");
    console.log("EventInfo:", eventinfo);
    
    let sectionId = null;
    if (eventinfo && eventinfo.sourceAttribute) {
        const match = eventinfo.sourceAttribute.match(/repeating_skillobjet_([^_]+)_/);
        if (match) {
            sectionId = match[1];
            console.log("ID de section extrait:", sectionId);
        }
    }
    
    if (sectionId) {
        buildActiveJetsWithSectionId("skillobjet", sectionId, "skill_objet");
    } else {
        console.error("Impossible d'extraire l'ID de section pour skill_objet");
    }
});

// Sort
on("clicked:repeating_sorts:jet", function(eventinfo) {
    console.log("=== BOUTON SORT CLIQUÉ ===");
    console.log("EventInfo:", eventinfo);
    
    let sectionId = null;
    if (eventinfo && eventinfo.sourceAttribute) {
        const match = eventinfo.sourceAttribute.match(/repeating_sorts_([^_]+)_/);
        if (match) {
            sectionId = match[1];
            console.log("ID de section extrait:", sectionId);
        }
    }
    
    if (sectionId) {
        buildActiveJetsWithSectionId("sorts", sectionId, "sort");
    } else {
        console.error("Impossible d'extraire l'ID de section pour sort");
    }
});

// Capacité
on("clicked:repeating_capacites:jet", function(eventinfo) {
    console.log("=== BOUTON CAPACITÉ CLIQUÉ ===");
    console.log("EventInfo:", eventinfo);
    
    let sectionId = null;
    if (eventinfo && eventinfo.sourceAttribute) {
        const match = eventinfo.sourceAttribute.match(/repeating_capacites_([^_]+)_/);
        if (match) {
            sectionId = match[1];
            console.log("ID de section extrait:", sectionId);
        }
    }
    
    if (sectionId) {
        buildActiveJetsWithSectionId("capacites", sectionId, "capacite");
    } else {
        console.error("Impossible d'extraire l'ID de section pour capacité");
    }
});

// === INITIALISATION ===
on("sheet:opened", function() {
    console.log("=== FICHE OUVERTE - SHEET WORKER UNIFIÉ PRÊT ===");
});

console.log("=== SHEET WORKER UNIFIÉ PRÊT ===");
</script> 

<script type="text/worker">
// =============================================
// SYSTÈME MONÉTAIRE AUTOMATISÉ COMPLET
// =============================================

console.log(" Sheet Workers du Système Monétaire chargés");

// === UTILITAIRES ===
function parseValueToNumber(value) {
  if (!value || value === "") return 0;
  
  // Si c'est déjà un nombre
  if (!isNaN(value)) return parseFloat(value) || 0;
  
  // Extraction simple des nombres (ex: "150 PG" -> 150)
  const numberMatch = value.toString().match(/(\d+(?:\.\d+)?)/);
  return numberMatch ? parseFloat(numberMatch[1]) : 0;
}

function getCurrentTimestamp() {
  const now = new Date();
  const day = String(now.getDate()).padStart(2, '0');
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return day + "/" + month + " " + hours + ":" + minutes;
}

// === CALCUL DE LA RICHESSE TOTALE ===
function calculateTotalWealth() {
  getAttrs([
    "pg_total", "pgi_total", "pc_total",
    "rate_pgi_to_pg", "rate_pc_to_pg",
    "custom_currency_1_value", "custom_1_rate",
    "custom_currency_2_value", "custom_2_rate", 
    "custom_currency_3_value", "custom_3_rate"
  ], function(values) {
    
    // Taux de change (nouveaux taux par défaut)
    const pgiRate = parseInt(values.rate_pgi_to_pg) || 220;
    const pcRate = parseInt(values.rate_pc_to_pg) || 30800;
    
    // Valeurs principales
    const pgValue = parseValueToNumber(values.pg_total);
    const pgiValue = parseValueToNumber(values.pgi_total);
    const pcValue = parseValueToNumber(values.pc_total);
    
    // Conversion en PG
    const pgFromPgi = pgiValue * pgiRate;
    const pgFromPc = pcValue * pcRate;
    
    // Monnaies personnalisées
    const custom1Value = parseValueToNumber(values.custom_currency_1_value);
    const custom1Rate = parseFloat(values.custom_1_rate) || 1;
    const custom2Value = parseValueToNumber(values.custom_currency_2_value);
    const custom2Rate = parseFloat(values.custom_2_rate) || 1;
    const custom3Value = parseValueToNumber(values.custom_currency_3_value);
    const custom3Rate = parseFloat(values.custom_3_rate) || 1;
    
    const pgFromCustom1 = custom1Value * custom1Rate;
    const pgFromCustom2 = custom2Value * custom2Rate;
    const pgFromCustom3 = custom3Value * custom3Rate;
    
    // Total en PG
    const totalPG = pgValue + pgFromPgi + pgFromPc + pgFromCustom1 + pgFromCustom2 + pgFromCustom3;
    
    // Déterminer le niveau de richesse
    let wealthLevel = "Indigent";
    let wealthClass = "poor";
    
    if (totalPG >= 100000) {
      wealthLevel = "Extrêmement Riche";
      wealthClass = "rich";
    } else if (totalPG >= 50000) {
      wealthLevel = "Très Riche";
      wealthClass = "wealthy";
    } else if (totalPG >= 10000) {
      wealthLevel = "Aisé";
      wealthClass = "comfortable";
    } else if (totalPG >= 1000) {
      wealthLevel = "Confortable";
      wealthClass = "modest";
    } else if (totalPG >= 100) {
      wealthLevel = "Modeste";
      wealthClass = "poor";
    }
    
    const updates = {
      total_wealth_display: Math.round(totalPG) + " PG",
      total_wealth_value: Math.round(totalPG),
      wealth_level_display: wealthLevel,
      wealth_status_class: wealthClass,
      // Valeurs calculées individuelles
      pg_calculated: pgValue,
      pgi_calculated: pgiValue, 
      pc_calculated: pcValue
    };
    
    setAttrs(updates);
    console.log(" Richesse totale: " + Math.round(totalPG) + " PG (" + wealthLevel + ")");
  });
}

// === GESTION DES TRANSACTIONS AVEC CONVERSION AUTOMATIQUE ===
function addTransaction(type, amount, currency, description, pgEquivalent) {
  const timestamp = getCurrentTimestamp();
  const displayAmount = amount >= 0 ? "+" + amount + " " + currency : amount + " " + currency;
  
  // TERMES FRANÇAIS
  const typeClass = amount >= 0 ? "gain" : "depense";
  
  // Si pgEquivalent est fourni, on l'utilise pour les statistiques
  const realPgAmount = pgEquivalent !== undefined ? pgEquivalent : amount;
  
  // Récupérer l'historique actuel
  getAttrs([
    "transaction_1_date", "transaction_1_type", "transaction_1_amount", "transaction_1_desc", "transaction_1_pg_value",
    "transaction_2_date", "transaction_2_type", "transaction_2_amount", "transaction_2_desc", "transaction_2_pg_value",
    "transaction_3_date", "transaction_3_type", "transaction_3_amount", "transaction_3_desc", "transaction_3_pg_value",
    "transaction_4_date", "transaction_4_type", "transaction_4_amount", "transaction_4_desc", "transaction_4_pg_value",
    "transaction_5_date", "transaction_5_type", "transaction_5_amount", "transaction_5_desc", "transaction_5_pg_value",
    "transaction_6_date", "transaction_6_type", "transaction_6_amount", "transaction_6_desc", "transaction_6_pg_value",
    "transaction_7_date", "transaction_7_type", "transaction_7_amount", "transaction_7_desc", "transaction_7_pg_value",
    "transaction_8_date", "transaction_8_type", "transaction_8_amount", "transaction_8_desc", "transaction_8_pg_value",
    "transaction_9_date", "transaction_9_type", "transaction_9_amount", "transaction_9_desc", "transaction_9_pg_value",
    "transaction_10_date", "transaction_10_type", "transaction_10_amount", "transaction_10_desc", "transaction_10_pg_value"
  ], function(values) {
    
    // Décaler l'historique (la nouvelle transaction devient #1)
    const updates = {
      // Nouvelle transaction en position 1
      transaction_1_date: timestamp,
      transaction_1_type: typeClass,
      transaction_1_amount: displayAmount,
      transaction_1_desc: description,
      transaction_1_pg_value: realPgAmount, // NOUVEAU: valeur en PG pour les calculs
      
      // Décaler toutes les autres
      transaction_2_date: values.transaction_1_date || "--",
      transaction_2_type: values.transaction_1_type || "--",
      transaction_2_amount: values.transaction_1_amount || "--",
      transaction_2_desc: values.transaction_1_desc || "--",
      transaction_2_pg_value: values.transaction_1_pg_value || 0,
      
      transaction_3_date: values.transaction_2_date || "--",
      transaction_3_type: values.transaction_2_type || "--",
      transaction_3_amount: values.transaction_2_amount || "--",
      transaction_3_desc: values.transaction_2_desc || "--",
      transaction_3_pg_value: values.transaction_2_pg_value || 0,
      
      transaction_4_date: values.transaction_3_date || "--",
      transaction_4_type: values.transaction_3_type || "--",
      transaction_4_amount: values.transaction_3_amount || "--",
      transaction_4_desc: values.transaction_3_desc || "--",
      transaction_4_pg_value: values.transaction_3_pg_value || 0,
      
      transaction_5_date: values.transaction_4_date || "--",
      transaction_5_type: values.transaction_4_type || "--",
      transaction_5_amount: values.transaction_4_amount || "--",
      transaction_5_desc: values.transaction_4_desc || "--",
      transaction_5_pg_value: values.transaction_4_pg_value || 0,
      
      transaction_6_date: values.transaction_5_date || "--",
      transaction_6_type: values.transaction_5_type || "--",
      transaction_6_amount: values.transaction_5_amount || "--",
      transaction_6_desc: values.transaction_5_desc || "--",
      transaction_6_pg_value: values.transaction_5_pg_value || 0,
      
      transaction_7_date: values.transaction_6_date || "--",
      transaction_7_type: values.transaction_6_type || "--",
      transaction_7_amount: values.transaction_6_amount || "--",
      transaction_7_desc: values.transaction_6_desc || "--",
      transaction_7_pg_value: values.transaction_6_pg_value || 0,
      
      transaction_8_date: values.transaction_7_date || "--",
      transaction_8_type: values.transaction_7_type || "--",
      transaction_8_amount: values.transaction_7_amount || "--",
      transaction_8_desc: values.transaction_7_desc || "--",
      transaction_8_pg_value: values.transaction_7_pg_value || 0,
      
      transaction_9_date: values.transaction_8_date || "--",
      transaction_9_type: values.transaction_8_type || "--",
      transaction_9_amount: values.transaction_8_amount || "--",
      transaction_9_desc: values.transaction_8_desc || "--",
      transaction_9_pg_value: values.transaction_8_pg_value || 0,
      
      transaction_10_date: values.transaction_9_date || "--",
      transaction_10_type: values.transaction_9_type || "--",
      transaction_10_amount: values.transaction_9_amount || "--",
      transaction_10_desc: values.transaction_9_desc || "--",
      transaction_10_pg_value: values.transaction_9_pg_value || 0
    };
    
    setAttrs(updates, function() {
      // Recalculer les statistiques automatiquement après ajout
      calculateMonthlyStats();
    });
    
    console.log(" Transaction ajoutée: " + displayAmount + " - " + description + " (≈" + realPgAmount + " PG)");
  });
}

// === TRANSACTIONS PRINCIPALES AVEC CONVERSION AUTOMATIQUE ===
function handleMainCurrencyTransaction(currency, isAdd) {
  const amountAttr = currency + "_transaction_amount";
  const totalAttr = currency + "_total";
  
  getAttrs([amountAttr, totalAttr, "rate_pgi_to_pg", "rate_pc_to_pg"], function(values) {
    const amount = parseInt(values[amountAttr]) || 0;
    if (amount === 0) return;
    
    const currentTotal = parseValueToNumber(values[totalAttr]);
    const modifier = isAdd ? amount : -amount;
    const newTotal = Math.max(0, currentTotal + modifier);
    
    // Obtenir les taux de conversion
    const pgiRate = parseInt(values.rate_pgi_to_pg) || 220;
    const pcRate = parseInt(values.rate_pc_to_pg) || 30800;
    
    // Calculer l'équivalent en PG pour les statistiques
    let pgEquivalent = modifier;
    let currencyName = "PG";
    
    if (currency === 'pgi') {
      pgEquivalent = modifier * pgiRate;
      currencyName = "PGI";
    } else if (currency === 'pc') {
      pgEquivalent = modifier * pcRate;
      currencyName = "PC";
    }
    
    const description = isAdd ? 
      "Gain de " + amount + " " + currencyName : 
      "Dépense de " + amount + " " + currencyName;
    
    const updates = {};
    updates[totalAttr] = newTotal.toString();
    updates[amountAttr] = 0; // Reset du champ de transaction
    
    setAttrs(updates, function() {
      // Ajouter la transaction avec l'équivalent PG
      addTransaction(isAdd ? "gain" : "depense", modifier, currencyName, description, pgEquivalent);
      calculateTotalWealth();
    });
  });
}

// === CALCUL DES STATISTIQUES MENSUELLES AMÉLIORÉ ===
function calculateMonthlyStats() {
  getAttrs([
    "transaction_1_type", "transaction_1_pg_value",
    "transaction_2_type", "transaction_2_pg_value",
    "transaction_3_type", "transaction_3_pg_value",
    "transaction_4_type", "transaction_4_pg_value",
    "transaction_5_type", "transaction_5_pg_value",
    "transaction_6_type", "transaction_6_pg_value",
    "transaction_7_type", "transaction_7_pg_value",
    "transaction_8_type", "transaction_8_pg_value",
    "transaction_9_type", "transaction_9_pg_value",
    "transaction_10_type", "transaction_10_pg_value"
  ], function(values) {
    
    let monthlyIncome = 0;
    let monthlyExpenses = 0;
    
    for (let i = 1; i <= 10; i++) {
      const type = values["transaction_" + i + "_type"];
      const pgValue = parseFloat(values["transaction_" + i + "_pg_value"]) || 0;
      
      if (type && type !== "--" && pgValue !== 0) {
        if (type === "gain") {
          monthlyIncome += Math.abs(pgValue);
        } else if (type === "depense") {
          monthlyExpenses += Math.abs(pgValue);
        }
      }
    }
    
    const balance = monthlyIncome - monthlyExpenses;
    
    const updates = {
      monthly_income: Math.round(monthlyIncome) + " PG",
      monthly_expenses: Math.round(monthlyExpenses) + " PG",
      monthly_balance: (balance >= 0 ? "+" : "") + Math.round(balance) + " PG"
    };
    
    setAttrs(updates);
    console.log(" Stats mises à jour: Revenus=" + Math.round(monthlyIncome) + "PG, Dépenses=" + Math.round(monthlyExpenses) + "PG");
  });
}

// === LISTENERS POUR BOUTONS DE TRANSACTION (MONNAIES PRINCIPALES SEULEMENT) ===
on("clicked:pg_add", function() { handleMainCurrencyTransaction('pg', true); });
on("clicked:pg_subtract", function() { handleMainCurrencyTransaction('pg', false); });
on("clicked:pgi_add", function() { handleMainCurrencyTransaction('pgi', true); });
on("clicked:pgi_subtract", function() { handleMainCurrencyTransaction('pgi', false); });
on("clicked:pc_add", function() { handleMainCurrencyTransaction('pc', true); });
on("clicked:pc_subtract", function() { handleMainCurrencyTransaction('pc', false); });

// === EFFACER HISTORIQUE ===
on("clicked:clear_transactions", function() {
  const updates = {};
  for (let i = 1; i <= 10; i++) {
    updates["transaction_" + i + "_date"] = "--";
    updates["transaction_" + i + "_type"] = "--";
    updates["transaction_" + i + "_amount"] = "--";
    updates["transaction_" + i + "_desc"] = "--";
    updates["transaction_" + i + "_pg_value"] = 0;
  }
  
  // Reset des statistiques
  updates.monthly_income = "0 PG";
  updates.monthly_expenses = "0 PG";
  updates.monthly_balance = "0 PG";
  
  setAttrs(updates);
  console.log("️ Historique des transactions effacé");
});

// === LISTENERS POUR RECALCULS AUTOMATIQUES ===
on("change:pg_total change:pgi_total change:pc_total change:rate_pgi_to_pg change:rate_pc_to_pg", calculateTotalWealth);

on("change:custom_currency_1_value change:custom_1_rate change:custom_currency_2_value change:custom_2_rate change:custom_currency_3_value change:custom_3_rate", calculateTotalWealth);

// Recalcul des stats à chaque changement de transaction
on("change:transaction_1_date change:transaction_1_type change:transaction_1_pg_value", calculateMonthlyStats);

// === GESTION DES REPEATING SECTIONS (monnaies personnalisées seulement) ===
on("change:repeating_currency_custom", function() {
  // Recalculer la richesse si les monnaies personnalisées changent
  setTimeout(calculateTotalWealth, 100);
});

// === INITIALISATION ===
on("sheet:opened", function() {
  console.log("️ Initialisation du système monétaire");
  calculateTotalWealth();
  calculateMonthlyStats();
  
  // Vérifier si l'historique est vide et ajouter une transaction de bienvenue
  getAttrs(["transaction_1_date"], function(values) {
    if (!values.transaction_1_date || values.transaction_1_date === "--") {
      addTransaction("gain", 0, "PG", "Début du suivi financier", 0);
    }
  });
});

console.log("✅ Sheet Workers du Système Monétaire prêts !");

// === FONCTIONS DE DEBUG ===
if (typeof window !== 'undefined') {
  window.debugCurrency = function() {
    console.log("=== DEBUG SYSTÈME MONÉTAIRE ===");
    getAttrs(["total_wealth_value", "wealth_level_display", "pg_total", "pgi_total", "pc_total"], function(values) {
      console.log("Richesse totale:", values.total_wealth_value);
      console.log("Niveau:", values.wealth_level_display);
      console.log("PG:", values.pg_total);
      console.log("PGI:", values.pgi_total);
      console.log("PC:", values.pc_total);
    });
  };
}

// === GESTION D'ERREURS ===
function safeCalculation(callback) {
  try {
    callback();
  } catch (error) {
    console.error("❌ Erreur dans le système monétaire:", error);
  }
}

// Wrapper pour les calculs sensibles
const originalCalculateWealth = calculateTotalWealth;
calculateTotalWealth = function() {
  safeCalculation(originalCalculateWealth);
};

const originalCalculateStats = calculateMonthlyStats;
calculateMonthlyStats = function() {
  safeCalculation(originalCalculateStats);
};
</script>

<script type="text/worker">
  // ---- Compétences ----
 function updateCompetences() {
  getSectionIDs("repeating_competences", function(ids) {
    if (!ids.length) {
      setAttrs({ competence_bonus_total: 0 });
      return;
    }
    const fields = ids.reduce((arr, id) => {
      arr.push(
        `repeating_competences_${id}_comp_bonus`,
        `repeating_competences_${id}_comp_active`,
        `repeating_competences_${id}_comp_bonus2`,
        `repeating_competences_${id}_comp_active2`
      );
      return arr;
    }, []);
    getAttrs(fields, function(v) {
      let total = 0;
      ids.forEach(id => {
        if (v[`repeating_competences_${id}_comp_active`] === "on") {
          total += parseInt(v[`repeating_competences_${id}_comp_bonus`], 10) || 0;
        }
        if (v[`repeating_competences_${id}_comp_active2`] === "on") {
          total += parseInt(v[`repeating_competences_${id}_comp_bonus2`], 10) || 0;
        }
      });
      setAttrs({ competence_bonus_total: total });
    });
  });
}
 on("change:repeating_competences:comp_bonus change:repeating_competences:comp_active change:repeating_competences:comp_bonus2 change:repeating_competences:comp_active2 change:repeating_traitcompetences:trait_comp_bonus1 change:repeating_traitcompetences:trait_comp_active1 change:repeating_traitcompetences:trait_comp_bonus2 change:repeating_traitcompetences:trait_comp_active2 remove:repeating_competences remove:repeating_traitcompetences", updateCompetences);





 // ---- Mouvement automatique ----
function calcMouvement() {
  getAttrs(["for", "cst", "dex", "mov_bonus", "mov_base"], values => {
    const force = parseFloat(values.for) || 0;
    const cst   = parseFloat(values.cst) || 0;
    const dex   = parseFloat(values.dex) || 0;
    const bonus = parseFloat(values.mov_bonus) || 0;
    const baseMov = parseFloat(values.mov_base) || 0;

    const base  = (force / 1.45 + cst * 1.25 + dex * 1.60) / 18;
    const mov   = baseMov + bonus + Math.floor(base);

    setAttrs({
      mov: mov + " ft",
      mov_debug: mov
    });
  });
}
on("sheet:opened change:for change:cst change:dex change:mov_bonus", calcMouvement);








// ---- Réactivité automatique ----
function calcReactivite() {
  getAttrs(["rea_base", "dex", "per", "ins"], values => {
    const base = parseFloat(values.rea_base) || 0;
    const dex  = parseFloat(values.dex) || 0;
    const per  = parseFloat(values.per) || 0;
    const ins  = parseFloat(values.ins) || 0;
    const calc = base + ((dex * 0.8 + per) / 2.5) + (ins / 2);
    setAttrs({
      rea_final: Math.round(calc),
      rea_debug: calc
    });
  });
}
on("sheet:opened change:rea_base change:dex change:per change:ins", calcReactivite);
// ---- Résistance Mentale automatique ----
function calcRM() {
  getAttrs(["rm_base", "int", "int_mod", "sag", "sag_mod"], values => {
    const base  = parseFloat(values.rm_base) || 0;
    const intel = parseFloat(values.int) || 0;
    const iMod  = parseFloat(values.int_mod) || 0;
    const sag   = parseFloat(values.sag) || 0;
    const sMod  = parseFloat(values.sag_mod) || 0;
    const calc  = base + (intel / 12) + (iMod / 3) + (sag / 6) + (sMod / 2);
    setAttrs({
      rm_final: Math.round(calc),
      rm_debug: calc
    });
  });
}
on("sheet:opened change:rm_base change:int change:int_mod change:sag change:sag_mod", calcRM);
// Init global
on("sheet:opened", () => {
  calcMouvement();
  calcReactivite();
  calcRM();
});
  // ---- Trait-competences toggles ----
  on("change:repeating_traitcompetences:trait_comp_bonus change:repeating_traitcompetences:trait_comp_active", function() {
    getAttrs([
      "repeating_traitcompetences_trait_comp_bonus",
      "repeating_traitcompetences_trait_comp_active"
    ], function(values) {
      const actif = values.repeating_traitcompetences_trait_comp_active === "on";
      const bonus = parseInt(values.repeating_traitcompetences_trait_comp_bonus, 10) || 0;
      setAttrs({repeating_traitcompetences_trait_comp_bonus_effectif: actif ? bonus : 0});
    });
  });
  // ---- Image dynamique (URL → affichage auto) ----
on("change:image_url", function() {
  getAttrs(["image_url"], function(values) {
    setAttrs({
      image_affichee: values.image_url
    });
  });
});
</script>

<script type="text/worker">
function handleRest(type) {
  const bonusAttr = (type === "court") ? "bonus_repos_court" : "bonus_repos_long";

  getAttrs([
    bonusAttr,
    "qualite_repos",
    "pv_base","pm_base","pe_base",
    "pv_actuel","pm_actuel","pe_actuel",
    "pv_total","pm_total","pe_total"
  ], function(v) {
    const bonusBase = parseInt(v[bonusAttr], 10) || 0;
    const qualiteBonus = parseInt(v.qualite_repos, 10) || 0;
    const bonusTotal = bonusBase + qualiteBonus;
    const rollExpression = "1d100 + " + bonusTotal;

    const rollTemplate = "&{template:restresult}" +
      " {{name=Repos " + (type === "court" ? "Court" : "Long") + "}}" +
      " {{Jet=[[" + rollExpression + "]]}}" +
      " {{recov=[[0]]}}";

    startRoll(rollTemplate, function(results) {
      const finalResult = results.results.Jet.result;
      
      let recoveryPercent = 0;
      let message = "";

      // === REPOS COURT ===
      if (type === "court") {
        if (finalResult <= 5) { 
          recoveryPercent = 0;
          message = "Échec ! Aucun PV/PM/PE récupéré."; 
        }
        else if (finalResult <= 10) { 
          recoveryPercent = Math.floor(Math.random() * 6) + 1 + 1;
        }
        else if (finalResult <= 30) { 
          recoveryPercent = (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + 2;
        }
        else if (finalResult <= 50) { 
          recoveryPercent = (Math.floor(Math.random() * 6) + 1) + (Math.floor(Math.random() * 6) + 1) + 4;
        }
        else if (finalResult <= 70) { 
          recoveryPercent = (Math.floor(Math.random() * 8) + 1) + (Math.floor(Math.random() * 8) + 1) + 5;
        }
        else if (finalResult <= 90) { 
          recoveryPercent = (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + 5;
        }
        else { 
          recoveryPercent = (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + (Math.floor(Math.random() * 5) + 1) + 6;
        }
      } 
      // === REPOS LONG ===
      else {
        if (finalResult <= 5) { 
          recoveryPercent = Math.floor(Math.random() * 6) + 1;
          message = "Désavantage au prochain repos."; 
        }
        else if (finalResult <= 10) { 
          recoveryPercent = Math.floor(Math.random() * 8) + 1 + 2;
        }
        else if (finalResult <= 20) { 
          recoveryPercent = Math.floor(Math.random() * 10) + 1 + 4;
        }
        else if (finalResult <= 30) { 
          recoveryPercent = (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + 6;
        }
        else if (finalResult <= 40) { 
          recoveryPercent = (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + 6;
        }
        else if (finalResult <= 60) { 
          recoveryPercent = (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + 6;
        }
        else if (finalResult <= 80) { 
          recoveryPercent = (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + 6;
        }
        else if (finalResult <= 90) { 
          recoveryPercent = (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + 8;
        }
        else if (finalResult <= 95) { 
          recoveryPercent = (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + (Math.floor(Math.random() * 10) + 1) + 10;
        }
        else { 
          recoveryPercent = 100;
          message = "Succès Total ! Tous les PV/PM/PE récupérés."; 
        }
      }
      
      // Appliquer la récupération
      applyRecovery(recoveryPercent, v);

      // === LOGS DEBUG ===
      console.log(' REPOS - Type: ' + type);
      console.log(' REPOS - Jet: ' + finalResult);
      console.log(' REPOS - Récupération %: ' + recoveryPercent);

      // Préparer finishData
      const finishData = {
        recov: recoveryPercent
      };

      if (message) {
        finishData.message = message;
      }

      console.log(' REPOS - finishData:', finishData);

      finishRoll(results.rollId, finishData);
    });
  });
}

function applyRecovery(percent, stats) {
  const pv_base = parseInt(stats.pv_base, 10) || 0;
  const pm_base = parseInt(stats.pm_base, 10) || 0;
  const pe_base = parseInt(stats.pe_base, 10) || 0;
  const pv_actuel = parseInt(stats.pv_actuel, 10) || 0;
  const pm_actuel = parseInt(stats.pm_actuel, 10) || 0;
  const pe_actuel = parseInt(stats.pe_actuel, 10) || 0;
  const pv_total = parseInt(stats.pv_total, 10) || 0;
  const pm_total = parseInt(stats.pm_total, 10) || 0;
  const pe_total = parseInt(stats.pe_total, 10) || 0;

  const soin_pv = Math.floor((pv_base * percent) / 100);
  const soin_pm = Math.floor((pm_base * percent) / 100);
  const soin_pe = Math.floor((pe_base * percent) / 100);

  console.log(' REPOS - Soins: PV+' + soin_pv + ' PM+' + soin_pm + ' PE+' + soin_pe);

  setAttrs({
    pv_actuel: Math.min(pv_total, pv_actuel + soin_pv),
    pm_actuel: Math.min(pm_total, pm_actuel + soin_pm),
    pe_actuel: Math.min(pe_total, pe_actuel + soin_pe)
  });
}

on("clicked:repos_court", function() { 
  handleRest("court"); 
});

on("clicked:repos_long", function() { 
  handleRest("long"); 
});

console.log("✅ Système de repos chargé");
</script>

<script type="text/worker">
// ========================================
// BONUS DES MODS - CALCULS AUTOMATIQUES
// Compatible ES5 + Persistance garantie
// ========================================

// ===== FONCTION : CALCUL DÉFENSE PHYSIQUE =====
function calculateDefPhyTotal() {
  getAttrs([
    "cst_mod", 
    "def_phy_bonus1_val", 
    "def_phy_bonus2_val", 
    "def_phy_bonus3_val", 
    "def_phy_bonus4_val"
  ], function(values) {
    var base = parseInt(values.cst_mod, 10) || 0;
    var bonus1 = parseInt(values.def_phy_bonus1_val, 10) || 0;
    var bonus2 = parseInt(values.def_phy_bonus2_val, 10) || 0;
    var bonus3 = parseInt(values.def_phy_bonus3_val, 10) || 0;
    var bonus4 = parseInt(values.def_phy_bonus4_val, 10) || 0;
    
    var total = base + bonus1 + bonus2 + bonus3 + bonus4;
    
    setAttrs({ def_phy_total: total });
  });
}

// ===== FONCTION : CALCUL DÉFENSE MAGIQUE =====
function calculateDefMagTotal() {
  getAttrs([
    "sag_mod", 
    "def_mag_bonus1_val", 
    "def_mag_bonus2_val", 
    "def_mag_bonus3_val", 
    "def_mag_bonus4_val"
  ], function(values) {
    var base = parseInt(values.sag_mod, 10) || 0;
    var bonus1 = parseInt(values.def_mag_bonus1_val, 10) || 0;
    var bonus2 = parseInt(values.def_mag_bonus2_val, 10) || 0;
    var bonus3 = parseInt(values.def_mag_bonus3_val, 10) || 0;
    var bonus4 = parseInt(values.def_mag_bonus4_val, 10) || 0;
    
    var total = base + bonus1 + bonus2 + bonus3 + bonus4;
    
    setAttrs({ def_mag_total: total });
  });
}

// ===== FONCTION : CALCUL ATTAQUE PHYSIQUE =====
function calculateAttPhyTotal() {
  getAttrs([
    "for_mod", 
    "att_phy_bonus1_val", 
    "att_phy_bonus2_val", 
    "att_phy_bonus3_val", 
    "att_phy_bonus4_val"
  ], function(values) {
    var base = parseInt(values.for_mod, 10) || 0;
    var bonus1 = parseInt(values.att_phy_bonus1_val, 10) || 0;
    var bonus2 = parseInt(values.att_phy_bonus2_val, 10) || 0;
    var bonus3 = parseInt(values.att_phy_bonus3_val, 10) || 0;
    var bonus4 = parseInt(values.att_phy_bonus4_val, 10) || 0;
    
    var total = base + bonus1 + bonus2 + bonus3 + bonus4;
    
    setAttrs({ att_phy_total: total });
  });
}

// ===== FONCTION : CALCUL ATTAQUE MAGIQUE =====
function calculateAttMagTotal() {
  getAttrs([
    "int_mod", 
    "att_mag_bonus1_val", 
    "att_mag_bonus2_val", 
    "att_mag_bonus3_val", 
    "att_mag_bonus4_val"
  ], function(values) {
    var base = parseInt(values.int_mod, 10) || 0;
    var bonus1 = parseInt(values.att_mag_bonus1_val, 10) || 0;
    var bonus2 = parseInt(values.att_mag_bonus2_val, 10) || 0;
    var bonus3 = parseInt(values.att_mag_bonus3_val, 10) || 0;
    var bonus4 = parseInt(values.att_mag_bonus4_val, 10) || 0;
    
    var total = base + bonus1 + bonus2 + bonus3 + bonus4;
    
    setAttrs({ att_mag_total: total });
  });
}

// ===== FONCTION GLOBALE : RECALCUL DE TOUT =====
function calculateAllModBonuses() {
  calculateDefPhyTotal();
  calculateDefMagTotal();
  calculateAttPhyTotal();
  calculateAttMagTotal();
}

// ========================================
// LISTENERS : DÉFENSE PHYSIQUE
// ========================================
on("change:cst_mod change:def_phy_bonus1_val change:def_phy_bonus2_val change:def_phy_bonus3_val change:def_phy_bonus4_val", 
   calculateDefPhyTotal);

// ========================================
// LISTENERS : DÉFENSE MAGIQUE
// ========================================
on("change:sag_mod change:def_mag_bonus1_val change:def_mag_bonus2_val change:def_mag_bonus3_val change:def_mag_bonus4_val", 
   calculateDefMagTotal);

// ========================================
// LISTENERS : ATTAQUE PHYSIQUE
// ========================================
on("change:for_mod change:att_phy_bonus1_val change:att_phy_bonus2_val change:att_phy_bonus3_val change:att_phy_bonus4_val", 
   calculateAttPhyTotal);

// ========================================
// LISTENERS : ATTAQUE MAGIQUE
// ========================================
on("change:int_mod change:att_mag_bonus1_val change:att_mag_bonus2_val change:att_mag_bonus3_val change:att_mag_bonus4_val", 
   calculateAttMagTotal);

// ========================================
// INITIALISATION AU CHARGEMENT
// ========================================
on("sheet:opened", function() {
  // CRITIQUE : Recalculer TOUS les totaux à l'ouverture
  // pour restaurer les valeurs correctes après rechargement
  calculateAllModBonuses();
});

</script>




<!-- === JAVASCRIPT POUR LES SECTIONS RÉPÉTABLES === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des clics sur les en-têtes des sections répétables
    document.addEventListener('click', function(e) {
        const clickableHeader = e.target.closest('.sheet-clickable-header');
        if (clickableHeader) {
            // Chercher le checkbox dans le même conteneur
            const container = clickableHeader.closest('.sheet-entrainement-card');
            if (container) {
                const checkbox = container.querySelector('.sheet-repeating-toggle');
                if (checkbox) {
                    // Inverser l'état
                    checkbox.checked = !checkbox.checked;
                    
                    // Déclencher l'événement pour Roll20
                    const event = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(event);
                }
            }
        }
    });
    
    console.log('Système dépliable pour sections répétables activé !');
});
</script>

<script type="text/worker">
// === ROLL20 SHEET WORKERS AVEC SYSTÈME DE RANGS ET MALUS ===

on("sheet:opened", function() {
    console.log(" Roll20 Entrainement - Initialisation avec système de rangs...");
    
    getAttrs(["base_pa_actuel", "base_pa_cible", "base_bonus_malus", "base_type_de", "base_nb_des", "base_bonus_flat", "base_bonus_pourcent", "base_rang", "base_rang_malus", "base_expanded"], function(values) {
        var updates = {};
        
        if (!values.base_pa_actuel && values.base_pa_actuel !== 0) updates.base_pa_actuel = 0;
        if (!values.base_pa_cible) updates.base_pa_cible = 100;
        if (!values.base_bonus_malus && values.base_bonus_malus !== 0) updates.base_bonus_malus = 0;
        if (!values.base_type_de) updates.base_type_de = "6";
        if (!values.base_nb_des && values.base_nb_des !== 0) updates.base_nb_des = 1;
        if (!values.base_bonus_flat && values.base_bonus_flat !== 0) updates.base_bonus_flat = 0;
        if (!values.base_bonus_pourcent && values.base_bonus_pourcent !== 0) updates.base_bonus_pourcent = 0;
        if (!values.base_rang) updates.base_rang = "1";
        if (!values.base_rang_malus && values.base_rang_malus !== 0) updates.base_rang_malus = 0;
        if (!values.base_expanded) updates.base_expanded = "1";
        
        if (Object.keys(updates).length > 0) {
            setAttrs(updates, function() {
                updateBaseProgress();
                updateBaseRangMalus();
            });
        } else {
            updateBaseProgress();
            updateBaseRangMalus();
        }
    });
});

function calculateRangMalus(rang) {
    switch(rang) {
        case "1": return 0;
        case "2": return -5;
        case "3": return -10;
        case "4": return -15;
        case "5": return -20;
        default: return 0;
    }
}

function updateBaseRangMalus() {
    getAttrs(["base_rang"], function(values) {
        var rang = values.base_rang || "1";
        var malus = calculateRangMalus(rang);
        
        setAttrs({
            base_rang_malus: malus,
            base_rang_malus_display: malus.toString()
        });
        
        console.log(" Base Rang " + rang + " → Malus: " + malus);
    });
}

function updateRepeatingRangMalus(rowId) {
    var prefix = "repeating_entrainement_" + rowId + "_";
    
    getAttrs([prefix + "rang"], function(values) {
        var rang = values[prefix + "rang"] || "1";
        var malus = calculateRangMalus(rang);
        
        var updates = {};
        updates[prefix + "rang_malus"] = malus;
        updates[prefix + "rang_malus_display"] = malus.toString();
        
        setAttrs(updates);
        console.log(" Repeating " + rowId + " Rang " + rang + " → Malus: " + malus);
    });
}

on("change:base_rang", function() {
    updateBaseRangMalus();
});

on("change:repeating_entrainement:rang", function(eventInfo) {
    var rowId = eventInfo.sourceAttribute.split("_")[2];
    updateRepeatingRangMalus(rowId);
});

function calculateExactPercent(actuel, cible) {
    if (!cible || cible <= 0) return 0;
    return Math.min(Math.max(Math.round((actuel / cible) * 100), 0), 100);
}

function updateBaseProgress() {
    getAttrs(["base_pa_actuel", "base_pa_cible"], function(values) {
        var actuel = parseInt(values.base_pa_actuel) || 0;
        var cible = parseInt(values.base_pa_cible) || 100;
        var percent = calculateExactPercent(actuel, cible);
        
        setAttrs({
            base_progress: percent,
            base_progress_text: percent + "%"
        });
        
        console.log(" Base Progress: " + actuel + "/" + cible + " = " + percent + "%");
    });
}

function updateRepeatingProgress(rowId) {
    var prefix = "repeating_entrainement_" + rowId + "_";
    
    getAttrs([prefix + "pa_actuel", prefix + "pa_cible"], function(values) {
        var actuel = parseInt(values[prefix + "pa_actuel"]) || 0;
        var cible = parseInt(values[prefix + "pa_cible"]) || 100;
        var percent = calculateExactPercent(actuel, cible);
        
        var updates = {};
        updates[prefix + "progress"] = percent;
        updates[prefix + "progress_text"] = percent + "%";
        
        setAttrs(updates);
        console.log(" Repeating " + rowId + ": " + actuel + "/" + cible + " = " + percent + "%");
    });
}

on("change:base_pa_actuel change:base_pa_cible", function() {
    updateBaseProgress();
});

on("change:repeating_entrainement:pa_actuel change:repeating_entrainement:pa_cible", function(eventInfo) {
    var rowId = eventInfo.sourceAttribute.split("_")[2];
    updateRepeatingProgress(rowId);
});

on("clicked:roll_base_gain", function(eventInfo) {
    console.log(" Clic Gain PA Base - Auto-addition activée");
    
    getAttrs(["base_nb_des", "base_type_de", "base_bonus_flat", "base_bonus_pourcent", "base_pa_actuel"], function(values) {
        var nbDes = parseInt(values.base_nb_des) || 1;
        var typeDe = parseInt(values.base_type_de) || 6;
        var bonusFlat = parseInt(values.base_bonus_flat) || 0;
        var bonusPourcent = parseInt(values.base_bonus_pourcent) || 0;
        var paActuel = parseInt(values.base_pa_actuel) || 0;
        
        var rollFormula = nbDes + "d" + typeDe;
        
        startRoll(rollFormula, function(results) {
            var jetBase = results.results[0].result;
            var bonusTotal = bonusFlat * nbDes;
            var totalAvant = jetBase + bonusTotal;
            var gainFinal = Math.floor(totalAvant * (1 + bonusPourcent / 100));
            var nouveauxPA = paActuel + gainFinal;
            
            finishRoll(results.rollId, {});
            
            setAttrs({
                base_pa_actuel: nouveauxPA
            }, function() {
                setTimeout(updateBaseProgress, 50);
                console.log("✅ Base PA: " + paActuel + " + " + gainFinal + " = " + nouveauxPA);
            });
        });
    });
});

on("clicked:roll_gain", function(eventInfo) {
    console.log(" Clic Gain PA Repeating - Auto-addition activée");
    
    var triggerName = eventInfo.triggerName || "";
    var match = triggerName.match(/repeating_entrainement_([^_]+)_roll_gain/);
    
    if (!match) {
        console.error("❌ ID de ligne non trouvé pour: " + triggerName);
        return;
    }
    
    var rowId = match[1];
    var prefix = "repeating_entrainement_" + rowId + "_";
    
    getAttrs([prefix + "nb_des", prefix + "type_de", prefix + "bonus_flat", prefix + "bonus_pourcent", prefix + "pa_actuel"], function(values) {
        var nbDes = parseInt(values[prefix + "nb_des"]) || 1;
        var typeDe = parseInt(values[prefix + "type_de"]) || 6;
        var bonusFlat = parseInt(values[prefix + "bonus_flat"]) || 0;
        var bonusPourcent = parseInt(values[prefix + "bonus_pourcent"]) || 0;
        var paActuel = parseInt(values[prefix + "pa_actuel"]) || 0;
        
        var rollFormula = nbDes + "d" + typeDe;
        
        startRoll(rollFormula, function(results) {
            var jetBase = results.results[0].result;
            var bonusTotal = bonusFlat * nbDes;
            var totalAvant = jetBase + bonusTotal;
            var gainFinal = Math.floor(totalAvant * (1 + bonusPourcent / 100));
            var nouveauxPA = paActuel + gainFinal;
            
            finishRoll(results.rollId, {});
            
            var updates = {};
            updates[prefix + "pa_actuel"] = nouveauxPA;
            
            setAttrs(updates, function() {
                setTimeout(function() { updateRepeatingProgress(rowId); }, 50);
                console.log("✅ Repeating " + rowId + " PA: " + paActuel + " + " + gainFinal + " = " + nouveauxPA);
            });
        });
    });
});

on("change:repeating_entrainement", function(eventInfo) {
    if (eventInfo.newValue !== undefined && eventInfo.previousValue === undefined) {
        var rowId = eventInfo.sourceAttribute.split("_")[2];
        var prefix = "repeating_entrainement_" + rowId + "_";
        
        setTimeout(function() {
            getAttrs([prefix + "pa_actuel", prefix + "pa_cible", prefix + "bonus_malus", prefix + "type_de", prefix + "nb_des", prefix + "bonus_flat", prefix + "bonus_pourcent", prefix + "rang", prefix + "expanded"], function(values) {
                var updates = {};
                
                if (!values[prefix + "pa_actuel"] && values[prefix + "pa_actuel"] !== 0) updates[prefix + "pa_actuel"] = 0;
                if (!values[prefix + "pa_cible"]) updates[prefix + "pa_cible"] = 100;
                if (!values[prefix + "bonus_malus"] && values[prefix + "bonus_malus"] !== 0) updates[prefix + "bonus_malus"] = 0;
                if (!values[prefix + "type_de"]) updates[prefix + "type_de"] = "6";
                if (!values[prefix + "nb_des"] && values[prefix + "nb_des"] !== 0) updates[prefix + "nb_des"] = 1;
                if (!values[prefix + "bonus_flat"] && values[prefix + "bonus_flat"] !== 0) updates[prefix + "bonus_flat"] = 0;
                if (!values[prefix + "bonus_pourcent"] && values[prefix + "bonus_pourcent"] !== 0) updates[prefix + "bonus_pourcent"] = 0;
                if (!values[prefix + "rang"]) updates[prefix + "rang"] = "1";
                if (!values[prefix + "expanded"]) updates[prefix + "expanded"] = "0"; // Replié par défaut
                
                updates[prefix + "progress"] = 0;
                updates[prefix + "progress_text"] = "0%";
                
                if (Object.keys(updates).length > 0) {
                    setAttrs(updates, function() {
                        updateRepeatingRangMalus(rowId);
                    });
                }
                
                console.log(" Nouvelle ligne repeating initialisée: " + rowId);
            });
        }, 100);
    }
});

on("change:base_pa_actuel", function(eventInfo) {
    if (parseInt(eventInfo.newValue) < 0) {
        setAttrs({base_pa_actuel: 0});
        console.log("⚠️ PA Base corrigé: négatif → 0");
    }
});

on("change:base_pa_cible", function(eventInfo) {
    if (parseInt(eventInfo.newValue) < 1) {
        setAttrs({base_pa_cible: 1});
        console.log("⚠️ PA Cible Base corrigé: < 1 → 1");
    }
});

on("change:repeating_entrainement:pa_actuel", function(eventInfo) {
    if (parseInt(eventInfo.newValue) < 0) {
        var rowId = eventInfo.sourceAttribute.split("_")[2];
        var updates = {};
        updates["repeating_entrainement_" + rowId + "_pa_actuel"] = 0;
        setAttrs(updates);
        console.log("⚠️ PA Repeating " + rowId + " corrigé: négatif → 0");
    }
});

on("change:repeating_entrainement:pa_cible", function(eventInfo) {
    if (parseInt(eventInfo.newValue) < 1) {
        var rowId = eventInfo.sourceAttribute.split("_")[2];
        var updates = {};
        updates["repeating_entrainement_" + rowId + "_pa_cible"] = 1;
        setAttrs(updates);
        console.log("⚠️ PA Cible Repeating " + rowId + " corrigé: < 1 → 1");
    }
});

console.log(" Sheet Workers Roll20 Entrainement complets chargés!");
console.log("✅ Fonctionnalités actives:");
console.log("    Système de Rangs avec malus automatiques");
console.log("    Zone d'objectif pour chaque entrainement");
console.log("    Système dépliable pour TOUTES les sections");
console.log("    Barres de progression dynamiques");
console.log("   ⚡ Addition automatique des gains de PA");
console.log("   ️ Validation anti-valeurs négatives");
</script>

<script type="text/worker">
// ===== SHEET WORKERS - COMPATIBLE ROLL20 =====

// Fonction pour calculer et mettre à jour la barre de progression
on("change:repeating_training:pa_actuel change:repeating_training:pa_max", function(eventInfo) {
    console.log(" Changement détecté:", eventInfo.sourceAttribute);
    
    // Extraire l'ID de la ligne
    const sourceAttribute = eventInfo.sourceAttribute;
    const attributeParts = sourceAttribute.split("_");
    
    if (attributeParts.length < 3) {
        console.error("❌ Format invalide:", sourceAttribute);
        return;
    }
    
    const rowId = attributeParts[2];
    
    // Récupérer les valeurs
    getAttrs([
        `repeating_training_${rowId}_pa_actuel`,
        `repeating_training_${rowId}_pa_max`
    ], function(values) {
        
        const paActuel = Math.max(0, parseInt(values[`repeating_training_${rowId}_pa_actuel`]) || 0);
        const paMax = Math.max(1, parseInt(values[`repeating_training_${rowId}_pa_max`]) || 1);
        
        // Calculer le pourcentage
        let pourcentage = Math.round((paActuel / paMax) * 100);
        pourcentage = Math.max(0, Math.min(100, pourcentage));
        
        // Créer le style CSS inline pour la largeur
        const styleWidth = `width: ${pourcentage}%;`;
        
        console.log(` Progression: ${paActuel}/${paMax} = ${pourcentage}%`);
        
        // Mettre à jour TOUS les attributs nécessaires
        setAttrs({
            // Affichage des valeurs
            [`repeating_training_${rowId}_progress_percentage`]: pourcentage,
            [`repeating_training_${rowId}_progress_text_display`]: pourcentage + "%",
            [`repeating_training_${rowId}_pa_actuel_display`]: paActuel,
            [`repeating_training_${rowId}_pa_max_display`]: paMax,
            
            // Largeur de la barre (valeur numérique pour CSS)
            [`repeating_training_${rowId}_progress_bar_width`]: pourcentage
        });
        
        console.log(`✅ Barre mise à jour: ${pourcentage}%`);
    });
});

// Initialisation au chargement
on("sheet:opened", function() {
    console.log(" Initialisation des barres...");
    
    setTimeout(function() {
        getSectionIDs("repeating_training", function(idArray) {
            console.log(` ${idArray.length} section(s) trouvée(s)`);
            
            idArray.forEach(function(id, index) {
                getAttrs([
                    `repeating_training_${id}_pa_actuel`,
                    `repeating_training_${id}_pa_max`
                ], function(values) {
                    
                    const paActuel = Math.max(0, parseInt(values[`repeating_training_${id}_pa_actuel`]) || 0);
                    const paMax = Math.max(1, parseInt(values[`repeating_training_${id}_pa_max`]) || 1);
                    
                    let pourcentage = Math.round((paActuel / paMax) * 100);
                    pourcentage = Math.max(0, Math.min(100, pourcentage));
                    
                    setAttrs({
                        [`repeating_training_${id}_progress_percentage`]: pourcentage,
                        [`repeating_training_${id}_progress_text_display`]: pourcentage + "%",
                        [`repeating_training_${id}_pa_actuel_display`]: paActuel,
                        [`repeating_training_${id}_pa_max_display`]: paMax,
                        [`repeating_training_${id}_progress_bar_width`]: pourcentage
                    });
                    
                    console.log(`✅ Ligne ${index + 1}/${idArray.length} (${id}): ${pourcentage}%`);
                });
            });
        });
    }, 500);
});

// Validation des valeurs
on("change:repeating_training:pa_actuel", function(eventInfo) {
    const rowId = eventInfo.sourceAttribute.split("_")[2];
    const newValue = parseInt(eventInfo.newValue);
    
    if (newValue < 0) {
        console.warn(`⚠️ PA actuels négatifs corrigés pour ${rowId}`);
        setAttrs({
            [`repeating_training_${rowId}_pa_actuel`]: 0
        });
    }
});

on("change:repeating_training:pa_max", function(eventInfo) {
    const rowId = eventInfo.sourceAttribute.split("_")[2];
    const newValue = parseInt(eventInfo.newValue);
    
    if (newValue < 1) {
        console.warn(`⚠️ PA max corrigé à 1 pour ${rowId}`);
        setAttrs({
            [`repeating_training_${rowId}_pa_max`]: 1
        });
    }
});

// Fonctions utilitaires
function forceUpdateProgressBar(rowId) {
    if (!rowId) {
        console.error("❌ rowId manquant");
        return;
    }
    
    getAttrs([
        `repeating_training_${rowId}_pa_actuel`,
        `repeating_training_${rowId}_pa_max`
    ], function(values) {
        
        const paActuel = Math.max(0, parseInt(values[`repeating_training_${rowId}_pa_actuel`]) || 0);
        const paMax = Math.max(1, parseInt(values[`repeating_training_${rowId}_pa_max`]) || 1);
        
        let pourcentage = Math.round((paActuel / paMax) * 100);
        pourcentage = Math.max(0, Math.min(100, pourcentage));
        
        setAttrs({
            [`repeating_training_${rowId}_progress_percentage`]: pourcentage,
            [`repeating_training_${rowId}_progress_text_display`]: pourcentage + "%",
            [`repeating_training_${rowId}_pa_actuel_display`]: paActuel,
            [`repeating_training_${rowId}_pa_max_display`]: paMax,
            [`repeating_training_${rowId}_progress_bar_width`]: pourcentage
        });
        
        console.log(` Barre ${rowId} mise à jour: ${pourcentage}%`);
    });
}

function recalculateAllProgressBars() {
    console.log(" Recalcul global...");
    
    getSectionIDs("repeating_training", function(idArray) {
        idArray.forEach(function(id) {
            forceUpdateProgressBar(id);
        });
        console.log("✅ Recalcul terminé");
    });
}

// Debug
on("change:repeating_training:progress_bar_width", function(eventInfo) {
    const rowId = eventInfo.sourceAttribute.split("_")[2];
    console.log(` CSS width pour ${rowId}: ${eventInfo.newValue}%`);
});

console.log(" Sheet Workers Roll20 Compatible chargés");
console.log(" Fonctions disponibles:");
console.log("   - forceUpdateProgressBar(rowId)");
console.log("   - recalculateAllProgressBars()");
</script>
<!-- Script pour gérer l'affichage dynamique et les animations -->
<script type="text/worker">
// =============================================
// SYSTÈME MONÉTAIRE AUTOMATISÉ COMPLET
// =============================================

console.log(" Sheet Workers du Système Monétaire chargés");

// === UTILITAIRES ===
function parseValueToNumber(value) {
  if (!value || value === "") return 0;
  
  // Si c'est déjà un nombre
  if (!isNaN(value)) return parseFloat(value) || 0;
  
  // Extraction simple des nombres (ex: "150 PG" -> 150)
  const numberMatch = value.toString().match(/(\d+(?:\.\d+)?)/);
  return numberMatch ? parseFloat(numberMatch[1]) : 0;
}

function getCurrentTimestamp() {
  const now = new Date();
  const day = String(now.getDate()).padStart(2, '0');
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return day + "/" + month + " " + hours + ":" + minutes;
}

// === CALCUL DE LA RICHESSE TOTALE ===
function calculateTotalWealth() {
  getAttrs([
    "pg_total", "pgi_total", "pc_total",
    "rate_pgi_to_pg", "rate_pc_to_pg",
    "custom_currency_1_value", "custom_1_rate",
    "custom_currency_2_value", "custom_2_rate", 
    "custom_currency_3_value", "custom_3_rate"
  ], function(values) {
    
    // Taux de change (nouveaux taux par défaut)
    const pgiRate = parseInt(values.rate_pgi_to_pg) || 220;
    const pcRate = parseInt(values.rate_pc_to_pg) || 30800;
    
    // Valeurs principales
    const pgValue = parseValueToNumber(values.pg_total);
    const pgiValue = parseValueToNumber(values.pgi_total);
    const pcValue = parseValueToNumber(values.pc_total);
    
    // Conversion en PG
    const pgFromPgi = pgiValue * pgiRate;
    const pgFromPc = pcValue * pcRate;
    
    // Monnaies personnalisées
    const custom1Value = parseValueToNumber(values.custom_currency_1_value);
    const custom1Rate = parseFloat(values.custom_1_rate) || 1;
    const custom2Value = parseValueToNumber(values.custom_currency_2_value);
    const custom2Rate = parseFloat(values.custom_2_rate) || 1;
    const custom3Value = parseValueToNumber(values.custom_currency_3_value);
    const custom3Rate = parseFloat(values.custom_3_rate) || 1;
    
    const pgFromCustom1 = custom1Value * custom1Rate;
    const pgFromCustom2 = custom2Value * custom2Rate;
    const pgFromCustom3 = custom3Value * custom3Rate;
    
    // Total en PG
    const totalPG = pgValue + pgFromPgi + pgFromPc + pgFromCustom1 + pgFromCustom2 + pgFromCustom3;
    
    // Déterminer le niveau de richesse selon le nouveau tableau
    let wealthLevel = "Indigent";
    let wealthClass = "poor";
    
    if (totalPG >= 308000) {
      wealthLevel = "Noble / Ordre";
      wealthClass = "rich";
    } else if (totalPG >= 88000) {
      wealthLevel = "Très Riche";
      wealthClass = "wealthy";
    } else if (totalPG >= 26400) {
      wealthLevel = "Riche";
      wealthClass = "wealthy";
    } else if (totalPG >= 8800) {
      wealthLevel = "Aisé";
      wealthClass = "comfortable";
    } else if (totalPG >= 2640) {
      wealthLevel = "Confortable";
      wealthClass = "comfortable";
    } else if (totalPG >= 660) {
      wealthLevel = "Modeste";
      wealthClass = "modest";
    } else if (totalPG >= 110) {
      wealthLevel = "Pauvre";
      wealthClass = "poor";
    }
    
    const updates = {
      total_wealth_display: Math.round(totalPG) + " PG",
      total_wealth_value: Math.round(totalPG),
      wealth_level_display: wealthLevel,
      wealth_status_class: wealthClass,
      // Valeurs calculées individuelles
      pg_calculated: pgValue,
      pgi_calculated: pgiValue, 
      pc_calculated: pcValue
    };
    
    setAttrs(updates);
    console.log(" Richesse totale: " + Math.round(totalPG) + " PG (" + wealthLevel + ")");
  });
}

// === GESTION DES TRANSACTIONS AVEC CONVERSION AUTOMATIQUE ===
function addTransaction(type, amount, currency, description, pgEquivalent) {
  const timestamp = getCurrentTimestamp();
  const displayAmount = amount >= 0 ? "+" + amount + " " + currency : amount + " " + currency;
  
  // TERMES FRANÇAIS
  const typeClass = amount >= 0 ? "gain" : "depense";
  
  // Si pgEquivalent est fourni, on l'utilise pour les statistiques
  const realPgAmount = pgEquivalent !== undefined ? pgEquivalent : amount;
  
  // Récupérer l'historique actuel
  getAttrs([
    "transaction_1_date", "transaction_1_type", "transaction_1_amount", "transaction_1_desc", "transaction_1_pg_value",
    "transaction_2_date", "transaction_2_type", "transaction_2_amount", "transaction_2_desc", "transaction_2_pg_value",
    "transaction_3_date", "transaction_3_type", "transaction_3_amount", "transaction_3_desc", "transaction_3_pg_value",
    "transaction_4_date", "transaction_4_type", "transaction_4_amount", "transaction_4_desc", "transaction_4_pg_value",
    "transaction_5_date", "transaction_5_type", "transaction_5_amount", "transaction_5_desc", "transaction_5_pg_value",
    "transaction_6_date", "transaction_6_type", "transaction_6_amount", "transaction_6_desc", "transaction_6_pg_value",
    "transaction_7_date", "transaction_7_type", "transaction_7_amount", "transaction_7_desc", "transaction_7_pg_value",
    "transaction_8_date", "transaction_8_type", "transaction_8_amount", "transaction_8_desc", "transaction_8_pg_value",
    "transaction_9_date", "transaction_9_type", "transaction_9_amount", "transaction_9_desc", "transaction_9_pg_value",
    "transaction_10_date", "transaction_10_type", "transaction_10_amount", "transaction_10_desc", "transaction_10_pg_value"
  ], function(values) {
    
    // Décaler l'historique (la nouvelle transaction devient #1)
    const updates = {
      // Nouvelle transaction en position 1
      transaction_1_date: timestamp,
      transaction_1_type: typeClass,
      transaction_1_amount: displayAmount,
      transaction_1_desc: description,
      transaction_1_pg_value: realPgAmount, // NOUVEAU: valeur en PG pour les calculs
      
      // Décaler toutes les autres
      transaction_2_date: values.transaction_1_date || "--",
      transaction_2_type: values.transaction_1_type || "--",
      transaction_2_amount: values.transaction_1_amount || "--",
      transaction_2_desc: values.transaction_1_desc || "--",
      transaction_2_pg_value: values.transaction_1_pg_value || 0,
      
      transaction_3_date: values.transaction_2_date || "--",
      transaction_3_type: values.transaction_2_type || "--",
      transaction_3_amount: values.transaction_2_amount || "--",
      transaction_3_desc: values.transaction_2_desc || "--",
      transaction_3_pg_value: values.transaction_2_pg_value || 0,
      
      transaction_4_date: values.transaction_3_date || "--",
      transaction_4_type: values.transaction_3_type || "--",
      transaction_4_amount: values.transaction_3_amount || "--",
      transaction_4_desc: values.transaction_3_desc || "--",
      transaction_4_pg_value: values.transaction_3_pg_value || 0,
      
      transaction_5_date: values.transaction_4_date || "--",
      transaction_5_type: values.transaction_4_type || "--",
      transaction_5_amount: values.transaction_4_amount || "--",
      transaction_5_desc: values.transaction_4_desc || "--",
      transaction_5_pg_value: values.transaction_4_pg_value || 0,
      
      transaction_6_date: values.transaction_5_date || "--",
      transaction_6_type: values.transaction_5_type || "--",
      transaction_6_amount: values.transaction_5_amount || "--",
      transaction_6_desc: values.transaction_5_desc || "--",
      transaction_6_pg_value: values.transaction_5_pg_value || 0,
      
      transaction_7_date: values.transaction_6_date || "--",
      transaction_7_type: values.transaction_6_type || "--",
      transaction_7_amount: values.transaction_6_amount || "--",
      transaction_7_desc: values.transaction_6_desc || "--",
      transaction_7_pg_value: values.transaction_6_pg_value || 0,
      
      transaction_8_date: values.transaction_7_date || "--",
      transaction_8_type: values.transaction_7_type || "--",
      transaction_8_amount: values.transaction_7_amount || "--",
      transaction_8_desc: values.transaction_7_desc || "--",
      transaction_8_pg_value: values.transaction_7_pg_value || 0,
      
      transaction_9_date: values.transaction_8_date || "--",
      transaction_9_type: values.transaction_8_type || "--",
      transaction_9_amount: values.transaction_8_amount || "--",
      transaction_9_desc: values.transaction_8_desc || "--",
      transaction_9_pg_value: values.transaction_8_pg_value || 0,
      
      transaction_10_date: values.transaction_9_date || "--",
      transaction_10_type: values.transaction_9_type || "--",
      transaction_10_amount: values.transaction_9_amount || "--",
      transaction_10_desc: values.transaction_9_desc || "--",
      transaction_10_pg_value: values.transaction_9_pg_value || 0
    };
    
    setAttrs(updates, function() {
      // Recalculer les statistiques automatiquement après ajout
      calculateMonthlyStats();
    });
    
    console.log(" Transaction ajoutée: " + displayAmount + " - " + description + " (≈" + realPgAmount + " PG)");
  });
}

// === TRANSACTIONS PRINCIPALES AVEC CONVERSION AUTOMATIQUE ===
function handleMainCurrencyTransaction(currency, isAdd) {
  const amountAttr = currency + "_transaction_amount";
  const totalAttr = currency + "_total";
  
  getAttrs([amountAttr, totalAttr, "rate_pgi_to_pg", "rate_pc_to_pg"], function(values) {
    const amount = parseInt(values[amountAttr]) || 0;
    if (amount === 0) return;
    
    const currentTotal = parseValueToNumber(values[totalAttr]);
    const modifier = isAdd ? amount : -amount;
    const newTotal = Math.max(0, currentTotal + modifier);
    
    // Obtenir les taux de conversion
    const pgiRate = parseInt(values.rate_pgi_to_pg) || 220;
    const pcRate = parseInt(values.rate_pc_to_pg) || 30800;
    
    // Calculer l'équivalent en PG pour les statistiques
    let pgEquivalent = modifier;
    let currencyName = "PG";
    
    if (currency === 'pgi') {
      pgEquivalent = modifier * pgiRate;
      currencyName = "PGI";
    } else if (currency === 'pc') {
      pgEquivalent = modifier * pcRate;
      currencyName = "PC";
    }
    
    const description = isAdd ? 
      "Gain de " + amount + " " + currencyName : 
      "Dépense de " + amount + " " + currencyName;
    
    const updates = {};
    updates[totalAttr] = newTotal.toString();
    updates[amountAttr] = 0; // Reset du champ de transaction
    
    setAttrs(updates, function() {
      // Ajouter la transaction avec l'équivalent PG
      addTransaction(isAdd ? "gain" : "depense", modifier, currencyName, description, pgEquivalent);
      calculateTotalWealth();
    });
  });
}

// === CALCUL DES STATISTIQUES MENSUELLES AMÉLIORÉ ===
function calculateMonthlyStats() {
  getAttrs([
    "transaction_1_type", "transaction_1_pg_value",
    "transaction_2_type", "transaction_2_pg_value",
    "transaction_3_type", "transaction_3_pg_value",
    "transaction_4_type", "transaction_4_pg_value",
    "transaction_5_type", "transaction_5_pg_value",
    "transaction_6_type", "transaction_6_pg_value",
    "transaction_7_type", "transaction_7_pg_value",
    "transaction_8_type", "transaction_8_pg_value",
    "transaction_9_type", "transaction_9_pg_value",
    "transaction_10_type", "transaction_10_pg_value"
  ], function(values) {
    
    let monthlyIncome = 0;
    let monthlyExpenses = 0;
    
    for (let i = 1; i <= 10; i++) {
      const type = values["transaction_" + i + "_type"];
      const pgValue = parseFloat(values["transaction_" + i + "_pg_value"]) || 0;
      
      if (type && type !== "--" && pgValue !== 0) {
        if (type === "gain") {
          monthlyIncome += Math.abs(pgValue);
        } else if (type === "depense") {
          monthlyExpenses += Math.abs(pgValue);
        }
      }
    }
    
    const balance = monthlyIncome - monthlyExpenses;
    
    const updates = {
      monthly_income: Math.round(monthlyIncome) + " PG",
      monthly_expenses: Math.round(monthlyExpenses) + " PG",
      monthly_balance: (balance >= 0 ? "+" : "") + Math.round(balance) + " PG"
    };
    
    setAttrs(updates);
    console.log(" Stats mises à jour: Revenus=" + Math.round(monthlyIncome) + "PG, Dépenses=" + Math.round(monthlyExpenses) + "PG");
  });
}

// === LISTENERS POUR BOUTONS DE TRANSACTION (MONNAIES PRINCIPALES SEULEMENT) ===
on("clicked:pg_add", function() { handleMainCurrencyTransaction('pg', true); });
on("clicked:pg_subtract", function() { handleMainCurrencyTransaction('pg', false); });
on("clicked:pgi_add", function() { handleMainCurrencyTransaction('pgi', true); });
on("clicked:pgi_subtract", function() { handleMainCurrencyTransaction('pgi', false); });
on("clicked:pc_add", function() { handleMainCurrencyTransaction('pc', true); });
on("clicked:pc_subtract", function() { handleMainCurrencyTransaction('pc', false); });

// === EFFACER HISTORIQUE ===
on("clicked:clear_transactions", function() {
  const updates = {};
  for (let i = 1; i <= 10; i++) {
    updates["transaction_" + i + "_date"] = "--";
    updates["transaction_" + i + "_type"] = "--";
    updates["transaction_" + i + "_amount"] = "--";
    updates["transaction_" + i + "_desc"] = "--";
    updates["transaction_" + i + "_pg_value"] = 0;
  }
  
  // Reset des statistiques
  updates.monthly_income = "0 PG";
  updates.monthly_expenses = "0 PG";
  updates.monthly_balance = "0 PG";
  
  setAttrs(updates);
  console.log("️ Historique des transactions effacé");
});

// === LISTENERS POUR RECALCULS AUTOMATIQUES ===
on("change:pg_total change:pgi_total change:pc_total change:rate_pgi_to_pg change:rate_pc_to_pg", calculateTotalWealth);

on("change:custom_currency_1_value change:custom_1_rate change:custom_currency_2_value change:custom_2_rate change:custom_currency_3_value change:custom_3_rate", calculateTotalWealth);

// Recalcul des stats à chaque changement de transaction
on("change:transaction_1_date change:transaction_1_type change:transaction_1_pg_value", calculateMonthlyStats);

// === GESTION DES REPEATING SECTIONS (monnaies personnalisées seulement) ===
on("change:repeating_currency_custom", function() {
  // Recalculer la richesse si les monnaies personnalisées changent
  setTimeout(calculateTotalWealth, 100);
});

// === INITIALISATION ===
on("sheet:opened", function() {
  console.log("️ Initialisation du système monétaire");
  calculateTotalWealth();
  calculateMonthlyStats();
  
  // Vérifier si l'historique est vide et ajouter une transaction de bienvenue
  getAttrs(["transaction_1_date"], function(values) {
    if (!values.transaction_1_date || values.transaction_1_date === "--") {
      addTransaction("gain", 0, "PG", "Début du suivi financier", 0);
    }
  });
});

console.log("✅ Sheet Workers du Système Monétaire prêts !");

// === FONCTIONS DE DEBUG ===
if (typeof window !== 'undefined') {
  window.debugCurrency = function() {
    console.log("=== DEBUG SYSTÈME MONÉTAIRE ===");
    getAttrs(["total_wealth_value", "wealth_level_display", "pg_total", "pgi_total", "pc_total"], function(values) {
      console.log("Richesse totale:", values.total_wealth_value);
      console.log("Niveau:", values.wealth_level_display);
      console.log("PG:", values.pg_total);
      console.log("PGI:", values.pgi_total);
      console.log("PC:", values.pc_total);
    });
  };
}

// === GESTION D'ERREURS ===
function safeCalculation(callback) {
  try {
    callback();
  } catch (error) {
    console.error("❌ Erreur dans le système monétaire:", error);
  }
}

// Wrapper pour les calculs sensibles
const originalCalculateWealth = calculateTotalWealth;
calculateTotalWealth = function() {
  safeCalculation(originalCalculateWealth);
};

const originalCalculateStats = calculateMonthlyStats;
calculateMonthlyStats = function() {
  safeCalculation(originalCalculateStats);
};
</script>

<script type="text/worker">
// =============================================
// SYSTÈME DE BARRE D'EXPÉRIENCE AUTOMATIQUE
// =============================================

console.log(" Sheet Workers de la Barre d'Expérience chargés");

// === FONCTION PRINCIPALE DE CALCUL ===
function updateExperienceBar() {
  getAttrs(["experience_actuelle", "experience_max"], function(values) {
    
    // Récupérer les valeurs avec gestion des cas limites
    const current = parseInt(values.experience_actuelle) || 0;
    const max = parseInt(values.experience_max) || 100;
    
    // Éviter la division par zéro et les valeurs négatives
    const safeCurrent = Math.max(0, current);
    const safeMax = Math.max(1, max);
    
    // Calculer le pourcentage brut
    const rawPercentage = (safeCurrent / safeMax) * 100;
    
    // Arrondir au multiple de 5 le plus proche (pour correspondre au CSS)
    const percentage = Math.min(100, Math.round(rawPercentage / 5) * 5);
    
    // Déterminer la zone de couleur selon les seuils
    let colorZone = "critical";
    if (percentage >= 95) {
      colorZone = "optimal";
    } else if (percentage >= 75) {
      colorZone = "high";
    } else if (percentage >= 50) {
      colorZone = "medium";
    } else if (percentage >= 25) {
      colorZone = "low";
    }
    
    // Créer le texte d'affichage
    const displayText = safeCurrent + "/" + safeMax + " PE (" + Math.round(rawPercentage) + "%)";
    
    // Mettre à jour tous les champs cachés
    const updates = {
      exp_percentage: percentage.toString(),
      exp_color_zone: colorZone,
      exp_display: displayText,
      exp_text_display: displayText
    };
    
    setAttrs(updates, function() {
      console.log(" Barre d'expérience mise à jour: " + percentage + "% (" + colorZone + ")");
    });
  });
}

// === VALIDATION DES ENTRÉES ===
function validateExperienceInput(inputName, minValue, defaultValue) {
  getAttrs([inputName], function(values) {
    const currentValue = parseInt(values[inputName]);
    
    if (isNaN(currentValue) || currentValue < minValue) {
      const updates = {};
      updates[inputName] = defaultValue;
      setAttrs(updates, function() {
        console.log("⚠️ Valeur d'expérience corrigée: " + inputName + " = " + defaultValue);
        // Recalculer après correction
        setTimeout(updateExperienceBar, 100);
      });
    }
  });
}

// === LISTENERS PRINCIPAUX ===
on("change:experience_actuelle", function(eventInfo) {
  console.log(" Expérience actuelle modifiée: " + eventInfo.newValue);
  
  // Valider que la valeur n'est pas négative
  if (parseInt(eventInfo.newValue) < 0) {
    setAttrs({experience_actuelle: 0});
    return;
  }
  
  // Mettre à jour la barre
  updateExperienceBar();
});

on("change:experience_max", function(eventInfo) {
  console.log(" Expérience maximum modifiée: " + eventInfo.newValue);
  
  // Valider que la valeur est au moins 1
  if (parseInt(eventInfo.newValue) < 1) {
    setAttrs({experience_max: 100});
    return;
  }
  
  // Mettre à jour la barre
  updateExperienceBar();
});

// === FONCTION D'INITIALISATION ===
function initializeExperienceBar() {
  console.log(" Initialisation de la barre d'expérience");
  
  // Vérifier si les valeurs par défaut sont présentes
  getAttrs(["experience_actuelle", "experience_max"], function(values) {
    const updates = {};
    
    if (!values.experience_actuelle || values.experience_actuelle === "") {
      updates.experience_actuelle = 0;
    }
    
    if (!values.experience_max || values.experience_max === "" || parseInt(values.experience_max) < 1) {
      updates.experience_max = 100;
    }
    
    if (Object.keys(updates).length > 0) {
      setAttrs(updates, function() {
        console.log(" Valeurs d'expérience initialisées");
        updateExperienceBar();
      });
    } else {
      updateExperienceBar();
    }
  });
}

// === FONCTION DE MISE À JOUR FORCÉE (pour débug) ===
on("clicked:force_exp_update", function() {
  console.log(" Mise à jour forcée de la barre d'expérience");
  updateExperienceBar();
});

// === GESTION DES REPEATING SECTIONS (si nécessaire) ===
on("change:repeating_talentsmetier", function() {
  // Si des talents influencent l'expérience, recalculer
  setTimeout(updateExperienceBar, 100);
});

// === INTÉGRATION AVEC LE SYSTÈME EXISTANT ===
// Si sheet:opened est déjà utilisé ailleurs, fusionner cette fonction
on("sheet:opened", function() {
  console.log(" Feuille ouverte - Initialisation de l'expérience");
  setTimeout(initializeExperienceBar, 200);
});

// === FONCTIONS DE DEBUG ===
if (typeof window !== 'undefined') {
  window.debugExperience = function() {
    console.log("=== DEBUG BARRE D'EXPÉRIENCE ===");
    getAttrs([
      "experience_actuelle", "experience_max", 
      "exp_percentage", "exp_color_zone", "exp_display"
    ], function(values) {
      console.log("Expérience actuelle:", values.experience_actuelle);
      console.log("Expérience maximum:", values.experience_max);
      console.log("Pourcentage calculé:", values.exp_percentage + "%");
      console.log("Zone de couleur:", values.exp_color_zone);
      console.log("Texte d'affichage:", values.exp_display);
    });
  };
  
  window.forceExpUpdate = function() {
    updateExperienceBar();
  };
}

// === GESTION D'ERREURS ===
function safeExperienceCalculation(callback) {
  try {
    callback();
  } catch (error) {
    console.error("❌ Erreur dans le calcul d'expérience:", error);
    // Remettre des valeurs par défaut en cas d'erreur
    setAttrs({
      exp_percentage: "0",
      exp_color_zone: "critical",
      exp_display: "Erreur - Veuillez recharger"
    });
  }
}

// Wrapper sécurisé pour la fonction principale
const originalUpdateExperienceBar = updateExperienceBar;
updateExperienceBar = function() {
  safeExperienceCalculation(originalUpdateExperienceBar);
};

console.log("✅ Sheet Workers de la Barre d'Expérience prêts !");

// === INTÉGRATION AVEC LE GRADE ===
on("change:grade_niveau", function() {
  // Optionnel: ajuster l'expérience max selon le grade
  console.log("️ Grade modifié - Vérification de l'expérience");
  setTimeout(updateExperienceBar, 100);
});
</script>

<script type="text/worker">
  // Auto-expand des textarea tout en gardant le redimensionnement manuel possible
  function adjustTextareas() {
    const areas = document.querySelectorAll('.auto-expand');
    areas.forEach(area => {
      area.style.height = 'auto';
      area.style.height = (area.scrollHeight) + 'px';
    });
  }

  on('sheet:opened change:repeating_talent_metier:talent_metier_effet change:repeating_passif_metier:passif_metier_effet', function() {
    setTimeout(adjustTextareas, 20);
  });

  document.addEventListener('input', function(e) {
    if (e.target && e.target.classList.contains('auto-expand')) {
      e.target.style.height = 'auto';
      e.target.style.height = (e.target.scrollHeight) + 'px';
    }
  });
</script>

<script type="text/worker">
  function adjustTextareas() {
    const areas = document.querySelectorAll('.auto-expand');
    areas.forEach(area => {
      area.style.height = 'auto';
      area.style.height = (area.scrollHeight) + 'px';
    });
  }

  on('sheet:opened change:repeating_corruptioneffect:corruption_effect_desc change:repeating_corruptioneffect:corruption_effect_name change:repeating_corruptioneffect:corruption_consequence', function () {
    setTimeout(adjustTextareas, 20);
  });

  document.addEventListener('input', function (e) {
    if (e.target && e.target.classList.contains('auto-expand')) {
      e.target.style.height = 'auto';
      e.target.style.height = (e.target.scrollHeight) + 'px';
    }
  });
</script>







<!-- Script pour activer les onglets -->
<script type="text/worker">
  const tabs = [
    "profils", "combat", "talent", "sort", "inventaire",
    "entrainement", "connaissance", "infos", "tableau",
    "metier", "corruption", "voie_sanguinaire"  // ✅ AJOUTÉ
  ];
  tabs.forEach(tab => {
    on(`clicked:${tab}`, () => {
      setAttrs({ sheetTab: tab });
    });
  });
</script>



<script type="text/worker">
// ================================================================
// === SYSTÈME TRAITS SPÉCIFIQUES - AVEC AVANTAGE/DÉSAVANTAGE ====
// === (AVANTAGE = GARDE LE PLUS BAS | DÉSAVANTAGE = PLUS HAUT) ==
// ================================================================

console.log("=== SYSTÈME TRAITS SPÉCIFIQUES CHARGÉ ===");

const N = x => Number(x) || 0;

/**
 * Lance un jet de trait spécifique avec support Avantage/Désavantage
 * IMPORTANT : Pour les traits, plus le jet est BAS, mieux c'est (marge = seuil - jet)
 * → AVANTAGE = garde le plus BAS
 * → DÉSAVANTAGE = garde le plus HAUT
 * 
 * @param {string} carac - Nom du trait (ex: "Résilience")
 * @param {string} base - Attribut de base (ex: "resi")
 * @param {string} bonus - Attribut de bonus (ex: "resibonus")
 * @param {string} diceAttr - Attribut du type de dé (ex: "residice")
 */
function rollTrait({ carac, base, bonus, diceAttr }) {
    console.log("=== JET DE TRAIT : " + carac + " ===");
    
    getAttrs([
        base, 
        bonus, 
        diceAttr, 
        "trait_competence_bonus_total", 
        "showtraitmargin", 
        "whisper_gm",
        "avantage_trait",      // ✅ NOUVEAU
        "desavantage_trait"    // ✅ NOUVEAU
    ], (v) => {
        // === RÉCUPÉRATION DES VALEURS ===
        const seuil = N(v[base]) + N(v[bonus]) + N(v["trait_competence_bonus_total"]);
        const baseDice = (v[diceAttr] || "1d12").trim();
        const show = v["showtraitmargin"] === "1" ? "1" : "";
        const W = v["whisper_gm"] === "1" ? "/w gm " : "";
        
        // === SYSTÈME AVANTAGE / DÉSAVANTAGE (INVERSÉ POUR TRAITS) ===
        const avantage = v["avantage_trait"] === "1";
        const desavantage = v["desavantage_trait"] === "1";
        
        let diceExpression = baseDice;  // Jet normal par défaut
        let modeJet = '';
        
        if (avantage && desavantage) {
            // Les deux cochés → s'annulent, jet normal
            console.warn("⚠️ AVANTAGE et DÉSAVANTAGE cochés → Jet NORMAL");
            modeJet = ' [Normal]';
        } else if (avantage) {
            // ✅ AVANTAGE : lance 2 dés, garde le PLUS BAS (kl1)
            const diceMatch = baseDice.match(/(\d*)d(\d+)/);
            if (diceMatch) {
                const diceType = diceMatch[2];  // Ex: "12" de "1d12"
                diceExpression = `2d${diceType}kl1`;  // ✅ KEEP LOWEST
            }
            modeJet = ' [AVANTAGE ⬆]';
            console.log("✅ JET AVEC AVANTAGE (" + diceExpression + ", GARDE LE PLUS BAS)");
        } else if (desavantage) {
            // ⚠️ DÉSAVANTAGE : lance 2 dés, garde le PLUS HAUT (kh1)
            const diceMatch = baseDice.match(/(\d*)d(\d+)/);
            if (diceMatch) {
                const diceType = diceMatch[2];
                diceExpression = `2d${diceType}kh1`;  // ⚠️ KEEP HIGHEST
            }
            modeJet = ' [DÉSAVANTAGE ⬇]';
            console.log("⚠️ JET AVEC DÉSAVANTAGE (" + diceExpression + ", GARDE LE PLUS HAUT)");
        }
        
        // === LOGS DEBUG ===
        console.log('┌─────────────────────────────');
        console.log('│ Trait: ' + carac);
        console.log('│ Mode: ' + (modeJet || 'Normal'));
        console.log('│ Seuil: ' + seuil);
        console.log('│ Dé de base: ' + baseDice);
        console.log('│ Expression finale: ' + diceExpression);
        console.log('└─────────────────────────────');
        
        // === CONSTRUCTION DU ROLL TEMPLATE ===
        const msg =
            `${W}&{template:trait-test}`
            + ` {{carac=${carac}${modeJet}}}`
            + ` {{jet=[[${diceExpression}]]}}`
            + ` {{seuil=[[${seuil}]]}}`
            + ` {{marge=[[0]]}}`
            + ` {{show_margin=${show}}}`;
        
        // === LANCEMENT DU ROLL ===
        startRoll(msg, (r) => {
            const jet = N(r.results?.jet?.result);
            const marge = seuil - jet;  // SEUIL - JET (pour traits)
            
            console.log('➤ Jet: ' + jet + ' | Marge: ' + marge + ' | ' + (marge >= 0 ? 'RÉUSSITE ✓' : 'ÉCHEC ✗'));
            
            finishRoll(r.rollId, { marge });
        });
    });
}

// ================================================================
// === LISTENERS SUR LES BOUTONS DE JET DE TRAITS =================
// ================================================================

on("clicked:rolltraitresi", function() {
    rollTrait({ carac: "Résilience", base: "resi", bonus: "resibonus", diceAttr: "residice" });
});

on("clicked:rolltraitfin", function() {
    rollTrait({ carac: "Finesse", base: "fin", bonus: "finbonus", diceAttr: "findice" });
});

on("clicked:rolltraitins", function() {
    rollTrait({ carac: "Instinct", base: "ins", bonus: "insbonus", diceAttr: "insdice" });
});

on("clicked:rolltraitsav", function() {
    rollTrait({ carac: "Savoir", base: "sav", bonus: "savbonus", diceAttr: "savdice" });
});

on("clicked:rolltraitsoc", function() {
    rollTrait({ carac: "Social", base: "soc", bonus: "socbonus", diceAttr: "socdice" });
});

on("clicked:rolltraitpui", function() {
    rollTrait({ carac: "Puissance", base: "pui", bonus: "puibonus", diceAttr: "puidice" });
});

on("clicked:rolltraitmetier", function() {
    rollTrait({ carac: "Métier", base: "metier", bonus: "metierbonus", diceAttr: "metierdice" });
});

on("clicked:rolltraitsan", function() {
    rollTrait({ carac: "Sang-Froid", base: "san", bonus: "sanbonus", diceAttr: "sandice" });
});

console.log("✅ Listeners de traits installés (avec Avantage/Désavantage INVERSÉ)");

console.log("╔══════════════════════════════════════════════════════════╗");
console.log("║  ✅ SYSTÈME TRAITS SPÉCIFIQUES COMPLET                   ║");
console.log("╠══════════════════════════════════════════════════════════╣");
console.log("║  ✓ Jets de traits (d10, d12, etc.)                      ║");
console.log("║  ✓ Calcul de seuil (base + bonus + compétences)         ║");
console.log("║  ✓ Calcul de marge (seuil - jet)                        ║");
console.log("║  ✓ Support whisper MJ                                   ║");
console.log("║  ✓ Affichage marge optionnel                            ║");
console.log("║  ✓ AVANTAGE : 2dX garde le PLUS BAS (kl1)               ║");
console.log("║  ✓ DÉSAVANTAGE : 2dX garde le PLUS HAUT (kh1)           ║");
console.log("╚══════════════════════════════════════════════════════════╝");

</script>





<script type="text/worker">
// ================================================================
// === SYSTÈME CARACTÉRISTIQUES PRINCIPALES - VERSION COMPLÈTE ===
// === AVEC AVANTAGE / DÉSAVANTAGE ================================
// ================================================================

console.log("=== SYSTÈME CARAC PRINCIPALES CHARGÉ ===");

// Fonction utilitaire pour convertir en nombre
const N = x => Number(x) || 0;

// Liste des caractéristiques principales
const caracPrincipales = ['for', 'cst', 'dex', 'int', 'sag', 'per', 'cha'];

// ================================================================
// === 1️⃣ SYNCHRONISATION CHECKBOX → ROW HIGHLIGHT ===============
// ================================================================

caracPrincipales.forEach(function(carac) {
    on('change:' + carac + '_principal sheet:opened', function(eventInfo) {
        getAttrs([carac + '_principal'], function(values) {
            const isPrincipal = values[carac + '_principal'] === '1';
            const updates = {};
            updates[carac + '_row_highlight'] = isPrincipal ? '1' : '0';
            setAttrs(updates);
            
            console.log(carac.toUpperCase() + ' principal: ' + isPrincipal);
        });
    });
});

console.log("✅ Sync highlight installé");

// ================================================================
// === 2️⃣ CALCUL AUTOMATIQUE DU MOD ==============================
// ================================================================

/**
 * Calcule le modificateur selon le tableau :
 * 1-4: -4 | 5-9: -3 | 10-14: -2 | 15-19: -1 | 20-29: 0
 * 30-34: +1 | 35-39: +2 | 40-44: +3 | 45-49: +4
 * 50+: +5 puis +1 tous les 10
 */
function calculateModifier(caracValue) {
    const value = parseInt(caracValue) || 0;
    
    if (value < 1) return -4;
    if (value >= 1 && value <= 4) return -4;
    if (value >= 5 && value <= 9) return -3;
    if (value >= 10 && value <= 14) return -2;
    if (value >= 15 && value <= 19) return -1;
    if (value >= 20 && value <= 29) return 0;
    if (value >= 30 && value <= 34) return 1;
    if (value >= 35 && value <= 39) return 2;
    if (value >= 40 && value <= 44) return 3;
    if (value >= 45 && value <= 49) return 4;
    if (value >= 50) {
        return 5 + Math.floor((value - 50) / 10);
    }
    
    return 0;
}

/**
 * Met à jour le modificateur d'une caractéristique
 */
function updateCaracMod(caracName) {
    getAttrs([caracName], function(values) {
        const caracValue = parseInt(values[caracName]) || 0;
        const modValue = calculateModifier(caracValue);
        
        const updates = {};
        updates[caracName + '_mod'] = modValue;
        setAttrs(updates);
        
        console.log(caracName.toUpperCase() + ' MOD calculé: ' + modValue);
    });
}

// Listeners pour recalculer le MOD automatiquement
caracPrincipales.forEach(function(carac) {
    on('change:' + carac + ' sheet:opened', function() {
        updateCaracMod(carac);
    });
});

console.log("✅ Calcul auto MOD installé");

// ================================================================
// === 3️⃣ FONCTION DE JET UNIFIÉE AVEC SYSTÈME PRINCIPAL =========
// === + AVANTAGE / DÉSAVANTAGE ===================================
// ================================================================

/**
 * Lance un jet de caractéristique avec support complet :
 * - Seuil = 100 - base + difficulté
 * - Jet = d100 + bonus + compétences (+ MOD si principale)
 * - Avantage : 2d100, garde le meilleur
 * - Désavantage : 2d100, garde le pire
 * - Marge = jet - seuil
 * - Whisper MJ optionnel
 * - Affichage marge optionnel
 * 
 * @param {string} label - Libellé affiché (ex: "Force")
 * @param {string} baseAttr - Attribut de base (ex: "for", "rm_final", "rea_final")
 * @param {string} bonusAttr - Attribut de bonus (ex: "for_bonus")
 * @param {string} diffEffAttr - Attribut de difficulté effective (ex: "for_diff_effectif")
 */
function rollCarac({ label, baseAttr, bonusAttr, diffEffAttr }) {
    console.log("=== JET DE " + label.toUpperCase() + " ===");
    
    // Déterminer si c'est une caractéristique principale ou secondaire
    const isPrimaryCarac = caracPrincipales.includes(baseAttr);
    
    // Liste des attributs à récupérer
    const attrsToGet = [
        baseAttr,
        bonusAttr,
        diffEffAttr,
        "competence_bonus_total",
        "showcaracmargin",
        "whispercarac",
        "avantage_carac",      // ✅ NOUVEAU
        "desavantage_carac"    // ✅ NOUVEAU
    ];
    
    // Ajouter les attributs spécifiques aux caractéristiques principales
    if (isPrimaryCarac) {
        attrsToGet.push(baseAttr + '_mod');
        attrsToGet.push(baseAttr + '_principal');
    }
    
    getAttrs(attrsToGet, function(values) {
        // === RÉCUPÉRATION DES VALEURS DE BASE ===
        const base = N(values[baseAttr]);                    // Valeur de la caractéristique
        const bonus = N(values[bonusAttr]);                  // Bonus normal
        const diff = N(values[diffEffAttr]);                 // Difficulté
        const comp = N(values["competence_bonus_total"]);    // Bonus de compétences global
        
        // === SYSTÈME AVANTAGE / DÉSAVANTAGE ===
        const avantage = values["avantage_carac"] === "1";
        const desavantage = values["desavantage_carac"] === "1";
        
        // Vérification : on ne peut pas avoir les deux en même temps
        let diceExpression = 'd100cs1cf100';  // Jet normal par défaut
        let modeJet = '';
        
        if (avantage && desavantage) {
            // Les deux sont cochés → s'annulent, jet normal
            console.warn("⚠️ AVANTAGE et DÉSAVANTAGE cochés → Annulation mutuelle, jet NORMAL");
            modeJet = ' [Normal]';
        } else if (avantage) {
            // Avantage : lance 2d100, garde le plus haut
            diceExpression = '2d100cs1cf100kh1';
            modeJet = ' [AVANTAGE ⬆]';
            console.log("✅ JET AVEC AVANTAGE (2d100, meilleur résultat)");
        } else if (desavantage) {
            // Désavantage : lance 2d100, garde le plus bas
            diceExpression = '2d100cs1cf100kl1';
            modeJet = ' [DÉSAVANTAGE ⬇]';
            console.log("⚠️ JET AVEC DÉSAVANTAGE (2d100, pire résultat)");
        }
        
        // === SYSTÈME CARACTÉRISTIQUE PRINCIPALE ===
        let bonusTotal = bonus;
        let isPrincipal = false;
        let mod = 0;
        
        if (isPrimaryCarac) {
            mod = N(values[baseAttr + '_mod']);
            isPrincipal = values[baseAttr + '_principal'] === '1';
            
            // AJOUT AUTOMATIQUE DU MOD SI PRINCIPALE
            bonusTotal = isPrincipal ? (bonus + mod) : bonus;
        }
        
        // === CALCULS DU JET ===
        const seuil = 100 - base + diff;
        const exprJet = `${diceExpression} + ${bonusTotal} + ${comp}`;
        
        // === OPTIONS D'AFFICHAGE ===
        const showMargin = values["showcaracmargin"] === "1" ? "1" : "";
        const whisper = values["whispercarac"] === "1" ? "/w gm " : "";
        
        // === LOGS DEBUG ===
        console.log('┌─────────────────────────────');
        console.log('│ Caractéristique: ' + label);
        console.log('│ Mode de jet: ' + (modeJet || 'Normal'));
        console.log('│ Valeur de base: ' + base);
        console.log('│ Bonus normal: ' + bonus);
        console.log('│ Difficulté: ' + diff);
        console.log('│ Bonus compétences: ' + comp);
        if (isPrimaryCarac) {
            console.log('│ Modificateur: ' + mod);
            console.log('│ Est principale: ' + isPrincipal);
            console.log('│ Bonus TOTAL: ' + bonusTotal + (isPrincipal ? ' (bonus + mod)' : ' (bonus seul)'));
        } else {
            console.log('│ Bonus TOTAL: ' + bonusTotal);
        }
        console.log('│ Seuil: ' + seuil);
        console.log('│ Expression jet: ' + exprJet);
        console.log('└─────────────────────────────');
        
        // === MISE À JOUR DES ATTRIBUTS CACHÉS ===
        const updates = {};
        if (isPrimaryCarac) {
            updates[baseAttr + '_bonus_total'] = bonusTotal;
        }
        setAttrs(updates);
        
        // === CONSTRUCTION DU ROLL TEMPLATE ===
        let msg = whisper + '&{template:carac-test}' +
    ' {{carac=' + label + modeJet + '}}' +
    ' {{jet=[[' + exprJet + ']]}}' +
    ' {{seuil=[[' + seuil + ']]}}' +
    ' {{marge=[[0]]}}' +
    ' {{jetbrut=[[0]]}}' +  // ✅ AJOUT DU PLACEHOLDER
    ' {{show_margin=' + showMargin + '}}';
        
        // Ajouter info MOD si caractéristique principale
        if (isPrimaryCarac && isPrincipal) {
            msg += ' {{mod_ajoute=' + mod + '}}';
        }
        
        // === LANCEMENT DU ROLL ===
// === LANCEMENT DU ROLL ===
startRoll(msg, function(results) {
    const jetTotal = N(results.results?.jet?.result);  // Total avec bonus
    const marge = jetTotal - seuil;
    
    // ✅ EXTRACTION DU JET BRUT (avant bonus)
    let jetBrut = 0;
    
    try {
        const firstRoll = results.results?.jet?.rolls?.[0];
        
        if (firstRoll && firstRoll.results && Array.isArray(firstRoll.results)) {
            // CAS AVANTAGE/DÉSAVANTAGE : Plusieurs dés lancés
            if (firstRoll.results.length > 1 && typeof firstRoll.results[0] === 'number') {
                if (avantage) {
                    // Avantage : garde le MAXIMUM
                    jetBrut = Math.max.apply(null, firstRoll.results);
                    console.log('✅ AVANTAGE - Dés: [' + firstRoll.results.join(',') + '] → Max: ' + jetBrut);
                } else if (desavantage) {
                    // Désavantage : garde le MINIMUM
                    jetBrut = Math.min.apply(null, firstRoll.results);
                    console.log('✅ DÉSAVANTAGE - Dés: [' + firstRoll.results.join(',') + '] → Min: ' + jetBrut);
                } else {
                    // Plusieurs dés mais pas avantage/désavantage
                    jetBrut = firstRoll.results[0];
                }
            }
            // CAS NORMAL : Un seul dé
            else if (typeof firstRoll.results[0] === 'number') {
                jetBrut = firstRoll.results[0];
                console.log('✅ Jet brut: ' + jetBrut);
            }
            // Cas objet {v: ...}
            else if (firstRoll.results[0] && typeof firstRoll.results[0].v === 'number') {
                jetBrut = firstRoll.results[0].v;
                console.log('✅ Jet brut (objet): ' + jetBrut);
            }
        }
        
        // Fallback si extraction échoue
        if (!jetBrut && bonusTotal === 0 && comp === 0) {
            jetBrut = jetTotal;
            console.log('⚠️ Fallback: jet brut = total');
        }
        
    } catch (e) {
        console.error('❌ Erreur extraction jet brut:', e);
        jetBrut = jetTotal;  // Ultime fallback
    }
    
    // ✅ DÉTECTION DES CRITIQUES SUR LE JET BRUT
    let critique = '';  // Texte du type de critique
    
    if (jetBrut === 100) {
        critique = 'destiny';
    } else if (jetBrut >= 96 && jetBrut <= 99) {
        critique = 'critsuccess';
    } else if (jetBrut === 1) {
        critique = 'fatality';
    } else if (jetBrut >= 2 && jetBrut <= 5) {
        critique = 'critfail';
    }
    
    // Logs debug
    console.log('┌─────────────────────────────');
    console.log('│ Jet brut: ' + jetBrut);
    console.log('│ Jet total: ' + jetTotal);
    console.log('│ Marge: ' + marge);
    console.log('│ Critique: ' + (critique || 'aucun'));
    console.log('└─────────────────────────────');
    
    // ✅ PASSAGE AU TEMPLATE
finishRoll(results.rollId, { 
    marge: marge,
    jetbrut: jetBrut  // ✅ Passer le jet brut comme NOMBRE
});
});
    });
}

console.log("✅ Fonction de jet unifiée installée (avec Avantage/Désavantage)");

// ================================================================
// === 4️⃣ LISTENERS SUR LES BOUTONS DE JET =======================
// ================================================================

// === CARACTÉRISTIQUES PRINCIPALES ===

on("clicked:rollcaracfor", function() {
    rollCarac({ 
        label: "Force", 
        baseAttr: "for", 
        bonusAttr: "for_bonus", 
        diffEffAttr: "for_diff_effectif" 
    });
});

on("clicked:rollcaraccst", function() {
    rollCarac({ 
        label: "Constitution", 
        baseAttr: "cst", 
        bonusAttr: "cst_bonus", 
        diffEffAttr: "cst_diff_effectif" 
    });
});

on("clicked:rollcaracdex", function() {
    rollCarac({ 
        label: "Dextérité", 
        baseAttr: "dex", 
        bonusAttr: "dex_bonus", 
        diffEffAttr: "dex_diff_effectif" 
    });
});

on("clicked:rollcaracint", function() {
    rollCarac({ 
        label: "Intelligence", 
        baseAttr: "int", 
        bonusAttr: "int_bonus", 
        diffEffAttr: "int_diff_effectif" 
    });
});

on("clicked:rollcaracsag", function() {
    rollCarac({ 
        label: "Sagesse", 
        baseAttr: "sag", 
        bonusAttr: "sag_bonus", 
        diffEffAttr: "sag_diff_effectif" 
    });
});

on("clicked:rollcaracper", function() {
    rollCarac({ 
        label: "Perception", 
        baseAttr: "per", 
        bonusAttr: "per_bonus", 
        diffEffAttr: "per_diff_effectif" 
    });
});

on("clicked:rollcaraccha", function() {
    rollCarac({ 
        label: "Charisme", 
        baseAttr: "cha", 
        bonusAttr: "cha_bonus", 
        diffEffAttr: "cha_diff_effectif" 
    });
});

// === CARACTÉRISTIQUES SECONDAIRES ===

on("clicked:rollcaracrm", function() {
    rollCarac({ 
        label: "Résistance Mentale", 
        baseAttr: "rm_final", 
        bonusAttr: "rm_bonus", 
        diffEffAttr: "rm_diff_effectif" 
    });
});

on("clicked:rollcaracrea", function() {
    rollCarac({ 
        label: "Réactivité", 
        baseAttr: "rea_final", 
        bonusAttr: "rea_bonus", 
        diffEffAttr: "rea_diff_effectif" 
    });
});

console.log("✅ Listeners de jets installés");

// ================================================================
// === 5️⃣ RÉCAPITULATIF FINAL ====================================
// ================================================================

console.log("╔══════════════════════════════════════════════════════════╗");
console.log("║  ✅ SYSTÈME CARACTÉRISTIQUES PRINCIPALES COMPLET         ║");
console.log("╠══════════════════════════════════════════════════════════╣");
console.log("║  ✓ Synchronisation checkbox → highlight visuel          ║");
console.log("║  ✓ Calcul automatique des modificateurs                 ║");
console.log("║  ✓ Ajout automatique du MOD si principale               ║");
console.log("║  ✓ Système de seuil (100 - base + diff)                 ║");
console.log("║  ✓ Calcul de marge (jet - seuil)                        ║");
console.log("║  ✓ Support whisper MJ                                   ║");
console.log("║  ✓ Affichage marge optionnel                            ║");
console.log("║  ✓ Compatibilité caractéristiques secondaires           ║");
console.log("║  ✓ AVANTAGE : 2d100 garde le meilleur                   ║");
console.log("║  ✓ DÉSAVANTAGE : 2d100 garde le pire                    ║");
console.log("╚══════════════════════════════════════════════════════════╝");

</script>

<script type="text/worker">
// === GESTION AFFICHAGE CHAMP PERSONNALISÉ "AUTRE" ===
// Roll20 ne supporte pas :has() en CSS natif, donc on utilise un sheet worker

// Fonction pour afficher/masquer le champ custom
function toggleCustomField(weaponNum) {
    var typeAttr = "weapon_type" + weaponNum;
    
    on("change:" + typeAttr, function() {
        getAttrs([typeAttr], function(values) {
            var selectedType = values[typeAttr];
            console.log("Arme " + weaponNum + " type changé:", selectedType);
            
            // Note: Le CSS gère déjà l'affichage avec les sélecteurs
            // Ce worker est juste pour le logging/debug
        });
    });
}

// Initialiser pour les 4 armes
for (var i = 1; i <= 4; i++) {
    toggleCustomField(i);
}

console.log("Sheet Workers Classe d'Arme chargés");
</script>

<script type="text/worker">
/* ==================== INITIALISATION COMPLÈTE DE LA FICHE ==================== */

/**
 * Initialise toutes les valeurs par défaut lors de la création d'une nouvelle fiche
 * Inclut : Caractéristiques, Traits Spécifiques, Points de Réaction, Mouvement
 */
on('sheet:opened', function() {
  getAttrs([
    // Caractéristiques principales
    'for', 'cst', 'dex', 'int', 'sag', 'per', 'cha',
    'for_bonus', 'cst_bonus', 'dex_bonus', 'int_bonus', 'sag_bonus', 'per_bonus', 'cha_bonus',
    'for_diff', 'cst_diff', 'dex_diff', 'int_diff', 'sag_diff', 'per_diff', 'cha_diff',
    
    // Caractéristiques secondaires
    'rm_base', 'rm_bonus', 'rm_diff',
    'rea_base', 'rea_bonus', 'rea_diff',
    
    // Points de réaction
    'pr_max', 'pr_current', 'pr_display',
    
    // Mouvement
    'mov_base', 'mov_bonus',
    
    // Traits Spécifiques
    'resi', 'resibonus', 'residice',
    'fin', 'finbonus', 'findice',
    'ins', 'insbonus', 'insdice',
    'sav', 'savbonus', 'savdice',
    'soc', 'socbonus', 'socdice',
    'pui', 'puibonus', 'puidice',
    'metier', 'metierbonus', 'metierdice',
    'san', 'sanbonus', 'sandice',
    
    // Marqueur d'initialisation
    'character_sheet_initialized'
  ], function(values) {
    
    // Vérifier si la fiche a déjà été initialisée
    if (values.character_sheet_initialized === '1') {
      console.log('Fiche déjà initialisée');
      return;
    }
    
    console.log(' Initialisation d\'une nouvelle fiche...');
    
    var updates = {};
    var needsInit = false;
    
    // ========================================
    // CARACTÉRISTIQUES PRINCIPALES
    // ========================================
    
    var caracPrincipales = ['for', 'cst', 'dex', 'int', 'sag', 'per', 'cha'];
    
    caracPrincipales.forEach(function(carac) {
      // Valeur de base : 15
      if (!values[carac] || values[carac] === '' || values[carac] === '0') {
        updates[carac] = 15;
        needsInit = true;
      }
      
      // Bonus : 0
      if (!values[carac + '_bonus'] || values[carac + '_bonus'] === '') {
        updates[carac + '_bonus'] = 0;
        needsInit = true;
      }
      
      // Difficulté : 0
      if (!values[carac + '_diff'] || values[carac + '_diff'] === '') {
        updates[carac + '_diff'] = 0;
        needsInit = true;
      }
    });
    
    // ========================================
    // CARACTÉRISTIQUES SECONDAIRES
    // ========================================
    
    // Résistance Mentale : Base = 20
    if (!values.rm_base || values.rm_base === '' || values.rm_base === '0') {
      updates.rm_base = 20;
      needsInit = true;
    }
    if (!values.rm_bonus || values.rm_bonus === '') {
      updates.rm_bonus = 0;
      needsInit = true;
    }
    if (!values.rm_diff || values.rm_diff === '') {
      updates.rm_diff = 0;
      needsInit = true;
    }
    
    // Réactivité : Base = 10
    if (!values.rea_base || values.rea_base === '' || values.rea_base === '0') {
      updates.rea_base = 10;
      needsInit = true;
    }
    if (!values.rea_bonus || values.rea_bonus === '') {
      updates.rea_bonus = 0;
      needsInit = true;
    }
    if (!values.rea_diff || values.rea_diff === '') {
      updates.rea_diff = 0;
      needsInit = true;
    }
    
    // ========================================
    // POINTS DE RÉACTION
    // ========================================
    
    if (!values.pr_max || values.pr_max === '' || values.pr_max === '0') {
      updates.pr_max = 1;
      needsInit = true;
    }
    
    if (!values.pr_current || values.pr_current === '') {
      var prMaxInit = updates.pr_max || values.pr_max || 1;
      updates.pr_current = prMaxInit;
      updates.pr_display = prMaxInit + '/' + prMaxInit;
      needsInit = true;
    }
    
    // ========================================
    // MOUVEMENT
    // ========================================
    
    if (!values.mov_base || values.mov_base === '' || values.mov_base === '0') {
      updates.mov_base = 20;
      needsInit = true;
    }
    
    if (!values.mov_bonus || values.mov_bonus === '') {
      updates.mov_bonus = 0;
      needsInit = true;
    }
    
    // ========================================
    // TRAITS SPÉCIFIQUES (8 traits fixes)
    // ========================================
    
    var traitsSpecifiques = [
      { nom: 'resi', valeur: 1, bonus: 0, dice: '1d10' },    // Résilience
      { nom: 'fin', valeur: 1, bonus: 0, dice: '1d10' },     // Finesse
      { nom: 'ins', valeur: 1, bonus: 0, dice: '1d10' },     // Instinct
      { nom: 'sav', valeur: 1, bonus: 0, dice: '1d10' },     // Savoir
      { nom: 'soc', valeur: 1, bonus: 0, dice: '1d10' },     // Social
      { nom: 'pui', valeur: 1, bonus: 0, dice: '1d10' },     // Puissance
      { nom: 'metier', valeur: 1, bonus: 0, dice: '1d10' },  // Métier
      { nom: 'san', valeur: 1, bonus: 0, dice: '1d10' }      // Sang-Froid
    ];
    
    traitsSpecifiques.forEach(function(trait) {
      // Valeur du trait
      if (!values[trait.nom] || values[trait.nom] === '' || values[trait.nom] === '0') {
        updates[trait.nom] = trait.valeur;
        needsInit = true;
      }
      
      // Bonus du trait
      if (!values[trait.nom + 'bonus'] || values[trait.nom + 'bonus'] === '') {
        updates[trait.nom + 'bonus'] = trait.bonus;
        needsInit = true;
      }
      
      // Dé du trait
      if (!values[trait.nom + 'dice'] || values[trait.nom + 'dice'] === '') {
        updates[trait.nom + 'dice'] = trait.dice;
        needsInit = true;
      }
    });
    
    // ========================================
    // MARQUER COMME INITIALISÉ
    // ========================================
    
    if (needsInit) {
      updates.character_sheet_initialized = '1';
      
      setAttrs(updates, {silent: false}, function() {
        console.log('✅ Fiche initialisée avec succès !');
        console.log(' Valeurs définies :', updates);
      });
    } else {
      console.log('ℹ️ Fiche déjà remplie, pas d\'initialisation nécessaire');
    }
  });
});

/* ==================== INITIALISATION REPEATING SECTIONS ==================== */

/**
 * Initialise les valeurs par défaut lors de l'ajout d'une nouvelle ligne
 * dans les sections répétables (Compétences)
 */

// Zone des Compétences (repeating_competences)
on('change:repeating_competences', function(eventInfo) {
  if (eventInfo.sourceType === 'player' || eventInfo.sourceType === 'api') {
    var rowId = eventInfo.sourceAttribute.split('_')[2];
    
    getAttrs([
      'repeating_competences_' + rowId + '_comp_bonus',
      'repeating_competences_' + rowId + '_comp_bonus2'
    ], function(values) {
      var updates = {};
      
      // Initialiser bonus à 0 si vide
      if (!values['repeating_competences_' + rowId + '_comp_bonus']) {
        updates['repeating_competences_' + rowId + '_comp_bonus'] = 0;
      }
      if (!values['repeating_competences_' + rowId + '_comp_bonus2']) {
        updates['repeating_competences_' + rowId + '_comp_bonus2'] = 0;
      }
      
      if (Object.keys(updates).length > 0) {
        setAttrs(updates, {silent: true});
      }
    });
  }
});

// Compétences de Trait Spécifique (repeating_traitcompetences)
on('change:repeating_traitcompetences', function(eventInfo) {
  if (eventInfo.sourceType === 'player' || eventInfo.sourceType === 'api') {
    var rowId = eventInfo.sourceAttribute.split('_')[2];
    
    getAttrs([
      'repeating_traitcompetences_' + rowId + '_trait_comp_bonus1',
      'repeating_traitcompetences_' + rowId + '_trait_comp_bonus2'
    ], function(values) {
      var updates = {};
      
      // Initialiser bonus à 0 si vide
      if (!values['repeating_traitcompetences_' + rowId + '_trait_comp_bonus1']) {
        updates['repeating_traitcompetences_' + rowId + '_trait_comp_bonus1'] = 0;
      }
      if (!values['repeating_traitcompetences_' + rowId + '_trait_comp_bonus2']) {
        updates['repeating_traitcompetences_' + rowId + '_trait_comp_bonus2'] = 0;
      }
      
      if (Object.keys(updates).length > 0) {
        setAttrs(updates, {silent: true});
      }
    });
  }
});

/* ==================== FIN INITIALISATION ==================== */
</script>

<script type="text/worker">/* ==================== INITIALISATION AUTOMATIQUE DES COMPÉTENCES ==================== */

/**
 * Initialise automatiquement 2 lignes dans "Zone des compétences"
 * et 1 ligne dans "Compétence de trait spécifique"
 */
on('sheet:opened', function() {
  // Vérifier d'abord si la fiche a déjà été initialisée
  getAttrs(['competences_initialized'], function(values) {
    
    if (values.competences_initialized === '1') {
      console.log('Compétences déjà initialisées');
      return;
    }
    
    console.log(' Initialisation des compétences...');
    
    // ========================================
    // ZONE DES COMPÉTENCES (2 lignes)
    // ========================================
    
    getSectionIDs('repeating_competences', function(idArray) {
      
      if (idArray.length === 0) {
        console.log('Création de 2 lignes dans Zone des compétences');
        
        // Générer 2 IDs uniques pour les 2 lignes
        var rowId1 = generateRowID();
        var rowId2 = generateRowID();
        
        var competencesUpdates = {};
        
        // ===== LIGNE 1 =====
        // Colonne 1 : "Compétence 1" | 3 | checkbox
        competencesUpdates['repeating_competences_' + rowId1 + '_comp_nom'] = 'Compétence 1';
        competencesUpdates['repeating_competences_' + rowId1 + '_comp_bonus'] = 3;
        competencesUpdates['repeating_competences_' + rowId1 + '_comp_active'] = '1'; // Coché
        
        // Colonne 2 : "Compétence 2" | 3 | checkbox
        competencesUpdates['repeating_competences_' + rowId1 + '_comp_nom2'] = 'Compétence 2';
        competencesUpdates['repeating_competences_' + rowId1 + '_comp_bonus2'] = 3;
        competencesUpdates['repeating_competences_' + rowId1 + '_comp_active2'] = '1'; // Coché
        
        // ===== LIGNE 2 =====
        // Colonne 1 : "Compétence 3" | 3 | checkbox
        competencesUpdates['repeating_competences_' + rowId2 + '_comp_nom'] = 'Compétence 3';
        competencesUpdates['repeating_competences_' + rowId2 + '_comp_bonus'] = 3;
        competencesUpdates['repeating_competences_' + rowId2 + '_comp_active'] = '1'; // Coché
        
        // Colonne 2 : "Nom" | "Bonus" | checkbox (vides, juste placeholders)
        competencesUpdates['repeating_competences_' + rowId2 + '_comp_nom2'] = '';
        competencesUpdates['repeating_competences_' + rowId2 + '_comp_bonus2'] = 0;
        competencesUpdates['repeating_competences_' + rowId2 + '_comp_active2'] = '0'; // Décoché
        
        setAttrs(competencesUpdates, {silent: false}, function() {
          console.log('✅ Zone des compétences initialisée (2 lignes)');
        });
      } else {
        console.log('Zone des compétences déjà remplie (' + idArray.length + ' lignes)');
      }
    });
    
    // ========================================
    // COMPÉTENCE DE TRAIT SPÉCIFIQUE (1 ligne)
    // ========================================
    
    getSectionIDs('repeating_traitcompetences', function(idArray) {
      
      if (idArray.length === 0) {
        console.log('Création de 1 ligne dans Compétence de trait spécifique');
        
        // Générer 1 ID unique
        var rowId = generateRowID();
        
        var traitUpdates = {};
        
        // ===== LIGNE 1 =====
        // Colonne 1 : "Compétence 1" | 1 | checkbox
        traitUpdates['repeating_traitcompetences_' + rowId + '_trait_comp_nom1'] = 'Compétence 1';
        traitUpdates['repeating_traitcompetences_' + rowId + '_trait_comp_bonus1'] = 1;
        traitUpdates['repeating_traitcompetences_' + rowId + '_trait_comp_active1'] = '1'; // Coché
        
        // Colonne 2 : "Compétence 2" | 1 | checkbox
        traitUpdates['repeating_traitcompetences_' + rowId + '_trait_comp_nom2'] = 'Compétence 2';
        traitUpdates['repeating_traitcompetences_' + rowId + '_trait_comp_bonus2'] = 1;
        traitUpdates['repeating_traitcompetences_' + rowId + '_trait_comp_active2'] = '1'; // Coché
        
        setAttrs(traitUpdates, {silent: false}, function() {
          console.log('✅ Compétence de trait spécifique initialisée (1 ligne)');
        });
      } else {
        console.log('Compétence de trait spécifique déjà remplie (' + idArray.length + ' lignes)');
      }
    });
    
    // Marquer comme initialisé
    setAttrs({
      competences_initialized: '1'
    }, {silent: true});
    
  });
});

/* ==================== FIN INITIALISATION COMPÉTENCES ==================== */
</script>

<script type="text/worker">

/* ==================== INITIALISATION AUTOMATIQUE ATOUTS & TALENTS ==================== */

/**
 * Initialise automatiquement 3 lignes dans "Atout de l'être" et "Talents"
 * Chaque nom est pré-rempli avec "-"
 */
on('sheet:opened', function() {
  // Vérifier d'abord si la fiche a déjà été initialisée
  getAttrs(['atouts_talents_initialized'], function(values) {
    
    if (values.atouts_talents_initialized === '1') {
      console.log('Atouts et Talents déjà initialisés');
      return;
    }
    
    console.log(' Initialisation des Atouts et Talents...');
    
    // ========================================
    // ATOUT DE L'ÊTRE (3 lignes)
    // ========================================
    
    getSectionIDs('repeating_atouts', function(idArray) {
      
      if (idArray.length === 0) {
        console.log('Création de 3 lignes dans Atout de l\'être');
        
        // Générer 3 IDs uniques pour les 3 lignes
        var rowId1 = generateRowID();
        var rowId2 = generateRowID();
        var rowId3 = generateRowID();
        
        var atoutsUpdates = {};
        
        // ===== LIGNE 1 =====
        atoutsUpdates['repeating_atouts_' + rowId1 + '_atout_nom1'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId1 + '_atout_effet1'] = '';
        atoutsUpdates['repeating_atouts_' + rowId1 + '_atout_nom2'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId1 + '_atout_effet2'] = '';
        atoutsUpdates['repeating_atouts_' + rowId1 + '_atout_nom3'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId1 + '_atout_effet3'] = '';
        
        // ===== LIGNE 2 =====
        atoutsUpdates['repeating_atouts_' + rowId2 + '_atout_nom1'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId2 + '_atout_effet1'] = '';
        atoutsUpdates['repeating_atouts_' + rowId2 + '_atout_nom2'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId2 + '_atout_effet2'] = '';
        atoutsUpdates['repeating_atouts_' + rowId2 + '_atout_nom3'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId2 + '_atout_effet3'] = '';
        
        // ===== LIGNE 3 =====
        atoutsUpdates['repeating_atouts_' + rowId3 + '_atout_nom1'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId3 + '_atout_effet1'] = '';
        atoutsUpdates['repeating_atouts_' + rowId3 + '_atout_nom2'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId3 + '_atout_effet2'] = '';
        atoutsUpdates['repeating_atouts_' + rowId3 + '_atout_nom3'] = '-';
        atoutsUpdates['repeating_atouts_' + rowId3 + '_atout_effet3'] = '';
        
        setAttrs(atoutsUpdates, {silent: false}, function() {
          console.log('✅ Atout de l\'être initialisé (3 lignes × 3 colonnes = 9 atouts)');
        });
      } else {
        console.log('Atout de l\'être déjà rempli (' + idArray.length + ' lignes)');
      }
    });
    
    // ========================================
    // TALENTS (3 lignes)
    // ========================================
    
    getSectionIDs('repeating_talents', function(idArray) {
      
      if (idArray.length === 0) {
        console.log('Création de 3 lignes dans Talents');
        
        // Générer 3 IDs uniques pour les 3 lignes
        var rowId1 = generateRowID();
        var rowId2 = generateRowID();
        var rowId3 = generateRowID();
        
        var talentsUpdates = {};
        
        // ===== LIGNE 1 =====
        talentsUpdates['repeating_talents_' + rowId1 + '_talent_nom1'] = '-';
        talentsUpdates['repeating_talents_' + rowId1 + '_talent_effet1'] = '';
        talentsUpdates['repeating_talents_' + rowId1 + '_talent_nom2'] = '-';
        talentsUpdates['repeating_talents_' + rowId1 + '_talent_effet2'] = '';
        talentsUpdates['repeating_talents_' + rowId1 + '_talent_nom3'] = '-';
        talentsUpdates['repeating_talents_' + rowId1 + '_talent_effet3'] = '';
        
        // ===== LIGNE 2 =====
        talentsUpdates['repeating_talents_' + rowId2 + '_talent_nom1'] = '-';
        talentsUpdates['repeating_talents_' + rowId2 + '_talent_effet1'] = '';
        talentsUpdates['repeating_talents_' + rowId2 + '_talent_nom2'] = '-';
        talentsUpdates['repeating_talents_' + rowId2 + '_talent_effet2'] = '';
        talentsUpdates['repeating_talents_' + rowId2 + '_talent_nom3'] = '-';
        talentsUpdates['repeating_talents_' + rowId2 + '_talent_effet3'] = '';
        
        // ===== LIGNE 3 =====
        talentsUpdates['repeating_talents_' + rowId3 + '_talent_nom1'] = '-';
        talentsUpdates['repeating_talents_' + rowId3 + '_talent_effet1'] = '';
        talentsUpdates['repeating_talents_' + rowId3 + '_talent_nom2'] = '-';
        talentsUpdates['repeating_talents_' + rowId3 + '_talent_effet2'] = '';
        talentsUpdates['repeating_talents_' + rowId3 + '_talent_nom3'] = '-';
        talentsUpdates['repeating_talents_' + rowId3 + '_talent_effet3'] = '';
        
        setAttrs(talentsUpdates, {silent: false}, function() {
          console.log('✅ Talents initialisés (3 lignes × 3 colonnes = 9 talents)');
        });
      } else {
        console.log('Talents déjà remplis (' + idArray.length + ' lignes)');
      }
    });
    
    // Marquer comme initialisé
    setAttrs({
      atouts_talents_initialized: '1'
    }, {silent: true});
    
  });
});

/* ==================== FIN INITIALISATION ATOUTS & TALENTS ==================== */
</script>









<!-- ================================================================= -->
<!-- ========== ROLL TEMPLATE : JETS D'ATTAQUE ====================== -->
<!-- ================================================================= -->

<script type="text/worker">
/* ================================================================= */
/* ========== SHEET WORKERS : BONUS MODS + LIAISON ATTAQUE ======== */
/* ================================================================= */

console.log(" Sheet Workers chargés");

// ====================================================================
// 1️⃣ CALCUL DES TOTAUX DES MODS (inchangé)
// ====================================================================
function recalcBonusTotals() {
  getAttrs(["for_mod", "int_mod", "cst_mod", "sag_mod"], function(v) {
    const n = function(x) { return parseInt(x, 10) || 0; };
    
    setAttrs({
      att_phy_total: n(v.for_mod),
      att_mag_total: n(v.int_mod),
      def_phy_total: n(v.cst_mod),
      def_mag_total: n(v.sag_mod)
    });
    
    console.log("✅ Totaux recalculés");
  });
}

// Recalcul des totaux quand les mods de base changent
on("change:for_mod change:int_mod change:cst_mod change:sag_mod", recalcBonusTotals);

// ====================================================================
// 2️⃣ LIAISON AUTOMATIQUE : Select Mod → Bonus de Mods
// ====================================================================

/**
 * Met à jour le champ "Bonus de mods" d'une ligne d'attaque
 * en fonction du mod sélectionné dans "Mod utilisé"
 */
function updateAttackBonusFromModSource(rowId) {
  const prefix = "repeating_attackdefense_" + rowId + "_";
  
  getAttrs([
    prefix + "attack_mod_source",
    "att_phy_total",
    "att_mag_total",
    "def_phy_total",
    "def_mag_total"
  ], function(values) {
    const modSource = values[prefix + "attack_mod_source"];
    let bonusValue = "";
    
    // Table de correspondance
    const modMapping = {
      "att_phy": "att_phy_total",
      "att_mag": "att_mag_total",
      "def_phy": "def_phy_total",
      "def_mag": "def_mag_total"
    };
    
    // Si un mod est sélectionné, récupérer sa valeur
    if (modSource && modMapping[modSource]) {
      const totalValue = parseInt(values[modMapping[modSource]]) || 0;
      bonusValue = totalValue >= 0 ? "+" + totalValue : String(totalValue);
    }
    
    // Mettre à jour le champ texte "Bonus de mods"
    const updates = {};
    updates[prefix + "attack_bonus_mod"] = bonusValue;
    
    setAttrs(updates);
    
    console.log("✅ Ligne " + rowId + " : Bonus Mod = " + bonusValue);
  });
}

/**
 * Écouter les changements du select "Mod utilisé" dans chaque ligne
 */
on("change:repeating_attackdefense:attack_mod_source", function(eventInfo) {
  const rowId = eventInfo.sourceAttribute.split("_")[2];
  console.log(" Select Mod modifié (ligne " + rowId + ")");
  updateAttackBonusFromModSource(rowId);
});

/**
 * Quand les totaux changent, mettre à jour TOUTES les lignes
 * qui utilisent ce mod
 */
on("change:att_phy_total change:att_mag_total change:def_phy_total change:def_mag_total", function(eventInfo) {
  console.log(" Total modifié : " + eventInfo.sourceAttribute);
  
  getSectionIDs("repeating_attackdefense", function(idArray) {
    if (!idArray || idArray.length === 0) {
      console.log("⚠️ Aucune ligne d'attaque");
      return;
    }
    
    // Mettre à jour chaque ligne qui a un mod sélectionné
    idArray.forEach(function(rowId) {
      updateAttackBonusFromModSource(rowId);
    });
    
    console.log("✅ " + idArray.length + " ligne(s) mise(s) à jour (Mod)");
  });
});

// ====================================================================
// 3️⃣ NOUVEAU : Classe d'Arme → Bonus de Classe
// ====================================================================

/**
 * Met à jour le champ "Bonus de classe d'arme" d'une ligne
 * en fonction du niveau sélectionné (E → SSS)
 */
function updateAttackClasseBonus(rowId) {
  const prefix = "repeating_attackdefense_" + rowId + "_";
  
  getAttrs([prefix + "attack_classe_niveau"], function(values) {
    const classeNiveau = values[prefix + "attack_classe_niveau"];
    let bonusClasse = "";
    
    // Table de correspondance Niveau → Formule de dés
    const classeMapping = {
      "E": "0",
      "D": "1d2+1",
      "C": "2d2+2",
      "B": "3d3+3",
      "A": "4d3+4",
      "S": "5d3+5",
      "SS": "6d4+5",
      "SSS": "7d4+5"
    };
    
    // Si un niveau est sélectionné, récupérer la formule
    if (classeNiveau && classeMapping[classeNiveau]) {
      bonusClasse = classeMapping[classeNiveau];
    }
    
    // Mettre à jour le champ "Bonus de classe d'arme"
    const updates = {};
    updates[prefix + "attack_bonus_classe"] = bonusClasse;
    
    setAttrs(updates);
    
    console.log("✅ Ligne " + rowId + " : Bonus Classe = " + bonusClasse);
  });
}

/**
 * Écouter les changements du select "Niveau de classe d'arme"
 */
on("change:repeating_attackdefense:attack_classe_niveau", function(eventInfo) {
  const rowId = eventInfo.sourceAttribute.split("_")[2];
  console.log("⚔️ Niveau Classe modifié (ligne " + rowId + ")");
  updateAttackClasseBonus(rowId);
});

// ====================================================================
// 4️⃣ INITIALISATION AU CHARGEMENT
// ====================================================================

/**
 * Initialisation au chargement de la fiche
 */
on("sheet:opened", function() {
  console.log(" Fiche ouverte - Initialisation...");
  
  // D'abord recalculer les totaux
  recalcBonusTotals();
  
  // Puis mettre à jour les lignes d'attaque après un délai
  setTimeout(function() {
    getSectionIDs("repeating_attackdefense", function(idArray) {
      if (!idArray || idArray.length === 0) {
        console.log("⚠️ Aucune ligne d'attaque à initialiser");
        return;
      }
      
      idArray.forEach(function(rowId) {
        updateAttackBonusFromModSource(rowId);
        updateAttackClasseBonus(rowId);
      });
      
      console.log("✅ " + idArray.length + " ligne(s) initialisée(s)");
    });
  }, 200);
});

console.log("✅ Sheet Workers actifs");
</script>

<script type="text/worker">
  // Helper: met à jour le flag d'affichage pour une colonne donnée de la ligne donnée
  function setCustomVisibility(rowId, idx, typeVal) {
    const show = (typeVal === "Autre") ? "1" : "0";
    const attr = {};
    attr[`repeating_arme_${rowId}_weapon_custom${idx}_show`] = show;
    setAttrs(attr);
  }

  // Écoutes pour les 4 colonnes
  ["1","2","3","4"].forEach(idx => {
    on(`change:repeating_arme:weapon_type${idx}`, (e) => {
      const m = e.sourceAttribute.match(/repeating_arme_([^_]+)/);
      if (!m) return;
      const rowId = m[1];
      const field = `repeating_arme_${rowId}_weapon_type${idx}`;
      getAttrs([field], v => setCustomVisibility(rowId, idx, v[field] || ""));
    });
  });

  // Initialisation à l'ouverture : synchronise toutes les lignes existantes
  on("sheet:opened", () => {
    getSectionIDs("repeating_arme", ids => {
      const fields = [];
      ids.forEach(id => ["1","2","3","4"].forEach(idx => fields.push(`repeating_arme_${id}_weapon_type${idx}`)));
      getAttrs(fields, v => {
        ids.forEach(id => ["1","2","3","4"].forEach(idx => {
          setCustomVisibility(id, idx, v[`repeating_arme_${id}_weapon_type${idx}`] || "");
        }));
      });
    });
  });
</script>

<!-- ============== SHEET-WORKER (JS) ============== -->
<script type="text/worker">
  /* ----- 1) Affichage du champ "Nom personnalisé" si Type = Autre ----- */
  function setCustomVisibility(rowId, idx, typeVal) {
    const show = (typeVal === "Autre") ? "1" : "0";
    const obj = {};
    obj[`repeating_arme_${rowId}_weapon_custom${idx}_show`] = show;
    setAttrs(obj);
  }

  ["1","2","3","4"].forEach(idx => {
    on(`change:repeating_arme:weapon_type${idx}`, (e) => {
      const m = e.sourceAttribute && e.sourceAttribute.match(/repeating_arme_([^_]+)/);
      if (!m) return;
      const rowId = m[1];
      const field = `repeating_arme_${rowId}_weapon_type${idx}`;
      getAttrs([field], v => setCustomVisibility(rowId, idx, v[field] || ""));
    });
  });

  /* ----- 2) Bonus auto en fonction de la CLASSE (F supprimé) ----- */
  // Barème fourni :
  // E:0 | D:1d2+1 | C:2d2+2 | B:3d3+3 | A:4d3+4 | S:5d3+5 | SS:6d4+5 | SSS:7d4+5
  const CLASS_TO_BONUS = {
    "E":  "0",
    "D":  "1d2+1",
    "C":  "2d2+2",
    "B":  "3d3+3",
    "A":  "4d3+4",
    "S":  "5d3+5",
    "SS": "6d4+5",
    "SSS":"7d4+5"
  };

  function setWeaponBonus(rowId, idx, classeVal) {
    const key = (classeVal || "").toUpperCase();
    const bonus = CLASS_TO_BONUS[key] || "";
    const obj = {};
    obj[`repeating_arme_${rowId}_weapon_bonus${idx}`] = bonus;
    setAttrs(obj);
  }

  // Écoute des changements de classe pour les 4 colonnes
  ["1","2","3","4"].forEach(idx => {
    on(`change:repeating_arme:weapon_classe${idx}`, (e) => {
      const m = e.sourceAttribute && e.sourceAttribute.match(/repeating_arme_([^_]+)/);
      if (!m) return;
      const rowId = m[1];
      const field = `repeating_arme_${rowId}_weapon_classe${idx}`;
      getAttrs([field], v => setWeaponBonus(rowId, idx, v[field] || ""));
    });
  });

  /* ----- 3) Initialisation à l'ouverture ----- */
  on("sheet:opened", () => {
    getSectionIDs("repeating_arme", ids => {
      const fields = [];
      ids.forEach(id => {
        ["1","2","3","4"].forEach(idx => {
          fields.push(`repeating_arme_${id}_weapon_type${idx}`);
          fields.push(`repeating_arme_${id}_weapon_classe${idx}`);
        });
      });
      getAttrs(fields, v => {
        ids.forEach(id => {
          ["1","2","3","4"].forEach(idx => {
            setCustomVisibility(id, idx, v[`repeating_arme_${id}_weapon_type${idx}`] || "");
            setWeaponBonus(id, idx, v[`repeating_arme_${id}_weapon_classe${idx}`] || "");
          });
        });
      });
    });
  });
</script>

<script type="text/worker">
/* ==================== RÉVÉLATION D'AIDE (SIMPLE) ==================== */

on('change:aide_revelation sheet:opened', function() {
    getAttrs(['aide_revelation'], function(values) {
        const isChecked = values.aide_revelation === '1';
        console.log('Révélation d\'aide:', isChecked ? 'ON' : 'OFF');
    });
});

/* ==================== FIN RÉVÉLATION D'AIDE ==================== */
</script>

<script type="text/worker">
// ===== COMPTEURS AUTOMATIQUES POUR LES SACS =====

/**
 * Fonction générique pour calculer et mettre à jour un compteur X/Y
 * @param {string} section - Nom de la repeating section (ex: "repeating_sac")
 * @param {string} qtyAttr - Nom de l'attribut de quantité (ex: "item_quantite")
 * @param {string} counterAttr - Nom de l'attribut du compteur (ex: "gros_sac_counter")
 */
const updateInventoryCounter = function(section, qtyAttr, counterAttr) {
    getSectionIDs(section, function(idArray) {
        if (!idArray || idArray.length === 0) {
            // Aucune ligne : afficher 0/0
            setAttrs({
                [counterAttr]: "0/0"
            });
            return;
        }
        
        const totalLines = idArray.length; // Y = nombre total de lignes
        const attrs = idArray.map(id => `${section}_${id}_${qtyAttr}`);
        
        getAttrs(attrs, function(values) {
            // Compter les lignes avec quantité > 0
            let occupiedLines = 0;
            
            attrs.forEach(attr => {
                const qty = parseInt(values[attr]) || 0;
                if (qty > 0) {
                    occupiedLines++;
                }
            });
            
            // Mettre à jour le compteur
            const counterValue = `${occupiedLines}/${totalLines}`;
            const isFull = (occupiedLines === totalLines && totalLines > 0);
            
            setAttrs({
                [counterAttr]: counterValue
            });
            
            console.log(`Compteur ${counterAttr} mis à jour : ${counterValue}`);
        });
    });
};

// ===== GROS SAC D'AVENTURE =====
on("change:repeating_sac", function() {
    updateInventoryCounter("repeating_sac", "item_quantite", "gros_sac_counter");
});

on("remove:repeating_sac", function() {
    // Petit délai pour laisser Roll20 finaliser la suppression
    setTimeout(function() {
        updateInventoryCounter("repeating_sac", "item_quantite", "gros_sac_counter");
    }, 100);
});

// ===== PARTIE CAMPEMENT =====
on("change:repeating_campement", function() {
    updateInventoryCounter("repeating_campement", "camp_item_quantite", "campement_counter");
});

on("remove:repeating_campement", function() {
    setTimeout(function() {
        updateInventoryCounter("repeating_campement", "camp_item_quantite", "campement_counter");
    }, 100);
});

// ===== SAC BONUS =====
on("change:repeating_sacbonus", function() {
    updateInventoryCounter("repeating_sacbonus", "bonus_item_quantite", "bonus_sac_counter");
});

on("remove:repeating_sacbonus", function() {
    setTimeout(function() {
        updateInventoryCounter("repeating_sacbonus", "bonus_item_quantite", "bonus_sac_counter");
    }, 100);
});

// ===== INITIALISATION AU CHARGEMENT DE LA FICHE =====
on("sheet:opened", function() {
    // Mettre à jour tous les compteurs au chargement
    updateInventoryCounter("repeating_sac", "item_quantite", "gros_sac_counter");
    updateInventoryCounter("repeating_campement", "camp_item_quantite", "campement_counter");
    updateInventoryCounter("repeating_sacbonus", "bonus_item_quantite", "bonus_sac_counter");
    
    console.log("Compteurs d'inventaire initialisés");
});
</script>

















<script type="text/worker">
/****************************************************
 * ALUCARNE SHOP — WORKER COMPLET CORRIGÉ
 * - calcule LS dépensés et LS restants
 * - met à jour canbuy (lignes rouges) + boughtflag (lignes vertes)
 ****************************************************/

on("sheet:opened", function() {
  console.log("率 Boutique Alucarne : Initialisation");
  getAttrs(["larmes_sang"], function(v) {
    var ls = parseInt(v.larmes_sang || "0", 10);
    console.log("LS total au démarrage :", ls);
    if (!isFinite(ls)) {
      setAttrs({ larmes_sang: 0 }, { silent: true });
    }
    recomputeShop();
  });
});

var TIER_COUNTS = { 1: 15, 2: 14, 3: 21, 4: 17, 5: 23, 6: 30, 7: 24 };

function pad2(n) {
  return String(n).padStart(2, "0");
}

function toInt(val) {
  var n = parseInt(val, 10);
  return isFinite(n) ? n : 0;
}

function isChecked(val) {
  return val === "on" || val === "1" || val === 1 || val === true;
}

function buildAttrList() {
  var attrs = ["larmes_sang", "larmes_sang_spent", "larmes_sang_available"];
  for (var t = 1; t <= 7; t++) {
    for (var i = 1; i <= TIER_COUNTS[t]; i++) {
      var ii = pad2(i);
      attrs.push("shop_t" + t + "_i" + ii + "_cost");
      attrs.push("shop_t" + t + "_i" + ii + "_bought");
      attrs.push("shop_t" + t + "_i" + ii + "_canbuy");
      attrs.push("shop_t" + t + "_i" + ii + "_boughtflag");
    }
  }
  return attrs;
}

var ALL_ATTRS = buildAttrList();

function buildWatchList() {
  var watched = ["change:larmes_sang"];
  for (var t = 1; t <= 7; t++) {
    for (var i = 1; i <= TIER_COUNTS[t]; i++) {
      var ii = pad2(i);
      watched.push("change:shop_t" + t + "_i" + ii + "_bought");
      watched.push("change:shop_t" + t + "_i" + ii + "_cost");
    }
  }
  return watched.join(" ");
}

var WATCH = buildWatchList();

function recomputeShop() {
  console.log(" Recalcul de la boutique...");
  
  getAttrs(ALL_ATTRS, function(v) {
    var total = Math.max(0, toInt(v.larmes_sang));
    console.log(" LS total :", total);
    
    var spent = 0;
    for (var t = 1; t <= 7; t++) {
      for (var i = 1; i <= TIER_COUNTS[t]; i++) {
        var ii = pad2(i);
        var cost = Math.max(0, toInt(v["shop_t" + t + "_i" + ii + "_cost"]));
        var bought = isChecked(v["shop_t" + t + "_i" + ii + "_bought"]);
        if (bought) {
          spent += cost;
        }
      }
    }
    
    var available = Math.max(0, total - spent);
    console.log(" LS dépensés :", spent);
    console.log("✅ LS disponibles :", available);
    
    var out = {
      larmes_sang_spent: spent,
      larmes_sang_available: available
    };
    
    for (var t = 1; t <= 7; t++) {
      for (var i = 1; i <= TIER_COUNTS[t]; i++) {
        var ii = pad2(i);
        var cost = Math.max(0, toInt(v["shop_t" + t + "_i" + ii + "_cost"]));
        var bought = isChecked(v["shop_t" + t + "_i" + ii + "_bought"]);
        
        var canbuy = bought || (available >= cost);
        
        out["shop_t" + t + "_i" + ii + "_canbuy"] = canbuy ? 1 : 0;
        out["shop_t" + t + "_i" + ii + "_boughtflag"] = bought ? 1 : 0;
        
        if (t === 1 && i === 1) {
          console.log("離 Test ligne 1 : cost=" + cost + ", available=" + available + ", canbuy=" + canbuy);
        }
      }
    }
    
    console.log("✨ Mise à jour des attributs...");
    setAttrs(out, { silent: true }, function() {
      console.log("✅ Boutique mise à jour !");
    });
  });
}

on(WATCH, recomputeShop);
on("sheet:opened", recomputeShop);

console.log("率 Boutique Alucarne : Worker chargé");
</script>





<script type="text/worker">
/* ========================================
   SHEET WORKERS - ÉVOLUTION VAMPIRIQUE v2.7
   ✅ Auto-addition des gains PS/LS aux ressources
   ======================================== */

(function () {
  'use strict';

  /* =========================================================
     CONSTANTES - LISTE DES MÉTHODES
     ========================================================= */

  var METHODS_GOULE = [
    { key: 'goule_cons_sang',        label: 'Consommation de Sang' },
    { key: 'goule_absorb_combat',    label: 'Absorption de Sang au Combat' },
    { key: 'goule_inhalation_pest',  label: 'Inhalation de Sang Pestilentiel' },
    { key: 'goule_chasse_nocturne',  label: 'Chasse Nocturne' },
    { key: 'goule_combat_difficile', label: 'Victoire dans un Combat Difficile' },
    { key: 'goule_fete_sanglante',   label: 'Fête Sanglante' },
    { key: 'goule_coeur_battant',    label: 'Dévorer un Cœur Battant' },
    { key: 'goule_crypte_maudite',   label: 'Absorption dans une Crypte Maudite' },
    { key: 'goule_pacte_sombre',     label: 'Récupération via un Pacte Sombre' }
  ];

  var METHODS_VAMPIRE = [
    { key: 'vamp_benediction',       label: 'Bénédiction des Anciens' },
    { key: 'vamp_drain_noble',       label: 'Drain de Force d\'une Créature Noble' },
    { key: 'vamp_union_maudit',      label: 'Union de Sang avec un Allié Maudit' },
    { key: 'vamp_duel_mort',         label: 'Absorption après un Duel à Mort' },
    { key: 'vamp_nouveau_serviteur', label: 'Initiation d\'un Nouveau Serviteur' },
    { key: 'vamp_echange_allies',    label: 'Échange de Sang entre Alliés' },
    { key: 'vamp_festin_maudit',     label: 'Festin Cérémoniel sur un Lieu Maudit' },
    { key: 'vamp_reve_victime',      label: 'Infiltration dans le Rêve d\'une Victime' },
    { key: 'vamp_synergie_clan',     label: 'Synergie Sanguine de Clan' }
  ];

  /* =========================================================
     FONCTIONS UTILITAIRES
     ========================================================= */

  function logObtention(msg, data) {
    try { console.log('[Obtention]', msg, data || ''); } catch (e) {}
  }

  function isChecked(v) {
    return v === '1' || v === 1 || v === 'on' || v === true || v === 'true';
  }

  function sanitizeExpr(s) {
    var x = (s || '').toString().trim();
    if (!x) return '0';
    x = x.replace(/{{|}}/g, '').replace(/\|/g, '').replace(/[\r\n]+/g, ' ');
    x = x.replace(/^\s*\[\[/, '').replace(/\]\]\s*$/, '');
    return x || '0';
  }

  function buildExpr(base, on, flat) {
    var b = sanitizeExpr(base);
    if (!isChecked(on)) return '(' + b + ')';
    var f = sanitizeExpr(flat);
    return '((' + b + ') + (' + f + '))';
  }

  function readRollResult(r, key) {
    try {
      var obj = r && r.results && r.results[key];
      if (obj == null) return 0;
      if (typeof obj === 'number') return obj;
      if (typeof obj === 'string') return Number(obj) || 0;
      if (typeof obj.result !== 'undefined') return Number(obj.result) || 0;
      if (typeof obj.value !== 'undefined') return Number(obj.value) || 0;
      return 0;
    } catch (e) {
      return 0;
    }
  }

  /* =========================================================
     RESET (PS + LS)
     ========================================================= */

  function resetObtentionPS() {
    var attrsToZero = [
      // GOULE - PS
      'goule_cons_sang_ps_result','goule_absorb_combat_ps_result','goule_inhalation_pest_ps_result','goule_chasse_nocturne_ps_result',
      'goule_combat_difficile_ps_result','goule_fete_sanglante_ps_result','goule_coeur_battant_ps_result','goule_crypte_maudite_ps_result','goule_pacte_sombre_ps_result',
      // GOULE - LS
      'goule_cons_sang_ls_result','goule_absorb_combat_ls_result','goule_inhalation_pest_ls_result','goule_chasse_nocturne_ls_result',
      'goule_combat_difficile_ls_result','goule_fete_sanglante_ls_result','goule_coeur_battant_ls_result','goule_crypte_maudite_ls_result','goule_pacte_sombre_ls_result',
      // VAMPIRE - PS
      'vamp_benediction_ps_result','vamp_drain_noble_ps_result','vamp_union_maudit_ps_result','vamp_duel_mort_ps_result','vamp_nouveau_serviteur_ps_result',
      'vamp_echange_allies_ps_result','vamp_festin_maudit_ps_result','vamp_reve_victime_ps_result','vamp_synergie_clan_ps_result',
      // VAMPIRE - LS
      'vamp_benediction_ls_result','vamp_drain_noble_ls_result','vamp_union_maudit_ls_result','vamp_duel_mort_ls_result','vamp_nouveau_serviteur_ls_result',
      'vamp_echange_allies_ls_result','vamp_festin_maudit_ls_result','vamp_reve_victime_ls_result','vamp_synergie_clan_ls_result'
    ];

    var set = {};
    for (var i = 0; i < attrsToZero.length; i++) set[attrsToZero[i]] = 0;
    setAttrs(set);
    logObtention('Résultats PS/LS réinitialisés');
  }

  /* =========================================================
     ✅ GAINS DE POINTS + AUTO-ADDITION AUX RESSOURCES
     ========================================================= */

  function buildObtentionGainDisplay(type) {
    var list = (type === 'goule') ? METHODS_GOULE : METHODS_VAMPIRE;

    var attrs = [];
    for (var i = 0; i < list.length; i++) {
      var k = list[i].key;
      attrs.push(
        k + '_active',
        k + '_ps_jet', k + '_ps_chance', k + '_ps_result',
        k + '_ps_bonus_on', k + '_ps_bonus_flat',
        k + '_ls_jet', k + '_ls_chance', k + '_ls_result',
        k + '_ls_bonus_on', k + '_ls_bonus_flat'
      );
    }

    // ✅ Ajouter les ressources actuelles aux attributs à lire
    attrs.push('sangsure_points', 'larmes_sang');

    getAttrs(attrs, function (v) {
      var selected = [];
      for (var j = 0; j < list.length; j++) {
        var kk = list[j].key;
        if (isChecked(v[kk + '_active'])) selected.push(list[j]);
      }

      if (!selected.length) {
        var exprNone = '&{template:gainpts} {{title=Gains de points}} {{note=Aucune méthode sélectionnée.}}';
        if (typeof startRoll === 'function') {
          startRoll(exprNone, function (r0) { finishRoll(r0.rollId, {}); });
        }
        return;
      }

      var title = (type === 'goule') ? 'Gains de points (Goule)' : 'Gains de points (Vampire)';
      var cmd = '&{template:gainpts} {{title=' + title + '}}';

      var idx = 0;
      var rollKeys = []; // ✅ Stocker les clés des jets lancés

      for (var m = 0; m < selected.length; m++) {
        var method = selected[m];
        var key = method.key;

        var psChance = parseInt(v[key + '_ps_chance'], 10) || 0;
        var psResult = parseInt(v[key + '_ps_result'], 10) || 0;
        var lsChance = parseInt(v[key + '_ls_chance'], 10) || 0;
        var lsResult = parseInt(v[key + '_ls_result'], 10) || 0;

        var psJet = buildExpr(v[key + '_ps_jet'], v[key + '_ps_bonus_on'], v[key + '_ps_bonus_flat']);
        var lsJet = buildExpr(v[key + '_ls_jet'], v[key + '_ls_bonus_on'], v[key + '_ls_bonus_flat']);

        var launchPS = (psResult <= psChance);
        var launchLS = (lsResult <= lsChance);

        if (!launchPS && !launchLS) continue;

        idx++;
        var psKey = 'ps' + idx;
        var lsKey = 'ls' + idx;

        cmd += ' {{m' + idx + '=' + method.label + '}}';

        if (launchPS) {
          cmd += ' {{' + psKey + '=[[' + psJet + ']]}}';
          rollKeys.push({ type: 'ps', key: psKey }); // ✅ Enregistrer la clé
        } else {
          cmd += ' {{' + psKey + '=—}}';
        }

        if (launchLS) {
          cmd += ' {{' + lsKey + '=[[' + lsJet + ']]}}';
          rollKeys.push({ type: 'ls', key: lsKey }); // ✅ Enregistrer la clé
        } else {
          cmd += ' {{' + lsKey + '=—}}';
        }
      }

      if (idx === 0) {
        cmd = '&{template:gainpts} {{title=' + title + '}} {{note=Aucun jet valide (conditions non remplies).}}';
      }

      if (typeof startRoll === 'function') {
        startRoll(cmd, function (r) {
          
          // ✅ CALCUL DES TOTAUX PS ET LS
          var totalPS = 0;
          var totalLS = 0;

          for (var i = 0; i < rollKeys.length; i++) {
            var rollInfo = rollKeys[i];
            var rollValue = readRollResult(r, rollInfo.key);

            if (rollInfo.type === 'ps') {
              totalPS += rollValue;
            } else if (rollInfo.type === 'ls') {
              totalLS += rollValue;
            }
          }

          logObtention('Gains calculés - PS: ' + totalPS + ', LS: ' + totalLS);

          // ✅ LECTURE DES VALEURS ACTUELLES ET ADDITION
          var currentPS = parseInt(v.sangsure_points, 10) || 0;
          var currentLS = parseInt(v.larmes_sang, 10) || 0;

          var newPS = currentPS + totalPS;
          var newLS = currentLS + totalLS;

          logObtention('Nouvelles valeurs - PS: ' + newPS + ' (avant: ' + currentPS + '), LS: ' + newLS + ' (avant: ' + currentLS + ')');

          // ✅ MISE À JOUR DES RESSOURCES
          var updateAttrs = {};
          if (totalPS > 0) updateAttrs.sangsure_points = newPS;
          if (totalLS > 0) updateAttrs.larmes_sang = newLS;

          if (Object.keys(updateAttrs).length > 0) {
            setAttrs(updateAttrs, { silent: false }, function() {
              logObtention('Ressources mises à jour avec succès');
              finishRoll(r.rollId, {});
            });
          } else {
            finishRoll(r.rollId, {});
          }
        });
      }
    });
  }

  /* =========================================================
     OBTENTION (d100) - Jets de chance
     ========================================================= */

  function buildObtentionRoll(type) {
    var attrs = [
      // --- GOULE ---
      'goule_cons_sang_active','goule_cons_sang_ps_chance','goule_cons_sang_ps_jet','goule_cons_sang_ls_chance','goule_cons_sang_ls_jet',
      'goule_absorb_combat_active','goule_absorb_combat_ps_chance','goule_absorb_combat_ps_jet','goule_absorb_combat_ls_chance','goule_absorb_combat_ls_jet',
      'goule_inhalation_pest_active','goule_inhalation_pest_ps_chance','goule_inhalation_pest_ps_jet','goule_inhalation_pest_ls_chance','goule_inhalation_pest_ls_jet',
      'goule_chasse_nocturne_active','goule_chasse_nocturne_ps_chance','goule_chasse_nocturne_ps_jet','goule_chasse_nocturne_ls_chance','goule_chasse_nocturne_ls_jet',
      'goule_combat_difficile_active','goule_combat_difficile_ps_chance','goule_combat_difficile_ps_jet','goule_combat_difficile_ls_chance','goule_combat_difficile_ls_jet',
      'goule_fete_sanglante_active','goule_fete_sanglante_ps_chance','goule_fete_sanglante_ps_jet','goule_fete_sanglante_ls_chance','goule_fete_sanglante_ls_jet',
      'goule_coeur_battant_active','goule_coeur_battant_ps_chance','goule_coeur_battant_ps_jet','goule_coeur_battant_ls_chance','goule_coeur_battant_ls_jet',
      'goule_crypte_maudite_active','goule_crypte_maudite_ps_chance','goule_crypte_maudite_ps_jet','goule_crypte_maudite_ls_chance','goule_crypte_maudite_ls_jet',
      'goule_pacte_sombre_active','goule_pacte_sombre_ps_chance','goule_pacte_sombre_ps_jet','goule_pacte_sombre_ls_chance','goule_pacte_sombre_ls_jet',

      // --- VAMPIRE ---
      'vamp_benediction_active','vamp_benediction_ps_chance','vamp_benediction_ps_jet','vamp_benediction_ls_chance','vamp_benediction_ls_jet',
      'vamp_drain_noble_active','vamp_drain_noble_ps_chance','vamp_drain_noble_ps_jet','vamp_drain_noble_ls_chance','vamp_drain_noble_ls_jet',
      'vamp_union_maudit_active','vamp_union_maudit_ps_chance','vamp_union_maudit_ps_jet','vamp_union_maudit_ls_chance','vamp_union_maudit_ls_jet',
      'vamp_duel_mort_active','vamp_duel_mort_ps_chance','vamp_duel_mort_ps_jet','vamp_duel_mort_ls_chance','vamp_duel_mort_ls_jet',
      'vamp_nouveau_serviteur_active','vamp_nouveau_serviteur_ps_chance','vamp_nouveau_serviteur_ps_jet','vamp_nouveau_serviteur_ls_chance','vamp_nouveau_serviteur_ls_jet',
      'vamp_echange_allies_active','vamp_echange_allies_ps_chance','vamp_echange_allies_ps_jet','vamp_echange_allies_ls_chance','vamp_echange_allies_ls_jet',
      'vamp_festin_maudit_active','vamp_festin_maudit_ps_chance','vamp_festin_maudit_ps_jet','vamp_festin_maudit_ls_chance','vamp_festin_maudit_ls_jet',
      'vamp_reve_victime_active','vamp_reve_victime_ps_chance','vamp_reve_victime_ps_jet','vamp_reve_victime_ls_chance','vamp_reve_victime_ls_jet',
      'vamp_synergie_clan_active','vamp_synergie_clan_ps_chance','vamp_synergie_clan_ps_jet','vamp_synergie_clan_ls_chance','vamp_synergie_clan_ls_jet'
    ];

    getAttrs(attrs, function (values) {
      var parts = [];
      var toStore = [];
      var testsCount = 0;

      function addTest(key, activeAttr, chanceAttr, jetAttr, resultAttr) {
        var active = isChecked(values[activeAttr]);
        var chance = parseInt(values[chanceAttr], 10) || 0;
        if (!active || chance <= 0) return;

        var jet = values[jetAttr] || '';

        parts.push('{{' + key + '=[[1d100]]}}');
        parts.push('{{' + key + '_chance=[[' + chance + ']]}}');
        if (jet) parts.push('{{' + key + '_info=' + jet + '}}');

        toStore.push({ key: key, attr: resultAttr });
        testsCount++;
      }

      if (type === 'goule') {
        parts.push('{{is_goule=1}}');

        addTest('goule_cons_sang_ps', 'goule_cons_sang_active', 'goule_cons_sang_ps_chance', 'goule_cons_sang_ps_jet', 'goule_cons_sang_ps_result');
        addTest('goule_cons_sang_ls', 'goule_cons_sang_active', 'goule_cons_sang_ls_chance', 'goule_cons_sang_ls_jet', 'goule_cons_sang_ls_result');

        addTest('goule_absorb_combat_ps', 'goule_absorb_combat_active', 'goule_absorb_combat_ps_chance', 'goule_absorb_combat_ps_jet', 'goule_absorb_combat_ps_result');
        addTest('goule_absorb_combat_ls', 'goule_absorb_combat_active', 'goule_absorb_combat_ls_chance', 'goule_absorb_combat_ls_jet', 'goule_absorb_combat_ls_result');

        addTest('goule_inhalation_pest_ps', 'goule_inhalation_pest_active', 'goule_inhalation_pest_ps_chance', 'goule_inhalation_pest_ps_jet', 'goule_inhalation_pest_ps_result');
        addTest('goule_inhalation_pest_ls', 'goule_inhalation_pest_active', 'goule_inhalation_pest_ls_chance', 'goule_inhalation_pest_ls_jet', 'goule_inhalation_pest_ls_result');

        addTest('goule_chasse_nocturne_ps', 'goule_chasse_nocturne_active', 'goule_chasse_nocturne_ps_chance', 'goule_chasse_nocturne_ps_jet', 'goule_chasse_nocturne_ps_result');
        addTest('goule_chasse_nocturne_ls', 'goule_chasse_nocturne_active', 'goule_chasse_nocturne_ls_chance', 'goule_chasse_nocturne_ls_jet', 'goule_chasse_nocturne_ls_result');

        addTest('goule_combat_difficile_ps', 'goule_combat_difficile_active', 'goule_combat_difficile_ps_chance', 'goule_combat_difficile_ps_jet', 'goule_combat_difficile_ps_result');
        addTest('goule_combat_difficile_ls', 'goule_combat_difficile_active', 'goule_combat_difficile_ls_chance', 'goule_combat_difficile_ls_jet', 'goule_combat_difficile_ls_result');

        addTest('goule_fete_sanglante_ps', 'goule_fete_sanglante_active', 'goule_fete_sanglante_ps_chance', 'goule_fete_sanglante_ps_jet', 'goule_fete_sanglante_ps_result');
        addTest('goule_fete_sanglante_ls', 'goule_fete_sanglante_active', 'goule_fete_sanglante_ls_chance', 'goule_fete_sanglante_ls_jet', 'goule_fete_sanglante_ls_result');

        addTest('goule_coeur_battant_ps', 'goule_coeur_battant_active', 'goule_coeur_battant_ps_chance', 'goule_coeur_battant_ps_jet', 'goule_coeur_battant_ps_result');
        addTest('goule_coeur_battant_ls', 'goule_coeur_battant_active', 'goule_coeur_battant_ls_chance', 'goule_coeur_battant_ls_jet', 'goule_coeur_battant_ls_result');

        addTest('goule_crypte_maudite_ps', 'goule_crypte_maudite_active', 'goule_crypte_maudite_ps_chance', 'goule_crypte_maudite_ps_jet', 'goule_crypte_maudite_ps_result');
        addTest('goule_crypte_maudite_ls', 'goule_crypte_maudite_active', 'goule_crypte_maudite_ls_chance', 'goule_crypte_maudite_ls_jet', 'goule_crypte_maudite_ls_result');

        addTest('goule_pacte_sombre_ps', 'goule_pacte_sombre_active', 'goule_pacte_sombre_ps_chance', 'goule_pacte_sombre_ps_jet', 'goule_pacte_sombre_ps_result');
        addTest('goule_pacte_sombre_ls', 'goule_pacte_sombre_active', 'goule_pacte_sombre_ls_chance', 'goule_pacte_sombre_ls_jet', 'goule_pacte_sombre_ls_result');
      } else {
        parts.push('{{is_vampire=1}}');

        addTest('vamp_benediction_ps', 'vamp_benediction_active', 'vamp_benediction_ps_chance', 'vamp_benediction_ps_jet', 'vamp_benediction_ps_result');
        addTest('vamp_benediction_ls', 'vamp_benediction_active', 'vamp_benediction_ls_chance', 'vamp_benediction_ls_jet', 'vamp_benediction_ls_result');

        addTest('vamp_drain_noble_ps', 'vamp_drain_noble_active', 'vamp_drain_noble_ps_chance', 'vamp_drain_noble_ps_jet', 'vamp_drain_noble_ps_result');
        addTest('vamp_drain_noble_ls', 'vamp_drain_noble_active', 'vamp_drain_noble_ls_chance', 'vamp_drain_noble_ls_jet', 'vamp_drain_noble_ls_result');

        addTest('vamp_union_maudit_ps', 'vamp_union_maudit_active', 'vamp_union_maudit_ps_chance', 'vamp_union_maudit_ps_jet', 'vamp_union_maudit_ps_result');
        addTest('vamp_union_maudit_ls', 'vamp_union_maudit_active', 'vamp_union_maudit_ls_chance', 'vamp_union_maudit_ls_jet', 'vamp_union_maudit_ls_result');

        addTest('vamp_duel_mort_ps', 'vamp_duel_mort_active', 'vamp_duel_mort_ps_chance', 'vamp_duel_mort_ps_jet', 'vamp_duel_mort_ps_result');
        addTest('vamp_duel_mort_ls', 'vamp_duel_mort_active', 'vamp_duel_mort_ls_chance', 'vamp_duel_mort_ls_jet', 'vamp_duel_mort_ls_result');

        addTest('vamp_nouveau_serviteur_ps', 'vamp_nouveau_serviteur_active', 'vamp_nouveau_serviteur_ps_chance', 'vamp_nouveau_serviteur_ps_jet', 'vamp_nouveau_serviteur_ps_result');
        addTest('vamp_nouveau_serviteur_ls', 'vamp_nouveau_serviteur_active', 'vamp_nouveau_serviteur_ls_chance', 'vamp_nouveau_serviteur_ls_jet', 'vamp_nouveau_serviteur_ls_result');

        addTest('vamp_echange_allies_ps', 'vamp_echange_allies_active', 'vamp_echange_allies_ps_chance', 'vamp_echange_allies_ps_jet', 'vamp_echange_allies_ps_result');
        addTest('vamp_echange_allies_ls', 'vamp_echange_allies_active', 'vamp_echange_allies_ls_chance', 'vamp_echange_allies_ls_jet', 'vamp_echange_allies_ls_result');

        addTest('vamp_festin_maudit_ps', 'vamp_festin_maudit_active', 'vamp_festin_maudit_ps_chance', 'vamp_festin_maudit_ps_jet', 'vamp_festin_maudit_ps_result');
        addTest('vamp_festin_maudit_ls', 'vamp_festin_maudit_active', 'vamp_festin_maudit_ls_chance', 'vamp_festin_maudit_ls_jet', 'vamp_festin_maudit_ls_result');

        addTest('vamp_reve_victime_ps', 'vamp_reve_victime_active', 'vamp_reve_victime_ps_chance', 'vamp_reve_victime_ps_jet', 'vamp_reve_victime_ps_result');
        addTest('vamp_reve_victime_ls', 'vamp_reve_victime_active', 'vamp_reve_victime_ls_chance', 'vamp_reve_victime_ls_jet', 'vamp_reve_victime_ls_result');

        addTest('vamp_synergie_clan_ps', 'vamp_synergie_clan_active', 'vamp_synergie_clan_ps_chance', 'vamp_synergie_clan_ps_jet', 'vamp_synergie_clan_ps_result');
        addTest('vamp_synergie_clan_ls', 'vamp_synergie_clan_active', 'vamp_synergie_clan_ls_chance', 'vamp_synergie_clan_ls_jet', 'vamp_synergie_clan_ls_result');
      }

      if (testsCount === 0) return;

      var title2 = (type === 'goule') ? 'Obtention des Points (Goule)' : 'Obtention des Points (Vampire)';
      var expr = '&{template:vampobt} {{name=' + title2 + '}} ' + parts.join(' ');

      if (typeof startRoll !== 'function' || typeof finishRoll !== 'function') return;

      startRoll(expr, function (res) {
        var set = {};
        for (var i2 = 0; i2 < toStore.length; i2++) {
          var item = toStore[i2];
          var rr = res.results[item.key];
          if (rr && typeof rr.result !== 'undefined') set[item.attr] = rr.result;
        }

        if (Object.keys(set).length) setAttrs(set, { silent: true });
        finishRoll(res.rollId, {});
      });
    });
  }

  /* =========================================================
     LISTENERS BOUTONS
     ========================================================= */

  on('clicked:goule_obtention_roll', function () { buildObtentionRoll('goule'); });
  on('clicked:vampire_obtention_roll', function () { buildObtentionRoll('vampire'); });

  on('clicked:goule_gain_roll', function () { buildObtentionGainDisplay('goule'); });
  on('clicked:vampire_gain_roll', function () { buildObtentionGainDisplay('vampire'); });

  on('clicked:obtention_reset_ps', function () { resetObtentionPS(); });

  /* =========================================================
     PROGRESSION / PALIERS (code existant conservé)
     ========================================================= */

  var PALIERS = {
    1: { min: 0,   max: 20,  nom: 'Goule Dévoreur',       niveau: 'Palier 1' },
    2: { min: 21,  max: 40,  nom: 'Goule de Sang',        niveau: 'Palier 2' },
    3: { min: 41,  max: 65,  nom: 'Goule de Nuit',        niveau: 'Palier 3' },
    4: { min: 66,  max: 90,  nom: 'Jeune Vampire',        niveau: 'Palier 4' },
    5: { min: 91,  max: 130, nom: 'Véritable Vampire',    niveau: 'Palier 5' },
    6: { min: 131, max: 165, nom: 'Grand Vampire',        niveau: 'Palier 6' },
    7: { min: 165, max: 250, nom: 'Seigneur Vampire',     niveau: 'Palier 7' }
  };

  var CHOIX_SEQUENCE = [
    {attr: 'palier1_branche',       tier: 1, label: 'Sous-branche Palier 1'},
    {attr: 'palier1_5pts_choice',   tier: 1, label: '5 Points'},
    {attr: 'palier1_10pts_choice',  tier: 1, label: '10 Points'},
    {attr: 'palier1_15pts_choice',  tier: 1, label: '15 Points'},
    {attr: 'palier1_20pts_choice',  tier: 1, label: '20 Points ÉVOLUTION'},

    {attr: 'palier2_branche',       tier: 2, label: 'Sous-branche Palier 2'},
    {attr: 'palier2_25pts_choice',  tier: 2, label: '25 Points'},
    {attr: 'palier2_30pts_choice',  tier: 2, label: '30 Points'},
    {attr: 'palier2_35pts_choice',  tier: 2, label: '35 Points'},
    {attr: 'palier2_40pts_choice',  tier: 2, label: '40 Points ÉVOLUTION'},

    {attr: 'palier3_branche',       tier: 3, label: 'Sous-branche Palier 3'},
    {attr: 'palier3_45pts_choice',  tier: 3, label: '45 Points'},
    {attr: 'palier3_50pts_choice',  tier: 3, label: '50 Points'},
    {attr: 'palier3_55pts_choice',  tier: 3, label: '55 Points'},
    {attr: 'palier3_65pts_choice',  tier: 3, label: '65 Points ÉVOLUTION'},

    {attr: 'palier4_branche',       tier: 4, label: 'Sous-branche Palier 4'},
    {attr: 'palier4_70pts_choice',  tier: 4, label: '70 Points'},
    {attr: 'palier4_75pts_choice',  tier: 4, label: '75 Points'},
    {attr: 'palier4_80pts_choice',  tier: 4, label: '80 Points'},
    {attr: 'palier4_90pts_choice',  tier: 4, label: '90 Points ÉVOLUTION'},

    {attr: 'palier5_branche',       tier: 5, label: 'Sous-branche Palier 5'},
    {attr: 'palier5_95pts_choice',  tier: 5, label: '95 Points'},
    {attr: 'palier5_105pts_choice', tier: 5, label: '105 Points'},
    {attr: 'palier5_115pts_choice', tier: 5, label: '115 Points'},
    {attr: 'palier5_125pts_choice', tier: 5, label: '125 Points'},
    {attr: 'palier5_130pts_choice', tier: 5, label: '130 Points ÉVOLUTION'},

    {attr: 'palier6_branche',       tier: 6, label: 'Sous-branche Palier 6'},
    {attr: 'palier6_135pts_choice', tier: 6, label: '135 Points'},
    {attr: 'palier6_145pts_choice', tier: 6, label: '145 Points'},
    {attr: 'palier6_155pts_choice', tier: 6, label: '155 Points'},
    {attr: 'palier6_165pts_choice', tier: 6, label: '165 Points ÉVOLUTION'},

    {attr: 'palier7_170pts_choice', tier: 7, label: '170 Points'},
    {attr: 'palier7_185pts_choice', tier: 7, label: '185 Points'},
    {attr: 'palier7_200pts_choice', tier: 7, label: '200 Points'},
    {attr: 'palier7_215pts_choice', tier: 7, label: '215 Points'},
    {attr: 'palier7_235pts_choice', tier: 7, label: '235 Points'},
    {attr: 'palier7_250pts_choice', tier: 7, label: '250 Points APEX'}
  ];

  var TOTAL_STEPS = CHOIX_SEQUENCE.length;

  function getPalier(points) {
    points = parseInt(points, 10) || 0;
    for (var i = 7; i >= 1; i--) {
      if (points >= PALIERS[i].min && points <= PALIERS[i].max) return i;
    }
    if (points > 250) return 7;
    return 1;
  }

  function calculateProgression() {
    var attrList = CHOIX_SEQUENCE.map(function (c) { return c.attr; });

    getAttrs(attrList, function (values) {
      var completedSteps = 0;
      var currentTier = 0;
      var hasWarning = false;
      var lastLabel = 'Aucune progression';
      var highestCompletedTier = 0;

      var tierProgress = {1:0,2:0,3:0,4:0,5:0,6:0,7:0};
      var tierTotal    = {1:0,2:0,3:0,4:0,5:0,6:0,7:0};

      for (var i = 0; i < CHOIX_SEQUENCE.length; i++) {
        tierTotal[CHOIX_SEQUENCE[i].tier]++;
      }

      for (var j = 0; j < CHOIX_SEQUENCE.length; j++) {
        var choix = CHOIX_SEQUENCE[j];
        var val = values[choix.attr] || '';

        if (val !== '' && val !== '0') {
          completedSteps++;
          tierProgress[choix.tier]++;
          currentTier = choix.tier;
          lastLabel = choix.label;
        } else {
          for (var k = j + 1; k < CHOIX_SEQUENCE.length; k++) {
            var futureVal = values[CHOIX_SEQUENCE[k].attr] || '';
            if (futureVal !== '' && futureVal !== '0') { hasWarning = true; break; }
          }
          break;
        }
      }

      for (var t2 = 1; t2 <= 7; t2++) {
        if (tierTotal[t2] > 0 && tierProgress[t2] === tierTotal[t2]) highestCompletedTier = t2;
        else break;
      }

      var percentage = Math.round((completedSteps / TOTAL_STEPS) * 100);

      setAttrs({
        progression_percentage: percentage,
        progression_completed_steps: completedSteps,
        progression_current_tier: currentTier,
        progression_has_warning: hasWarning ? 1 : 0,
        progression_last_label: lastLabel,
        progression_tier_display: highestCompletedTier
      }, { silent: true });
    });
  }

  function updatePalierDisplay() {
    getAttrs(['sangsure_points'], function (values) {
      var points = parseInt(values.sangsure_points, 10) || 0;
      var palier = getPalier(points);
      setAttrs({
        sangsure_palier: palier,
        sangsure_niveau: PALIERS[palier].nom
      });
    });
  }

  function unlockRewards() {
    getAttrs(['sangsure_points'], function (values) {
      var points = parseInt(values.sangsure_points, 10) || 0;
      var update = {};

      update.palier1_5pts_unlocked  = points >= 5  ? 1 : 0;
      update.palier1_10pts_unlocked = points >= 10 ? 1 : 0;
      update.palier1_15pts_unlocked = points >= 15 ? 1 : 0;
      update.palier1_20pts_unlocked = points >= 20 ? 1 : 0;

      update.palier2_25pts_unlocked = points >= 25 ? 1 : 0;
      update.palier2_30pts_unlocked = points >= 30 ? 1 : 0;
      update.palier2_35pts_unlocked = points >= 35 ? 1 : 0;
      update.palier2_40pts_unlocked = points >= 40 ? 1 : 0;

      update.palier3_45pts_unlocked = points >= 45 ? 1 : 0;
      update.palier3_50pts_unlocked = points >= 50 ? 1 : 0;
      update.palier3_55pts_unlocked = points >= 55 ? 1 : 0;
      update.palier3_60pts_unlocked = points >= 60 ? 1 : 0;
      update.palier3_65pts_unlocked = points >= 65 ? 1 : 0;

      update.palier4_70pts_unlocked = points >= 70 ? 1 : 0;
      update.palier4_75pts_unlocked = points >= 75 ? 1 : 0;
      update.palier4_80pts_unlocked = points >= 80 ? 1 : 0;
      update.palier4_85pts_unlocked = points >= 85 ? 1 : 0;
      update.palier4_90pts_unlocked = points >= 90 ? 1 : 0;

      update.palier5_95pts_unlocked  = points >= 95  ? 1 : 0;
      update.palier5_105pts_unlocked = points >= 105 ? 1 : 0;
      update.palier5_115pts_unlocked = points >= 115 ? 1 : 0;
      update.palier5_125pts_unlocked = points >= 125 ? 1 : 0;
      update.palier5_130pts_unlocked = points >= 130 ? 1 : 0;

      update.palier6_135pts_unlocked = points >= 135 ? 1 : 0;
      update.palier6_145pts_unlocked = points >= 145 ? 1 : 0;
      update.palier6_155pts_unlocked = points >= 155 ? 1 : 0;
      update.palier6_165pts_unlocked = points >= 165 ? 1 : 0;

      update.palier7_170pts_unlocked = points >= 170 ? 1 : 0;
      update.palier7_185pts_unlocked = points >= 185 ? 1 : 0;
      update.palier7_200pts_unlocked = points >= 200 ? 1 : 0;
      update.palier7_215pts_unlocked = points >= 215 ? 1 : 0;
      update.palier7_235pts_unlocked = points >= 235 ? 1 : 0;
      update.palier7_250pts_unlocked = points >= 250 ? 1 : 0;

      setAttrs(update);
    });
  }

  function calculateRage() {
    var attrs = [
      'taux_rage_base',
      'sangsure_points',
      'palier1_20pts_choice',
      'palier2_40pts_choice',
      'palier4_90pts_choice'
    ];

    getAttrs(attrs, function (values) {
      var base   = parseInt(values.taux_rage_base, 10) || 50;
      var points = parseInt(values.sangsure_points, 10) || 0;
      var modifier = 0;

      if (points >= 20)  modifier -= 2;
      if (points >= 40)  modifier -= 3;
      if (points >= 65)  modifier -= 3;
      if (points >= 90)  modifier -= 3;
      if (points >= 130) modifier -= 3;
      if (points >= 165) modifier -= 3;

      if (values.palier1_20pts_choice === 'marcheur') modifier -= 2;
      if (values.palier1_20pts_choice === 'rage')     modifier += 7;

      if (values.palier2_40pts_choice === 'bataille')    modifier -= 2;
      if (values.palier2_40pts_choice === 'first_blood') modifier += 2;

      if (values.palier4_90pts_choice === 'reserve')     modifier -= 3;
      if (values.palier4_90pts_choice === 'selfcontrol') modifier += 4;

      setAttrs({ taux_rage_total: base + modifier });
    });
  }

  function initializeSheet() {
    updatePalierDisplay();
    unlockRewards();
    calculateRage();
    calculateProgression();
  }

  on('change:sangsure_points', function () {
    updatePalierDisplay();
    unlockRewards();
    calculateRage();
    calculateProgression();
  });

  var choiceAttrs = CHOIX_SEQUENCE.map(function (c) { return 'change:' + c.attr; }).join(' ');
  on(choiceAttrs, function () {
    calculateRage();
    calculateProgression();
  });

  on('change:taux_rage_base', function () { calculateRage(); });
  on('sheet:opened', function () { initializeSheet(); });

})();




</script>











<script type="text/worker">
/* =====================================================
   SHEET WORKER - SIMPLIFIÉ (sans lock/unlock)
   Affiche TOUS les bonus fixes séparément : + 4 + 3 + 2
   ===================================================== */

// ========== INITIALISATION ==========
on("sheet:opened", function() {
  console.log("⚔️ Système d'Initiative : Chargement...");
  calculateInitiative();
});

// ========== CALCUL AUTOMATIQUE DE L'INITIATIVE ==========
on("change:level change:rea_final change:per_mod change:initiative_advantage change:initiative_disadvantage change:initiative_whisper", calculateInitiative);

// ========== CALCUL QUAND UN BONUS CHANGE (ligne de base) ==========
on("change:base_bonus_type change:base_bonus_value change:base_bonus_active change:base_bonus_name", calculateInitiative);

// ========== CALCUL QUAND UN BONUS CHANGE (repeating) ==========
on("change:repeating_initiativebonus:bonus_type change:repeating_initiativebonus:bonus_value change:repeating_initiativebonus:bonus_active change:repeating_initiativebonus:bonus_name", calculateInitiative);

// ========== FONCTION PRINCIPALE DE CALCUL ==========
function calculateInitiative() {
  var attrs = [
    "level",
    "rea_final",
    "per_mod",
    "initiative_advantage",
    "initiative_disadvantage",
    "initiative_whisper",
    "base_bonus_type",
    "base_bonus_value",
    "base_bonus_active",
    "base_bonus_name"
  ];
  
  getSectionIDs("repeating_initiativebonus", function(idArray) {
    var bonusAttrs = [];
    idArray.forEach(function(id) {
      bonusAttrs.push("repeating_initiativebonus_" + id + "_bonus_name");
      bonusAttrs.push("repeating_initiativebonus_" + id + "_bonus_type");
      bonusAttrs.push("repeating_initiativebonus_" + id + "_bonus_value");
      bonusAttrs.push("repeating_initiativebonus_" + id + "_bonus_active");
    });
    
    var allAttrs = attrs.concat(bonusAttrs);
    
    getAttrs(allAttrs, function(v) {
      // ===== CALCULS DE BASE =====
      var level = parseInt(v.level || "1", 10);
      var reactivite = parseInt(v.rea_final || "0", 10);
      var perMod = parseInt(v.per_mod || "0", 10);
      var hasAdvantage = v.initiative_advantage === "1" || v.initiative_advantage === "on";
      var hasDisadvantage = v.initiative_disadvantage === "1" || v.initiative_disadvantage === "on";
      var isWhisper = v.initiative_whisper === "1" || v.initiative_whisper === "on";
      
      var levelDice = Math.floor(level / 10);
      var reactivityBonus = Math.floor(reactivite / 10);
      
      console.log(" Niveau:", level, "→", levelDice, "d10");
      console.log("⚡ Réactivité:", reactivite, "→ Bonus:", reactivityBonus);
      console.log(" Nombre de lignes repeating:", idArray.length);
      if (isWhisper) {
        console.log(" Jet MJ activé (whisper)");
      }
      
      // ===== COMPTAGE DES BONUS ACTIFS =====
      var bonusD10Count = 0;
      var bonusD20Count = 0;
      
      // LIGNE DE BASE
      var baseActive = v.base_bonus_active === "1" || v.base_bonus_active === "on";
      var baseType = v.base_bonus_type;
      
      if (baseActive) {
        if (baseType === "d10") bonusD10Count++;
        if (baseType === "d20") bonusD20Count++;
      }
      
      // LIGNES REPEATING
      idArray.forEach(function(id) {
        var isActive = v["repeating_initiativebonus_" + id + "_bonus_active"];
        var bonusType = v["repeating_initiativebonus_" + id + "_bonus_type"];
        var bonusName = v["repeating_initiativebonus_" + id + "_bonus_name"];
        
        console.log(" Ligne " + id + ":", bonusName, "Type:", bonusType, "Actif:", isActive);
        
        if (isActive === "1" || isActive === "on") {
          if (bonusType === "d10") bonusD10Count++;
          if (bonusType === "d20") bonusD20Count++;
        }
      });
      
      console.log(" Bonus d10 actifs:", bonusD10Count);
      console.log(" Bonus d20 actifs:", bonusD20Count);
      
      // ===== CALCUL DES TOTAUX =====
      var totalD10 = levelDice + bonusD10Count;
      var totalD20 = 1 + bonusD20Count;
      
      // ===== CONSTRUCTION DE LA FORMULE =====
      var formula = "";
      var d20Display = totalD20 + "d20";
      var d10Display = totalD10 + "d10";
      
      // Avantage/Désavantage sur TOUS les dés
      if (hasAdvantage && !hasDisadvantage) {
        var d20WithAdvantage = totalD20 * 2;
        formula = d20WithAdvantage + "d20kh" + totalD20;
        d20Display = d20WithAdvantage + "d20kh" + totalD20;
        
        if (totalD10 > 0) {
          var d10WithAdvantage = totalD10 * 2;
          formula += " + " + d10WithAdvantage + "d10kh" + totalD10;
          d10Display = d10WithAdvantage + "d10kh" + totalD10;
        }
        
        console.log("✅ AVANTAGE appliqué sur d20 ET d10");
      } else if (hasDisadvantage) {
        var d20WithDisadvantage = totalD20 * 2;
        formula = d20WithDisadvantage + "d20kl" + totalD20;
        d20Display = d20WithDisadvantage + "d20kl" + totalD20;
        
        if (totalD10 > 0) {
          var d10WithDisadvantage = totalD10 * 2;
          formula += " + " + d10WithDisadvantage + "d10kl" + totalD10;
          d10Display = d10WithDisadvantage + "d10kl" + totalD10;
        }
        
        console.log("❌ DÉSAVANTAGE appliqué sur d20 ET d10");
      } else {
        formula = totalD20 + "d20";
        d20Display = totalD20 + "d20";
        
        if (totalD10 > 0) {
          formula += " + " + totalD10 + "d10";
          d10Display = totalD10 + "d10";
        }
      }
      
      // Ajouter le mod de PER
      if (perMod !== 0) {
        formula += (perMod >= 0 ? " + " : " - ") + Math.abs(perMod);
      }
      
      // Ajouter le bonus de réactivité
      if (reactivityBonus !== 0) {
        formula += (reactivityBonus >= 0 ? " + " : " - ") + Math.abs(reactivityBonus);
      }
      
      // ===== COLLECTE DES BONUS FIXES - AFFICHÉS SÉPARÉMENT =====
      var allBonusesArray = [];  // Tableau pour stocker TOUS les bonus
      var bonusParts = [];  // Pour la console
      
      // LIGNE DE BASE - BONUS FIXE
      var baseBonusValue = v.base_bonus_value;
      var baseName = v.base_bonus_name || "Base";
      
      if (baseActive && baseType === "fixed" && baseBonusValue) {
        formula += " + " + baseBonusValue;
        bonusParts.push(baseBonusValue + " (" + baseName + ")");
        
        // Ajouter au tableau d'affichage
        allBonusesArray.push(" + " + baseBonusValue);
      }
      
      // LIGNES REPEATING - BONUS FIXES
      idArray.forEach(function(id) {
        var isActive = v["repeating_initiativebonus_" + id + "_bonus_active"];
        var bonusType = v["repeating_initiativebonus_" + id + "_bonus_type"];
        var bonusValue = v["repeating_initiativebonus_" + id + "_bonus_value"];
        var bonusName = v["repeating_initiativebonus_" + id + "_bonus_name"] || "Sans nom";
        
        if ((isActive === "1" || isActive === "on") && bonusType === "fixed" && bonusValue) {
          formula += " + " + bonusValue;
          bonusParts.push(bonusValue + " (" + bonusName + ")");
          
          // Ajouter au tableau d'affichage
          allBonusesArray.push(" + " + bonusValue);
        }
      });
      
      // Concaténer TOUS les bonus pour l'affichage : " + 4 + 3 + 2"
      var allBonusesDisplay = allBonusesArray.join("");
      
      console.log(" Formule finale:", formula);
      console.log("✨ Affichage bonus fixes:", allBonusesDisplay);
      if (bonusParts.length > 0 || bonusD10Count > 0 || bonusD20Count > 0) {
        console.log("⚡ Bonus actifs:", bonusParts.join(", "));
        if (bonusD10Count > 0) console.log("⚡ d10 bonus:", bonusD10Count);
        if (bonusD20Count > 0) console.log("⚡ d20 bonus:", bonusD20Count);
      }
      
      // ===== AFFICHAGE ESTIMÉ =====
      var estimatedTotal = perMod + reactivityBonus;
      var estimatedDisplay = (estimatedTotal >= 0 ? "+" : "") + estimatedTotal;
      
      if (totalD10 > 0) {
        estimatedDisplay += " + " + totalD10 + "d10 (moy " + (totalD10 * 5.5).toFixed(1) + ")";
      }
      
      // ===== MISE À JOUR =====
      var whisperPrefix = isWhisper ? "/w gm " : "";
      
      setAttrs({
        initiative_level_dice: levelDice,
        initiative_level_dice_display: levelDice + "d10",
        initiative_d20_display: d20Display,
        initiative_d10_display: d10Display,
        all_bonuses_display: allBonusesDisplay,  // ← UN SEUL attribut avec TOUS les bonus séparés
        initiative_reactivity_bonus: reactivityBonus,
        initiative_total_display: estimatedDisplay,
        initiative_roll_formula: whisperPrefix + "&{template:initiative} {{name=@{character_name}}} {{result=[[" + formula + " &{tracker}]]}} {{advantage=" + (hasAdvantage ? "Oui" : "") + "}} {{disadvantage=" + (hasDisadvantage ? "Oui" : "") + "}} {{whisper=" + (isWhisper ? "Oui" : "") + "}}"
      }, { silent: true }, function() {
        console.log("✅ Initiative recalculée !");
        console.log(" Affichage d20:", d20Display);
        console.log(" Affichage d10:", d10Display);
        console.log(" Affichage TOUS les bonus:", allBonusesDisplay);
      });
    });
  });
}

console.log("⚔️ Système d'Initiative : Worker chargé avec succès !");
</script>


<!-- =====================================================
     ROLL TEMPLATE - INITIATIVE
     HTML du template (à placer AVANT <script type="text/worker">)
     Style doré/bronze avec nom du token et badge Jet MJ
     ===================================================== -->

<rolltemplate class="sheet-rolltemplate-initiative">
  <div class="sheet-template-container">
    
    <!-- En-tête doré -->
    <div class="sheet-template-header">
      <div class="sheet-template-title">
        JET D'INITIATIVE
        {{#advantage}}[AVANTAGE]{{/advantage}}
        {{#disadvantage}}[DÉSAVANTAGE]{{/disadvantage}}
        {{#whisper}}<span class="sheet-whisper-badge"> JET MJ</span>{{/whisper}}
      </div>
    </div>
    
    <!-- Contenu -->
    <div class="sheet-template-content">
      
      <!-- Nom du token -->
      {{#name}}
      <div class="sheet-initiative-character-name">{{name}}</div>
      {{/name}}
      
      <!-- Résultat (réduit) -->
      {{#result}}
      <div class="sheet-initiative-result">
        <div class="sheet-initiative-roll">{{result}}</div>
      </div>
      {{/result}}
      
    </div>
    
  </div>
</rolltemplate>


<!-- ===========================
     SYSTEM RÉCUPÉRATION
     =========================== -->
<!-- Template pour les gains de points de vie, magie et énergie -->
<rolltemplate class="sheet-rolltemplate-gain">
  <div class="title">{{title}}</div>
  <div class="row">
    <span class="label">Jet :</span>
    <span class="value">{{result}}</span>
  </div>
</rolltemplate>

<!-- ===========================
     JETS SPÉCIAUX & EFFETS
     =========================== -->
<!-- Template pour jets spéciaux avec effets et fatalité -->
<!-- =========================== JETS SPÉCIAUX & EFFETS =========================== -->
<rolltemplate class="sheet-rolltemplate-despecial">
    <div class="sheet-template-container {{#fatalite}}sheet-fatalite{{/fatalite}}">
        <div class="sheet-header">
            <span class="sheet-title">{{nom}}</span>
        </div>
        
        <div class="sheet-separator"></div>
        
        <div class="sheet-content-wrapper">
            <div class="sheet-result-row">
                <span class="sheet-result-label">Résultat:</span>
                <span class="sheet-result-value">{{resultat}}</span>
            </div>
            
            <div class="sheet-separator"></div>
            
            <div class="sheet-effect-row">
                <div class="sheet-effect-label">Effet :</div>
                <div class="sheet-effect-text">{{effet}}</div>
            </div>
        </div>
    </div>
</rolltemplate>

<!-- ===========================
     TESTS DE CARACTÉRISTIQUES
     =========================== -->
<!-- =========================== TESTS DE CARACTÉRISTIQUES =========================== -->
<rolltemplate class="sheet-rolltemplate-carac-test">
  <div class="sheet-carac-template">
    <h3>Jet de {{carac}}</h3>
    <hr>
    <p><strong>Jet:</strong> {{jet}}</p>
    <p><strong>Seuil de réussite:</strong> {{seuil}}</p>
    
    {{#show_margin}}
      <p class="sheet-margin-display"><strong>Marge de réussite:</strong> {{computed::marge}}</p>
    {{/show_margin}}
    
    <!-- ✨ SUCCÈS DE LA DESTINÉE (jet brut = 100) -->
    {{#rollGreater() computed::jetbrut 99}}
      <p class="sheet-crit-success">&#10024; Succès de la destinée</p>
    {{/rollGreater() computed::jetbrut 99}}
    
    <!-- ⭐ RÉUSSITE CRITIQUE (jet brut = 96-99) -->
    {{#rollGreater() computed::jetbrut 95}}
      {{#rollLess() computed::jetbrut 100}}
        <p class="sheet-crit-success">&#11088; Réussite critique</p>
      {{/rollLess() computed::jetbrut 100}}
    {{/rollGreater() computed::jetbrut 95}}
    
    <!-- ☠️ ÉCHEC DE LA FATALITÉ (jet brut = 1) -->
    {{#rollLess() computed::jetbrut 2}}
      <p class="sheet-crit-fail">&#9760;&#65039; Échec de la fatalité</p>
    {{/rollLess() computed::jetbrut 2}}
    
    <!--  ÉCHEC CRITIQUE (jet brut = 2-5) -->
    {{#rollGreater() computed::jetbrut 1}}
      {{#rollLess() computed::jetbrut 6}}
        <p class="sheet-crit-fail">&#9888;&#65039; Échec critique</p>
      {{/rollLess() computed::jetbrut 6}}
    {{/rollGreater() computed::jetbrut 1}}
    
    <!-- ✅ RÉUSSITE NORMALE -->
    {{#rollLess() computed::jetbrut 96}}
      {{#rollGreater() computed::jetbrut 5}}
        {{#rollGreater() computed::marge -1}}
          <p class="sheet-success">&#9989; Réussite</p>
        {{/rollGreater() computed::marge -1}}
      {{/rollGreater() computed::jetbrut 5}}
    {{/rollLess() computed::jetbrut 96}}
    
    <!-- ❌ ÉCHEC NORMAL -->
    {{#rollLess() computed::jetbrut 96}}
      {{#rollGreater() computed::jetbrut 5}}
        {{#rollLess() computed::marge 0}}
          <p class="sheet-fail">&#10060; Échec</p>
        {{/rollLess() computed::marge 0}}
      {{/rollGreater() computed::jetbrut 5}}
    {{/rollLess() computed::jetbrut 96}}
  </div>
</rolltemplate>

<!-- ===========================
     TESTS DE TRAITS SPECIFIQUE
     =========================== -->
<rolltemplate class="sheet-rolltemplate-trait-test">
  <div class="sheet-trait-template">
    <h3>Jet de {{carac}}</h3>
    <hr>
    <p><strong>Jet :</strong> {{jet}}</p>
    <p><strong>Seuil de réussite:</strong> {{seuil}}</p>
    
    <!-- AFFICHAGE CONDITIONNEL DE LA MARGE -->
    {{#show_margin}}
      <p class="sheet-margin-display"><strong>Marge de réussite :</strong> {{computed::marge}}
</p>
    {{/show_margin}}
    
    <!-- ✨ Réussite critique -->
    {{#rollTotal() jet 1}}
      <p class="sheet-crit-success">✨ Réussite critique</p>
    {{/rollTotal() jet 1}}
    
    <!-- ☠️ Échec critique (jet = max du dé) -->
    {{#^rollTotal() jet 1}}
      {{#rollWasCrit() jet}}
        <p class="sheet-crit-fail">☠️ Échec critique</p>
      {{/rollWasCrit() jet}}
    {{/^rollTotal() jet 1}}
    
    <!-- ✅ Réussite normale : jet ≤ seuil et ≠ critique -->
    {{#rollLess() jet seuil}}
      {{#^rollTotal() jet 1}}
        <p class="sheet-success">✅ Réussite</p>
      {{/^rollTotal() jet 1}}
    {{/rollLess() jet seuil}}
    {{#rollTotal() jet seuil}}
      {{#^rollTotal() jet 1}}
        <p class="sheet-success">✅ Réussite</p>
      {{/^rollTotal() jet 1}}
    {{/rollTotal() jet seuil}}
    
    <!-- ❌ Échec normal : jet > seuil -->
    {{#rollGreater() jet seuil}}
      {{#^rollTotal() jet 1}}
        {{#^rollWasCrit() jet}}
          <p class="sheet-fail">❌ Échec</p>
        {{/^rollWasCrit() jet}}
      {{/^rollTotal() jet 1}}
    {{/rollGreater() jet seuil}}
  </div>
</rolltemplate>



<!-- ===========================
     ACTIVATION DES TALENTS
     =========================== -->
<!-- Template unifié pour tous les types de talents (combat, hors combat, spéciaux) -->
<rolltemplate class="sheet-rolltemplate-talent">
  <div class="sheet-talent-template-container">
    <div class="sheet-talent-header-section">
      <h3 class="sheet-talent-title">{{nom}}</h3>
      <div class="sheet-talent-badges">
        <div class="sheet-talent-category-badge">{{categorie}}</div>
        {{#type}}
        <div class="sheet-talent-type-badge">{{type}}</div>
        {{/type}}
      </div>
    </div>
    <div class="sheet-talent-separator"></div>
    <div class="sheet-talent-effect-section">
      <div class="sheet-talent-effect-label">Effet :</div>
      <div class="sheet-talent-effect-content">{{effet}}</div>
    </div>
  </div>
</rolltemplate>




<!-- ===========================
     TECHNIQUES CORPS À CORPS
     =========================== -->
<!-- Template pour les techniques de combat au corps à corps -->
<rolltemplate class="sheet-rolltemplate-macroTechniquecorps">
  <div class="sheet-mtccorps-wrap">
    <div class="sheet-mtccorps-head">
      <div class="sheet-mtccorps-nom">{{nom}}</div>
      <div class="sheet-mtccorps-type">{{type}}</div>
    </div>
    
    <div class="sheet-mtccorps-body">
      <div class="sheet-mtccorps-dmg">
        <span class="sheet-mtccorps-dmg-lbl">Dégâts :</span>
        <span class="sheet-mtccorps-dmg-val">{{jet}}</span>
      </div>
      
      {{#nature}}
      <div class="sheet-mtccorps-nat">
        <span class="sheet-mtccorps-nat-lbl">Nature :</span>
        <span class="sheet-mtccorps-elem sheet-mtccorps-elem-{{nature}}">{{nature}}</span>
      </div>
      {{/nature}}
      
      {{#effet}}
      <details class="sheet-mtccorps-fx">
        <summary class="sheet-mtccorps-fx-sum">⚔ Effets Spéciaux</summary>
        <div class="sheet-mtccorps-fx-txt">{{effet}}</div>
      </details>
      {{/effet}}
    </div>
  </div>
</rolltemplate>




<!-- ===========================
     SYSTÈME D'ENTRAÎNEMENT
     =========================== -->
<!-- Template pour les jets d'entraînement et progression -->
<rolltemplate class="sheet-rolltemplate-jet_entrainement">
    <div class="sheet-template-container">
        <div class="sheet-template-header">
            <div class="sheet-template-title">⚔️ Jet d'Entrainement</div>
            {{#name}}<div class="sheet-character">{{name}}</div>{{/name}}
        </div>
        <div class="sheet-template-content">
            <div class="sheet-info-section">
                {{#categorie}}<div class="sheet-info-item"><strong>Catégorie:</strong> {{categorie}}</div>{{/categorie}}
                {{#rang}}<div class="sheet-info-item"><strong>Rang:</strong> {{rang}} 
                    {{#malus_rang}}({{malus_rang}} malus){{/malus_rang}}
                </div>{{/rang}}
                {{#bonus}}<div class="sheet-info-item"><strong>Modificateur:</strong> {{bonus}}</div>{{/bonus}}
            </div>
            
            <div class="sheet-jet-result">
                <div class="sheet-jet-name">Résultat du Jet</div>
                <div class="sheet-jet-roll">{{jet}}</div>
            </div>
            
            <div class="sheet-des-conseilles">
                <div class="sheet-des-header">&#127922;Dés Conseillés</div>
                <div class="sheet-des-result">
                    {{#rollGreater() jet 100}}<strong>6 dés + Relance !</strong>{{/rollGreater() jet 100}}
                    {{#rollBetween() jet 95 100}}<strong>6 dés</strong>{{/rollBetween() jet 95 100}}
                    {{#rollBetween() jet 81 94}}<strong>5 dés</strong>{{/rollBetween() jet 81 94}}
                    {{#rollBetween() jet 61 80}}<strong>4 dés</strong>{{/rollBetween() jet 61 80}}
                    {{#rollBetween() jet 41 60}}<strong>3 dés</strong>{{/rollBetween() jet 41 60}}
                    {{#rollBetween() jet 21 40}}<strong>2 dés</strong>{{/rollBetween() jet 21 40}}
                    {{#rollBetween() jet 6 20}}<strong>1 dé</strong>{{/rollBetween() jet 6 20}}
                    {{#rollBetween() jet 1 5}}<strong>Aucun dé</strong>{{/rollBetween() jet 1 5}}
                </div>
            </div>
        </div>
    </div>
</rolltemplate>

<!-- ===========================
     GAINS DE POINTS D'AVENTURE
     =========================== -->
<!-- Template pour les gains de PA (Points d'Aventure) -->
<rolltemplate class="sheet-rolltemplate-gain_pa">
    <div class="sheet-template-container">
        <div class="sheet-template-header">
            <div class="sheet-template-title">✨ Gain de PA</div>
        </div>
        <div class="sheet-template-content">
            <div class="sheet-gain-result">
                <div class="sheet-gain-roll">{{gain_final}}</div>
            </div>
        </div>
    </div>
</rolltemplate>

<!-- ===========================
     CAPACITÉS SPÉCIALES
     =========================== -->
<!-- Template pour l'activation des capacités de métier -->
<rolltemplate class="sheet-rolltemplate-capacite">
  <div class="sheet-roll-capacite">
    <div class="sheet-roll-title">{{name}}</div>
    <hr>
    {{#Type}}
    <div><strong>Type :</strong> {{Type}}</div>
    {{/Type}}
    {{#Nature}}
    <div><strong>Nature :</strong> {{Nature}}</div>
    {{/Nature}}
    {{#Jet}}
    <div class="sheet-roll-jet">{{Jet}}</div>
    {{/Jet}}
    {{#Effet_Actif}}
    <div class="sheet-roll-effet-actif">{{Effet_Actif}}</div>
    {{/Effet_Actif}}
  </div>
</rolltemplate>

<!-- ===========================
     ENTRAÎNEMENT SIMPLE
     =========================== -->
<!-- Template simplifié pour les jets d'entraînement basiques -->
<rolltemplate class="sheet-rolltemplate-entrainement">
  <div class="sheet-roll-entrainement">
    <div class="sheet-roll-title">{{name}}</div>
    <hr>
    <div class="sheet-roll-jet">{{Résultat}}</div>
  </div>
</rolltemplate>



<!-- === ROLL TEMPLATE POUR LES JETS AVEC ALTÉRATIONS ET COULEURS (EN DEHORS) === -->
<rolltemplate class="sheet-rolltemplate-jets">
  <div class="sheet-template-container">
    <div class="sheet-template-header">
      <div class="sheet-template-title">{{name}}</div>
    </div>
    
    <div class="sheet-template-content">
      <!-- JET PRINCIPAL -->
      {{#principal_actif}}
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">{{principal_nom}}</div>
        <div class="sheet-jet-details">
          {{#principal_type}}
          <span class="sheet-jet-type sheet-jet-type-{{principal_type_color}}">{{principal_type}}</span>
          {{/principal_type}}
          {{#principal_nature}}
          <span class="sheet-jet-nature sheet-jet-nature-{{principal_nature_color}}">{{principal_nature}}</span>
          {{/principal_nature}}
        </div>
        <div class="sheet-jet-roll">{{principal_jet}}</div>
      </div>
      {{/principal_actif}}
      
      <!-- JETS SECONDAIRES -->
      {{#jet1_actif}}
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">{{jet1_nom}}</div>
        <div class="sheet-jet-details">
          {{#jet1_type}}
          <span class="sheet-jet-type sheet-jet-type-{{jet1_type_color}}">{{jet1_type}}</span>
          {{/jet1_type}}
          {{#jet1_nature}}
          <span class="sheet-jet-nature sheet-jet-nature-{{jet1_nature_color}}">{{jet1_nature}}</span>
          {{/jet1_nature}}
        </div>
        <div class="sheet-jet-roll">{{jet1_jet}}</div>
      </div>
      {{/jet1_actif}}
      
      {{#jet2_actif}}
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">{{jet2_nom}}</div>
        <div class="sheet-jet-details">
          {{#jet2_type}}
          <span class="sheet-jet-type sheet-jet-type-{{jet2_type_color}}">{{jet2_type}}</span>
          {{/jet2_type}}
          {{#jet2_nature}}
          <span class="sheet-jet-nature sheet-jet-nature-{{jet2_nature_color}}">{{jet2_nature}}</span>
          {{/jet2_nature}}
        </div>
        <div class="sheet-jet-roll">{{jet2_jet}}</div>
      </div>
      {{/jet2_actif}}
      
      {{#jet3_actif}}
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">{{jet3_nom}}</div>
        <div class="sheet-jet-details">
          {{#jet3_type}}
          <span class="sheet-jet-type sheet-jet-type-{{jet3_type_color}}">{{jet3_type}}</span>
          {{/jet3_type}}
          {{#jet3_nature}}
          <span class="sheet-jet-nature sheet-jet-nature-{{jet3_nature_color}}">{{jet3_nature}}</span>
          {{/jet3_nature}}
        </div>
        <div class="sheet-jet-roll">{{jet3_jet}}</div>
      </div>
      {{/jet3_actif}}
      
      {{#jet4_actif}}
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">{{jet4_nom}}</div>
        <div class="sheet-jet-details">
          {{#jet4_type}}
          <span class="sheet-jet-type sheet-jet-type-{{jet4_type_color}}">{{jet4_type}}</span>
          {{/jet4_type}}
          {{#jet4_nature}}
          <span class="sheet-jet-nature sheet-jet-nature-{{jet4_nature_color}}">{{jet4_nature}}</span>
          {{/jet4_nature}}
        </div>
        <div class="sheet-jet-roll">{{jet4_jet}}</div>
      </div>
      {{/jet4_actif}}
      
      {{#jet5_actif}}
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">{{jet5_nom}}</div>
        <div class="sheet-jet-details">
          {{#jet5_type}}
          <span class="sheet-jet-type sheet-jet-type-{{jet5_type_color}}">{{jet5_type}}</span>
          {{/jet5_type}}
          {{#jet5_nature}}
          <span class="sheet-jet-nature sheet-jet-nature-{{jet5_nature_color}}">{{jet5_nature}}</span>
          {{/jet5_nature}}
        </div>
        <div class="sheet-jet-roll">{{jet5_jet}}</div>
      </div>
      {{/jet5_actif}}
      
      <!-- SECTION ALTÉRATIONS ET EFFETS ACTIFS -->
      {{#has_alterations}}
      <div class="sheet-alterations-section">
        <div class="sheet-alterations-header">
          <span class="sheet-alterations-icon">&#128128;</span>
          <span class="sheet-alterations-title">Effets et Altérations</span>
        </div>
        
        <div class="sheet-alterations-list">
          {{#saignement_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#129656;</span>
            <span class="sheet-alteration-name">Saignement</span>
            {{#saignement_valeur}}<span class="sheet-alteration-value">{{saignement_valeur}}</span>{{/saignement_valeur}}
            {{#saignement_des}}<span class="sheet-alteration-dice">{{saignement_des}}</span>{{/saignement_des}}
          </div>
          {{/saignement_actif}}
          
          {{#empoisonnement_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#9762;</span>
            <span class="sheet-alteration-name">Empoisonnement</span>
            {{#empoisonnement_valeur}}<span class="sheet-alteration-value">{{empoisonnement_valeur}}</span>{{/empoisonnement_valeur}}
            {{#empoisonnement_des}}<span class="sheet-alteration-dice">{{empoisonnement_des}}</span>{{/empoisonnement_des}}
          </div>
          {{/empoisonnement_actif}}
          
          {{#destruction_armure_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128293;</span>
            <span class="sheet-alteration-name">Destruction d'armure</span>
            {{#destruction_armure_valeur}}<span class="sheet-alteration-value">{{destruction_armure_valeur}}</span>{{/destruction_armure_valeur}}
          </div>
          {{/destruction_armure_actif}}
          
          {{#brulure_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128293;</span>
            <span class="sheet-alteration-name">Brûlure</span>
            {{#brulure_valeur}}<span class="sheet-alteration-value">{{brulure_valeur}}</span>{{/brulure_valeur}}
          </div>
          {{/brulure_actif}}
          
          {{#fragilisation_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128165;</span>
            <span class="sheet-alteration-name">Fragilisation</span>
            {{#fragilisation_valeur}}<span class="sheet-alteration-value">{{fragilisation_valeur}}</span>{{/fragilisation_valeur}}
          </div>
          {{/fragilisation_actif}}
          
          {{#corrosion_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128165;</span>
            <span class="sheet-alteration-name">Corrosion</span>
            {{#corrosion_valeur}}<span class="sheet-alteration-value">{{corrosion_valeur}}</span>{{/corrosion_valeur}}
            {{#corrosion_des}}<span class="sheet-alteration-dice">{{corrosion_des}}</span>{{/corrosion_des}}
          </div>
          {{/corrosion_actif}}
          
          {{#reduction_armure_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128737;</span>
            <span class="sheet-alteration-name">Réduction d'armure {{reduction_armure_type}}</span>
            {{#reduction_armure_valeur}}<span class="sheet-alteration-value">{{reduction_armure_valeur}}</span>{{/reduction_armure_valeur}}
          </div>
          {{/reduction_armure_actif}}
          
          {{#attaque_sournoise_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128298;</span>
            <span class="sheet-alteration-name">Attaque sournoise</span>
          </div>
          {{/attaque_sournoise_actif}}
          
          {{#fracture_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#128165;</span>
            <span class="sheet-alteration-name">Fracture</span>
            {{#fracture_valeur}}<span class="sheet-alteration-value">{{fracture_valeur}}</span>{{/fracture_valeur}}
            {{#fracture_des}}<span class="sheet-alteration-dice">{{fracture_des}}</span>{{/fracture_des}}
          </div>
          {{/fracture_actif}}
          
          {{#effet_libre_actif}}
          <div class="sheet-alteration-effect">
            <span class="sheet-alteration-icon">&#11088;</span>
            <span class="sheet-alteration-name">{{effet_libre_nom}}</span>
            {{#effet_libre_valeur}}<span class="sheet-alteration-value">{{effet_libre_valeur}}</span>{{/effet_libre_valeur}}
          </div>
          {{/effet_libre_actif}}
        </div>
      </div>
      {{/has_alterations}}
      
      <!-- SECTION EFFET ACTIF -->
      {{#effet_actif}}
      <div class="sheet-effet-actif-section">
        <div class="sheet-effet-actif-header">
          <span class="sheet-effet-actif-icon">⚡</span>
          <span class="sheet-effet-actif-title">Effet Actif</span>
        </div>
        <div class="sheet-effet-actif-content">
          {{effet_actif}}
        </div>
      </div>
      {{/effet_actif}}
      
    </div>
  </div>
</rolltemplate>


<!-- ROLLTEMPLATE COURSE -->
    <rolltemplate class="sheet-rolltemplate-course-action">
      <div class="sheet-course-header">
        <h3>{{nom}}</h3>
      </div>
      <div class="sheet-course-content">
        <div class="sheet-course-result">
          <strong>Mouvement :</strong> {{mouvement}}
        </div>
        <div class="sheet-course-pr">
          <strong>PR restants après action :</strong> {{pr_apres}}
        </div>
      </div>
    </rolltemplate>
    
    

<!-- =========================== SYSTÈME DE REPOS =========================== -->
<rolltemplate class="sheet-rolltemplate-restresult">
    <div class="sheet-rr-wrapper">
        <div class="sheet-rr-head">
            <span class="sheet-rr-name">{{name}}</span>
        </div>
        
        <div class="sheet-rr-body">
            <!-- Jet principal -->
            <div class="sheet-rr-block sheet-rr-jet-block">
                <div class="sheet-rr-jet-lbl">Jet de repos :</div>
                <div class="sheet-rr-jet-val">{{Jet}}</div>
            </div>
            
            <!-- RÉCUPÉRATION -->
            <div class="sheet-rr-line"></div>
            <div class="sheet-rr-block">
                <h4 class="sheet-rr-recov-title">
                    <span class="sheet-rr-icon-recov">&#10084;&#65039;</span>
                    Récupération
                </h4>
                <div class="sheet-rr-recov-txt">
                    Vous récupérez
                   <span class="sheet-rr-percent">{{computed::recov}}%</span>
                    de vos PV/PM/PE
                </div>
            </div>
            
            <!-- Message (si présent) -->
            {{#message}}
            <div class="sheet-rr-line"></div>
            <div class="sheet-rr-block sheet-rr-msg-block">
                <h4 class="sheet-rr-msg-title">
                    <span class="sheet-rr-icon-msg">&#9888;&#65039;</span>
                    Effet Actif
                </h4>
                <div class="sheet-rr-msg-txt">{{message}}</div>
            </div>
            {{/message}}
        </div>
    </div>
</rolltemplate>


<!-- ===========================
     MESSAGES D'ERREUR
     =========================== -->
<!-- Template simple pour afficher les avertissements et erreurs -->
<rolltemplate class="sheet-rolltemplate-simple">
  <div class="sheet-template-container">
    <div class="sheet-template-header">
      <div class="sheet-template-title">{{name}}</div>
    </div>
    <div class="sheet-template-content">
      <div class="sheet-jet-result">
        <div class="sheet-jet-name">Message d'erreur</div>
        <div class="sheet-jet-details">
          <span class="sheet-jet-type sheet-jet-type-warning">Avertissement</span>
        </div>
        <div class="sheet-jet-roll">{{desc}}</div>
      </div>
    </div>
  </div>
</rolltemplate>



<rolltemplate class="sheet-rolltemplate-attack">
  <div class="sheet-template-attack-container">
    
    <!-- EN-TÊTE -->
    <div class="sheet-template-attack-header">
      <div class="sheet-template-attack-title">{{name}}</div>
      {{#character}}
      <div class="sheet-template-attack-character">{{character}}</div>
      {{/character}}
    </div>
    
    <!-- CONTENU PRINCIPAL -->
    <div class="sheet-template-attack-content">
      
      <!-- RÉSULTAT DU JET -->
      {{#attack}}
      <div class="sheet-template-attack-dice">
        {{attack}}
      </div>
      {{/attack}}
      
      <!-- INFORMATIONS COMPLÉMENTAIRES -->
      <div class="sheet-template-attack-info-grid">
        
        <!-- NATURE -->
        {{#nature}}
        <div class="sheet-template-attack-info-item">
          <div class="sheet-template-attack-info-label">Nature</div>
          <div class="sheet-template-attack-info-value sheet-attack-nature-badge">{{nature}}</div>
        </div>
        {{/nature}}
        
        <!-- TYPE -->
        {{#type}}
        <div class="sheet-template-attack-info-item">
          <div class="sheet-template-attack-info-label">Type</div>
          <div class="sheet-template-attack-info-value sheet-attack-type-badge">{{type}}</div>
        </div>
        {{/type}}
        
      </div>
      
    </div>
    
  </div>
</rolltemplate>
























































<!-- =========================
     ROLLTEMPLATE : vampobt (jets d'obtention) - PATCH OK/FAIL
     ========================= -->
<rolltemplate class="sheet-rolltemplate-vampobt">
  <div class="sheet-template-obtention-container">

    <div class="sheet-template-obtention-header">
      <div class="sheet-template-obtention-title">{{name}}</div>
      {{#is_goule}}<div class="sheet-template-obtention-sub">Catégorie : Goule</div>{{/is_goule}}
      {{#is_vampire}}<div class="sheet-template-obtention-sub">Catégorie : Vampire</div>{{/is_vampire}}
    </div>

    <div class="sheet-template-obtention-content">

      <!-- =========================
           GOULE
           ========================= -->

      {{#goule_cons_sang_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Consommation de Sang — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_cons_sang_ps goule_cons_sang_ps_chance}}sheet-rt-ok{{/rollLess()  goule_cons_sang_ps goule_cons_sang_ps_chance}}
          {{#rollTotal() goule_cons_sang_ps goule_cons_sang_ps_chance}}sheet-rt-ok{{/rollTotal() goule_cons_sang_ps goule_cons_sang_ps_chance}}
          {{#rollGreater() goule_cons_sang_ps goule_cons_sang_ps_chance}}sheet-rt-bad{{/rollGreater() goule_cons_sang_ps goule_cons_sang_ps_chance}}
        ">{{goule_cons_sang_ps}} / {{goule_cons_sang_ps_chance}}%</div>
      </div>
      {{/goule_cons_sang_ps}}

      {{#goule_cons_sang_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Consommation de Sang — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_cons_sang_ls goule_cons_sang_ls_chance}}sheet-rt-ok{{/rollLess()  goule_cons_sang_ls goule_cons_sang_ls_chance}}
          {{#rollTotal() goule_cons_sang_ls goule_cons_sang_ls_chance}}sheet-rt-ok{{/rollTotal() goule_cons_sang_ls goule_cons_sang_ls_chance}}
          {{#rollGreater() goule_cons_sang_ls goule_cons_sang_ls_chance}}sheet-rt-bad{{/rollGreater() goule_cons_sang_ls goule_cons_sang_ls_chance}}
        ">{{goule_cons_sang_ls}} / {{goule_cons_sang_ls_chance}}%</div>
      </div>
      {{/goule_cons_sang_ls}}

      {{#goule_absorb_combat_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Absorption au Combat — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_absorb_combat_ps goule_absorb_combat_ps_chance}}sheet-rt-ok{{/rollLess()  goule_absorb_combat_ps goule_absorb_combat_ps_chance}}
          {{#rollTotal() goule_absorb_combat_ps goule_absorb_combat_ps_chance}}sheet-rt-ok{{/rollTotal() goule_absorb_combat_ps goule_absorb_combat_ps_chance}}
          {{#rollGreater() goule_absorb_combat_ps goule_absorb_combat_ps_chance}}sheet-rt-bad{{/rollGreater() goule_absorb_combat_ps goule_absorb_combat_ps_chance}}
        ">{{goule_absorb_combat_ps}} / {{goule_absorb_combat_ps_chance}}%</div>
      </div>
      {{/goule_absorb_combat_ps}}

      {{#goule_absorb_combat_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Absorption au Combat — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_absorb_combat_ls goule_absorb_combat_ls_chance}}sheet-rt-ok{{/rollLess()  goule_absorb_combat_ls goule_absorb_combat_ls_chance}}
          {{#rollTotal() goule_absorb_combat_ls goule_absorb_combat_ls_chance}}sheet-rt-ok{{/rollTotal() goule_absorb_combat_ls goule_absorb_combat_ls_chance}}
          {{#rollGreater() goule_absorb_combat_ls goule_absorb_combat_ls_chance}}sheet-rt-bad{{/rollGreater() goule_absorb_combat_ls goule_absorb_combat_ls_chance}}
        ">{{goule_absorb_combat_ls}} / {{goule_absorb_combat_ls_chance}}%</div>
      </div>
      {{/goule_absorb_combat_ls}}

      {{#goule_inhalation_pest_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Sang Pestilentiel — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_inhalation_pest_ps goule_inhalation_pest_ps_chance}}sheet-rt-ok{{/rollLess()  goule_inhalation_pest_ps goule_inhalation_pest_ps_chance}}
          {{#rollTotal() goule_inhalation_pest_ps goule_inhalation_pest_ps_chance}}sheet-rt-ok{{/rollTotal() goule_inhalation_pest_ps goule_inhalation_pest_ps_chance}}
          {{#rollGreater() goule_inhalation_pest_ps goule_inhalation_pest_ps_chance}}sheet-rt-bad{{/rollGreater() goule_inhalation_pest_ps goule_inhalation_pest_ps_chance}}
        ">{{goule_inhalation_pest_ps}} / {{goule_inhalation_pest_ps_chance}}%</div>
      </div>
      {{/goule_inhalation_pest_ps}}

      {{#goule_inhalation_pest_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Sang Pestilentiel — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_inhalation_pest_ls goule_inhalation_pest_ls_chance}}sheet-rt-ok{{/rollLess()  goule_inhalation_pest_ls goule_inhalation_pest_ls_chance}}
          {{#rollTotal() goule_inhalation_pest_ls goule_inhalation_pest_ls_chance}}sheet-rt-ok{{/rollTotal() goule_inhalation_pest_ls goule_inhalation_pest_ls_chance}}
          {{#rollGreater() goule_inhalation_pest_ls goule_inhalation_pest_ls_chance}}sheet-rt-bad{{/rollGreater() goule_inhalation_pest_ls goule_inhalation_pest_ls_chance}}
        ">{{goule_inhalation_pest_ls}} / {{goule_inhalation_pest_ls_chance}}%</div>
      </div>
      {{/goule_inhalation_pest_ls}}

      {{#goule_chasse_nocturne_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Chasse Nocturne — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_chasse_nocturne_ps goule_chasse_nocturne_ps_chance}}sheet-rt-ok{{/rollLess()  goule_chasse_nocturne_ps goule_chasse_nocturne_ps_chance}}
          {{#rollTotal() goule_chasse_nocturne_ps goule_chasse_nocturne_ps_chance}}sheet-rt-ok{{/rollTotal() goule_chasse_nocturne_ps goule_chasse_nocturne_ps_chance}}
          {{#rollGreater() goule_chasse_nocturne_ps goule_chasse_nocturne_ps_chance}}sheet-rt-bad{{/rollGreater() goule_chasse_nocturne_ps goule_chasse_nocturne_ps_chance}}
        ">{{goule_chasse_nocturne_ps}} / {{goule_chasse_nocturne_ps_chance}}%</div>
      </div>
      {{/goule_chasse_nocturne_ps}}

      {{#goule_chasse_nocturne_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Chasse Nocturne — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_chasse_nocturne_ls goule_chasse_nocturne_ls_chance}}sheet-rt-ok{{/rollLess()  goule_chasse_nocturne_ls goule_chasse_nocturne_ls_chance}}
          {{#rollTotal() goule_chasse_nocturne_ls goule_chasse_nocturne_ls_chance}}sheet-rt-ok{{/rollTotal() goule_chasse_nocturne_ls goule_chasse_nocturne_ls_chance}}
          {{#rollGreater() goule_chasse_nocturne_ls goule_chasse_nocturne_ls_chance}}sheet-rt-bad{{/rollGreater() goule_chasse_nocturne_ls goule_chasse_nocturne_ls_chance}}
        ">{{goule_chasse_nocturne_ls}} / {{goule_chasse_nocturne_ls_chance}}%</div>
      </div>
      {{/goule_chasse_nocturne_ls}}

      {{#goule_combat_difficile_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Combat Difficile — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_combat_difficile_ps goule_combat_difficile_ps_chance}}sheet-rt-ok{{/rollLess()  goule_combat_difficile_ps goule_combat_difficile_ps_chance}}
          {{#rollTotal() goule_combat_difficile_ps goule_combat_difficile_ps_chance}}sheet-rt-ok{{/rollTotal() goule_combat_difficile_ps goule_combat_difficile_ps_chance}}
          {{#rollGreater() goule_combat_difficile_ps goule_combat_difficile_ps_chance}}sheet-rt-bad{{/rollGreater() goule_combat_difficile_ps goule_combat_difficile_ps_chance}}
        ">{{goule_combat_difficile_ps}} / {{goule_combat_difficile_ps_chance}}%</div>
      </div>
      {{/goule_combat_difficile_ps}}

      {{#goule_combat_difficile_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Combat Difficile — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_combat_difficile_ls goule_combat_difficile_ls_chance}}sheet-rt-ok{{/rollLess()  goule_combat_difficile_ls goule_combat_difficile_ls_chance}}
          {{#rollTotal() goule_combat_difficile_ls goule_combat_difficile_ls_chance}}sheet-rt-ok{{/rollTotal() goule_combat_difficile_ls goule_combat_difficile_ls_chance}}
          {{#rollGreater() goule_combat_difficile_ls goule_combat_difficile_ls_chance}}sheet-rt-bad{{/rollGreater() goule_combat_difficile_ls goule_combat_difficile_ls_chance}}
        ">{{goule_combat_difficile_ls}} / {{goule_combat_difficile_ls_chance}}%</div>
      </div>
      {{/goule_combat_difficile_ls}}

      {{#goule_fete_sanglante_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Fête Sanglante — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_fete_sanglante_ps goule_fete_sanglante_ps_chance}}sheet-rt-ok{{/rollLess()  goule_fete_sanglante_ps goule_fete_sanglante_ps_chance}}
          {{#rollTotal() goule_fete_sanglante_ps goule_fete_sanglante_ps_chance}}sheet-rt-ok{{/rollTotal() goule_fete_sanglante_ps goule_fete_sanglante_ps_chance}}
          {{#rollGreater() goule_fete_sanglante_ps goule_fete_sanglante_ps_chance}}sheet-rt-bad{{/rollGreater() goule_fete_sanglante_ps goule_fete_sanglante_ps_chance}}
        ">{{goule_fete_sanglante_ps}} / {{goule_fete_sanglante_ps_chance}}%</div>
      </div>
      {{/goule_fete_sanglante_ps}}

      {{#goule_fete_sanglante_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Fête Sanglante — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_fete_sanglante_ls goule_fete_sanglante_ls_chance}}sheet-rt-ok{{/rollLess()  goule_fete_sanglante_ls goule_fete_sanglante_ls_chance}}
          {{#rollTotal() goule_fete_sanglante_ls goule_fete_sanglante_ls_chance}}sheet-rt-ok{{/rollTotal() goule_fete_sanglante_ls goule_fete_sanglante_ls_chance}}
          {{#rollGreater() goule_fete_sanglante_ls goule_fete_sanglante_ls_chance}}sheet-rt-bad{{/rollGreater() goule_fete_sanglante_ls goule_fete_sanglante_ls_chance}}
        ">{{goule_fete_sanglante_ls}} / {{goule_fete_sanglante_ls_chance}}%</div>
      </div>
      {{/goule_fete_sanglante_ls}}

      {{#goule_coeur_battant_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Cœur Battant — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_coeur_battant_ps goule_coeur_battant_ps_chance}}sheet-rt-ok{{/rollLess()  goule_coeur_battant_ps goule_coeur_battant_ps_chance}}
          {{#rollTotal() goule_coeur_battant_ps goule_coeur_battant_ps_chance}}sheet-rt-ok{{/rollTotal() goule_coeur_battant_ps goule_coeur_battant_ps_chance}}
          {{#rollGreater() goule_coeur_battant_ps goule_coeur_battant_ps_chance}}sheet-rt-bad{{/rollGreater() goule_coeur_battant_ps goule_coeur_battant_ps_chance}}
        ">{{goule_coeur_battant_ps}} / {{goule_coeur_battant_ps_chance}}%</div>
      </div>
      {{/goule_coeur_battant_ps}}

      {{#goule_coeur_battant_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Cœur Battant — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_coeur_battant_ls goule_coeur_battant_ls_chance}}sheet-rt-ok{{/rollLess()  goule_coeur_battant_ls goule_coeur_battant_ls_chance}}
          {{#rollTotal() goule_coeur_battant_ls goule_coeur_battant_ls_chance}}sheet-rt-ok{{/rollTotal() goule_coeur_battant_ls goule_coeur_battant_ls_chance}}
          {{#rollGreater() goule_coeur_battant_ls goule_coeur_battant_ls_chance}}sheet-rt-bad{{/rollGreater() goule_coeur_battant_ls goule_coeur_battant_ls_chance}}
        ">{{goule_coeur_battant_ls}} / {{goule_coeur_battant_ls_chance}}%</div>
      </div>
      {{/goule_coeur_battant_ls}}

      {{#goule_crypte_maudite_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Crypte Maudite — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_crypte_maudite_ps goule_crypte_maudite_ps_chance}}sheet-rt-ok{{/rollLess()  goule_crypte_maudite_ps goule_crypte_maudite_ps_chance}}
          {{#rollTotal() goule_crypte_maudite_ps goule_crypte_maudite_ps_chance}}sheet-rt-ok{{/rollTotal() goule_crypte_maudite_ps goule_crypte_maudite_ps_chance}}
          {{#rollGreater() goule_crypte_maudite_ps goule_crypte_maudite_ps_chance}}sheet-rt-bad{{/rollGreater() goule_crypte_maudite_ps goule_crypte_maudite_ps_chance}}
        ">{{goule_crypte_maudite_ps}} / {{goule_crypte_maudite_ps_chance}}%</div>
      </div>
      {{/goule_crypte_maudite_ps}}

      {{#goule_crypte_maudite_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Crypte Maudite — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_crypte_maudite_ls goule_crypte_maudite_ls_chance}}sheet-rt-ok{{/rollLess()  goule_crypte_maudite_ls goule_crypte_maudite_ls_chance}}
          {{#rollTotal() goule_crypte_maudite_ls goule_crypte_maudite_ls_chance}}sheet-rt-ok{{/rollTotal() goule_crypte_maudite_ls goule_crypte_maudite_ls_chance}}
          {{#rollGreater() goule_crypte_maudite_ls goule_crypte_maudite_ls_chance}}sheet-rt-bad{{/rollGreater() goule_crypte_maudite_ls goule_crypte_maudite_ls_chance}}
        ">{{goule_crypte_maudite_ls}} / {{goule_crypte_maudite_ls_chance}}%</div>
      </div>
      {{/goule_crypte_maudite_ls}}

      {{#goule_pacte_sombre_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Pacte Sombre — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_pacte_sombre_ps goule_pacte_sombre_ps_chance}}sheet-rt-ok{{/rollLess()  goule_pacte_sombre_ps goule_pacte_sombre_ps_chance}}
          {{#rollTotal() goule_pacte_sombre_ps goule_pacte_sombre_ps_chance}}sheet-rt-ok{{/rollTotal() goule_pacte_sombre_ps goule_pacte_sombre_ps_chance}}
          {{#rollGreater() goule_pacte_sombre_ps goule_pacte_sombre_ps_chance}}sheet-rt-bad{{/rollGreater() goule_pacte_sombre_ps goule_pacte_sombre_ps_chance}}
        ">{{goule_pacte_sombre_ps}} / {{goule_pacte_sombre_ps_chance}}%</div>
      </div>
      {{/goule_pacte_sombre_ps}}

      {{#goule_pacte_sombre_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Pacte Sombre — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  goule_pacte_sombre_ls goule_pacte_sombre_ls_chance}}sheet-rt-ok{{/rollLess()  goule_pacte_sombre_ls goule_pacte_sombre_ls_chance}}
          {{#rollTotal() goule_pacte_sombre_ls goule_pacte_sombre_ls_chance}}sheet-rt-ok{{/rollTotal() goule_pacte_sombre_ls goule_pacte_sombre_ls_chance}}
          {{#rollGreater() goule_pacte_sombre_ls goule_pacte_sombre_ls_chance}}sheet-rt-bad{{/rollGreater() goule_pacte_sombre_ls goule_pacte_sombre_ls_chance}}
        ">{{goule_pacte_sombre_ls}} / {{goule_pacte_sombre_ls_chance}}%</div>
      </div>
      {{/goule_pacte_sombre_ls}}

      <!-- =========================
           VAMPIRE
           ========================= -->

      {{#vamp_benediction_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Bénédiction des Anciens — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_benediction_ps vamp_benediction_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_benediction_ps vamp_benediction_ps_chance}}
          {{#rollTotal() vamp_benediction_ps vamp_benediction_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_benediction_ps vamp_benediction_ps_chance}}
          {{#rollGreater() vamp_benediction_ps vamp_benediction_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_benediction_ps vamp_benediction_ps_chance}}
        ">{{vamp_benediction_ps}} / {{vamp_benediction_ps_chance}}%</div>
      </div>
      {{/vamp_benediction_ps}}

      {{#vamp_benediction_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Bénédiction des Anciens — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_benediction_ls vamp_benediction_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_benediction_ls vamp_benediction_ls_chance}}
          {{#rollTotal() vamp_benediction_ls vamp_benediction_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_benediction_ls vamp_benediction_ls_chance}}
          {{#rollGreater() vamp_benediction_ls vamp_benediction_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_benediction_ls vamp_benediction_ls_chance}}
        ">{{vamp_benediction_ls}} / {{vamp_benediction_ls_chance}}%</div>
      </div>
      {{/vamp_benediction_ls}}

      {{#vamp_drain_noble_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Drain Noble — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_drain_noble_ps vamp_drain_noble_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_drain_noble_ps vamp_drain_noble_ps_chance}}
          {{#rollTotal() vamp_drain_noble_ps vamp_drain_noble_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_drain_noble_ps vamp_drain_noble_ps_chance}}
          {{#rollGreater() vamp_drain_noble_ps vamp_drain_noble_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_drain_noble_ps vamp_drain_noble_ps_chance}}
        ">{{vamp_drain_noble_ps}} / {{vamp_drain_noble_ps_chance}}%</div>
      </div>
      {{/vamp_drain_noble_ps}}

      {{#vamp_drain_noble_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Drain Noble — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_drain_noble_ls vamp_drain_noble_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_drain_noble_ls vamp_drain_noble_ls_chance}}
          {{#rollTotal() vamp_drain_noble_ls vamp_drain_noble_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_drain_noble_ls vamp_drain_noble_ls_chance}}
          {{#rollGreater() vamp_drain_noble_ls vamp_drain_noble_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_drain_noble_ls vamp_drain_noble_ls_chance}}
        ">{{vamp_drain_noble_ls}} / {{vamp_drain_noble_ls_chance}}%</div>
      </div>
      {{/vamp_drain_noble_ls}}

      {{#vamp_union_maudit_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Union Maudite — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_union_maudit_ps vamp_union_maudit_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_union_maudit_ps vamp_union_maudit_ps_chance}}
          {{#rollTotal() vamp_union_maudit_ps vamp_union_maudit_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_union_maudit_ps vamp_union_maudit_ps_chance}}
          {{#rollGreater() vamp_union_maudit_ps vamp_union_maudit_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_union_maudit_ps vamp_union_maudit_ps_chance}}
        ">{{vamp_union_maudit_ps}} / {{vamp_union_maudit_ps_chance}}%</div>
      </div>
      {{/vamp_union_maudit_ps}}

      {{#vamp_union_maudit_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Union Maudite — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_union_maudit_ls vamp_union_maudit_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_union_maudit_ls vamp_union_maudit_ls_chance}}
          {{#rollTotal() vamp_union_maudit_ls vamp_union_maudit_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_union_maudit_ls vamp_union_maudit_ls_chance}}
          {{#rollGreater() vamp_union_maudit_ls vamp_union_maudit_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_union_maudit_ls vamp_union_maudit_ls_chance}}
        ">{{vamp_union_maudit_ls}} / {{vamp_union_maudit_ls_chance}}%</div>
      </div>
      {{/vamp_union_maudit_ls}}

      {{#vamp_duel_mort_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Duel à Mort — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_duel_mort_ps vamp_duel_mort_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_duel_mort_ps vamp_duel_mort_ps_chance}}
          {{#rollTotal() vamp_duel_mort_ps vamp_duel_mort_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_duel_mort_ps vamp_duel_mort_ps_chance}}
          {{#rollGreater() vamp_duel_mort_ps vamp_duel_mort_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_duel_mort_ps vamp_duel_mort_ps_chance}}
        ">{{vamp_duel_mort_ps}} / {{vamp_duel_mort_ps_chance}}%</div>
      </div>
      {{/vamp_duel_mort_ps}}

      {{#vamp_duel_mort_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Duel à Mort — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_duel_mort_ls vamp_duel_mort_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_duel_mort_ls vamp_duel_mort_ls_chance}}
          {{#rollTotal() vamp_duel_mort_ls vamp_duel_mort_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_duel_mort_ls vamp_duel_mort_ls_chance}}
          {{#rollGreater() vamp_duel_mort_ls vamp_duel_mort_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_duel_mort_ls vamp_duel_mort_ls_chance}}
        ">{{vamp_duel_mort_ls}} / {{vamp_duel_mort_ls_chance}}%</div>
      </div>
      {{/vamp_duel_mort_ls}}

      {{#vamp_nouveau_serviteur_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Nouveau Serviteur — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_nouveau_serviteur_ps vamp_nouveau_serviteur_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_nouveau_serviteur_ps vamp_nouveau_serviteur_ps_chance}}
          {{#rollTotal() vamp_nouveau_serviteur_ps vamp_nouveau_serviteur_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_nouveau_serviteur_ps vamp_nouveau_serviteur_ps_chance}}
          {{#rollGreater() vamp_nouveau_serviteur_ps vamp_nouveau_serviteur_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_nouveau_serviteur_ps vamp_nouveau_serviteur_ps_chance}}
        ">{{vamp_nouveau_serviteur_ps}} / {{vamp_nouveau_serviteur_ps_chance}}%</div>
      </div>
      {{/vamp_nouveau_serviteur_ps}}

      {{#vamp_nouveau_serviteur_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Nouveau Serviteur — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_nouveau_serviteur_ls vamp_nouveau_serviteur_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_nouveau_serviteur_ls vamp_nouveau_serviteur_ls_chance}}
          {{#rollTotal() vamp_nouveau_serviteur_ls vamp_nouveau_serviteur_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_nouveau_serviteur_ls vamp_nouveau_serviteur_ls_chance}}
          {{#rollGreater() vamp_nouveau_serviteur_ls vamp_nouveau_serviteur_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_nouveau_serviteur_ls vamp_nouveau_serviteur_ls_chance}}
        ">{{vamp_nouveau_serviteur_ls}} / {{vamp_nouveau_serviteur_ls_chance}}%</div>
      </div>
      {{/vamp_nouveau_serviteur_ls}}

      {{#vamp_echange_allies_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Échange entre Alliés — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_echange_allies_ps vamp_echange_allies_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_echange_allies_ps vamp_echange_allies_ps_chance}}
          {{#rollTotal() vamp_echange_allies_ps vamp_echange_allies_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_echange_allies_ps vamp_echange_allies_ps_chance}}
          {{#rollGreater() vamp_echange_allies_ps vamp_echange_allies_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_echange_allies_ps vamp_echange_allies_ps_chance}}
        ">{{vamp_echange_allies_ps}} / {{vamp_echange_allies_ps_chance}}%</div>
      </div>
      {{/vamp_echange_allies_ps}}

      {{#vamp_echange_allies_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Échange entre Alliés — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_echange_allies_ls vamp_echange_allies_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_echange_allies_ls vamp_echange_allies_ls_chance}}
          {{#rollTotal() vamp_echange_allies_ls vamp_echange_allies_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_echange_allies_ls vamp_echange_allies_ls_chance}}
          {{#rollGreater() vamp_echange_allies_ls vamp_echange_allies_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_echange_allies_ls vamp_echange_allies_ls_chance}}
        ">{{vamp_echange_allies_ls}} / {{vamp_echange_allies_ls_chance}}%</div>
      </div>
      {{/vamp_echange_allies_ls}}

      {{#vamp_festin_maudit_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Festin sur Lieu Maudit — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_festin_maudit_ps vamp_festin_maudit_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_festin_maudit_ps vamp_festin_maudit_ps_chance}}
          {{#rollTotal() vamp_festin_maudit_ps vamp_festin_maudit_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_festin_maudit_ps vamp_festin_maudit_ps_chance}}
          {{#rollGreater() vamp_festin_maudit_ps vamp_festin_maudit_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_festin_maudit_ps vamp_festin_maudit_ps_chance}}
        ">{{vamp_festin_maudit_ps}} / {{vamp_festin_maudit_ps_chance}}%</div>
      </div>
      {{/vamp_festin_maudit_ps}}

      {{#vamp_festin_maudit_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Festin sur Lieu Maudit — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_festin_maudit_ls vamp_festin_maudit_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_festin_maudit_ls vamp_festin_maudit_ls_chance}}
          {{#rollTotal() vamp_festin_maudit_ls vamp_festin_maudit_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_festin_maudit_ls vamp_festin_maudit_ls_chance}}
          {{#rollGreater() vamp_festin_maudit_ls vamp_festin_maudit_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_festin_maudit_ls vamp_festin_maudit_ls_chance}}
        ">{{vamp_festin_maudit_ls}} / {{vamp_festin_maudit_ls_chance}}%</div>
      </div>
      {{/vamp_festin_maudit_ls}}

      {{#vamp_reve_victime_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Rêve d'une Victime — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_reve_victime_ps vamp_reve_victime_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_reve_victime_ps vamp_reve_victime_ps_chance}}
          {{#rollTotal() vamp_reve_victime_ps vamp_reve_victime_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_reve_victime_ps vamp_reve_victime_ps_chance}}
          {{#rollGreater() vamp_reve_victime_ps vamp_reve_victime_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_reve_victime_ps vamp_reve_victime_ps_chance}}
        ">{{vamp_reve_victime_ps}} / {{vamp_reve_victime_ps_chance}}%</div>
      </div>
      {{/vamp_reve_victime_ps}}

      {{#vamp_reve_victime_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Rêve d'une Victime — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_reve_victime_ls vamp_reve_victime_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_reve_victime_ls vamp_reve_victime_ls_chance}}
          {{#rollTotal() vamp_reve_victime_ls vamp_reve_victime_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_reve_victime_ls vamp_reve_victime_ls_chance}}
          {{#rollGreater() vamp_reve_victime_ls vamp_reve_victime_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_reve_victime_ls vamp_reve_victime_ls_chance}}
        ">{{vamp_reve_victime_ls}} / {{vamp_reve_victime_ls_chance}}%</div>
      </div>
      {{/vamp_reve_victime_ls}}

      {{#vamp_synergie_clan_ps}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Synergie de Clan — PS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_synergie_clan_ps vamp_synergie_clan_ps_chance}}sheet-rt-ok{{/rollLess()  vamp_synergie_clan_ps vamp_synergie_clan_ps_chance}}
          {{#rollTotal() vamp_synergie_clan_ps vamp_synergie_clan_ps_chance}}sheet-rt-ok{{/rollTotal() vamp_synergie_clan_ps vamp_synergie_clan_ps_chance}}
          {{#rollGreater() vamp_synergie_clan_ps vamp_synergie_clan_ps_chance}}sheet-rt-bad{{/rollGreater() vamp_synergie_clan_ps vamp_synergie_clan_ps_chance}}
        ">{{vamp_synergie_clan_ps}} / {{vamp_synergie_clan_ps_chance}}%</div>
      </div>
      {{/vamp_synergie_clan_ps}}

      {{#vamp_synergie_clan_ls}}
      <div class="sheet-template-obtention-row">
        <div class="sheet-template-obtention-label">Synergie de Clan — LS</div>
        <div class="sheet-template-obtention-roll
          {{#rollLess()  vamp_synergie_clan_ls vamp_synergie_clan_ls_chance}}sheet-rt-ok{{/rollLess()  vamp_synergie_clan_ls vamp_synergie_clan_ls_chance}}
          {{#rollTotal() vamp_synergie_clan_ls vamp_synergie_clan_ls_chance}}sheet-rt-ok{{/rollTotal() vamp_synergie_clan_ls vamp_synergie_clan_ls_chance}}
          {{#rollGreater() vamp_synergie_clan_ls vamp_synergie_clan_ls_chance}}sheet-rt-bad{{/rollGreater() vamp_synergie_clan_ls vamp_synergie_clan_ls_chance}}
        ">{{vamp_synergie_clan_ls}} / {{vamp_synergie_clan_ls_chance}}%</div>
      </div>
      {{/vamp_synergie_clan_ls}}

    </div>
  </div>
</rolltemplate>






<!-- =========================
     ROLLTEMPLATE : gainpts
     ========================= -->
<rolltemplate class="sheet-rolltemplate-gainpts">
  <div class="sheet-rt-card">
    <div class="sheet-rt-title">{{title}}</div>

    {{#note}}
      <div class="sheet-rt-note">{{note}}</div>
    {{/note}}

    {{#m1}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m1}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps1}}</div>
        <div class="sheet-rt-gain">LS : {{ls1}}</div>
      </div>
    </div>{{/m1}}

    {{#m2}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m2}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps2}}</div>
        <div class="sheet-rt-gain">LS : {{ls2}}</div>
      </div>
    </div>{{/m2}}

    {{#m3}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m3}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps3}}</div>
        <div class="sheet-rt-gain">LS : {{ls3}}</div>
      </div>
    </div>{{/m3}}

    {{#m4}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m4}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps4}}</div>
        <div class="sheet-rt-gain">LS : {{ls4}}</div>
      </div>
    </div>{{/m4}}

    {{#m5}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m5}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps5}}</div>
        <div class="sheet-rt-gain">LS : {{ls5}}</div>
      </div>
    </div>{{/m5}}

    {{#m6}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m6}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps6}}</div>
        <div class="sheet-rt-gain">LS : {{ls6}}</div>
      </div>
    </div>{{/m6}}

    {{#m7}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m7}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps7}}</div>
        <div class="sheet-rt-gain">LS : {{ls7}}</div>
      </div>
    </div>{{/m7}}

    {{#m8}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m8}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps8}}</div>
        <div class="sheet-rt-gain">LS : {{ls8}}</div>
      </div>
    </div>{{/m8}}

    {{#m9}}<div class="sheet-rt-row">
      <div class="sheet-rt-method">{{m9}}</div>
      <div class="sheet-rt-gains">
        <div class="sheet-rt-gain">PS : {{ps9}}</div>
        <div class="sheet-rt-gain">LS : {{ls9}}</div>
      </div>
    </div>{{/m9}}

  </div>
</rolltemplate>

